<!DOCTYPE html>
<html lang="th">
<head>
	<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
            margin: 0;
            
            /* ‡πÉ‡∏™‡πà Overlay ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏à‡∏≤‡∏á‡πÜ (rgba(255, 255, 255, 0.7)) ‡∏ó‡∏±‡∏ö‡∏£‡∏π‡∏õ */
            background-image: linear-gradient(rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.7)), url('https://sv1.img.in.th/7fDpZ8.png');
            background-size: cover;         
            background-position: center;    
            background-attachment: fixed;   
            background-repeat: no-repeat;   
            background-color: #f0f2f5; /* ‡∏™‡∏µ‡∏™‡∏≥‡∏£‡∏≠‡∏á */
        }
        
        .sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100vh; background: white; z-index: 1000; transition: left 0.3s ease; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; box-shadow: 2px 0 10px rgba(0,0,0,0.1); overflow-y: auto;}
        .sidebar.active { left: 0; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; display: none; }
        .overlay.active { display: block; }
        .menu-btn { position: fixed; top: 20px; left: 20px; z-index: 800; background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 20px; }

        .sidebar-btn { background: #f8f9fa; border: none; padding: 15px; width: 100%; text-align: left; margin-bottom: 10px; border-radius: 8px; cursor: pointer; font-size: 16px; color: #333; }
        .sidebar-btn:hover { background: #e2e6ea; }
        .create-btn { background: #007bff; color: white; font-weight: bold; text-align: center; }
        .create-btn:hover { background: #0056b3; }
        .admin-btn { background: #ffc107; color: #333; font-weight: bold; }
		
		.my-active-posts-btn {
		background: #007bff; 
		color: white; 
		font-weight: bold; 
		text-align: left;
		}
		.my-active-posts-btn:hover { 
		background: #0056b3; 
		}

        .content-area { padding: 80px 20px 20px 20px; max-width: 800px; margin: 0 auto; position: relative; }
        
        .header-tools { position: absolute; top: 20px; right: 20px; display: flex; gap: 15px; align-items: center; z-index: 800; }
        .coin-badge { background: white; padding: 8px 15px; border-radius: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-weight: bold; color: #333; border: 2px solid #e67e22; display: flex; align-items: center; width: auto; cursor: pointer; transition: transform 0.2s; position: relative; }
        .coin-badge:hover { transform: scale(1.05); }
        
        #coin-notif-dot { top: -2px; right: 0px; }
        
        .mail-btn { background: white; width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; font-size: 1.5em; position: relative; transition: transform 0.2s; }
        .mail-btn:hover { transform: scale(1.1); background: #f0f2f5; }
        
        .notif-dot { position: absolute; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; justify-content: center; align-items: center; border: 2px solid white; animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-3px); } }

        .post-card { background: white; padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .post-card:first-child { border-top-left-radius: 10px; border-top-right-radius: 10px; }
        .post-card:last-child { border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; border-bottom: none; }
        .post-card.occupied { background: #fff3cd; border-left: 5px solid #ffc107 !important; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 500px; padding: 30px; border-radius: 15px; max-height: 80vh; overflow-y: auto; }
        .hidden { display: none !important; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: 'Kanit'; }

        #user-search-input { margin-bottom: 20px; padding: 10px; border: 2px solid #007bff; border-radius: 8px; font-size: 1em; }
        .user-list-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .user-list-item:hover { background: #f0f2f5; }
        .unread-indicator { width: 20px; height: 20px; background: red; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.75em; margin-left: 10px; }

        #private-chat-modal { z-index: 3000; }
        .chat-window { display: flex; flex-direction: column; height: 400px; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; border: 1px solid #eee; margin-bottom: 10px; border-radius: 8px;}
        .chat-input-area { display: flex; gap: 5px; }
        
        .give-coin-btn { background: #ffc107; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; font-size: 1.2em; transition: 0.2s; }
        .give-coin-btn:hover { background: #e0a800; }
        .deduct-coin-btn { background: #dc3545; color: white; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; font-size: 1.2em; transition: 0.2s; }
        .deduct-coin-btn:hover { background: #c82333; }

        .msg { margin-bottom: 5px; font-size: 0.9em; padding: 5px 10px; border-radius: 10px; max-width: 80%; display: block; clear: both;}
        .my-msg { float: right; background: #007bff; color: white; }
        .other-msg { float: left; background: #e4e6eb; color: #333; }
        
        .system-msg { text-align: center; font-size: 0.8em; color: gray; margin: 10px 0; clear: both; float: none;}
        .system-link { cursor: pointer; color: #007bff; text-decoration: underline; background: #e9ecef; padding: 5px 10px; border-radius: 15px; display: inline-block; transition: background 0.2s; }
        .system-link:hover { background: #dde2e6; }

        .sidebar-btn.active-menu { background-color: #e2e6ea; border-left: 5px solid #007bff; font-weight: bold; }
        
        .version-display { position: fixed; bottom: 10px; right: 10px; font-size: 0.75em; color: #6c757d; background: #f8f9fa; padding: 3px 8px; border-radius: 5px; z-index: 9999; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .transaction-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .tx-plus { color: #28a745; font-weight: bold; } 
        .tx-minus { color: #dc3545; font-weight: bold; } 
        
        .location-btn { background: white; border: 1px solid #28a745; color: #28a745; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.9em; width: 100%; justify-content: center; margin-bottom: 10px; }
        .location-btn:hover { background: #e9f7ef; }
        .location-btn.active { background: #28a745; color: white; }
    </style>
</head>
<body>

    <button class="menu-btn" onclick="toggleSidebar()">‚ò∞ Menu</button>
    <div class="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
    <h2 style="text-align:center; margin-top:0;">Webboard</h2>
    
    <div style="text-align:center; margin-bottom:20px;">
        <div style="font-size:40px;" id="user-avatar-display">üë§</div>
        <div id="user-display">Guest</div>
        <div style="color:black; font-weight:bold; margin-top:5px;">
            ‚≠ê <span id="sidebar-rating" style="color:black;">5.0</span> / 5.0
        </div>
        <div style="color:#28a745; font-weight:bold; margin-top:5px; line-height: 1.1;">
            <div id="sidebar-coins">
                <div id="sidebar-usd-display">0 USD</div> 
                <div id="sidebar-converted-display" style="font-size:0.75em; color:#6c757d; font-weight: normal;">(0.00 THB)</div>
            </div>
        </div>
    </div>
    
    <div style="margin: 0 15px 15px 15px; display: flex; align-items: center; gap: 10px;">
    <label for="currency-select" style="font-size: 0.85em; color: #6c757d; margin-bottom:0;" data-i18n-key="label_currency">‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô:</label>
    <select id="currency-select" onchange="setPreferredCurrency(this.value)" style="flex-grow: 1; padding: 8px; border-radius: 5px; border:1px solid #ddd; font-family: 'Kanit';">
        <option value="THB">‡∏ø THB </option>
        <option value="USD">$ USD </option>
        <option value="EUR">‚Ç¨ EUR </option>
        <option value="JPY">¬• JPY </option>
    </select>
</div>

<div style="margin: 0 15px 15px 15px; display: flex; align-items: center; gap: 10px;">
    <label for="lang-select" style="font-size: 0.85em; color: #6c757d; margin-bottom:0;" data-i18n-key="label_language">‡∏†‡∏≤‡∏©‡∏≤:</label>
    <select id="lang-select" onchange="setLanguage(this.value)" style="flex-grow: 1; padding: 8px; border-radius: 5px; border:1px solid #ddd; font-family: 'Kanit';">
        <option value="th">üáπüá≠ ‡πÑ‡∏ó‡∏¢</option>
        <option value="en">üá∫üá∏ English</option>
    </select>
</div>
    
    <button class="sidebar-btn" onclick="switchView('home')" data-i18n-key="home">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    <button class="sidebar-btn create-btn" onclick="openCreateModal()" data-i18n-key="create_post">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ</button>
	
	<button class="sidebar-btn my-active-posts-btn" onclick="showMyActivePosts()">
    <span data-i18n-key="my_active_posts">‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î</span>
    <span id="active-post-count" style="margin-left:5px; padding: 2px 7px; border-radius: 50%; background:#dc3545; color:white; font-size:0.8em; line-height:1;">0</span>
</button>
	<button class="sidebar-btn my-closed-posts-btn" onclick="showMyClosedPosts()" data-i18n-key="my_closed_posts">
‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß
</button>
    
    <div id="admin-panel" class="hidden">
        <hr style="margin: 15px 0; border: 0; border-top: 1px solid #ddd;">
        <div style="font-size:0.8em; color:gray; margin-bottom:5px;" data-i18n-key="admin_section">‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</div>
        <button class="sidebar-btn admin-btn" onclick="openAdminPinnedModal()" data-i18n-key="admin_create_pinned">üìå ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©</button> <button class="sidebar-btn admin-btn" onclick="switchView('closed')" data-i18n-key="admin_closed_posts">üóÑÔ∏è ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß</button>
        <button class="sidebar-btn admin-btn" onclick="openAdminTopicModal()" data-i18n-key="admin_manage_topics">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</button>
        <button class="sidebar-btn admin-btn" onclick="setPostCost()" data-i18n-key="admin_set_cost">üè∑Ô∏è ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°</button>
        <button class="sidebar-btn admin-btn" onclick="openAllUserList()" data-i18n-key="admin_user_list">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <button class="sidebar-btn" style="margin-top:auto;" onclick="logout()" data-i18n-key="logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>

    <div class="content-area">
    <div class="header-tools">
        <div class="coin-badge" onclick="contactAdmin()" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô">
            <div id="header-coins-container" style="text-align: right; line-height: 1.1;">
                <div id="header-usd-display" style="font-size:1.4em; color:#e67e22; font-weight: bold;">0 USD</div>
                <div id="header-converted-display" style="font-size:0.75em; color:#6c757d; font-weight: normal;">(0.00 THB)</div>
            </div>
            <div id="coin-notif-dot" class="notif-dot hidden">!</div>
        </div>
        
        <div class="mail-btn" onclick="openInbox()" title="‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° / ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô">
            üì©
            <div id="notif-badge" class="notif-dot hidden">!</div>
        </div>
    </div>

    <h2 style="margin-top:0;" id="page-title" data-i18n-key="page_title">üìå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
    
    <div id="post-list-scroll-container" style="max-height: 70vh; overflow-y: auto;">
	
		<div style="text-align: center; margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.8); border-radius: 8px;">
                <button id="geo-filter-btn" class="sidebar-btn" style="width: auto; padding: 8px 20px; background: #17a2b8; color: white; font-size: 1rem;" onclick="setDistanceFilter()" data-i18n-key="btn_checkin">
                    üìç ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
                </button>
                <span id="filter-status" style="margin-left: 10px; font-size: 0.9em; color: #333; font-weight: bold;" data-i18n-key="status_all">
                    (‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
                </span>
                
                
            </div>

            <div id="post-list">
                </div>
				
        <div id="post-list" style="background:white; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.05);"></div>
    </div>
    
    <div id="post-pagination" style="text-align: center; margin-top: 20px; display: none;">
    <button class="sidebar-btn" id="post-prev-btn" onclick="changePostPage(-1)" style="width:auto; padding: 5px 15px; font-size: 0.9em; display:inline-block;" data-i18n-key="post_btn_prev"></button>
    <span id="post-page-info" style="margin: 0 10px; font-size: 0.9em; font-weight: bold;"></span>
    <button class="sidebar-btn" id="post-next-btn" onclick="changePostPage(1)" style="width:auto; padding: 5px 15px; font-size: 0.9em; display:inline-block;" data-i18n-key="post_btn_next"></button>
</div>
</div>

    <div id="login-modal" class="modal-overlay">
        <div class="modal-box" style="text-align:center;">
            <h2 data-i18n-key="login_title">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
            <input type="text" id="username-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô..." autofocus data-i18n-key="login_placeholder">
            <button class="sidebar-btn create-btn" onclick="login()" data-i18n-key="login_btn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="create-modal" class="modal-overlay hidden">
    <div class="modal-box">
        <h2 id="create-modal-title" data-i18n-key="title_create">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà</h2>
        
        <p style="color:#e67e22;" id="modal-cost-row"> 
            <span data-i18n-key="cost_fee">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°:</span> <span id="modal-cost-display">0 USD</span>
        </p>
        
        <input type="text" id="title-input" class="hidden" placeholder="‚≠ê ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏© (Admin)" style="margin-bottom: 15px;" data-i18n-key="placeholder_title_admin">
        
        <select id="category-select" required style="margin-bottom: 15px;"></select>
        
        <button type="button" class="location-btn" id="geo-btn" onclick="getLocation()" data-i18n-key="geo_btn">
            üìç ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô)
        </button>
        <div id="location-display" style="font-size:0.8em; color:gray; margin-bottom:15px; text-align:center;"></div>
        
        <div class="input-group" style="margin-top: 15px;">
            <label for="post-image" data-i18n-key="label_image_max">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5MB):</label>
            <input type="file" id="post-image" name="image" accept="image/*" style="padding: 8px 0;">
        </div>
		
		<div style="position: relative; margin-bottom: 15px;">
            <textarea id="content" rows="5" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." required data-i18n-key="placeholder_content" style="margin-bottom: 5px;"></textarea>
            
            <button type="button" class="sidebar-btn" onclick="toggleEmojiPicker('create')" style="width: auto; padding: 5px 10px; font-size: 1.2em;">üòä</button>
            
            <div id="emoji-picker-container-create" style="display: none; position: absolute; z-index: 100; bottom: 50px; left: 0;">
                <emoji-picker id="picker-create"></emoji-picker>
            </div>
        </div>
        
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="sidebar-btn" onclick="closeCreateModal()" style="width:auto;" data-i18n-key="cancel_btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="sidebar-btn create-btn" onclick="createPost()" style="width:auto;" data-i18n-key="post_btn">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
        </div>
        <div style="font-size:0.8em; color:gray; margin-top:10px;" data-i18n-key="create_note">
            * ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏à‡∏∞‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà Admin ‡∏Å‡∏≥‡∏´‡∏ô‡∏î
        </div>
    </div>
</div>

    <div id="user-list-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="user-list-title" data-i18n-key="modal_user_list_title">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</h2>
                <button onclick="document.getElementById('user-list-modal').classList.add('hidden')" style="border:none; background:none; font-size:1.5em; cursor:pointer;">√ó</button>
            </div>
            <p id="user-list-desc" style="font-size:0.9em; color:gray;" data-i18n-key="modal_user_list_desc"></p>

            <input type="text" id="user-search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠..." onkeyup="openAllUserList(this.value)" style="width:100%;" data-i18n-key="search_placeholder">

            <div id="pagination-controls" style="text-align: center; margin-top: 15px; margin-bottom: 10px; display: none;">
    <button class="sidebar-btn" id="list-prev-btn" onclick="changeListPage(-1)" style="width:auto; padding: 5px 15px; font-size: 0.9em;" data-i18n-key="btn_prev">‚¨ÖÔ∏è ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
    <span id="page-info" style="margin: 0 10px; font-size: 0.9em; font-weight: bold;"></span>
    <button class="sidebar-btn" id="list-next-btn" onclick="changeListPage(1)" style="width:auto; padding: 5px 15px; font-size: 0.9em;" data-i18n-key="btn_next">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button>
</div>

            <div id="user-list-container">Loading...</div>
        </div>
    </div>

    <div id="private-chat-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0;"><span data-i18n-key="chat_with">üí¨ ‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö:</span> <span id="chat-partner-name">...</span></h3>
                <button onclick="closePrivateChat()" style="border:none; background:none; font-size:1.5em; cursor:pointer;">√ó</button>
            </div>
            <div class="chat-window">
                <div id="private-chat-messages" class="chat-messages"></div>
                <div class="chat-input-area">
                    <div id="admin-chat-tools" class="hidden" style="display:flex; gap:5px;">
                        <button class="give-coin-btn" title="‡πÇ‡∏≠‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" onclick="sendCoinInChat()">üí∏</button>
                        <button class="deduct-coin-btn" title="‡∏î‡∏∂‡∏á‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≤‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" onclick="deductCoinInChat()">üß≤</button>
                    </div>
                    
                    <input type="text" id="private-chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." style="margin-bottom:0;" autocomplete="off" data-i18n-key="chat_placeholder">
                    <button class="sidebar-btn create-btn" style="width:auto; margin-bottom:0;" onclick="sendPrivateMessage()" data-i18n-key="chat_send">‡∏™‡πà‡∏á</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="admin-topic-modal" class="modal-overlay hidden">
        <div class="modal-box" style="width: 90%; max-width: 600px;">
            <h2 style="text-align: center;" data-i18n-key="admin_topic_title">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏ß‡πá‡∏ö‡∏ö‡∏≠‡∏£‡πå‡∏î</h2>
            <div style="max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #ccc; margin-bottom: 20px; border-radius: 8px;">
                <table id="admin-topic-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="border-bottom: 2px solid #333; padding: 8px; text-align: left;" data-i18n-key="th_topic_name">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (ID)</th>
                            <th style="border-bottom: 2px solid #333; padding: 8px; width: 100px;" data-i18n-key="th_action">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <h3 style="margin-top: 30px;" data-i18n-key="header_add_topic">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà</h3>
            <input type="text" id="new-topic-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏µ‡∏¨‡∏≤, ‡∏≠‡∏≤‡∏´‡∏≤‡∏£)" style="width: 100%; margin-bottom: 10px;" data-i18n-key="placeholder_new_topic">
            <button class="sidebar-btn create-btn" onclick="addTopic()" style="margin-bottom: 10px;" data-i18n-key="btn_add_topic">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</button>
            <button class="sidebar-btn" onclick="document.getElementById('admin-topic-modal').classList.add('hidden');" data-i18n-key="btn_close">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>
    
    <div class="version-display">v: 3.7.0 (THB+I18N)</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myUsername = "";
		let myAdminLevel = 0;
		let filterLocation = null;      // ‡πÄ‡∏Å‡πá‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ô‡∏î‡∏π
        let filterMaxDistance = null;   // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á (‡∏Å‡∏°.)
		
		function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÇ‡∏•‡∏Å (‡∏Å‡∏°.)
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // ‚úÖ [NEW] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á (‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô)
        function setDistanceFilter() {
			const t = translations[currentLang];
            // 1. ‡∏ñ‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
            const input = prompt(t.prompt_distance, "50");
            if (input === null) return; 
            
            const dist = parseFloat(input);
            if (isNaN(dist) || dist <= 0) {
                alert(t.alert_invalid_num);
                return;
            }

            // 2. ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS
            if (!navigator.geolocation) {
                alert(t.error_geo_not_supported);
                return;
            }

            document.getElementById('filter-status').innerText = t.status_locating;
            document.getElementById('filter-status').removeAttribute('data-i18n-key');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    filterLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    filterMaxDistance = dist;
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                    const kmText = currentLang === 'th' ? '‡∏Å‡∏°.' : 'km';
                    document.getElementById('filter-status').innerText = `${t.status_dist_prefix} ${dist} ${kmText})`;
                    document.getElementById('filter-status').style.color = "#007bff";
                    document.getElementById('clear-filter-btn').style.display = "inline-block";
                    
                    // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå
                    loadPosts();
                    // alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß! ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞ ${dist} ‡∏Å‡∏°.`);
                },
                (error) => {
                    onsole.error(error);
                    alert(`${t.error_geo_failed}: ${error.message}`);
                    document.getElementById('filter-status').innerText = `(${t.error_geo_failed})`;
                },
                { enableHighAccuracy: true }
            );
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á
        function clearDistanceFilter() {
            const t = translations[currentLang];
            
            filterLocation = null;
            filterMaxDistance = null;
            
            const statusSpan = document.getElementById('filter-status');
            statusSpan.innerText = t.status_all;
            statusSpan.setAttribute('data-i18n-key', 'status_all'); // ‡πÉ‡∏™‡πà key ‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô
            
            statusSpan.style.color = "#333";
            document.getElementById('clear-filter-btn').style.display = "none";
            loadPosts();
        }
		
        
        // --- NEW: Global Configuration ---
		const DEFAULT_CURRENCY = 'THB'; // ‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á
        // ---------------------------------
		let currentCurrency = DEFAULT_CURRENCY;
		let currentLang = 'th';
		
		// Translation Data Structure (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UI ‡πÅ‡∏•‡∏∞ System Message Keys)
		const translations = {
    'th': {
        'app_title': 'Webboard',
        'label_currency': '‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô:',
        'label_language': '‡∏†‡∏≤‡∏©‡∏≤:',
        'menu': '‚ò∞ Menu',
        'home': 'üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å',
        'create_post': '+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ',
        'my_active_posts': '‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î',
        'my_closed_posts': '‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß',
        'logout': '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
        'admin_section': '‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô',
        'admin_create_pinned': 'üìå ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©',
        'admin_closed_posts': 'üóÑÔ∏è ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß',
        'admin_manage_topics': '‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠',
        'admin_set_cost': 'üè∑Ô∏è ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°',
        'admin_user_list': 'üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
        'page_title': 'üìå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
        'title_create': '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà',
        'cost_fee': '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°:',
        'placeholder_title_admin': '‚≠ê ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏© (Admin)',
        'placeholder_content': '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ...',
        'geo_btn': 'üìç ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô)',
        'label_image_max': '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5MB):',
        'post_btn': '‡πÇ‡∏û‡∏™‡∏ï‡πå',
        'cancel_btn': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        'notif_currency_change': '‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô [CURRENCY] ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
        
        'geo_not_supported': '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',
        'geo_searching': '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...',
        'geo_success_name': '‚úÖ ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
        'geo_success_coord': '‚úÖ ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
        'geo_display_name': 'üìç ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà:',
        'geo_display_coord': 'üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î:',
        'geo_error_permission': 'üö´ ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',
        'geo_error_general': 'üö® ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ',
        'prompt_fee': '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° (USD):',
        
        'btn_prev': '‚¨ÖÔ∏è',
        'btn_next': '‚û°Ô∏è',
        'post_btn_prev': '‚¨ÖÔ∏è',
        'post_btn_next': '‚û°Ô∏è',
        'login_title': '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö',
        'login_placeholder': '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô...',
        'login_btn': '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
        'create_note': '* ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏à‡∏∞‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà Admin ‡∏Å‡∏≥‡∏´‡∏ô‡∏î',
        'modal_user_list_title': 'üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠',
        'modal_user_list_desc': '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)',
        'search_placeholder': 'üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠...',
        'chat_with': 'üí¨ ‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö:',
        'chat_placeholder': '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...',
        'chat_send': '‡∏™‡πà‡∏á',
        
        'prompt_transfer_admin': '‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô USD ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡πâ',
        'prompt_deduct_admin': '‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô USD ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≤‡∏Å',
        
        'admin_topic_title': '‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏ß‡πá‡∏ö‡∏ö‡∏≠‡∏£‡πå‡∏î',
        'th_topic_name': '‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (ID)',
        'th_action': '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£',
        'header_add_topic': '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà',
        'placeholder_new_topic': '‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏µ‡∏¨‡∏≤, ‡∏≠‡∏≤‡∏´‡∏≤‡∏£)',
        'btn_add_topic': '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠',
        'btn_close': '‡∏õ‡∏¥‡∏î',
        
        'post_not_found': '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ',
        'closed_or_finished': '‚õî ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô/‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
        'room_occupied': '‚ö†Ô∏è ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...',
        
        'prompt_confirm_ban': '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏à‡∏∞ ‡πÅ‡∏ö‡∏ô (‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå) ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: [USERNAME] ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        'prompt_confirm_unban': '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏à‡∏∞ ‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: [USERNAME] ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        'notif_user_banned': '‚ùå ‡πÅ‡∏ö‡∏ô [USERNAME] ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
        'notif_user_unbanned': '‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô [USERNAME] ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
        
        'tx_paid': '‡∏à‡πà‡∏≤‡∏¢',
        'tx_received': '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö',
        'tx_from': '‡∏à‡∏≤‡∏Å',
        'tx_to': '‡πÉ‡∏´‡πâ',
        'tx_post_fee_prefix': '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ',
        'tx_handover_success': '‚úÖ ‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•/‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        
        'admin_tx_title': '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç USD',
        'admin_tx_desc': '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô)',
        'admin_tx_revenue': 'üí∏ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°)',
        'admin_tx_deduct': 'üß≤ ‡∏î‡∏∂‡∏á‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏Ñ‡∏∑‡∏ô',
        'admin_tx_transfer_out': '‚û°Ô∏è ‡πÇ‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å',
        'member_tx_title': '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° USD',
        'member_tx_desc': '‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏•‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô)',

        'SYS_FEE': (data) => `üí∏ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î "${data.topicName}" ‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å ${data.cost} USD`,
        'SYS_TRANSFER': (data) => `üí∞ Admin ‡πÑ‡∏î‡πâ‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${data.amount} USD`,
        'SYS_DEDUCT': (data) => `üí∏ Admin ‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á USD ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${data.amount} USD`,
        'SYS_NEW_COMMENT': (data) => `üí¨ ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ "${data.postTitle}"`,
        'tx_detail_create_post': '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ: [TITLE]',
        'tx_detail_admin_give': '‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡πâ [USER]',
        'tx_detail_admin_deduct': '‡∏î‡∏∂‡∏á‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≤‡∏Å [USER]',
        'tx_detail_handover': '‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•/‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô: [TITLE]',
        'admin_warn_empty_topic': '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà',
        'admin_confirm_delete_topic': '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "[NAME]"?',
        'admin_success_add_topic': '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        'admin_success_delete_topic': '‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        'admin_error_topic': '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ',
        'confirm_delete_post': '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ?',

        'btn_checkin': 'üìç ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á',
        'status_all': '(‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)',
        'btn_cancel_filter': '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        'prompt_distance': '‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ (‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£):',
        'alert_invalid_num': '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
        'status_locating': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...',
        'status_dist_prefix': '(‡∏£‡∏∞‡∏¢‡∏∞',
        'msg_no_post_range': '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞',
        'btn_show_all': '‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
        'error_geo_not_supported': 'Browser ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',
        'error_geo_failed': '‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'
    },
    'en': {
        'app_title': 'Webboard',
        'label_currency': 'Currency:',
        'label_language': 'Language:',
        'menu': '‚ò∞ Menu',
        'home': 'üè† Home',
        'create_post': '+ Create Post',
        'my_active_posts': 'My Active Posts',
        'my_closed_posts': 'My Closed Posts',
        'logout': 'Logout',
        'admin_section': 'Admin Section',
        'admin_create_pinned': 'üìå Create Pinned Post',
        'admin_closed_posts': 'üóÑÔ∏è Closed Posts',
        'admin_manage_topics': '‚öôÔ∏è Manage Topics',
        'admin_set_cost': 'üè∑Ô∏è Set Fee',
        'admin_user_list': 'üë• All Members List',
        'page_title': 'üìå Listings',
        'title_create': 'Create New Post',
        'cost_fee': 'Fee:',
        'placeholder_title_admin': '‚≠ê Pinned Post Title (Admin)',
        'placeholder_content': 'Post details...',
        'geo_btn': 'üìç Get Current Location (Check In)',
        'label_image_max': 'Image (Max 5MB):',
        'post_btn': 'Post',
        'cancel_btn': 'Cancel',
        'notif_currency_change': '‚úÖ Currency changed to [CURRENCY]',
        
        'geo_not_supported': 'Your browser does not support geolocation.',
        'geo_searching': '‚è≥ Searching location...',
        'geo_success_name': '‚úÖ Location found',
        'geo_success_coord': '‚úÖ Coordinates retrieved',
        'geo_display_name': 'üìç Your location is:',
        'geo_display_coord': 'üìç Coordinates:',
        'geo_error_permission': 'üö´ Permission denied: Please allow access to location in browser settings.',
        'geo_error_general': 'üö® Cannot retrieve location',
        'prompt_fee': 'Fee (USD):',

        'btn_prev': '‚¨ÖÔ∏è',
        'btn_next': '‚û°Ô∏è',
        'post_btn_prev': '‚¨ÖÔ∏è',
        'post_btn_next': '‚û°Ô∏è',
        'login_title': 'Welcome',
        'login_placeholder': 'Nickname...',
        'login_btn': 'Login',
        'create_note': '* Creating a post incurs a fee set by Admin.',
        'modal_user_list_title': 'üë• Members',
        'modal_user_list_desc': 'List of all members in the system (and remaining balance)',
        'search_placeholder': 'üîç Search user...',
        'chat_with': 'üí¨ Chat with:',
        'chat_placeholder': 'Type a message...',
        'chat_send': 'Send',
        
        'prompt_transfer_admin': 'Enter USD amount to transfer to',
        'prompt_deduct_admin': 'Enter USD amount to deduct from',

        'admin_topic_title': '‚öôÔ∏è Manage Topics',
        'th_topic_name': 'Topic Name (ID)',
        'th_action': 'Action',
        'header_add_topic': '+ Add New Topic',
        'placeholder_new_topic': 'New Topic Name...',
        'btn_add_topic': 'Add Topic',
        'btn_close': 'Close',
        
        'post_not_found': 'Post not found',
        'closed_or_finished': '‚õî This post is closed/finished.',
        'room_occupied': '‚ö†Ô∏è This post is currently occupied. Please wait...',
        
        'prompt_confirm_ban': 'Are you sure you want to BAN (suspend) member: [USERNAME]?',
        'prompt_confirm_unban': 'Are you sure you want to UNBAN member: [USERNAME]?',
        'notif_user_banned': '‚ùå [USERNAME] has been banned',
        'notif_user_unbanned': '‚úÖ [USERNAME] has been unbanned',
        
        'tx_paid': 'Paid',
        'tx_received': 'Received',
        'tx_from': 'From',
        'tx_to': 'To',
        'tx_post_fee_prefix': 'Post Creation Fee',
        'tx_handover_success': '‚úÖ Deal Closed/Handover Success',
        
        'admin_tx_title': 'History of All USD Transactions',
        'admin_tx_desc': 'All income and transfers (newest first)',
        'admin_tx_revenue': 'üí∏ Revenue (Post Fee)',
        'admin_tx_deduct': 'üß≤ Coins Deducted',
        'admin_tx_transfer_out': '‚û°Ô∏è Coins Transferred Out',
        'member_tx_title': 'USD Transaction History',
        'member_tx_desc': 'Your complete coin history (newest first)',

        'SYS_FEE': (data) => `üí∏ You created a post in category "${data.topicName}" and were charged ${data.cost} USD`,
        'SYS_TRANSFER': (data) => `üí∞ Admin transferred ${data.amount} USD to you`,
        'SYS_DEDUCT': (data) => `üí∏ Admin deducted ${data.amount} USD from your account`,
        'SYS_NEW_COMMENT': (data) => `üí¨ New comment in post "${data.postTitle}"`,
        'tx_detail_create_post': 'Post Creation Fee: [TITLE]',
        'tx_detail_admin_give': 'Transfer to [USER]',
        'tx_detail_admin_deduct': 'Deduct from [USER]',
        'tx_detail_handover': 'Job Handover: [TITLE]',
        'admin_warn_empty_topic': 'Please enter a new topic name.',
        'admin_confirm_delete_topic': 'Are you sure you want to delete the topic "[NAME]"?',
        'admin_success_add_topic': 'Topic added successfully.',
        'admin_success_delete_topic': 'Topic deleted successfully.',
        'admin_error_topic': 'Error occurred: ',
        'confirm_delete_post': 'Are you sure you want to delete this post?',

        // ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
        'btn_checkin': 'üìç Distance Filter',
        'status_all': '(Show All)',
        'btn_cancel_filter': '‚ùå Cancel',
        'prompt_distance': 'Enter distance radius (km):',
        'alert_invalid_num': 'Please enter a valid number.',
        'status_locating': 'Locating...',
        'status_dist_prefix': '(Radius',
        'msg_no_post_range': '‚ùå No posts found within',
        'btn_show_all': 'Show All',
        'error_geo_not_supported': 'Browser does not support Geolocation',
        'error_geo_failed': 'Location failed'
    }
};

		// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤ (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô startApp)
	function setLanguage(lang) {
        if (!translations[lang]) return;
        currentLang = lang;
        localStorage.setItem('preferredLanguage', lang);
        
        // 1. ‡πÅ‡∏õ‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ data-i18n-key
        document.querySelectorAll('[data-i18n-key]').forEach(element => {
            const key = element.getAttribute('data-i18n-key');
            const translatedText = translations[lang][key];

            if (translatedText) {
                if (element.placeholder) {
                    element.placeholder = translatedText;
                } else {
                    // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ icon/emoji ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°
                    const textOnly = element.innerText.replace(/(<i[^>]*><\/i>|[\u2600-\u26FF\u2700-\u27BF\u1F600-\u1F64F\u1F300-\u1F5FF\u2B06-\u2B07\u2B50\u23F3\u231B\u23E9-\u23EC\u23F0\u23F8-\u23FA\u23CF\u21AA\u21A9\u2190-\u21FF\u25AA-\u25FE\u2B1B\u2B1C\u2B55\u23E3\u2705\u274C\u274E\u2714\u2716\u2728\u2733\u2734\u2753\u2754\u2755\u2795-\u2797\u27A1\u27B0\u27BF\u27C0-\u27FF\u1F000-\u1F6FF\u1F900-\u1F9FF]+)/g, '').trim();
                    const icon = element.innerHTML.substring(0, element.innerHTML.indexOf(textOnly));
                    
                    if(icon.trim() !== '') {
                        element.innerHTML = `${icon} ${translatedText}`;
                    } else {
                        element.innerHTML = translatedText;
                    }
                }
            }
        });
        
        document.getElementById('post-prev-btn').innerText = translations[currentLang]['post_btn_prev'];
		document.getElementById('post-next-btn').innerText = translations[currentLang]['post_btn_next'];

        // 3. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        updateUserInfo(); 
        loadPosts(); 

        // 4. ‚≠ê [FIXED] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Modal ‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏ô
        const modal = document.getElementById('user-list-modal');
        if (!modal.classList.contains('hidden')) {
            const listType = document.getElementById('pagination-controls').dataset.type;
            
            if (listType === 'adminTx') {
                 // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏ß‡∏° (Admin)" ‡∏≠‡∏¢‡∏π‡πà
                 openTransactionModal(adminTxPage); 
            } else if (listType === 'memberTx') {
                 // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß" ‡∏≠‡∏¢‡∏π‡πà
                 openMemberLedger(memberTxPage);
            }
        }
    }
        
        let currentCost = 0;
        let currentChatPartner = ""; 
        let unreadUsers = new Set();
        let currentView = 'home'; 
        let hasNewTransaction = false; 
		let currentRating = 5.0; 
        
        let currentLocationData = null;
        let postStatusMap = {}; 

        // Pagination States
        let adminTxPage = 1;
        let memberTxPage = 1;
        let inboxPage = 1;
        
        let currentPostPage = 1;
        const POST_LIMIT = 20; 
        const PAGE_LIMIT = 20;

        const notificationSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-positive-notification-951.mp3');
        const ADMIN_USERNAME = 'Admin'; 

        window.onload = () => {
    const savedName = localStorage.getItem('myUsername');
    // ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const savedLang = localStorage.getItem('preferredLanguage') || 'th';
    currentLang = savedLang;
    
    const langSelect = document.getElementById('lang-select');
    if (langSelect) {
        langSelect.value = savedLang;
        setLanguage(savedLang); // ‡πÅ‡∏õ‡∏• UI ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ Selector ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        setLanguage(currentLang);
    }
    
    if (savedName) startApp(savedName);
    else document.getElementById('login-modal').classList.remove('hidden');
};
        
        document.getElementById('private-chat-input')?.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendPrivateMessage();
        });

        function login() {
            const name = document.getElementById('username-input').value.trim();
            if(!name) return;
            localStorage.setItem('myUsername', name);
            startApp(name);
        }

        function startApp(name) {
    myUsername = name;
    // ‡πÉ‡∏ä‡πâ user-display ‡πÅ‡∏ó‡∏ô user-display-name ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö HTML
    const userDisplay = document.getElementById('user-display');
    if(userDisplay) userDisplay.innerText = name;

    document.getElementById('login-modal').classList.add('hidden');
    socket.emit('register', myUsername);
    
    // ‚≠ê [FIXED] ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å localStorage ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateUserInfo()
    const preferred = localStorage.getItem('preferredCurrency');
    if (preferred) {
        currentCurrency = preferred;
        const selectElement = document.getElementById('currency-select');
        if (selectElement) selectElement.value = preferred;
    }

    if (name !== 'Admin') { 
        checkAndRedirectActiveJob(name);
    }

    const adminPanelDiv = document.getElementById('admin-panel');
    
    // ‚úÖ [CLEANED] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    checkNewTransaction();
    loadUnreadStatus(); 
    loadTopics(); 
    loadPosts(); 
    updateUserInfo();
    updateActivePostCount(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
}
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    function setPreferredCurrency(currency) {
        currentCurrency = currency;
        localStorage.setItem('preferredCurrency', currency);
        updateUserInfo(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        
        // ‚≠ê [FIXED] ‡πÉ‡∏ä‡πâ Translation Key ‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà [CURRENCY]
        const translatedMsg = translations[currentLang]['notif_currency_change'].replace('[CURRENCY]', currency);

        showNotification(translatedMsg, 'fas fa-money-bill');
    }

     

		async function checkAndRedirectActiveJob(username) {
            try {
                const res = await fetch(`/api/check-active-job?username=${username}`);
                const data = await res.json();
                if (data.hasJob) {
                    location.href = `/post.html?id=${data.postId}`;
                }
            } catch (err) {
                console.error("Error checking active job:", err);
            }
        }

        function logout() {
            localStorage.removeItem('myUsername'); 
            location.reload();
        }
            
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.querySelector('.overlay').classList.toggle('active'); }

        // --- FIXED: updateUserInfo Function ---
        async function updateUserInfo() {
    if (!myUsername) return;

    try {
        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Server ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        const response = await fetch(`/api/user-info?username=${myUsername}&currency=${currentCurrency}`);
        const data = await response.json();

        if (data.error) {
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error ‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô
            if (data.error.includes('‡∏£‡∏∞‡∏á‡∏±‡∏ö')) {
                alert(data.error);
                localStorage.removeItem('myUsername');
                window.location.reload();
            }
            return;
        }
		
				// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
                myAdminLevel = data.adminLevel || 0;
				
				// Logic ‡πÅ‡∏™‡∏î‡∏á‡∏î‡∏≤‡∏ß/‡∏¢‡∏® ‡∏ö‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
        const avatarEl = document.getElementById('user-avatar-display');
        if (avatarEl) {
            let stars = '';
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡∏≤‡∏ß‡∏ï‡∏≤‡∏° Level
            if (myAdminLevel === 1) stars = '<div style="font-size:14px; margin-top:-5px; color:#ffc107; text-shadow: 1px 1px 2px black;">‚≠ê</div>';
            if (myAdminLevel === 2) stars = '<div style="font-size:14px; margin-top:-5px; color:#ffc107; text-shadow: 1px 1px 2px black;">‚≠ê‚≠ê</div>';
            if (myAdminLevel === 3) stars = '<div style="font-size:14px; margin-top:-5px; color:#ffc107; text-shadow: 1px 1px 2px black;">‚≠ê‚≠ê‚≠ê</div>';
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: ‡∏£‡∏π‡∏õ‡∏Ñ‡∏ô + ‡∏î‡∏≤‡∏ß‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á
            avatarEl.innerHTML = `üë§${stars}`;
        }
                
                // ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Admin Panel ‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡πÄ‡∏ß‡∏•
                const adminPanelDiv = document.getElementById('admin-panel');
                if (myAdminLevel >= 1) {
                    adminPanelDiv.classList.remove('hidden');
                } else {
                    adminPanelDiv.classList.add('hidden');
                }
                
                // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° "‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç" ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Level 3)
                const giveCoinBtn = document.querySelector('.give-coin-btn');
                if (giveCoinBtn) {
                     giveCoinBtn.style.display = (myAdminLevel >= 3) ? 'inline-block' : 'none';
                }

        // 2. ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç USD ‡πÅ‡∏•‡∏∞‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß
        const formattedConvertedCoins = parseFloat(data.convertedCoins).toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        const formattedUSD = parseFloat(data.coins).toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        // ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á String ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 2 (‡πÅ‡∏ö‡∏ö‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö)
        const convertedDisplay = `(${formattedConvertedCoins} ${data.currencySymbol})`;


        // --- 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Header (‡πÅ‡∏™‡∏î‡∏á 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î: USD ‡πÅ‡∏•‡∏∞ Converted) ---
        const headerUsd = document.getElementById('header-usd-display');
        const headerConverted = document.getElementById('header-converted-display');

        if (headerUsd) {
            headerUsd.innerText = `${formattedUSD} USD`;
        }
        if (headerConverted) {
            headerConverted.innerText = convertedDisplay;
        }


        // --- 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Sidebar (‡πÅ‡∏™‡∏î‡∏á 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î: USD ‡πÅ‡∏•‡∏∞ Converted) ---
        const sidebarUsd = document.getElementById('sidebar-usd-display');
        const sidebarConverted = document.getElementById('sidebar-converted-display');

        if (sidebarUsd) {
            sidebarUsd.innerText = `${formattedUSD} USD`;
        }
        if (sidebarConverted) {
            sidebarConverted.innerText = convertedDisplay;
        }


        // --- 5. ‚úÖ [FIXED] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå (‡πÉ‡∏ô Modal) ---
        const modalCostDisplay = document.getElementById('modal-cost-display');
		const postCostUSD = data.postCost; // ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (USD)
		currentCost = postCostUSD; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô)
        let formattedConvertedCost = '0.00';
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏®‡∏π‡∏ô‡∏¢‡πå
        if (parseFloat(data.coins) > 0) {
            const conversionRate = parseFloat(data.convertedCoins) / parseFloat(data.coins);
            const convertedCost = postCostUSD * conversionRate;
            formattedConvertedCost = convertedCost.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô Modal
        if (modalCostDisplay) {
            modalCostDisplay.innerHTML = 
                `${postCostUSD.toFixed(2)} USD <span style="font-size:0.8em; color:#6c757d; font-weight:normal;">(${formattedConvertedCost} ${data.currencySymbol})</span>`;
        }
        
        // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 5 ---
        

        // 6. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        const sidebarRating = document.getElementById('sidebar-rating');
        if (sidebarRating) sidebarRating.innerText = data.rating.toFixed(2);
        
        // 7. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠ (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå)
        const userDisplay = document.getElementById('user-display');
        if (userDisplay) userDisplay.innerText = myUsername;


        // 8. ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ
        loadPosts();

    } catch (e) {
        console.error('Error fetching user info:', e);
    }
}
		
        async function toggleBanUser(targetUser, currentStatus) {
        if (myUsername !== 'Admin') return; 
        
        const shouldBan = !currentStatus;
        
        let confirmMsgKey;
        let notifMsgKey;
        let notifIcon;
        
        // 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        if (shouldBan) {
            confirmMsgKey = 'prompt_confirm_ban';
            notifMsgKey = 'notif_user_banned';
            notifIcon = 'fas fa-ban';
        } else {
            confirmMsgKey = 'prompt_confirm_unban';
            notifMsgKey = 'notif_user_unbanned';
            notifIcon = 'fas fa-check-circle';
        }
        
        // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà [USERNAME] ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PROMPT
        const translatedTemplate = translations[currentLang][confirmMsgKey];
        const finalPrompt = translatedTemplate.replace('[USERNAME]', targetUser);
        
        if (!confirm(finalPrompt)) {
            return;
        }

        try {
            const res = await fetch('/api/admin/toggle-ban', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targetUser, shouldBan, requestBy: myUsername })
            });

            const data = await res.json();
            
            // ‚≠ê 3. ‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏õ‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ô IF BLOCK ‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            if (data.success) { 
                const translatedMsg = translations[currentLang][notifMsgKey].replace('[USERNAME]', targetUser);
                showNotification(translatedMsg, notifIcon, 3000); 
                
                // ‚≠ê 4. [SAFE REFRESH] ‡πÉ‡∏ä‡πâ Null Check ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                const searchInput = document.getElementById('user-search-input');
                const currentSearch = searchInput ? searchInput.value : ''; 

                allUsersCache = []; 
                if (!document.getElementById('user-list-modal').classList.contains('hidden')) {
                    openAllUserList(currentSearch);
                }
            } else {
                // 5. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
                showNotification(`‚ùå ${data.error || 'Operation failed'}`, 'fas fa-times-circle', 4000);
            }
        } catch (error) {
            // 6. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
            showNotification('‚ùå An error occurred while connecting to the server.', 'fas fa-times-circle', 4000);
            console.error('Ban toggle error:', error);
        }
    }

        function setMemberRating(targetUser) {
            let newRating = prompt(`‚≠ê Set Rating (1.0 - 5.0) User: ${targetUser}:`);
            if (newRating === null || newRating.trim() === "") return;
            newRating = parseFloat(newRating);

            if (isNaN(newRating) || newRating < 1 || newRating > 5) {
                alert('‚ùå Incorrect rating! Please specify between 1.0 - 5.0');
                return;
            }
            
            fetch('/api/admin/set-rating', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targetUser, rating: newRating, requestBy: myUsername })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert(`‚ùå Failed to set rating: ${data.error}`);
                } else {
                    alert(`‚úÖ SetRating ${targetUser} To ${data.newRating} Success`);
                    openAllUserList(); 
                    updateUserInfo(); 
                }
            })
            .catch(err => alert('‚ùå Error: Unable to connect to server to set score.'));
        }
		
		// setAdminLevel
async function setAdminLevel(targetUser, newLevel) {
    const levelName = newLevel === 0 ? 'User ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' : `Admin Level ${newLevel}`;
    const action = newLevel === 0 ? '‡∏ñ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Demote)' : '‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á (Promote)';
    
    if (!confirm(`Are you sure you want to? ${action} ${targetUser} Let it be ${levelName} Or not?`)) return;

    try {
        const res = await fetch('/api/admin/set-level', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ targetUser, newLevel, requestBy: myUsername })
        });

        const data = await res.json();
        if (data.success) {
            alert(`‚úÖ Successfully completed: ${targetUser} Promote ${levelName} `);
            allUsersCache = []; // ‡∏•‡πâ‡∏≤‡∏á Cache ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
            openAllUserList();  // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
        } else {
            alert(`‚ùå Failed: ${data.error}`);
        }
    } catch (error) {
        console.error(error);
        alert('‚ùå Error connecting to server');
    }
}

        function changeListPage(delta) {
            const listType = document.getElementById('pagination-controls').dataset.type;
            if (listType === 'adminTx') {
                adminTxPage += delta;
                openTransactionModal(adminTxPage);
            } else if (listType === 'memberTx') {
                memberTxPage += delta;
                openMemberLedger(memberTxPage);
            } else if (listType === 'inbox') {
                inboxPage += delta;
                openInbox(inboxPage);
            }
        }
        
        function changePostPage(delta) {
            currentPostPage += delta;
            renderPostList();
            document.querySelector('.content-area').scrollIntoView({ behavior: 'smooth' });
        }

        function updatePaginationUI(data, listType) {
            const controls = document.getElementById('pagination-controls');
            const pageInfo = document.getElementById('page-info');
            const prevBtn = document.getElementById('list-prev-btn');
            const nextBtn = document.getElementById('list-next-btn');

            controls.style.display = 'block'; 
            controls.dataset.type = listType;

            if (data.totalItems === 0) {
                controls.style.display = 'none';
                return;
            }

            pageInfo.innerText = `${data.currentPage} / ${data.totalPages} (${data.totalItems})`;
            
            prevBtn.disabled = data.currentPage === 1;
            nextBtn.disabled = data.currentPage === data.totalPages;
        }
		
		// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤
function getTransactionDetail(t) {
    const lang = currentLang;
    const tr = translations[lang];
    let detail = t.note; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤)

    if (t.type === 'POST_REVENUE' && t.postTitle) {
        detail = tr['tx_detail_create_post'].replace('[TITLE]', t.postTitle);
    } else if (t.type === 'ADMIN_GIVE') {
        detail = tr['tx_detail_admin_give'].replace('[USER]', t.toUser);
    } else if (t.type === 'ADMIN_DEDUCT') {
        detail = tr['tx_detail_admin_deduct'].replace('[USER]', t.fromUser);
    } else if (t.type === 'HANDOVER') {
        // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏à‡∏≤‡∏Å note ‡πÄ‡∏î‡∏¥‡∏° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ postTitle ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
        let title = t.postTitle;
        if (!title && t.note.includes(':')) {
            title = t.note.split(':').pop().trim();
        }
        detail = tr['tx_detail_handover'].replace('[TITLE]', title || '???');
    }
    
    return `(${detail})`;
}

        // --- TRANSACTION LOGIC ---
        
        async function openTransactionModal(page = 1) {
            if (myUsername !== 'Admin') return openPrivateChat('Admin');
            
            document.getElementById('user-list-modal').classList.remove('hidden');
            
            // 1. ‡πÅ‡∏õ‡∏•‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ Modal
            document.getElementById('user-list-title').innerText = translations[currentLang]['admin_tx_title'];
            document.getElementById('user-list-desc').innerText = translations[currentLang]['admin_tx_desc'];
            
            // 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Container ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            const container = document.getElementById('user-list-container');
            container.innerHTML = "Loading...";
            
            document.getElementById('user-search-input').style.display = 'none';
            document.getElementById('pagination-controls').style.display = 'none';

            // ‚≠ê [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ] ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Server
            const res = await fetch(`/api/admin/transactions?requestBy=${myUsername}&page=${page}&limit=${PAGE_LIMIT}`);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
            if (res.status !== 200) {
                 container.innerHTML = "<p style='color:red;'>Error loading transactions</p>";
                 return;
            }

            const data = await res.json();
            const transactions = data.transactions;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏´‡∏°
            if (transactions.length === 0 && data.currentPage > 1) {
                return openTransactionModal(1);
            } else if (transactions.length === 0) {
                container.innerHTML = "<p style='text-align:center;color:gray;margin-top:20px;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</p>";
                updatePaginationUI(data, 'adminTx');
                return;
            }

            // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            container.innerHTML = transactions.map(t => {
                const isRevenue = t.type === 'POST_REVENUE' || t.type === 'ADMIN_DEDUCT'; 
                
                let typeText;
                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
                if (t.type === 'POST_REVENUE') {
                    typeText = translations[currentLang]['admin_tx_revenue']; 
                } else if (t.type === 'ADMIN_DEDUCT') {
                    typeText = translations[currentLang]['admin_tx_deduct']; 
                } else { // ADMIN_GIVE
                    typeText = translations[currentLang]['admin_tx_transfer_out']; 
                }

                const styleClass = isRevenue ? 'tx-plus' : 'tx-minus';
                const amountSign = isRevenue ? '+' : '';
                const relatedUser = isRevenue ? t.fromUser : t.toUser;
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (‡∏à‡∏≤‡∏Å/‡πÉ‡∏´‡πâ)
                const fromToPrefix = isRevenue 
                    ? translations[currentLang]['tx_from'] 
                    : translations[currentLang]['tx_to'];
                
                const detail = getTransactionDetail(t);
                
                return `
                    <div class="transaction-item" style="border-left: 5px solid ${isRevenue ? '#28a745' : '#dc3545'}; margin-bottom:5px;">
                        <div>
                            <strong>${typeText}</strong> (${detail})<br>
                            <small style="color:gray;">${new Date(t.timestamp).toLocaleString()} | ${fromToPrefix}: ${relatedUser}</small>
                        </div>
                        <span class="${styleClass}">${amountSign}${t.amount} USD</span>
                    </div>
                `;
            }).join('');
            
            // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            updatePaginationUI(data, 'adminTx');
            adminTxPage = data.currentPage;
            
            // 5. ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡∏õ‡∏∏‡πà‡∏° Pagination
            document.getElementById('list-prev-btn').innerText = translations[currentLang]['btn_prev'];
            document.getElementById('list-next-btn').innerText = translations[currentLang]['btn_next'];
        }
        
        async function openMemberLedger(page = 1) {
            document.getElementById('user-list-modal').classList.remove('hidden');
            document.getElementById('user-list-title').innerText = translations[currentLang]['member_tx_title'];
            document.getElementById('user-list-desc').innerText = translations[currentLang]['member_tx_desc'];
            
            localStorage.setItem(`hasNewTransaction_${myUsername}`, 'false');
            document.getElementById('coin-notif-dot').classList.add('hidden'); 
            
            const container = document.getElementById('user-list-container');
            container.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
            
            document.getElementById('user-search-input').style.display = 'none';
            document.getElementById('pagination-controls').style.display = 'none';

            const res = await fetch(`/api/member/transactions?username=${myUsername}&page=${page}&limit=${PAGE_LIMIT}`);
            
            if(res.status !== 200) {
                container.innerHTML = "<p style='color:red;'>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ</p>";
                return;
            }
            
            const data = await res.json();
            const transactions = data.transactions;

            if (transactions.length === 0 && data.currentPage > 1) {
                return openMemberLedger(1);
            } else if (transactions.length === 0) {
                container.innerHTML = "<p style='text-align:center;color:gray;margin-top:20px;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</p>";
                updatePaginationUI(data, 'memberTx');
                return;
            }

            container.innerHTML = transactions.map(t => {
                const isIncome = t.toUser === myUsername; 
                const typeText = isIncome 
                    ? `‚úÖ ${translations[currentLang]['tx_received']}`
                    : `‚ùå ${translations[currentLang]['tx_paid']}`;
                const styleClass = isIncome ? 'tx-plus' : 'tx-minus';
                const amountSign = isIncome ? '+' : '-';
                
                const detail = getTransactionDetail(t);

                const relatedUser = isIncome ? t.fromUser : t.toUser;
                const fromToPrefix = isIncome 
                    ? translations[currentLang]['tx_from'] 
                    : translations[currentLang]['tx_to'];

                return `
                    <div class="transaction-item" style="border-left: 5px solid ${isIncome ? '#28a745' : '#dc3545'}; margin-bottom:5px;">
                        <div>
                            <strong>${typeText}</strong> ${detail}<br>
                            <small style="color:gray;">${new Date(t.timestamp).toLocaleString()} | ${fromToPrefix}: ${relatedUser}</small>
                        </div>
                        <span class="${styleClass}">${amountSign}${t.amount} USD</span>
                    </div>
                `;
            }).join('');
            
            updatePaginationUI(data, 'memberTx');
            memberTxPage = data.currentPage;
			document.getElementById('list-prev-btn').innerText = translations[currentLang]['btn_prev'];
            document.getElementById('list-next-btn').innerText = translations[currentLang]['btn_next'];
        }

        function contactAdmin() {
            if (myUsername === 'Admin') openTransactionModal(); 
            else openMemberLedger(); 
        }

        function checkNewTransaction() {
            const status = localStorage.getItem(`hasNewTransaction_${myUsername}`);
            if (status === 'true') {
                document.getElementById('coin-notif-dot').classList.remove('hidden');
                hasNewTransaction = true;
            }
        }
        
        function saveUnreadStatus() {
            localStorage.setItem(`unreadUsers_${myUsername}`, JSON.stringify(Array.from(unreadUsers)));
            if (unreadUsers.size > 0) {
                document.getElementById('notif-badge').innerText = unreadUsers.size;
                document.getElementById('notif-badge').classList.remove('hidden');
            } else {
                document.getElementById('notif-badge').classList.add('hidden');
                document.title = "Webboard";
            }
        }

        function loadUnreadStatus() {
            const savedUnread = localStorage.getItem(`unreadUsers_${myUsername}`);
            if (savedUnread) {
                unreadUsers = new Set(JSON.parse(savedUnread));
                saveUnreadStatus(); 
            }
        }
        
        function switchView(view) {
    currentView = view;
    currentPostPage = 1; 
    
    const title = document.getElementById('page-title');
    if (view === 'home') {
        title.innerText = translations[currentLang]['page_title']; // ‡πÉ‡∏ä‡πâ translation key
        title.style.color = "#333";
        loadPosts(); 
        
        // üí° ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏° Pagination ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å loadPosts
        document.getElementById('post-prev-btn').onclick = () => changePostPage(-1);
        document.getElementById('post-next-btn').onclick = () => changePostPage(1);

    } else if (view === 'closed') {
        // ‚≠ê [FIXED] ‡πÉ‡∏ä‡πâ translation key ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Admin Closed
        title.innerText = translations[currentLang]['admin_closed_posts'];
        title.style.color = "#6c757d";
        loadPosts(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)

    } else if (view === 'my_active') { 
        showMyActivePosts(1); 
        
    } else if (view === 'my_closed') { 
        showMyClosedPosts(1); 
    }
    
    toggleSidebar();
}

        async function loadPosts() {
            try {
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ (Limit 1000 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Admin)
                const res = await fetch('/api/posts?limit=1000');
                const responseData = await res.json();
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö Array ‡πÅ‡∏•‡∏∞ Object)
                let postsArray = [];
                if (Array.isArray(responseData)) {
                    postsArray = responseData;
                } else if (responseData.posts && Array.isArray(responseData.posts)) {
                    postsArray = responseData.posts;
                }

                // ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ postStatusMap ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ renderPostList ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
                postsArray.forEach(p => {
                    if (postStatusMap[p.id]) {
                        postStatusMap[p.id].data = p; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
                    } else {
                        postStatusMap[p.id] = { data: p, isOccupied: false }; // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                    }
                });

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏Å (‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)
                renderPostList(); 
                
            } catch (err) {
                console.error("Error loading posts:", err);
            }
        }
		
		// ‡∏î‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î
	async function showMyActivePosts(page = 1) {
    if (!myUsername) return;
    try {
        currentView = 'my_active'; // üëà [NEW] ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ currentView
        currentPostPage = page;

        const response = await fetch(`/api/my-active-posts?username=${myUsername}&page=${page}&limit=${POST_LIMIT}`);
        const data = await response.json();
        const postListDiv = document.getElementById('post-list');
        const pageTitle = document.getElementById('page-title');
        const paginationDiv = document.getElementById('post-pagination');

        postListDiv.innerHTML = '';
        
        // ‚≠ê [FIXED] ‡πÉ‡∏ä‡πâ translations key ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤
        pageTitle.innerText = `üìù ${translations[currentLang]['my_active_posts']}`;
        
        if (data.totalItems === 0) {
            postListDiv.innerHTML = `<div style="text-align:center; padding: 50px; color:#6c757d; font-size:1.2em;">
                                        ${currentLang === 'th' ? '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà' : 'You currently have no active posts.'}
                                     </div>`;
            paginationDiv.style.display = 'none';
            return;
        }

        data.posts.forEach((post) => {
            const statusInfo = postStatusMap[post.id];
            const isOccupied = statusInfo ? statusInfo.isOccupied : false;
            addPostToDOM(post, isOccupied);
        });

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Pagination UI
        if (data.totalItems > POST_LIMIT) {
            paginationDiv.style.display = 'block';
            document.getElementById('post-page-info').innerText = `${data.currentPage} / ${data.totalPages} (${data.totalItems})`;
            
            document.getElementById('post-prev-btn').onclick = () => showMyActivePosts(data.currentPage - 1);
            document.getElementById('post-next-btn').onclick = () => showMyActivePosts(data.currentPage + 1);
            
            document.getElementById('post-prev-btn').disabled = (data.currentPage === 1);
            document.getElementById('post-next-btn').disabled = (data.currentPage === data.totalPages);
        } else {
            paginationDiv.style.display = 'none';
        }
        
    } catch (e) {
        console.error('Error fetching my active posts:', e);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ', 'fas fa-exclamation-triangle', 3000, '#dc3545');
    }
}

		// [NEW FUNCTION] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°
		async function updateActivePostCount() {
		if (!myUsername || myUsername === 'Admin') return;
    
		try {
        const response = await fetch(`/api/my-active-count?username=${myUsername}`);
        const data = await response.json();
        
        const countSpan = document.getElementById('active-post-count');
        if (countSpan) {
            countSpan.innerText = data.count;
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            countSpan.style.background = data.count > 0 ? '#dc3545' : '#6c757d';
        }
    } catch(e) {
        console.error('Error fetching active post count:', e);
    }
}

		// [NEW FUNCTION] ‡∏î‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß
async function showMyClosedPosts(page = 1) { 
    if (!myUsername) return;
    try {
        currentView = 'my_closed'; // üëà ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ currentView ‡πÉ‡∏´‡∏°‡πà
        currentPostPage = page;
        
        // 1. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á page ‡πÅ‡∏•‡∏∞ limit
        const response = await fetch(`/api/my-closed-posts?username=${myUsername}&page=${page}&limit=${POST_LIMIT}`);
        const data = await response.json();
        const postListDiv = document.getElementById('post-list');
        const pageTitle = document.getElementById('page-title');
        const paginationDiv = document.getElementById('post-pagination');
        
        // 2. ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÄ‡∏î‡∏¥‡∏°
        postListDiv.innerHTML = '';
        
        // ‚≠ê [FIXED] ‡πÉ‡∏ä‡πâ translations key ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' / 'items'
        const itemText = currentLang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'items';
        pageTitle.innerText = `üóÑÔ∏è ${translations[currentLang]['my_closed_posts']} (${data.totalItems} ${itemText})`;
        
        if (data.totalItems === 0) {
            postListDiv.innerHTML = `<div style="text-align:center; padding: 50px; color:#6c757d; font-size:1.2em;">
                                        ${currentLang === 'th' ? '‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î' : 'You have no closed posts yet.'}
                                     </div>`;
            paginationDiv.style.display = 'none';
            return;
        }

        // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ
        data.posts.forEach((post) => {
            const statusInfo = postStatusMap[post.id];
            const isOccupied = statusInfo ? statusInfo.isOccupied : false;
            addPostToDOM(post, isOccupied);
        });

        // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Pagination UI
        if (data.totalItems > POST_LIMIT) {
            paginationDiv.style.display = 'block';
            document.getElementById('post-page-info').innerText = `${data.currentPage} / ${data.totalPages} (${data.totalItems})`;
            
            document.getElementById('post-prev-btn').onclick = () => showMyClosedPosts(data.currentPage - 1);
            document.getElementById('post-next-btn').onclick = () => showMyClosedPosts(data.currentPage + 1);
            
            document.getElementById('post-prev-btn').disabled = (data.currentPage === 1);
            document.getElementById('post-next-btn').disabled = (data.currentPage === data.totalPages);
        } else {
            paginationDiv.style.display = 'none';
        }

    } catch (e) {
        console.error('Error fetching my closed posts:', e);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ', 'fas fa-exclamation-triangle', 3000, '#dc3545');
    }
}

        function renderPostList() {
            const list = document.getElementById('post-list');
            const paginationDiv = document.getElementById('post-pagination');
            list.innerHTML = '';
            
            let postsArray = Object.values(postStatusMap).map(item => item);
            let filteredPosts = postsArray;

            if (currentView === 'home') {
                filteredPosts = postsArray.filter(item => !item.data.isClosed);
            } else if (currentView === 'closed') {
                filteredPosts = postsArray.filter(item => item.data.isClosed);
            }
			
			if (filterLocation && filterMaxDistance) {
    filteredPosts = filteredPosts.filter(item => {
        const post = item.data;
        // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà Logic ‡∏Ñ‡∏∏‡∏ì)
        if (!post.location || !post.location.lat || !post.location.lng) {
            return false; 
        }
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
        const dist = getDistanceFromLatLonInKm(
            filterLocation.lat, filterLocation.lng,
            post.location.lat, post.location.lng
        );
        // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ True ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞
        return dist <= filterMaxDistance;
    });
}
            
            filteredPosts.sort((a, b) => {
                const postA = a.data;
                const postB = b.data;

                // 1. ‡πÄ‡∏ä‡πá‡∏Ñ Pinned Post ‡∏Å‡πà‡∏≠‡∏ô (‡πÉ‡∏´‡πâ Pinned ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠)
                const aIsPinned = postA.isPinned && !postA.isClosed;
				const bIsPinned = postB.isPinned && !postB.isClosed;
                
                if (aIsPinned && !bIsPinned) return -1; // a ‡πÄ‡∏õ‡πá‡∏ô Pinned -> ‡πÄ‡∏≠‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
                if (!aIsPinned && bIsPinned) return 1;  // b ‡πÄ‡∏õ‡πá‡∏ô Pinned -> ‡πÄ‡∏≠‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô

                // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏ö‡∏á‡∏≤‡∏ô/‡∏õ‡∏¥‡∏î (‡πÉ‡∏´‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏á)
                const aDone = postA.status === 'finished' || postA.isClosed;
                const bDone = postB.status === 'finished' || postB.isClosed;
                
                if (aDone && !bDone) return 1; 
                if (!aDone && bDone) return -1; 

                // 3. ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô)
                return postB.id - postA.id; 
            });

            if (filteredPosts.length === 0) {
                 list.innerHTML = `<div style="text-align:center; margin-top:50px; color:gray;"><h3>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ</h3></div>`;
                 paginationDiv.style.display = 'none'; 
                 return;
            }
            
            const totalItems = filteredPosts.length;
            const totalPages = Math.ceil(totalItems / POST_LIMIT);
            
            if (currentPostPage < 1) currentPostPage = 1;
            if (currentPostPage > totalPages) currentPostPage = totalPages;

            const startIndex = (currentPostPage - 1) * POST_LIMIT;
            const endIndex = startIndex + POST_LIMIT;
            const paginatedPosts = filteredPosts.slice(startIndex, endIndex);

            paginatedPosts.forEach(item => {
                addPostToDOM(item.data, item.isOccupied);
            });

            if (totalItems > POST_LIMIT) {
                paginationDiv.style.display = 'block';
                document.getElementById('post-page-info').innerText = `${currentPostPage} / ${totalPages} (${totalItems})`;
                
                document.getElementById('post-prev-btn').disabled = (currentPostPage === 1);
                document.getElementById('post-next-btn').disabled = (currentPostPage === totalPages);
            } else {
                paginationDiv.style.display = 'none'; 
            }
        }

        // ---addPostToDOM (With Winner Display) ---
        function addPostToDOM(post, isOccupied) {
            const list = document.getElementById('post-list');
            
            let deleteBtn = myUsername === 'Admin' 
                ? `<button onclick="deletePost(event,${post.id})" style="border:none;background:none;color:red;font-size:1.2em;cursor:pointer;">üóëÔ∏è</button>` 
                : '';

            let occupiedClass = (isOccupied && !post.isPinned) ? 'occupied' : '';
            let occupiedText = isOccupied 
                ? `<span style="color:#d9534f; font-weight:bold; margin-left:10px;">(‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∏‡∏¢ üí¨)</span>`
                : '';

            let ratingHtml = `<span style="color:black; font-weight:bold; font-size:0.9em; margin-left:5px;">(‚≠ê ${post.authorRating || '0.00'})</span>`;
			
            // ‚úÖ [FIXED] ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞
			let winnerHtml = '';
			if (post.acceptedViewer) {
			    winnerHtml = ` <span style="color:#d9534f; font-weight:bold;">(‚úî ${post.acceptedViewer})</span>`;
			}

            let baseStyle = '';
            let icon = '';
			
			//‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pinned Post
            let pinnedText = '';
            if (post.isPinned) {
                baseStyle = 'background:#f0e2ff; color:#6a1b9a; border-left:5px solid #6a1b9a;'; // ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á
                icon = 'üìå'; 
                pinnedText = ' (‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î)';
            }

            if (post.status === 'finished' || post.status === 'closed_permanently') {
                baseStyle = 'background:#fff3cd; color:#856404; border-left:5px solid #ffc107;';
                icon = 'üîí'; 
            } else if (post.isClosed) {
                baseStyle = 'background:#e2e3e5; color:#6c757d; border-left:5px solid #6c757d;';
                icon = 'üîí';
            } else if (!post.isPinned) {
                baseStyle = 'background:#d1e7dd; color:#0f5132; border-left:5px solid #198754;';
                icon = '‚úÖ'; 
            }

            let action = (post.isClosed && myUsername !== 'Admin') 
                ? "alert('‚õî ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß')" 
                : `location.href='post.html?id=${post.id}'`; 

            let locationHtml = '';
            if (post.location && post.location.lat && post.location.lng) {
                const lat = post.location.lat.toFixed(4);
                const lng = post.location.lng.toFixed(4);
                
                let displayText = post.location.name; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ filterLocation ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞)
                if (typeof filterLocation !== 'undefined' && filterLocation) {
                    const dist = getDistanceFromLatLonInKm(
                        filterLocation.lat, filterLocation.lng,
                        post.location.lat, post.location.lng
                    );
                    displayText = `${dist.toFixed(1)} km`; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 1 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)
                }

                const mapsLink = `https://www.google.com/maps?q=${post.location.lat},${post.location.lng}`;
                
                locationHtml = `
                    <a href="${mapsLink}" target="_blank" onclick="event.stopPropagation()" style="text-decoration:none; color:#007bff; font-size:0.85em; margin-left:10px;" 
                        title="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${post.location.name}">
                        üìç ${displayText} 
                    </a>
                `;
            }

            // ‚úÖ ‡πÅ‡∏ó‡∏£‡∏Å winnerHtml ‡∏•‡∏á‡πÉ‡∏ô title
            list.insertAdjacentHTML('beforeend', `
                <div class="post-card ${occupiedClass}" id="post-${post.id}" onclick="${action}" style="${baseStyle}">
                    <div style="flex-grow: 1;"> <b>${icon} ${post.title}${winnerHtml}</b>
                        <br>
                        <small>
                            ${post.author} ${ratingHtml} ‚Ä¢ ${new Date(post.id).toLocaleTimeString()} 
                        </small>
                        ${locationHtml}
                        ${occupiedText}
                    </div>
                    
                    <div style="display:flex; align-items:center;">
                        ${deleteBtn}
                    </div>
                </div>
            `);
        }
        
        // --- SOCKET LOGIC ---
		socket.on('force-logout', (msg) => {
            alert(msg);
            localStorage.removeItem('myUsername');
            window.location.replace('/');
        });

        socket.on('catch-up-post-status', (occupiedList) => { 
            occupiedList.forEach(item => {
                const postId = item.postId;
                if (postStatusMap[postId]) {
                    postStatusMap[postId].isOccupied = item.isOccupied; 
                }
            });
            renderPostList(); 
        });

        socket.on('post-list-update', (data) => { 
            const postId = data.postId;
            if (postStatusMap[postId]) {
                if (data.status) postStatusMap[postId].data.status = data.status; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï status (finished)
                if (data.isOccupied !== undefined) postStatusMap[postId].isOccupied = data.isOccupied;
                
                // ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö data.post ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏¢ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ acceptedViewer)
                if (data.post) postStatusMap[postId].data = data.post;
                
                // ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
                loadPosts(); 
            } else {
                 loadPosts(); // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÇ‡∏´‡∏•‡∏î
            }
        });
        
        socket.on('admin-new-transaction', () => {
             if (myUsername === 'Admin') {
                notificationSound.play().catch(()=>{});
                localStorage.setItem(`hasNewTransaction_${myUsername}`, 'true');
                hasNewTransaction = true;
                document.getElementById('coin-notif-dot').classList.remove('hidden');
             }
        });
        
        // --- FIXED: Socket Balance Update ---
        socket.on('balance-update', (data) => {
    if (data.user === myUsername) {
        // ‚≠ê [FIXED] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateUserInfo() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏≤‡∏£ fetch ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
        // ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• 2 ‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        updateUserInfo();
        
        // üí° [Note] ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å updateUserInfo ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞ Server ‡∏™‡πà‡∏á‡πÅ‡∏Ñ‡πà USD ‡∏°‡∏≤‡πÉ‡∏ô socket event ‡∏ô‡∏µ‡πâ
        // ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateUserInfo ‡∏à‡∏∂‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏á‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ convertedCoins ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• 2 ‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô

        if (data.coins) {
             const formattedUSD = parseFloat(data.coins).toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
             });
             // ‡πÉ‡∏ä‡πâ formattedUSD ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
             showNotification(`Update Balance: You have a balance. ${formattedUSD} USD`, 'fas fa-coins', 4000);
        }
    }
});
        
        // --- Notification Helper ---
        function showNotification(message, iconClass = 'fas fa-info-circle', duration = 3000) {
             const modal = document.getElementById('comment-notif-modal');
             if(!modal) return;
             document.getElementById('notif-content').innerText = message;
             modal.classList.remove('hidden');
             setTimeout(() => modal.classList.add('hidden'), duration);
        }
		
		// ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Admin
        socket.on('config-update', (newCost) => {
            currentCost = newCost; 
            const costDisplay = document.getElementById('cost-display');
            if (costDisplay) costDisplay.innerText = newCost;
            document.getElementById('modal-cost').innerText = newCost; 
            
            if (myUsername === 'Admin') {
                alert(`üîî ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${newCost} USD`);
            }
        });
		
		socket.on('rating-update', (data) => {
            if (data.user === myUsername) {
                const sidebarRating = document.getElementById('sidebar-rating');
                if(sidebarRating) sidebarRating.innerText = data.rating;
                currentRating = parseFloat(data.rating);
            }
            if (!document.getElementById('user-list-modal').classList.contains('hidden')) {
                const title = document.getElementById('user-list-title').innerText;
                if (title.includes('‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')) {
                    const searchInput = document.getElementById('user-search-input');
                    openAllUserList(searchInput ? searchInput.value : '');
                }
            }
        });

		socket.on('private-message', (data) => {
            if (data.target === myUsername && data.sender === 'System' && data.msg.includes('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏´‡∏°‡πà')) {
                showCommentNotification(data.msg, data.postId);
            }
        });

        function showCommentNotification(message, postId) {
            const modal = document.getElementById('comment-notif-modal');
            const content = document.getElementById('notif-content');
            
            content.innerText = message;
            modal.classList.remove('hidden');
            
            modal.onclick = () => {
                window.location.href = `/post.html?id=${postId}`;
            };
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 5000);
        }

        // --- CRUD and ADMIN FUNCTIONS ---
    function openCreateModal() { 
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°
    document.getElementById('modal-cost-row').classList.remove('hidden');
    
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Title ‡∏Ç‡∏≠‡∏á Modal
    document.getElementById('create-modal-title').innerText = translations[currentLang]['title_create'];
    
    // ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å Title (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏õ‡∏Å‡∏ï‡∏¥)
    const titleInput = document.getElementById('title-input');
    titleInput.classList.add('hidden'); 
    titleInput.value = '';
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å setLanguage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏ó‡∏∏‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÉ‡∏ô modal ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á 
    setLanguage(currentLang); 
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Location ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á setLanguage)
    currentLocationData = null;
    document.getElementById('geo-btn').classList.remove('active');
    document.getElementById('geo-btn').innerHTML = `üìç ${translations[currentLang]['geo_btn'].replace('üìç', '').trim()}`;
    document.getElementById('location-display').innerHTML = '';
    
    // ‡πÅ‡∏™‡∏î‡∏á Modal
    document.getElementById('create-modal').classList.remove('hidden'); 
    toggleSidebar(); 
}

// ----------------------------------------------------

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô openAdminPinnedModal()
function openAdminPinnedModal() {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin
    if (myUsername !== 'Admin') return alert('‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Admin');
    
    // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°
    document.getElementById('modal-cost-row').classList.add('hidden');

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Title ‡∏Ç‡∏≠‡∏á Modal (‡πÉ‡∏ä‡πâ key: 'admin_create_pinned')
    document.getElementById('create-modal-title').innerText = translations[currentLang]['admin_create_pinned'];

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å Title (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin Pinned Post)
    const titleInput = document.getElementById('title-input');
    titleInput.classList.remove('hidden'); 
    titleInput.value = ''; 
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î placeholder ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    titleInput.placeholder = translations[currentLang]['placeholder_title_admin']; 
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å setLanguage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏ó‡∏∏‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÉ‡∏ô modal ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
    setLanguage(currentLang); 
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Location ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
    currentLocationData = null;
    document.getElementById('geo-btn').classList.remove('active');
    document.getElementById('geo-btn').innerHTML = `üìç ${translations[currentLang]['geo_btn'].replace('üìç', '').trim()}`;
    document.getElementById('location-display').innerHTML = '';
    
    // ‡πÅ‡∏™‡∏î‡∏á Modal
    document.getElementById('create-modal').classList.remove('hidden'); 
    toggleSidebar(); 
}

        function closeCreateModal() { document.getElementById('create-modal').classList.add('hidden'); } 
        
        function getLocation() {
    const btn = document.getElementById('geo-btn');
    const display = document.getElementById('location-display');
    const t = translations[currentLang]; // ‡∏ï‡∏±‡∏ß‡∏¢‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏õ‡∏•

    if (!navigator.geolocation) {
        alert(t['geo_not_supported']); // ‚≠ê ‡πÅ‡∏õ‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        return;
    }

    btn.classList.remove('active');
    btn.innerHTML = t['geo_searching']; // ‚≠ê ‡πÅ‡∏õ‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    display.innerHTML = '';
    
    navigator.geolocation.getCurrentPosition(async (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        
        try {
            // ‚≠ê [MODIFIED] ‡πÉ‡∏ä‡πâ currentLang ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Nominatim ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=${currentLang}`); 
            const data = await res.json();
            
            let placeName = data.address.city || data.address.town || data.address.village || data.address.state || (currentLang === 'th' ? '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà' : 'Unknown location name');
            if(data.address.road) placeName = `${data.address.road}, ${placeName}`;

            currentLocationData = { lat, lng, name: placeName };
            
            btn.innerHTML = t['geo_success_name']; // ‚≠ê ‡πÅ‡∏õ‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà)
            btn.classList.add('active');
            display.innerHTML = `${t['geo_display_name']} <b>${placeName}</b>`; // ‚≠ê ‡πÅ‡∏õ‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            
        } catch (e) {
            currentLocationData = { lat, lng, name: `${lat.toFixed(4)}, ${lng.toFixed(4)}` };
            btn.innerHTML = t['geo_success_coord']; // ‚≠ê ‡πÅ‡∏õ‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏ó‡∏ô)
            btn.classList.add('active');
            display.innerHTML = `${t['geo_display_coord']} ${lat.toFixed(4)}, ${lng.toFixed(4)}`; // ‚≠ê ‡πÅ‡∏õ‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        }

    }, (error) => {
        let errorMessage = t['geo_error_general']; 
        if (error.code === 1) {
            errorMessage = t['geo_error_permission']; // ‚≠ê ‡πÅ‡∏õ‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
        }
        
        alert(errorMessage);
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô (‡πÉ‡∏ä‡πâ geo_btn)
        btn.innerHTML = `üìç ${translations[currentLang]['geo_btn'].replace('üìç', '').trim()}`; 
    });
}

		function toggleEmojiPicker(type) {
        const pickerId = type === 'create' ? 'emoji-picker-container-create' : 'emoji-picker-container-chat';
        const container = document.getElementById(pickerId);
        container.style.display = container.style.display === 'none' ? 'block' : 'none';
    }

    // Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Emoji ‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ
    document.querySelector('#picker-create').addEventListener('emoji-click', event => {
        const textarea = document.getElementById('content');
        insertAtCursor(textarea, event.detail.unicode);
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î picker ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏î‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ó‡∏£‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Cursor
    function insertAtCursor(myField, myValue) {
        if (myField.selectionStart || myField.selectionStart == '0') {
            var startPos = myField.selectionStart;
            var endPos = myField.selectionEnd;
            myField.value = myField.value.substring(0, startPos)
                + myValue
                + myField.value.substring(endPos, myField.value.length);
            myField.selectionStart = startPos + myValue.length;
            myField.selectionEnd = startPos + myValue.length;
        } else {
            myField.value += myValue;
        }
        myField.focus();
    }
	

			async function createPost() {
    const titleInput = document.getElementById('title-input');
    const content = document.getElementById('content').value.trim();
    const imageFile = document.getElementById('post-image').files[0];
    const category = document.getElementById('category-select').value;
	
	if (myUsername !== 'Admin' && !currentLocationData) {
            alert("‚õî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î 'üìç ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô' ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ");
            // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏õ‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
            document.getElementById('geo-btn').scrollIntoView({ behavior: 'smooth' });
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Effect ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
            document.getElementById('geo-btn').style.border = "2px solid red";
            setTimeout(() => document.getElementById('geo-btn').style.border = "1px solid #28a745", 2000);
            return;
        }
    
    let titleVal = "";
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ Logic ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Title
    if (myUsername === 'Admin') {
        // Admin ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Input
        titleVal = titleInput.value.trim();
        if (!titleVal) return alert("Admin ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©");
    } else {
        // User ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏õ (Server ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏≠‡∏á)
        titleVal = ""; 
        if (!content) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ");
    }

    const formData = new FormData();
    formData.append('title', titleVal);
    formData.append('category', category);
    formData.append('content', content);
    formData.append('author', myUsername);

    if (imageFile) formData.append('image', imageFile); 
    if (currentLocationData) formData.append('location', JSON.stringify(currentLocationData));

    const res = await fetch('/api/posts', {
        method: 'POST',
        body: formData 
    }); 

    if (res.status !== 200) { 
        const d = await res.json(); 
        alert(d.error); 
    } else { 
        closeCreateModal(); 
        titleInput.value = ''; 
        document.getElementById('content').value = ''; 
        document.getElementById('post-image').value = '';
        
        currentView = 'home';
        loadPosts(); 
        showNotification('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'fas fa-check-circle', 3000);
    } 
}

        socket.on('new-post', loadPosts); 
        socket.on('delete-post', (id)=>{ 
            delete postStatusMap[id];
            renderPostList();
        }); 
        socket.on('update-post-status', (data) => {
    if (currentView === 'my_active') {
        showMyActivePosts(currentPostPage);
    } else if (currentView === 'my_closed') {
        showMyClosedPosts(currentPostPage);
    } else if (currentView === 'closed') {
        // ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏°‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏õ‡∏¥‡∏î (‡∏Ç‡∏≠‡∏á Admin)
        loadPosts(); 
    } else {
        // ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (Home)
        loadPosts();
    }
}); 
        
        async function loadTopics(){ 
            const res = await fetch('/api/topics'); 
            if (res.status !== 200) return;
            const c = await res.json(); 
            document.getElementById('category-select').innerHTML = c.map(x => `<option value="${x.id}">${x.name}</option>`).join(''); 
        }

        async function setPostCost(){ 
    const c=prompt(translations[currentLang]['prompt_fee'],currentCost); 
    if(c) {
        const res = await fetch('/api/admin/set-cost', {
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({cost:c,requestBy:myUsername})
        });
        
        if (res.status === 200) {
            updateUserInfo(); 
            alert("‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        } else {
            alert("‚ùå ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
    }
}
        
        async function openAdminTopicModal() {
            if (myUsername !== ADMIN_USERNAME) {
                alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡πà‡∏ß‡∏ô Admin');
                return;
            }
            document.getElementById('admin-topic-modal').classList.remove('hidden');
            await fetchAndRenderAdminTopics();
        }

        async function fetchAndRenderAdminTopics() {
    const tableBody = document.querySelector('#admin-topic-table tbody');
    tableBody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:gray;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
    try {
        const response = await fetch('/api/admin/topics');
        if (response.status !== 200) {
            tableBody.innerHTML = '<tr><td colspan="2" style="color:red; text-align:center;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÑ‡∏î‡πâ</td></tr>';
            return;
        }
        const topics = await response.json();
        tableBody.innerHTML = '';
        topics.forEach(topic => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td style="padding: 8px; border-bottom: 1px solid #eee;">${topic.name} (ID: ${topic.id})</td>
                <td style="padding: 8px; border-bottom: 1px solid #eee;">
                    <button onclick="deleteTopic('${topic.id}', '${topic.name}')" style="
                        background-color: #f44336; 
                        color: white; 
                        border: none; 
                        padding: 5px 10px; 
                        cursor: pointer; 
                        border-radius: 5px;
                        font-size: 1.1em; 
                        line-height: 1; 
                    ">
                        üóëÔ∏è
                    </button>
                </td>
            `;
        });
    } catch (error) {
        console.error('Error fetching admin topics:', error);
    }
}

        async function addTopic() {
    const nameInput = document.getElementById('new-topic-name');
    const name = nameInput.value.trim();
    
    // 1. ‡∏î‡∏∂‡∏á‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•
    const t = translations[currentLang] || translations['th'];

    // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•)
    if (!name) {
        alert(t['admin_warn_empty_topic']);
        return;
    }

    try {
        const response = await fetch('/api/admin/topics/manage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'add', name: name })
        });

        const result = await response.json();
        
        if (result.success) {
            // 3. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤ ‡πÅ‡∏ó‡∏ô message ‡∏à‡∏≤‡∏Å Server)
            alert(t['admin_success_add_topic']);
            nameInput.value = ''; 
            await fetchAndRenderAdminTopics(); 
            loadTopics(); 
        } else {
            // ‡∏Å‡∏£‡∏ì‡∏µ Error ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å Server (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏ä‡πâ t['admin_error_topic'] ‡∏Å‡πá‡πÑ‡∏î‡πâ)
            alert(`${t['admin_error_topic']} ${result.message}`);
        }
    } catch (error) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
    }
}

        async function deleteTopic(id, name) {
    // 1. ‡∏î‡∏∂‡∏á‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•
    const t = translations[currentLang] || translations['th'];
    
    // 2. ‡πÅ‡∏™‡∏î‡∏á Confirm Box (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏• + ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠)
    const confirmMsg = t['admin_confirm_delete_topic'].replace('[NAME]', name);
    if (!confirm(confirmMsg)) return;

    try {
        const response = await fetch('/api/admin/topics/manage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'delete', id: id })
        });

        const result = await response.json();
        
        if (result.success) {
            // 3. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤)
            alert(t['admin_success_delete_topic']);
            await fetchAndRenderAdminTopics(); 
            loadTopics(); 
        } else {
             alert(`${t['admin_error_topic']} ${result.message}`);
        }
    } catch (error) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
    }
}

        async function deletePost(e, id) {
    e.stopPropagation();
    
    const t = translations[currentLang] || translations['th'];
    
    if (confirm(t['confirm_delete_post'])) { 
        fetch(`/api/posts/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ requestBy: myUsername })
        });
    }
}
    
    // --- PRIVATE CHAT/INBOX FUNCTIONS ---

    function closePrivateChat() {
        document.getElementById('private-chat-modal').classList.add('hidden');
        currentChatPartner = "";
        if (!document.getElementById('user-list-modal').classList.contains('hidden')) {
            openInbox();
        }
    }

    function sendPrivateMessage() {
        const input = document.getElementById('private-chat-input');
        const msg = input.value.trim();
        if(!msg || !currentChatPartner) return; 
        
        socket.emit('private-message', { sender: myUsername, target: currentChatPartner, msg: msg });
        input.value = '';
    }

    async function sendCoinInChat() {
        if (myUsername !== 'Admin') return alert('‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Admin');
        const promptText = translations[currentLang]['prompt_transfer_admin'];
        const amount = prompt(`${promptText} ${currentChatPartner}:`);
        if(!amount || isNaN(amount) || parseInt(amount) <= 0) return;
        const parsedAmount = parseInt(amount);

        const res = await fetch('/api/admin/give-coins', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ targetUser: currentChatPartner, amount: parsedAmount, requestBy: myUsername }) 
        });
        
        if (res.status === 200) {
            alert(`‚úÖ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç ${parsedAmount} ‡πÉ‡∏´‡πâ ${currentChatPartner} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
        } else {
            const d = await res.json();
            alert(`‚ùå ‡πÇ‡∏≠‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${d.error || res.statusText}`);
        }
    }
    
    async function deductCoinInChat() {
        if (myUsername !== 'Admin') return alert('‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Admin');
        const promptText = translations[currentLang]['prompt_deduct_admin'];
        const amount = prompt(`üî¥ ${promptText} ${currentChatPartner}:`);
        if(!amount || isNaN(amount) || parseInt(amount) <= 0) return;
        const parsedAmount = parseInt(amount);

        const res = await fetch('/api/admin/deduct-coins', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ targetUser: currentChatPartner, amount: parsedAmount, requestBy: myUsername }) 
        });
        
        if (res.status === 200) {
            alert(`üß≤ ‡∏î‡∏∂‡∏á‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏Ñ‡∏∑‡∏ô ${parsedAmount} ‡∏à‡∏≤‡∏Å ${currentChatPartner} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
        } else {
            const d = await res.json();
            alert(`‚ùå ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${d.error || res.statusText}`);
        }
    }

    async function checkAndGo(postId) {
        const res = await fetch(`/api/posts/${postId}`);
        if (res.status === 404) { alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ (‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)'); return; }
        const post = await res.json();
        
        if (post.isClosed) {
            if (myUsername === 'Admin') {
                if(confirm('üîí ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô Admin) ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏´‡∏°?')) { location.href = `post.html?id=${post.id}`; }
            } else { alert('‚õî ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß'); }
        } else { location.href = `post.html?id=${post.id}`; }
    }

    socket.on('private-history', (history) => {
        const box = document.getElementById('private-chat-messages');
        box.innerHTML = ''; 
        if (history.length === 0) box.innerHTML = '<div class="system-msg">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà</div>';
        else history.forEach(data => appendMessage(data));
        box.scrollTop = box.scrollHeight;
    });

    socket.on('private-message', (data) => {
        const isChatOpen = !document.getElementById('private-chat-modal').classList.contains('hidden');
        let isRelevant = false;
        if (data.sender === currentChatPartner) isRelevant = true;
        if (data.sender === myUsername && data.target === currentChatPartner) isRelevant = true;
        if (data.sender === 'System' && currentChatPartner === 'Admin') isRelevant = true;
        
        if (isChatOpen && isRelevant) {
            appendMessage(data);
            const box = document.getElementById('private-chat-messages');
            box.scrollTop = box.scrollHeight;
            if (data.sender !== myUsername) notificationSound.play().catch(()=>{});
        } else {
            if (data.target === myUsername) {
                const isFinancialSystemMsg = data.sender === 'System' && (data.msg.startsWith('üí∏') || data.msg.startsWith('USD'));

                if (isFinancialSystemMsg) { 
                    localStorage.setItem(`hasNewTransaction_${myUsername}`, 'true');
                    document.getElementById('coin-notif-dot').classList.remove('hidden');
                    notificationSound.play().catch(()=>{});

                } else {
                    if (data.sender !== 'System') unreadUsers.add(data.sender);
                    else unreadUsers.add('System'); 
                    notify(data);
                    saveUnreadStatus(); 
                }
            }
        }
    });

    function appendMessage(data) {
    const box = document.getElementById('private-chat-messages');
    const div = document.createElement('div');
    
    let translatedMsg = data.msg;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° System Message
    if (data.sender === 'System' && data.msgKey) {
        const lang = currentLang;
        const key = data.msgKey;
        const t = translations[lang] || translations['th']; // Fallback ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢
        const messageTemplateFunc = t[key];

        if (typeof messageTemplateFunc === 'function') {
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏• ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            translatedMsg = messageTemplateFunc(data.msgData);
        } else {
            translatedMsg = data.msg; // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö Key
        }
    } else {
        translatedMsg = data.msg; // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
    }
    // ----------------------------------------------------

    if (data.sender === 'System') {
        div.className = 'system-msg'; 
        if (data.postId) {
            div.innerHTML = `<span class="system-link" onclick="checkAndGo(${data.postId})">${translatedMsg} <br><small>üëâ Go To  Topic</small></span>`;
        } else {
            div.innerHTML = `${translatedMsg}`; 
        }
    } else {
        div.className = 'msg ' + (data.sender === myUsername ? 'my-msg' : 'other-msg');
        div.innerHTML = `<b>${data.sender}:</b> ${translatedMsg}`;
    }
    box.appendChild(div);
}

    function notify(data) {
        notificationSound.play().catch(()=>{});
        document.getElementById('notif-badge').classList.remove('hidden');
        document.title = "üî¥ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà!";
    }
    
    function openPrivateChat(targetUser) {
        currentChatPartner = targetUser;
        document.getElementById('user-list-modal').classList.add('hidden'); 
        document.getElementById('private-chat-modal').classList.remove('hidden'); 
        document.getElementById('chat-partner-name').innerText = targetUser;
        
        unreadUsers.delete(targetUser);
        saveUnreadStatus();

        if (myUsername === 'Admin') {
            document.getElementById('admin-chat-tools').classList.remove('hidden');
        } else {
            document.getElementById('admin-chat-tools').classList.add('hidden');
        }
        
        document.getElementById('private-chat-messages').innerHTML = '<div class="system-msg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</div>';
        socket.emit('get-private-history', { me: myUsername, partner: targetUser });
    }

    async function openInbox(page = 1) {
        if (myUsername !== 'Admin') {
            openPrivateChat('Admin'); 
            return;
        }
        
        document.getElementById('user-list-modal').classList.remove('hidden');
        //document.getElementById('user-list-title').innerText = "üì© ‡πÅ‡∏ä‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î";
        //document.getElementById('user-list-desc').innerText = "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î";
        const container = document.getElementById('user-list-container');
        container.innerHTML = "Loading...";
        
        document.getElementById('user-search-input').style.display = 'none';
        document.getElementById('pagination-controls').style.display = 'none';

        const res = await fetch(`/api/contacts?username=${myUsername}&page=${page}&limit=${PAGE_LIMIT}`);
        const data = await res.json();
        const recentContacts = data.contacts;

        if (recentContacts.length === 0 && data.currentPage > 1) {
             return openInbox(1);
        } else if (recentContacts.length === 0) {
            container.innerHTML = "<div style='text-align:center;color:gray;margin-top:20px;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>";
            updatePaginationUI(data, 'inbox');
            return;
        }

        container.innerHTML = recentContacts.map(u => {
            const isUnread = unreadUsers.has(u);
            const dot = isUnread ? `<span class="unread-indicator" style="animation: none;">${unreadUsers.size}</span>` : '';
            const style = isUnread ? 'font-weight:bold; background:#fff8e1;' : '';
            return `<div class="user-list-item" style="${style}" onclick="openPrivateChat('${u}')"><span>üë§ ${u} ${dot}</span><span style="color:#007bff; font-size:0.8em;">open chat ></span></div>`;
        }).join('');
        
        updatePaginationUI(data, 'inbox');
        inboxPage = data.currentPage;
		document.getElementById('list-prev-btn').innerText = translations[currentLang]['btn_prev'];
        document.getElementById('list-next-btn').innerText = translations[currentLang]['btn_next'];
    }
    
    let allUsersCache = [];
    
	async function openAllUserList(searchTerm = '') {
            
    if (searchTerm === '' && document.getElementById('user-list-modal').classList.contains('hidden')) {
        document.getElementById('user-list-modal').classList.remove('hidden');
        if(document.getElementById('sidebar').classList.contains('active')) toggleSidebar();
    }
    
    document.getElementById('user-list-title').innerText = translations[currentLang]['modal_user_list_title'];
    document.getElementById('user-list-desc').innerText = translations[currentLang]['modal_user_list_desc'];
    
    document.getElementById('pagination-controls').style.display = 'none';
    document.getElementById('user-search-input').style.display = 'block'; 
    
    const container = document.getElementById('user-list-container');
    
    let users = [];
    if (allUsersCache.length === 0) {
        container.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
        const res = await fetch(`/api/users-list?requestBy=${myUsername}`);
        
        if(res.status !== 200) {
            const errorData = await res.json();
            alert(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ: ${errorData.error || res.statusText}`);
            document.getElementById('user-list-modal').classList.add('hidden');
            return;
        }
        users = await res.json();
        allUsersCache = users; 
    } else {
        users = allUsersCache; 
    }
    
    const searchTermLower = searchTerm.trim().toLowerCase();
    let list = users.filter(u => u.name !== 'Admin');
    
    if (searchTermLower) {
        list = list.filter(u => u.name.toLowerCase().includes(searchTermLower));
    }

    if(list.length === 0) { 
        container.innerHTML = searchTermLower 
            ? `<p style='text-align:center; color:red; margin-top:20px;'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ä‡∏∑‡πà‡∏≠ "${searchTerm}"</p>`
            : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å"; 
        return; 
    }
    
    const banText = currentLang === 'th' ? '‡πÅ‡∏ö‡∏ô' : 'Ban';
    const unbanText = currentLang === 'th' ? '‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô' : 'Unban';
    const chatText = currentLang === 'th' ? '‡πÅ‡∏ä‡∏ó/‡πÇ‡∏≠‡∏ô' : 'Chat/Transfer';
    const ratingText = currentLang === 'th' ? '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô' : 'Set Rating';

    container.innerHTML = list.map(u => {
        const isBanned = u.isBanned;
		const targetLevel = u.adminLevel || 0;
        const banBtnText = isBanned ? `‚úÖ ${unbanText}` : `‚ùå ${banText}`; 
        const banBtnColor = isBanned ? '#28a745' : '#dc3545';
        const banStatusText = isBanned ? ' (‚õî ‡πÅ‡∏ö‡∏ô)' : '';
		
		let promoteButtons = '';
		
		// 1. ‡∏ñ‡πâ‡∏≤‡∏â‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô Level 2+ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏¢‡∏®‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 1 -> ‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Admin 1 ‡πÑ‡∏î‡πâ
        if (myAdminLevel >= 2 && targetLevel < 1) {
             promoteButtons += `
                <button class="sidebar-btn" style="width:auto; padding:5px 8px; background:#17a2b8; color:white; font-size:0.8em;" 
                    onclick="setAdminLevel('${u.name}', 1)">
                    üëÆ‚Äç‚ôÇÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Admin 1
                </button>
             `;
        }

        // 2. ‡∏ñ‡πâ‡∏≤‡∏â‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô Level 3+ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏¢‡∏®‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 2 -> ‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Admin 2 ‡πÑ‡∏î‡πâ
        if (myAdminLevel >= 3 && targetLevel < 2) {
             promoteButtons += `
                <button class="sidebar-btn" style="width:auto; padding:5px 8px; background:#6610f2; color:white; font-size:0.8em;" 
                    onclick="setAdminLevel('${u.name}', 2)">
                    üë®‚Äçüíº ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Admin 2
                </button>
             `;
        }
        
        // 3. ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Demote)
        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‡∏â‡∏±‡∏ô‡∏¢‡∏®‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏°‡∏µ‡∏¢‡∏® (Level > 0)
        if (myAdminLevel > targetLevel && targetLevel > 0) {
            promoteButtons += `
                <button class="sidebar-btn" style="width:auto; padding:5px 8px; background:#ffc107; color:black; font-size:0.8em;" 
                    onclick="setAdminLevel('${u.name}', 0)">
                    ‚¨áÔ∏è ‡∏ñ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                </button>
             `;
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á Badge ‡∏ö‡∏≠‡∏Å‡∏¢‡∏®‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        let levelBadge = '';
        if (targetLevel > 0) {
            levelBadge = `<span style="background:#007bff; color:white; padding:2px 6px; border-radius:4px; font-size:0.7em; margin-left:5px;">L${targetLevel}</span>`;
        }

        return `
        <div class="user-list-item" style="display:flex; flex-direction:column; align-items:flex-start; background: ${isBanned ? '#f8d7da' : 'none'}; border-left: 5px solid ${isBanned ? '#dc3545' : 'none'};">
            <span>
                üë§ ${u.name} ${levelBadge} ${banStatusText}
                <span style="color:black; font-size:0.9em; font-weight:bold; margin-left:5px;">
                    (‚≠ê ${u.rating.toFixed(2)} / 5.0)
                </span>
            </span>
            <span style="color:#28a745; font-size:0.9em; font-weight:bold; margin-top:3px;">
                üíµ ${u.coins} USD
            </span>
            <div style="margin-top: 5px; display: flex; flex-wrap: wrap; gap: 10px;">
                <button class="sidebar-btn create-btn" style="width:auto; padding: 5px 10px;" onclick="openPrivateChat('${u.name}')">
                    ${chatText}
                </button>
                <button class="sidebar-btn admin-btn" style="width:auto; padding: 5px 10px; background:#dc3545;" onclick="setMemberRating('${u.name}')">
                    ${ratingText}
                </button>
                
                <button class="sidebar-btn" 
                        style="width:auto; padding: 5px 10px; background:${banBtnColor}; color:white;"
                        onclick="toggleBanUser('${u.name}', ${isBanned})">
                    ${banBtnText}
                </button>
                
                ${promoteButtons}
            </div>
        </div>`;
    }).join('');
	document.getElementById('list-prev-btn').innerText = translations[currentLang]['btn_prev'];
    document.getElementById('list-next-btn').innerText = translations[currentLang]['btn_next'];
}
</script>

<div id="comment-notif-modal" class="hidden" style="
        position: fixed; 
        top: 20px; 
        right: 20px; 
        width: 300px; 
        padding: 15px; 
        background: #007bff; 
        color: white; 
        border-radius: 8px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 3000;
        cursor: pointer;
        font-size: 14px;
        transition: opacity 0.3s ease;
    ">
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="fas fa-bell" style="font-size: 1.5em;"></i>
            <div>
                <div id="notif-content" style="font-weight: 600;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                </div>
        </div>
    </div>
    </div>
	
</body>
</html>