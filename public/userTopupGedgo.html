<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="/socket.io/socket.io.js"></script>
    <title>GedGo! - ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --primary: #11998e; --secondary: #38ef7d; --dark: #2c3e50; --light: #f8fafc; --danger: #e74c3c; }
        body { font-family: 'Kanit', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Admin */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; backdrop-filter: blur(2px); }
        .sidebar { 
            width: 260px; background: var(--dark); color: white; height: 100vh; 
            position: fixed; left: -260px; top: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001; display: flex; flex-direction: column;
        }
        .sidebar.active { left: 0; }
        .sidebar-header { padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .sidebar-menu { flex: 1; padding: 10px 0; }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; gap: 12px; color: rgba(255,255,255,0.7); text-decoration: none; cursor: pointer; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: var(--secondary); border-left: 4px solid var(--secondary); }
        
        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; width: 100%; }
        .top-bar { background: white; padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 999; }
        .content-body { padding: 25px; max-width: 600px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô */
        .topup-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; }
        .amount-input-group { position: relative; margin: 25px 0; }
        .amount-input { width: 100%; padding: 15px; font-size: 2em; text-align: center; border: 2px solid #eee; border-radius: 15px; outline: none; font-weight: bold; color: var(--dark); transition: 0.3s; }
        .amount-input:focus { border-color: var(--secondary); box-shadow: 0 0 10px rgba(56, 239, 125, 0.2); }
        
        .btn-submit-topup { width: 100%; padding: 15px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3); }
        .btn-submit-topup:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4); }

        /* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠ */
        .history-item { background: white; border-radius: 12px; padding: 15px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .status-pending { color: #f1c40f; font-weight: bold; }
        .status-success { color: #2ecc71; font-weight: bold; }
		
		
		
	#section-pending-chat {
    display: none; /* ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
    flex-direction: column;
    height: 100%;
    width: 100%;
}

#realtime-chats {
    flex: 1; /* ‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ä‡∏ó‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà */
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px;
}



    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 style="margin:0; color:var(--secondary);">GedGo! Wallet</h3>
            <small style="opacity:0.6;">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</small>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item active" onclick="switchTab('topup')">
                <i class="fas fa-hand-holding-usd"></i> ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô
            </div>
            <div class="menu-item" onclick="switchTab('history')">
                <i class="fas fa-file-invoice-dollar"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô
            </div>
        </div>
        <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="usergedgo.html" class="menu-item" style="padding:0;"><i class="fas fa-user-circle"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a>
        </div>
    </nav>

    <main class="main-content">
        <header class="top-bar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <i class="fas fa-bars menu-btn" onclick="toggleSidebar()" style="cursor:pointer; font-size: 1.2em;"></i>
                <h2 id="content-title" style="margin:0; font-size: 1.2em;">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h2>
            </div>
            <div>
                ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b id="current-balance">0.00</b> USD
            </div>
        </header>

        <div class="container" style="padding-bottom: 0;">
            <div id="zone-info-display" style="margin-top: 15px; padding: 15px; background: #fff; border: 1px solid #eee; border-radius: 12px; display: flex; align-items: center; gap: 12px; text-align: left;">
                <div style="background: #e8f5e9; color: var(--primary); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div style="flex: 1;">
                    <div id="display-zone-name" style="font-weight: bold; color: var(--dark); font-size: 0.9em;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    <div style="font-size: 0.75em; color: #666; margin-top: 2px;">
                        <i class="fas fa-user-shield" style="color: #f1c40f;"></i> ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•: 
                        <span id="display-zone-admin" style="font-weight: bold; color: var(--primary);">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-body" id="main-display">
            
            <div id="section-topup-form">
                <div class="topup-card">
                    <div style="font-size: 50px; color: var(--primary);"><i class="fas fa-wallet"></i></div>
                    <h3>‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°</h3>
                    <div class="amount-input-group">
                        <input type="number" id="topup-amount" class="amount-input" placeholder="0.00">
                        <div style="margin-top: 10px; font-weight: bold; color: var(--primary);">USD</div>
                    </div>
                    <button class="btn-submit-topup" onclick="submitTopupRequest()">
                        <i class="fas fa-paper-plane"></i> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô
                    </button>
                </div>

                <div style="margin-top: 30px;">
                    <h4><i class="fas fa-info-circle"></i> ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h4>
                    <ul style="color: #666; font-size: 0.85em; line-height: 1.8;">
                        <li>‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô USD ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</li>
                        <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á <b>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô</b> ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</li>
                        <li>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</li>
                        <li>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
                    </ul>
                </div>
            </div>

            <div id="section-pending-chat" style="display: none; height: calc(100vh - 150px); flex-direction: column;">
    <div style="text-align: center; margin-bottom: 10px;">
        <span style="background: #fff9e6; color: #f1c40f; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; font-weight: bold; border: 1px solid #f1c40f;">
            <i class="fas fa-clock"></i> ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
        </span>
    </div>

    <div id="chat-messages-container" style="flex: 1; overflow-y: auto; background: #f8fafc; padding: 15px; border-radius: 15px; border: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
        <div id="admin-auto-reply-wrapper"></div>
        <div id="realtime-chats"></div>
    </div>

    <div style="display: flex; gap: 10px; background: white; padding: 10px; border-radius: 15px; align-items: center; border: 1px solid #eee;">
    <input type="file" id="slip-file-input" hidden accept="image/*" onchange="handleSlipUpload()">
    <button onclick="document.getElementById('slip-file-input').click()" style="background: #f1f5f9; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; color: #64748b;">
        <i class="fas fa-image"></i>
    </button>
    
    <input type="text" id="user-chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." style="flex: 1; border: none; padding: 10px; outline: none;">
    
    <button onclick="sendUserChat()" style="background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 10px; cursor: pointer;">
        <i class="fas fa-paper-plane"></i>
    </button>
</div>

</div>

            <div id="section-history" style="display: none;">
                <h4>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</h4>
                <div id="history-list">
                    <p style="text-align: center; color: #999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</p>
                </div>
            </div>

        </div>
    </main>

    <script>
	const socket = io();
	let currentRequestId = null;
	
	
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
        }

    function switchTab(tab) {
	isHistoryMode = false;
    const title = document.getElementById('content-title');
    const topupSec = document.getElementById('section-topup-form'); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ID ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö HTML
    const historySec = document.getElementById('section-history');
    const chatSec = document.getElementById('section-pending-chat');

    document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
    // ‡πÉ‡∏ä‡πâ event.currentTarget ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ event
    if(event) event.currentTarget.classList.add('active');

    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô/‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ä‡∏ó‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ó‡πá‡∏ö
    const inputArea = chatSec.querySelector('div:last-child');
    if(inputArea) inputArea.style.display = 'flex';

    if (tab === 'topup') {
        title.innerText = '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô';
        historySec.style.display = 'none';
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å checkTopupStatus ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÇ‡∏ä‡∏ß‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏ä‡∏ó‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
        checkTopupStatus(); 
    } else {
        title.innerText = '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô';
        if(topupSec) topupSec.style.display = 'none';
        chatSec.style.display = 'none';
        historySec.style.display = 'block';
        loadHistory();
    }
    if (window.innerWidth <= 768) toggleSidebar();
}

        async function processTopup() {
            const amount = document.getElementById('topup-amount').value;
            if(!amount || amount <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");
            
            // Logic ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            alert(`‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${amount} USD ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`);
        }

        async function loadHistory() {
    const myName = localStorage.getItem('myUsername');
    const list = document.getElementById('history-list');
    list.innerHTML = '<p style="text-align: center; color: #999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</p>';

    try {
        const res = await fetch(`/api/topup/history?username=${myName}`);
        const history = await res.json();

        if (history.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: #999; margin-top:20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</p>';
            return;
        }

        list.innerHTML = history.map(item => `
            <div class="history-item" onclick="viewArchivedChat('${item._id}', ${item.amount}, '${item.status}')" style="cursor:pointer; transition: 0.2s; border-left: 5px solid ${item.status === 'approved' ? '#2ecc71' : '#e74c3c'};">
                <div>
                    <b style="font-size: 1.1em;">${item.amount.toFixed(2)} USD</b><br>
                    <small style="color:#999;">${new Date(item.createdAt).toLocaleString('th-TH')}</small>
                </div>
                <div style="text-align:right;">
                    <span class="status-${item.status === 'approved' ? 'success' : 'danger'}" style="font-size: 0.9em;">
                        ${item.status === 'approved' ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò'}
                    </span><br>
                    <i class="fas fa-chevron-right" style="color:#eee; font-size: 0.8em;"></i>
                </div>
            </div>
        `).join('');
    } catch (err) {
        list.innerHTML = '<p style="text-align: center; color: red;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>';
    }
}

    window.onload = async () => {
    const myName = localStorage.getItem('myUsername');
	await checkTopupStatus();
    if (!myName) {
        window.location.href = 'index.html';
        return;
    }

    try {
        const savedLoc = localStorage.getItem('userPrimaryLocation');
        let locationParam = savedLoc ? `&location=${encodeURIComponent(savedLoc)}` : '';

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≤‡∏ô API ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
        const res = await fetch(`/api/profile-details?username=${myName}${locationParam}`);
        const data = await res.json();

        if (data.error) throw new Error(data.error);

        // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
        document.getElementById('current-balance').innerText = (data.coins || 0).toFixed(2);
        
        // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ã‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô (‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!)
        document.getElementById('display-zone-name').innerText = data.zoneName || "‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£";
        document.getElementById('display-zone-admin').innerText = data.zoneOwner || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•";

    } catch (err) {
        console.error("Load Topup Info Error:", err);
        document.getElementById('display-zone-name').innerText = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß";
    }
};




socket.on('receiveMessage', (msg) => {
    // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏´‡∏°
    // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤ (msg.requestId) ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà User ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (currentRequestId)
    // 3. (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°) ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏á (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏™‡∏±‡πà‡∏á appendMessage ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏™‡πà‡∏á)
    if (typeof appendMessage === "function" && 
        msg.requestId === currentRequestId && 
        msg.sender !== localStorage.getItem('myUsername')) {
        
        appendMessage(msg); 
    }
});

socket.on('updateStatus', (data) => {
    if(data.status === 'approved') {
        alert("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß");
        checkTopupStatus(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
    } else if(data.status === 'rejected') {
        alert("‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà");
        checkTopupStatus();
    }
});

async function loadChatHistory(requestId) {
    try {
        const res = await fetch(`/api/topup/chat-history?requestId=${requestId}`);
        const history = await res.json();
        
        const chatContainer = document.getElementById('realtime-chats');
        chatContainer.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ä‡∏ó‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)

        history.forEach(msg => {
            appendMessage(msg); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        });
    } catch (err) {
        console.error("Load chat history error:", err);
    }
}

async function checkTopupStatus() {
    const myName = localStorage.getItem('myUsername');
    const savedLoc = localStorage.getItem('userPrimaryLocation');
    const locParam = savedLoc ? `&location=${encodeURIComponent(savedLoc)}` : '';

    try {
        const res = await fetch(`/api/topup/status?username=${myName}${locParam}`);
        const data = await res.json();

        const formSec = document.getElementById('section-topup-form');
        const chatSec = document.getElementById('section-pending-chat');

        if (data.hasPending) {
    currentRequestId = data.requestId;
    formSec.style.display = 'none';
    chatSec.style.display = 'flex';
    
    // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á HTML ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏ö‡πÑ‡∏î‡πâ
    document.getElementById('admin-auto-reply-wrapper').innerHTML = `
        <div style="margin-bottom: 15px; width: 100%;">
            <details open style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <summary style="padding: 10px 15px; background: #f8fafc; cursor: pointer; font-weight: bold; color: var(--primary); display: flex; justify-content: space-between; align-items: center; list-style: none;">
                    <span><i class="fas fa-university"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î)</span>
                    <i class="fas fa-chevron-down" style="font-size: 0.8em;"></i>
                </summary>
                <div style="padding: 15px; font-size: 0.9em; border-top: 1px solid #eee;">
                    <b style="color: var(--primary);">üè¶ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</b><br>
                    ${data.adminMessage.bankInfo.replace(/\n/g, '<br>')}<br><br>
                    <b style="color: var(--dark);">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</b><br>
                    ${data.adminMessage.desc.replace(/\n/g, '<br>')}
                </div>
            </details>
        </div>
    `;

    await loadChatHistory(data.requestId);
    socket.emit('joinRequest', data.requestId);

        } else {
            formSec.style.display = 'block';
            chatSec.style.display = 'none';
        }
    } catch (err) {
        console.error("üö® Check status error:", err.message);
    }
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á User
function sendUserChat() {
    if (isHistoryMode) return; // ‡∏ñ‡πâ‡∏≤‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏¢‡∏π‡πà ‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á!
    
    const input = document.getElementById('user-chat-input');
    const message = input.value.trim();
    if (!message || !currentRequestId) return;

    const chatData = {
        requestId: currentRequestId,
        sender: localStorage.getItem('myUsername'),
        message: message,
        type: 'text'
    };

    socket.emit('sendMessage', chatData);
    appendMessage(chatData);
    input.value = '';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó
function appendMessage(msg) { // ‡∏´‡∏£‡∏∑‡∏≠ appendAdminChatMessage(msg)
    const chatContainer = document.getElementById('realtime-chats'); // ‡∏´‡∏£‡∏∑‡∏≠ chat-box ‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
    if (!chatContainer) return;

    const isMe = msg.sender === localStorage.getItem('myUsername');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    let contentHTML = "";
    if (msg.type === 'image') {
        contentHTML = `<img src="${msg.message}" style="max-width: 100%; border-radius: 10px; cursor: pointer; display: block;" onclick="window.open(this.src)">`;
    } else {
        contentHTML = `<p style="margin: 0; line-height: 1.5;">${msg.message}</p>`;
    }
	
	if (msg.type === 'system') {
    const sysHTML = `
        <div style="align-self: center; margin: 15px 0; background: #fff4e5; color: #663c00; padding: 8px 20px; border-radius: 20px; font-size: 0.85em; font-weight: bold; border: 1px solid #ffe7cc;">
            ${msg.message}
        </div>
    `;
    chatContainer.innerHTML += sysHTML; // chatContainer ‡∏Ñ‡∏∑‡∏≠‡πÑ‡∏≠‡∏î‡∏µ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤
    chatContainer.scrollTop = chatContainer.scrollHeight;
    return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ
}

    const msgHTML = `
        <div style="display: flex; flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
            <div style="background: ${isMe ? 'var(--primary)' : 'white'}; 
                        color: ${isMe ? 'white' : 'var(--dark)'}; 
                        padding: ${msg.type === 'image' ? '5px' : '10px 15px'}; 
                        border-radius: ${isMe ? '15px 15px 0 15px' : '0 15px 15px 15px'}; 
                        max-width: 75%; 
                        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                        border: ${isMe ? 'none' : '1px solid #eee'};">
                ${contentHTML}
            </div>
            <small style="font-size: 0.7em; color: #999; margin-top: 4px;">
                ${isMe ? '‡∏Ñ‡∏∏‡∏ì' : msg.sender}
            </small>
        </div>
    `;
    
    chatContainer.innerHTML += msgHTML;
    chatContainer.scrollTop = chatContainer.scrollHeight;
}





function sendChat(content, type = 'text') {
    const requestId = "..."; // ‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤
    socket.emit('sendMessage', {
        requestId,
        sender: localStorage.getItem('myUsername'),
        message: content,
        type: type
    });
}

async function submitTopupRequest() {
    const amount = document.getElementById('topup-amount').value;
    const username = localStorage.getItem('myUsername');
    
    if (!amount || amount <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");

    try {
        const res = await fetch('/api/topup/request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: username,
                amount: amount,
                // ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏≤ adminId ‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏ù‡∏±‡πà‡∏á Backend ‡πÄ‡∏≠‡∏á
                location: localStorage.getItem('userPrimaryLocation') 
            })
        });

        if (res.ok) {
            const result = await res.json();
			socket.emit('newTopupRequest', {
                adminId: result.adminId,
                username: username,
                amount: amount
				});
            await checkTopupStatus();
        }
    } catch (err) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠");
    }
}

	
	async function handleSlipUpload() {
    const fileInput = document.getElementById('slip-file-input');
    const file = fileInput.files[0];
    if (!file || !currentRequestId) return;

    const originalBtn = document.querySelector('button[onclick*="slip-file-input"]');
    originalBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
        // ‚úÖ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô (Max width 1024px, Quality 70%)
        const compressedBlob = await compressImage(file, { maxWidth: 1024, quality: 0.7 });

        const formData = new FormData();
        // ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á (‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô .jpg)
        formData.append('slip', compressedBlob, 'slip_optimized.jpg');

        const res = await fetch('/api/upload-slip', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();

        if (data.url) {
            const chatData = {
                requestId: currentRequestId,
                sender: localStorage.getItem('myUsername'),
                message: data.url,
                type: 'image'
            };
            socket.emit('sendMessage', chatData);
            appendMessage(chatData);
        }
    } catch (err) {
        console.error("Upload error:", err);
        alert("‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
    } finally {
        fileInput.value = '';
        originalBtn.innerHTML = '<i class="fas fa-image"></i>';
    }
}

	// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
async function compressImage(file, { maxWidth = 1024, quality = 0.7 }) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏° (Aspect Ratio)
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Blob (‡πÑ‡∏ü‡∏•‡πå) ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 0.7 (70%)
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/jpeg', quality);
            };
        };
        reader.onerror = (error) => reject(error);
    });
}

let isHistoryMode = false; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞

async function viewArchivedChat(requestId, amount, status, createdAt, processedAt) {
    currentRequestId = requestId;
    isHistoryMode = true; 
    
    const titleElem = document.getElementById('content-title');
    const historySec = document.getElementById('section-history');
    const chatSec = document.getElementById('section-pending-chat');
    
    titleElem.innerText = "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°";
    historySec.style.display = 'none';
    chatSec.style.display = 'flex';
    chatSec.style.flexDirection = 'column';
    chatSec.style.width = '100%';
    chatSec.style.height = '100%';

    const inputArea = document.getElementById('chat-input-area');
    if(inputArea) inputArea.style.display = 'none';

    const headerWrapper = document.getElementById('admin-auto-reply-wrapper');
    headerWrapper.innerHTML = `
        <div style="background: ${status === 'approved' ? '#e8f5e9' : '#ffebee'}; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid ${status === 'approved' ? '#c8e6c9' : '#ffcdd2'}; width: 100%; box-sizing: border-box;">
            <div style="text-align: center;">
                <i class="fas ${status === 'approved' ? 'fa-check-circle' : 'fa-times-circle'}" style="font-size: 2em; color: ${status === 'approved' ? '#2e7d32' : '#c62828'};"></i>
                <div style="font-weight: bold; margin-top: 5px; color: ${status === 'approved' ? '#2e7d32' : '#c62828'};">
                    ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ${status === 'approved' ? '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò'}‡πÅ‡∏•‡πâ‡∏ß
                </div>
                <div style="font-size: 1.1em; font-weight: bold; margin: 5px 0;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: ${amount.toFixed(2)} USD</div>
            </div>
            
            <div style="border-top: 1px solid rgba(0,0,0,0.05); margin-top: 10px; padding-top: 10px; font-size: 0.85em; color: #666;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                    <span>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠:</span>
                    <span>${new Date(createdAt).toLocaleString('th-TH')}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>‚úÖ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠:</span>
                    <span>${new Date(processedAt).toLocaleString('th-TH')}</span>
                </div>
            </div>

            <button onclick="location.reload()" style="width:100%; margin-top:12px; border:none; background:rgba(0,0,0,0.08); padding: 10px; border-radius: 8px; cursor:pointer; font-weight:bold; color:#555;">
                <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            </button>
        </div>
    `;

    const chatDisplay = document.getElementById('realtime-chats');
    chatDisplay.style.flex = '1';
    chatDisplay.style.overflowY = 'auto';
    chatDisplay.innerHTML = '<p style="text-align:center; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó...</p>';
    
    await loadChatHistory(requestId);
}



    </script>
</body>
</html>