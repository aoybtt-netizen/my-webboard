<!DOCTYPE html>
<html lang="th">
<head>

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="GedGo">
	<meta name="mobile-web-app-capable" content="yes">
	
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="/socket.io/socket.io.js"></script>
    <title>GedGo! - ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --primary: #11998e; --secondary: #38ef7d; --dark: #2c3e50; --light: #f8fafc; --danger: #e74c3c; }
        body { font-family: 'Kanit', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Admin */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; backdrop-filter: blur(2px); }
        .sidebar { 
            width: 260px; background: var(--dark); color: white; height: 100vh; 
            position: fixed; left: -260px; top: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001; display: flex; flex-direction: column;
        }
        .sidebar.active { left: 0; }
        .sidebar-header { padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .sidebar-menu { flex: 1; padding: 10px 0; }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; gap: 12px; color: rgba(255,255,255,0.7); text-decoration: none; cursor: pointer; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: var(--secondary); border-left: 4px solid var(--secondary); }
        
        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; width: 100%; }
        .top-bar { background: white; padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 999; }
        .content-body { padding: 25px; max-width: 600px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô */
        .topup-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; }
        .amount-input-group { position: relative; margin: 25px 0; }
        .amount-input { width: 100%; padding: 15px; font-size: 2em; text-align: center; border: 2px solid #eee; border-radius: 15px; outline: none; font-weight: bold; color: var(--dark); transition: 0.3s; }
        .amount-input:focus { border-color: var(--secondary); box-shadow: 0 0 10px rgba(56, 239, 125, 0.2); }
        
        .btn-submit-topup { width: 100%; padding: 15px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3); }
        .btn-submit-topup:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4); }

        /* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠ */
        .history-item { background: white; border-radius: 12px; padding: 15px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .status-pending { color: #f1c40f; font-weight: bold; }
        .status-success { color: #2ecc71; font-weight: bold; }
		
		
		
	#section-pending-chat {
    display: none; /* ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
    flex-direction: column;
    height: 100%;
    width: 100%;
}

#realtime-chats {
    flex: 1; /* ‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ä‡∏ó‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà */
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px;
}




body {
    padding-bottom: env(safe-area-inset-bottom);
    min-height: -webkit-fill-available;
}

.modal-content, .sidebar {
    padding-bottom: calc(20px + env(safe-area-inset-bottom)) !important;
}

html {
    height: -webkit-fill-available;
}

    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h3 style="margin:0; color:var(--secondary);">GedGo! Wallet</h3>
        <small style="opacity:0.6;" data-i18n-key="lbl_wallet_system">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</small>
    </div>
    
    <div class="sidebar-menu">
        <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="index.html" class="menu-item" style="padding:0;">
                <i class="fas fa-user-circle"></i> 
                <span data-i18n-key="menu_back_home">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
            </a>
        </div>

        <div class="menu-item" id="menu-topup" onclick="switchTab('topup', 'TOPUP')">
            <i class="fas fa-hand-holding-usd"></i> 
            <span data-i18n-key="menu_topup">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</span>
        </div>

        <div class="menu-item" id="menu-withdraw" onclick="switchTab('topup', 'WITHDRAW')">
            <i class="fas fa-money-bill-transfer"></i> 
            <span data-i18n-key="menu_withdraw">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
        </div>

        <div class="menu-item" onclick="switchTab('history')">
            <i class="fas fa-file-invoice-dollar"></i> 
            <span data-i18n-key="menu_topup_history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</span>
        </div>
    </div>

    <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
        <a href="index.html" class="menu-item" style="padding:0;">
            <i class="fas fa-user-circle"></i> 
            <span data-i18n-key="menu_back_home">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
        </a>
    </div>
</nav>

    <main class="main-content">
        <header class="top-bar">
            <div style="display: flex; align-items: center; gap: 15px;">
			<i class="fas fa-bars menu-btn" onclick="toggleSidebar()" style="cursor:pointer; font-size: 1.2em;"></i>
    
			<h2 id="content-title" style="margin:0; font-size: 1.2em;" data-i18n-key="title_topup">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h2>
		</div>
            <div>
			Balance: <b id="current-balance">0.00</b> <span id="currency-label">USD</span>
			</div>
        </header>

        <div class="container" style="padding-bottom: 0;">
            <div id="zone-info-display" style="margin-top: 15px; padding: 15px; background: #fff; border: 1px solid #eee; border-radius: 12px; display: flex; align-items: center; gap: 12px; text-align: left;">
                <div style="background: #e8f5e9; color: var(--primary); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div style="flex: 1;">
    <div id="display-zone-name" style="font-weight: bold; color: var(--dark); font-size: 0.9em;" data-i18n-key="lbl_loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    <div style="font-size: 0.75em; color: #666; margin-top: 2px;">
        <i class="fas fa-user-shield" style="color: #f1c40f;"></i> 
        <span data-i18n-key="lbl_zone_admin_title">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•:</span> 
        <span id="display-zone-admin" style="font-weight: bold; color: var(--primary);" data-i18n-key="lbl_wait_connect">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
    </div>
</div>
            </div>
        </div>

        <div class="content-body" id="main-display">
            
            <div id="section-topup-form">
                <div class="topup-card">
    <div id="form-icon" style="font-size: 50px; color: var(--primary);">
        <i class="fas fa-wallet"></i>
    </div>
    <h3 id="amount-label" data-i18n-key="lbl_specify_amount">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h3>
    <div id="min-amount-notice" style="font-size: 0.9em; color: #666; margin-top: -5px; margin-bottom: 10px; display: none;">
    <i class="fas fa-info-circle"></i> 
    <span data-i18n-key="lbl_min_amount">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥:</span> 
    <b id="min-val-display">0</b> 
    <span id="min-currency-display">USD</span>
	</div>
    <div class="amount-input-group">
    <input type="number" id="topup-amount" class="amount-input" placeholder="0.00">
    <div id="input-currency-label" style="margin-top: 10px; font-weight: bold; color: var(--primary);">Loading...</div>
	</div>

    <div id="withdraw-bank-info" style="display: none; margin-bottom: 20px; text-align: left;">
    <label style="font-size: 0.85em; color: #666; font-weight: bold;" data-i18n-key="lbl_withdraw_bank_title">‡∏£‡∏∞‡∏ö‡∏∏‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏ä‡∏∑‡πà‡∏≠-‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ-‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£):</label>
    <textarea id="withdraw-bank-details" rows="3" data-i18n-key="plh_withdraw_bank_details" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ 123-4-567-890 ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #eee; font-family: inherit; margin-top: 5px;"></textarea>
</div>

    <button class="btn-submit-topup" onclick="submitTransactionRequest()">
    <i class="fas fa-paper-plane"></i> 
    <span data-i18n-key="btn_send_request">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</span>
</button>
</div>

                <div style="margin-top: 30px;">
    <h4 data-i18n-key="title_topup_steps"><i class="fas fa-info-circle"></i> ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h4>
    <ul style="color: #666; font-size: 0.85em; line-height: 1.8;">
        <li id="step-1-desc">
    <span data-i18n-key="step_1_prefix">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span> 
    <b id="step-currency-label" style="color: var(--primary);">---</b> 
    <span data-i18n-key="step_1_suffix">‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</span>
</li>
        <li data-i18n-key="step_2_text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á <b>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô</b> ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</li>
    </ul>
</div>
            </div>

            <div id="section-pending-chat" style="display: none; height: calc(100vh - 150px); flex-direction: column;">
    <div style="text-align: center; margin-bottom: 10px;">
        <span style="background: #fff9e6; color: #f1c40f; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; font-weight: bold; border: 1px solid #f1c40f;">
    <i class="fas fa-clock"></i> 
    <span data-i18n-key="status_pending_review">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>
</span>
    </div>

    <div id="chat-messages-container" style="flex: 1; overflow-y: auto; background: #f8fafc; padding: 15px; border-radius: 15px; border: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
        <div id="admin-auto-reply-wrapper"></div>
        <div id="realtime-chats"></div>
    </div>

    <div style="display: flex; gap: 10px; background: white; padding: 10px; border-radius: 15px; align-items: center; border: 1px solid #eee;">
    <input type="file" id="slip-file-input" hidden accept="image/*" onchange="handleSlipUpload()">
    <button onclick="document.getElementById('slip-file-input').click()" style="background: #f1f5f9; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; color: #64748b;">
        <i class="fas fa-image"></i>
    </button>
    
    <input type="text" id="user-chat-input" data-i18n-key="plh_chat_message" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." style="flex: 1; border: none; padding: 10px; outline: none;">
    
    <button onclick="sendUserChat()" style="background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 10px; cursor: pointer;">
        <i class="fas fa-paper-plane"></i>
    </button>
</div>

</div>

            <div id="section-history" style="display: none;">
    <h4 data-i18n-key="title_request_history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</h4>
    <div id="history-list">
        <p style="text-align: center; color: #999;" data-i18n-key="lbl_loading_history">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</p>
    </div>
</div>

        </div>
    </main>

    <script>
	const socket = io();
	let currentRequestId = null;
	let transactionType = 'TOPUP';
	let zoneCurrency = 'USD';
	


const currentLang = localStorage.getItem('preferredLanguage') || 'th';
				
const translations = {
    'th': {
        'lbl_wallet_system': '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å',
        'menu_back_home': '‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å',
        'menu_topup': '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô',
        'menu_withdraw': '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
        'menu_topup_history': '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô',
		'title_topup': '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô',
		'lbl_loading': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
        'lbl_zone_admin_title': '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•:',
        'lbl_wait_connect': '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠',
        'lbl_specify_amount': '‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
        'lbl_withdraw_bank_title': '‡∏£‡∏∞‡∏ö‡∏∏‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏ä‡∏∑‡πà‡∏≠-‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ-‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£):',
        'plh_withdraw_bank_details': '‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ 123-4-567-890 ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢',
        'btn_send_request': '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠',
        'title_topup_steps': '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô',
        'step_1_text': '‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô {currency} ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£',
        'step_2_text': '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á <b>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô</b> ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î',
        'status_pending_review': '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
		'step_1_prefix': '‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
        'step_1_suffix': '‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£',
		'plh_chat_message': '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...',
        'title_request_history': '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠',
        'lbl_loading_history': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...',
		'title_topup': '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô',
        'title_withdraw': '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î',
        'title_history': '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°',
        'btn_confirm_withdraw': '<i class="fas fa-money-bill-transfer"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
        'btn_confirm_topup': '<i class="fas fa-paper-plane"></i> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô',
        'lbl_amount_withdraw': '‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô',
        'lbl_amount_topup': '‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°',
        'err_invalid_amount': '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
        'msg_topup_success': (amt) => `‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${amt} USD ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`,
        'msg_withdraw_success': (amt) => `‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${amt} USD ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`,
        'log_withdraw': '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
        'log_topup': '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô',
		'status_waiting': '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
        'err_load_failed': '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
        'lbl_outside_service': '‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
        'lbl_no_admin': '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•',
        'alert_topup_approved': '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß',
        'alert_request_rejected': '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò',
		'title_bank_info_collapsible': '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î)',
        'lbl_bank_account': 'üè¶ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:',
        'lbl_more_details': 'üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:',
		'err_invalid_amount': '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
        'title_transaction_detail': '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°',
        'status_approved_msg': '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß',
        'status_rejected_msg': '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß',
        'lbl_amount_total': '‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô:',
        'lbl_request_date': 'üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠:',
        'lbl_processed_date': '‚úÖ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠:',
        'btn_back_history': '‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥',
        'date_locale': 'th-TH',
		'err_no_bank_details': '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£',
        'err_insufficient_balance': '‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô',
		'status_waiting_withdraw': '<i class="fas fa-university"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
        'status_pending_review': '<i class="fas fa-clock"></i> ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
        'lbl_your_withdraw_info': 'üìå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:',
        'lbl_amount': '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:',
        'lbl_transfer_to': '‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤:',
        'title_admin_bank_info': 'üè¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô)',
        'lbl_admin_bank_acc': '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô:',
		'lbl_min_amount': '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥:',
    },
    'en': {
        'lbl_wallet_system': 'Member Wallet System',
        'menu_back_home': 'Back to Home',
        'menu_topup': 'Top-up',
        'menu_withdraw': 'Withdraw',
        'menu_topup_history': 'Top-up History',
		'title_topup': 'Top-up',
		'lbl_loading': 'Loading...',
        'lbl_zone_admin_title': 'Admin:',
        'lbl_wait_connect': 'Waiting...',
        'lbl_specify_amount': 'Specify Amount',
        'lbl_withdraw_bank_title': 'Specify receiving bank account (Name-Number-Bank):',
        'plh_withdraw_bank_details': 'e.g. Kasikorn Bank 123-4-567-890 John Doe',
        'btn_send_request': 'Submit Request',
        'title_topup_steps': 'Top-up Steps',
        'step_1_text': 'Specify the amount of {currency} needed',
        'step_2_text': 'The request will be sent to the <b>Zone Owner</b>',
        'status_pending_review': 'Pending Review',
		'step_1_prefix': 'Specify the amount of',
        'step_1_suffix': 'needed',
		'plh_chat_message': 'Type a message...',
        'title_request_history': 'Request History',
        'lbl_loading_history': 'Loading history...',
		'title_topup': 'Top-up',
        'title_withdraw': 'Withdraw Cash',
        'title_history': 'Transaction History',
        'btn_confirm_withdraw': '<i class="fas fa-money-bill-transfer"></i> Confirm Withdrawal',
        'btn_confirm_topup': '<i class="fas fa-paper-plane"></i> Submit Top-up Request',
        'lbl_amount_withdraw': 'Enter amount to withdraw',
        'lbl_amount_topup': 'Enter amount to top-up',
        'err_invalid_amount': 'Please enter a valid amount',
        'msg_topup_success': (amt) => `Top-up request for ${amt} USD submitted successfully!`,
        'msg_withdraw_success': (amt) => `Withdrawal request for ${amt} USD submitted successfully!`,
        'log_withdraw': 'Withdraw',
        'log_topup': 'Top-up',
		'status_waiting': 'Pending Approval',
        'err_load_failed': 'Failed to load data',
        'lbl_outside_service': 'Outside service area',
        'lbl_no_admin': 'No administrator',
        'alert_topup_approved': 'Congratulations! Your top-up has been approved.',
        'alert_request_rejected': 'Your request has been rejected.',
		'title_bank_info_collapsible': 'Transfer Information (Click to toggle)',
        'lbl_bank_account': 'üè¶ Bank Account:',
        'lbl_more_details': 'üìù Additional Details:',
		'err_invalid_amount': 'Please enter a valid amount',
        'title_transaction_detail': 'Transaction Details',
        'status_approved_msg': 'This transaction has been approved',
        'status_rejected_msg': 'This transaction has been rejected',
        'lbl_amount_total': 'Amount:',
        'lbl_request_date': 'üìÖ Request Date:',
        'lbl_processed_date': '‚úÖ Processed on:',
        'btn_back_history': 'Back to History',
        'date_locale': 'en-US',
		'err_no_bank_details': 'Please provide bank account details',
        'err_insufficient_balance': 'Your balance is insufficient for withdrawal',
		'status_waiting_withdraw': '<i class="fas fa-university"></i> Waiting for withdrawal',
        'status_pending_review': '<i class="fas fa-clock"></i> Pending review',
        'lbl_your_withdraw_info': 'üìå Your Withdrawal Info:',
        'lbl_amount': 'Amount:',
        'lbl_transfer_to': 'Transfer to:',
        'title_admin_bank_info': 'üè¶ Transfer Information (Top-up)',
        'lbl_admin_bank_acc': 'Admin Bank Account:',
		'lbl_min_amount': 'Minimum:',
    },
    'pt': {
        'lbl_wallet_system': 'Sistema de Carteira',
        'menu_back_home': 'Voltar ao In√≠cio',
        'menu_topup': 'Recarregar',
        'menu_withdraw': 'Sacar',
        'menu_topup_history': 'Hist√≥rico de Recargas',
		'title_topup': 'Recarregar',
		'lbl_loading': 'Carregando...',
        'lbl_zone_admin_title': 'Admin:',
        'lbl_wait_connect': 'Aguardando...',
        'lbl_specify_amount': 'Especificar Valor',
        'lbl_withdraw_bank_title': 'Dados banc√°rios para recebimento (Nome-N√∫mero-Banco):',
        'plh_withdraw_bank_details': 'ex: Banco Ita√∫ 123-4-567-890 Jo√£o Silva',
        'btn_send_request': 'Enviar Pedido',
        'title_topup_steps': 'Passos para Recarga',
        'step_1_text': 'Especifique o valor de {currency} desejado',
        'step_2_text': 'O pedido ser√° enviado ao <b>Dono da Zona</b>',
        'status_pending_review': 'Pendente',
		'step_1_prefix': 'Especifique o valor de',
        'step_1_suffix': 'desejado',
		'plh_chat_message': 'Digite uma mensagem...',
        'title_request_history': 'Hist√≥rico de Pedidos',
        'lbl_loading_history': 'Carregando hist√≥rico...',
		'title_topup': 'Recarregar',
        'title_withdraw': 'Sacar Dinheiro',
        'title_history': 'Hist√≥rico de Transa√ß√µes',
        'btn_confirm_withdraw': '<i class="fas fa-money-bill-transfer"></i> Confirmar Saque',
        'btn_confirm_topup': '<i class="fas fa-paper-plane"></i> Enviar Pedido de Recarga',
        'lbl_amount_withdraw': 'Insira o valor para sacar',
        'lbl_amount_topup': 'Insira o valor para recarregar',
        'err_invalid_amount': 'Por favor, insira um valor v√°lido',
        'msg_topup_success': (amt) => `Pedido de recarga de ${amt} USD enviado com sucesso!`,
        'msg_withdraw_success': (amt) => `Pedido de saque de ${amt} USD enviado com sucesso!`,
        'log_withdraw': 'Saque',
        'log_topup': 'Recarga',
		'status_waiting': 'Aguardando Aprova√ß√£o',
        'err_load_failed': 'Falha ao carregar dados',
        'lbl_outside_service': 'Fora da √°rea de servi√ßo',
        'lbl_no_admin': 'Sem administrador',
        'alert_topup_approved': 'Parab√©ns! Sua recarga foi aprovada.',
        'alert_request_rejected': 'Seu pedido foi rejeitado.',
		'title_bank_info_collapsible': 'Informa√ß√µes de Transfer√™ncia (Clique para abrir/fechar)',
        'lbl_bank_account': 'üè¶ Conta Banc√°ria:',
        'lbl_more_details': 'üìù Detalhes Adicionais:',
		'err_invalid_amount': 'Por favor, insira um valor v√°lido',
        'title_transaction_detail': 'Detalhes da Transa√ß√£o',
        'status_approved_msg': 'Esta transa√ß√£o foi aprovada',
        'status_rejected_msg': 'Esta transa√ß√£o foi rejeitada',
        'lbl_amount_total': 'Valor:',
        'lbl_request_date': 'üìÖ Data do Pedido:',
        'lbl_processed_date': '‚úÖ Processado em:',
        'btn_back_history': 'Voltar ao Hist√≥rico',
        'date_locale': 'pt-BR',
		'err_no_bank_details': 'Por favor, forne√ßa os detalhes da conta banc√°ria',
        'err_insufficient_balance': 'Seu saldo √© insuficiente para o saque',
		'status_waiting_withdraw': '<i class="fas fa-university"></i> Aguardando saque',
        'status_pending_review': '<i class="fas fa-clock"></i> Em an√°lise',
        'lbl_your_withdraw_info': 'üìå Suas informa√ß√µes de saque:',
        'lbl_amount': 'Valor:',
        'lbl_transfer_to': 'Transferir para:',
        'title_admin_bank_info': 'üè¶ Informa√ß√µes de Transfer√™ncia (Recarga)',
        'lbl_admin_bank_acc': 'Conta Banc√°ria do Admin:',
		'lbl_min_amount': 'M√≠nimo:',
    }
};

function applyMerchantTranslations() {
    const lang = localStorage.getItem('preferredLanguage') || 'th';
    console.log(`[i18n] Applying translations for: ${lang}`);

    document.querySelectorAll('[data-i18n-key]').forEach(el => {
        const key = el.getAttribute('data-i18n-key');
        const translatedText = translations[lang]?.[key];

        if (translatedText) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = translatedText;
            } 
            else {
                const icon = el.querySelector('i');
                if (icon) {
                    el.innerHTML = '';
                    el.appendChild(icon);
                    el.insertAdjacentHTML('beforeend', ' ' + translatedText);
                } else {
                    el.innerHTML = translatedText;
                }
            }
        }
    });
}

// ‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
window.addEventListener('DOMContentLoaded', () => {
    applyMerchantTranslations();
});



	
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
        }

    function switchTab(tab, type = 'TOPUP') {
    console.log("--- üïµÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö switchTab ---");
    console.log("Mode:", tab, "| TransactionType:", type);

    isHistoryMode = false;
    transactionType = type; 
    
    const title = document.getElementById('content-title');
    const topupSec = document.getElementById('section-topup-form');
    const historySec = document.getElementById('section-history');
    const chatSec = document.getElementById('section-pending-chat');

    document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
    
    if (tab === 'topup') {
        if(type === 'TOPUP') document.getElementById('menu-topup').classList.add('active');
        if(type === 'WITHDRAW') document.getElementById('menu-withdraw').classList.add('active');

        title.innerText = (transactionType === 'TOPUP') 
                ? translations[currentLang].title_topup 
                : translations[currentLang].title_withdraw;
        
        document.getElementById('withdraw-bank-info').style.display = (transactionType === 'WITHDRAW') ? 'block' : 'none';
        document.getElementById('form-icon').style.color = (transactionType === 'WITHDRAW') ? 'var(--danger)' : 'var(--primary)';

        // üö© ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥
        const minNotice = document.getElementById('min-amount-notice');
        const minValDisplay = document.getElementById('min-val-display');
        const minCurrDisplay = document.getElementById('min-currency-display');
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ã‡∏ô
        const zoneInfo = window.currentZoneData || (typeof currentZoneData !== 'undefined' ? currentZoneData : null);
        console.log("üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Zone ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö:", zoneInfo);

        if (minNotice) {
            if (zoneInfo) {
                // ‚ö†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏ô JSON ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏ß‡πà‡∏≤ 'currency' ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 'zoneCurrency'
                const minVal = (transactionType === 'TOPUP') 
                               ? (zoneInfo.minTopup || 0) 
                               : (zoneInfo.minWithdraw || 0);
                const currency = zoneInfo.currency || zoneInfo.zoneCurrency || 'USD'; 

                console.log(`üí∞ ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÇ‡∏ä‡∏ß‡πå: ${minVal} ${currency}`);

                if (minValDisplay) minValDisplay.innerText = minVal.toLocaleString();
                if (minCurrDisplay) minCurrDisplay.innerText = currency;
                
                minNotice.style.display = 'block';
                console.log("‚úÖ ‡∏™‡∏±‡πà‡∏á‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏ñ‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÅ‡∏•‡πâ‡∏ß");
            } else {
                console.warn("‚ùå ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ñ‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÄ‡∏û‡∏£‡∏≤‡∏∞: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô zoneInfo (‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô null ‡∏´‡∏£‡∏∑‡∏≠ undefined)");
            }
        } else {
            console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Element ‡∏ó‡∏µ‡πà‡∏°‡∏µ ID: min-amount-notice ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ HTML");
        }

        // ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏° (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà)
        const submitBtn = document.querySelector('.btn-submit-topup');
        if(transactionType === 'WITHDRAW') {
            submitBtn.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            submitBtn.innerHTML = translations[currentLang].btn_confirm_withdraw;
            document.getElementById('amount-label').innerText = translations[currentLang].lbl_amount_withdraw;
        } else {
            submitBtn.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
            submitBtn.innerHTML = translations[currentLang].btn_confirm_topup;
            document.getElementById('amount-label').innerText = translations[currentLang].lbl_amount_topup;
        }
        
        if(historySec) historySec.style.display = 'none';
        checkTransactionStatus(); 
    } else {
        // ... ‡πÇ‡∏´‡∏°‡∏î history ‡πÄ‡∏î‡∏¥‡∏° ...
        title.innerText = translations[currentLang].title_history;
        if(topupSec) topupSec.style.display = 'none';
        if(chatSec) chatSec.style.display = 'none';
        if(historySec) historySec.style.display = 'block';
        loadHistory();
    }
    
    if (window.innerWidth <= 768) toggleSidebar();
}

        async function processTopup() {
            const amount = document.getElementById('topup-amount').value;
           if(!amount || amount <= 0) return alert(translations[currentLang].err_invalid_amount);
            
            // Logic ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            alert(translations[currentLang].msg_withdraw_success(amount));
        }
		

    async function loadHistory() {
    const myName = localStorage.getItem('myUsername');
    const list = document.getElementById('history-list');
    if (!list) return;

    list.innerHTML = '<p style="text-align: center; color: #999;">Loading...</p>';

    try {
        const res = await fetch(`/api/topup/history?username=${myName}`);
        const history = await res.json();

        if (history.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: #999; margin-top:20px;">No transaction history found.</p>';
            return;
        }

        list.innerHTML = history.map(item => {
            const isWithdraw = item.type === 'WITHDRAW';
            const typeLabel = isWithdraw ? translations[currentLang].log_withdraw : translations[currentLang].log_topup;
            const typeIcon = isWithdraw ? 'fa-money-bill-transfer' : 'fa-hand-holding-usd';
            const typeColor = isWithdraw ? '#e74c3c' : '#3498db'; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ñ‡∏≠‡∏ô ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏¥‡∏°
            
            // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å Database (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ USD ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
            const currency = item.currency || 'USD';

            // üö© ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏£‡∏¥‡∏á
            let statusColor = '#f39c12'; // ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pending
            let statusText = translations[currentLang].status_waiting;

            if (item.status === 'approved') {
                statusColor = '#2ecc71'; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                statusText = 'success!';
            } else if (item.status === 'rejected') {
                statusColor = '#e74c3c'; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                statusText = 'reject';
            }

            return `
                <div class="history-item" 
                     onclick="viewArchivedChat('${item._id}', ${item.amount}, '${item.status}', '${item.createdAt}', '${item.processedAt}', '${item.type || 'TOPUP'}', '${currency}')" 
                     style="cursor:pointer; transition: 0.2s; border-left: 5px solid ${statusColor}; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                    
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="background: ${typeColor}15; color: ${typeColor}; width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2em;">
                            <i class="fas ${typeIcon}"></i>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-size: 0.75em; color: ${typeColor}; font-weight: bold; text-transform: uppercase;">${typeLabel}</div>
                            <b style="font-size: 1.1em; color: #2c3e50;">${item.amount.toFixed(2)} ${currency}</b><br>
                            <small style="color:#999; font-size: 0.8em;">${new Date(item.createdAt).toLocaleString('th-TH')}</small>
                        </div>
                    </div>

                    <div style="text-align:right;">
                        <span style="color: ${statusColor}; font-weight: bold; font-size: 0.9em;">
                            ${statusText}
                        </span><br>
                        <i class="fas fa-chevron-right" style="color:#eee; font-size: 0.8em; margin-top: 5px;"></i>
                    </div>
                </div>
            `;
        }).join('');
    } catch (err) {
        console.error("Load History UI Error:", err);
        list.innerHTML = `<p style="text-align: center; color: red;">${translations[currentLang].err_load_failed}</p>`;
    }
}

    window.onload = async () => {
    const myName = localStorage.getItem('myUsername');
    if (typeof checkTransactionStatus === 'function') {
        await checkTransactionStatus();
    } else if (typeof checkTopupStatus === 'function') {
        await checkTopupStatus();
    }

    if (!myName) {
        window.location.href = 'index.html';
        return;
    }

    try {
        const savedLoc = localStorage.getItem('userPrimaryLocation');
        let locationParam = savedLoc ? `&location=${encodeURIComponent(savedLoc)}` : '';

        const res = await fetch(`/api/profile-details?username=${myName}${locationParam}`);
        const data = await res.json();

        if (data.error) throw new Error(data.error);
        if (typeof zoneCurrency !== 'undefined') {
            zoneCurrency = data.currency || 'USD';
        }

        // ‚úÖ 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)
        document.getElementById('current-balance').innerText = (data.coins || 0).toFixed(2);
		const inputLabel = document.getElementById('input-currency-label');
		if(inputLabel) inputLabel.innerText = zoneCurrency;
		const stepLabel = document.getElementById('step-currency-label');
		if(stepLabel) stepLabel.innerText = zoneCurrency;
        
        // ‚úÖ 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á id ‡πÑ‡∏ß‡πâ)
        // ‡∏ñ‡πâ‡∏≤ API ‡∏™‡πà‡∏á‡∏°‡∏≤‡∏ß‡πà‡∏≤ 'THB' ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡πá‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å USD ‡πÄ‡∏õ‡πá‡∏ô THB ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const currencyLabel = document.getElementById('currency-label');
        if (currencyLabel) {
            currencyLabel.innerText = data.currency || 'USD';
        }

        // ‚úÖ 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ã‡∏ô
        document.getElementById('display-zone-name').innerText = data.zoneName || translations[currentLang].lbl_outside_service;
		document.getElementById('display-zone-admin').innerText = data.zoneOwner || translations[currentLang].lbl_no_admin;

    } catch (err) {
        console.error("Load Topup Info Error:", err);
        const zoneDisplay = document.getElementById('display-zone-name');
        if(zoneDisplay) zoneDisplay.innerText = translations[currentLang].err_load_failed;
    }
};




socket.on('receiveMessage', (msg) => {
    if (typeof appendMessage === "function" && 
        msg.requestId === currentRequestId && 
        msg.sender !== localStorage.getItem('myUsername')) {
        
        appendMessage(msg); 
    }
});

socket.on('updateStatus', (data) => {
    if(data.status === 'approved') {
        alert(translations[currentLang].alert_topup_approved);
        checkTopupStatus(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
    } else if(data.status === 'rejected') {
        alert(translations[currentLang].alert_request_rejected);
        checkTopupStatus();
    }
});

async function loadChatHistory(requestId) {
    try {
        const res = await fetch(`/api/topup/chat-history?requestId=${requestId}`);
        const history = await res.json();
        
        const chatContainer = document.getElementById('realtime-chats');
        chatContainer.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ä‡∏ó‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)

        history.forEach(msg => {
            appendMessage(msg); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        });
    } catch (err) {
        console.error("Load chat history error:", err);
    }
}

async function checkTopupStatus() {
    const myName = localStorage.getItem('myUsername');
    const savedLoc = localStorage.getItem('userPrimaryLocation');
    const locParam = savedLoc ? `&location=${encodeURIComponent(savedLoc)}` : '';

    try {
        const res = await fetch(`/api/topup/status?username=${myName}${locParam}`);
        const data = await res.json();

        const formSec = document.getElementById('section-topup-form');
        const chatSec = document.getElementById('section-pending-chat');

        if (data.hasPending) {
    currentRequestId = data.requestId;
    formSec.style.display = 'none';
    chatSec.style.display = 'flex';
    
    document.getElementById('admin-auto-reply-wrapper').innerHTML = `
    <div style="margin-bottom: 15px; width: 100%;">
        <details open style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <summary style="padding: 10px 15px; background: #f8fafc; cursor: pointer; font-weight: bold; color: var(--primary); display: flex; justify-content: space-between; align-items: center; list-style: none;">
                <span><i class="fas fa-university"></i> ${translations[currentLang].title_bank_info_collapsible}</span>
                <i class="fas fa-chevron-down" style="font-size: 0.8em;"></i>
            </summary>
            <div style="padding: 15px; font-size: 0.9em; border-top: 1px solid #eee;">
                <b style="color: var(--primary);">${translations[currentLang].lbl_bank_account}</b><br>
                ${data.adminMessage.bankInfo.replace(/\n/g, '<br>')}<br><br>
                <b style="color: var(--dark);">${translations[currentLang].lbl_more_details}</b><br>
                ${data.adminMessage.desc.replace(/\n/g, '<br>')}
            </div>
        </details>
    </div>
	`;

    await loadChatHistory(data.requestId);
    socket.emit('joinRequest', data.requestId);

        } else {
            formSec.style.display = 'block';
            chatSec.style.display = 'none';
        }
    } catch (err) {
        console.error("üö® Check status error:", err.message);
    }
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á User
function sendUserChat() {
    if (isHistoryMode) return; // ‡∏ñ‡πâ‡∏≤‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏¢‡∏π‡πà ‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á!
    
    const input = document.getElementById('user-chat-input');
    const message = input.value.trim();
    if (!message || !currentRequestId) return;

    const chatData = {
        requestId: currentRequestId,
        sender: localStorage.getItem('myUsername'),
        message: message,
        type: 'text'
    };

    socket.emit('sendMessage', chatData);
    appendMessage(chatData);
    input.value = '';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó
function appendMessage(msg) { // ‡∏´‡∏£‡∏∑‡∏≠ appendAdminChatMessage(msg)
    const chatContainer = document.getElementById('realtime-chats'); // ‡∏´‡∏£‡∏∑‡∏≠ chat-box ‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
    if (!chatContainer) return;

    const isMe = msg.sender === localStorage.getItem('myUsername');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    let contentHTML = "";
    if (msg.type === 'image') {
        contentHTML = `<img src="${msg.message}" style="max-width: 100%; border-radius: 10px; cursor: pointer; display: block;" onclick="window.open(this.src)">`;
    } else {
        contentHTML = `<p style="margin: 0; line-height: 1.5;">${msg.message}</p>`;
    }
	
	if (msg.type === 'system') {
    const sysHTML = `
        <div style="align-self: center; margin: 15px 0; background: #fff4e5; color: #663c00; padding: 8px 20px; border-radius: 20px; font-size: 0.85em; font-weight: bold; border: 1px solid #ffe7cc;">
            ${msg.message}
        </div>
    `;
    chatContainer.innerHTML += sysHTML; // chatContainer ‡∏Ñ‡∏∑‡∏≠‡πÑ‡∏≠‡∏î‡∏µ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤
    chatContainer.scrollTop = chatContainer.scrollHeight;
    return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ
}

    const msgHTML = `
        <div style="display: flex; flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
            <div style="background: ${isMe ? 'var(--primary)' : 'white'}; 
                        color: ${isMe ? 'white' : 'var(--dark)'}; 
                        padding: ${msg.type === 'image' ? '5px' : '10px 15px'}; 
                        border-radius: ${isMe ? '15px 15px 0 15px' : '0 15px 15px 15px'}; 
                        max-width: 75%; 
                        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                        border: ${isMe ? 'none' : '1px solid #eee'};">
                ${contentHTML}
            </div>
            <small style="font-size: 0.7em; color: #999; margin-top: 4px;">
                ${isMe ? 'You' : msg.sender}
            </small>
        </div>
    `;
    
    chatContainer.innerHTML += msgHTML;
    chatContainer.scrollTop = chatContainer.scrollHeight;
}





function sendChat(content, type = 'text') {
    const requestId = "..."; // ‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤
    socket.emit('sendMessage', {
        requestId,
        sender: localStorage.getItem('myUsername'),
        message: content,
        type: type
    });
}

async function submitTopupRequest() {
    const amount = document.getElementById('topup-amount').value;
    const username = localStorage.getItem('myUsername');
    
    if (!amount || amount <= 0) return alert(i18n.err_invalid_amount);

    try {
        const res = await fetch('/api/topup/request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: username,
                amount: amount,
                location: localStorage.getItem('userPrimaryLocation') 
            })
        });

        if (res.ok) {
            const result = await res.json();
			socket.emit('newTopupRequest', {
                adminId: result.adminId,
                username: username,
                amount: amount
				});
            await checkTopupStatus();
        }
    } catch (err) {
        alert("An error occurred while submitting the request.");
    }
}

	
	async function handleSlipUpload() {
    const fileInput = document.getElementById('slip-file-input');
    const file = fileInput.files[0];
    if (!file || !currentRequestId) return;

    const originalBtn = document.querySelector('button[onclick*="slip-file-input"]');
    originalBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
        // ‚úÖ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô (Max width 1024px, Quality 70%)
        const compressedBlob = await compressImage(file, { maxWidth: 1024, quality: 0.7 });

        const formData = new FormData();
        // ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á (‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô .jpg)
        formData.append('slip', compressedBlob, 'slip_optimized.jpg');

        const res = await fetch('/api/upload-slip', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();

        if (data.url) {
            const chatData = {
                requestId: currentRequestId,
                sender: localStorage.getItem('myUsername'),
                message: data.url,
                type: 'image'
            };
            socket.emit('sendMessage', chatData);
            appendMessage(chatData);
        }
    } catch (err) {
        console.error("Upload error:", err);
        alert("Image upload or resizing error.");
    } finally {
        fileInput.value = '';
        originalBtn.innerHTML = '<i class="fas fa-image"></i>';
    }
}

	// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
async function compressImage(file, { maxWidth = 1024, quality = 0.7 }) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏° (Aspect Ratio)
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Blob (‡πÑ‡∏ü‡∏•‡πå) ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 0.7 (70%)
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/jpeg', quality);
            };
        };
        reader.onerror = (error) => reject(error);
    });
}

let isHistoryMode = false; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞

async function viewArchivedChat(requestId, amount, status, createdAt, processedAt) {
	const currentLang = localStorage.getItem('preferredLanguage') || 'th';
	const i18n = translations[currentLang];
    currentRequestId = requestId;
    isHistoryMode = true; 
    
    const titleElem = document.getElementById('content-title');
    const historySec = document.getElementById('section-history');
    const chatSec = document.getElementById('section-pending-chat');
    
    titleElem.innerText = i18n.title_transaction_detail;
    historySec.style.display = 'none';
    chatSec.style.display = 'flex';
    chatSec.style.flexDirection = 'column';
    chatSec.style.width = '100%';
    chatSec.style.height = '100%';

    const inputArea = document.getElementById('chat-input-area');
    if(inputArea) inputArea.style.display = 'none';

    const headerWrapper = document.getElementById('admin-auto-reply-wrapper');
    headerWrapper.innerHTML = `
    <div style="background: ${status === 'approved' ? '#e8f5e9' : '#ffebee'}; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid ${status === 'approved' ? '#c8e6c9' : '#ffcdd2'}; width: 100%; box-sizing: border-box;">
        <div style="text-align: center;">
            <i class="fas ${status === 'approved' ? 'fa-check-circle' : 'fa-times-circle'}" style="font-size: 2em; color: ${status === 'approved' ? '#2e7d32' : '#c62828'};"></i>
            <div style="font-weight: bold; margin-top: 5px; color: ${status === 'approved' ? '#2e7d32' : '#c62828'};">
                ${status === 'approved' ? i18n.status_approved_msg : i18n.status_rejected_msg}
            </div>
            <div style="font-size: 1.1em; font-weight: bold; margin: 5px 0;">${i18n.lbl_amount_total} ${amount.toFixed(2)}</div>
        </div>
        
        <div style="border-top: 1px solid rgba(0,0,0,0.05); margin-top: 10px; padding-top: 10px; font-size: 0.85em; color: #666;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                <span>${i18n.lbl_request_date}</span>
                <span>${new Date(createdAt).toLocaleString(i18n.date_locale)}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>${i18n.lbl_processed_date}</span>
                <span>${new Date(processedAt).toLocaleString(i18n.date_locale)}</span>
            </div>
        </div>

        <button onclick="switchTab('history')" style="width:100%; margin-top:12px; border:none; background:rgba(0,0,0,0.08); padding: 10px; border-radius: 8px; cursor:pointer; font-weight:bold; color:#555;">
            <i class="fas fa-arrow-left"></i> ${i18n.btn_back_history}
        </button>
    </div>
`;

    const chatDisplay = document.getElementById('realtime-chats');
    chatDisplay.style.flex = '1';
    chatDisplay.style.overflowY = 'auto';
    chatDisplay.innerHTML = '<p style="text-align:center; color:#999;">Loading chat history...</p>';
    
    await loadChatHistory(requestId);
}


async function submitTransactionRequest() {
	const currentLang = localStorage.getItem('preferredLanguage') || 'th';
	const i18n = translations[currentLang];
    const amount = document.getElementById('topup-amount').value;
    const bankDetails = document.getElementById('withdraw-bank-details').value;
    const username = localStorage.getItem('myUsername');
    
    if (!amount || amount <= 0) return alert(i18n.err_invalid_amount);
    if (transactionType === 'WITHDRAW' && !bankDetails) {
				return alert(i18n.err_no_bank_details);
		}

    const currentBalance = parseFloat(document.getElementById('current-balance').innerText);
    if (transactionType === 'WITHDRAW' && amount > currentBalance) {
        return alert(i18n.err_insufficient_balance);
    }

    try {
        const res = await fetch('/api/topup/request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: username,
                amount: amount,
                type: transactionType,
                bankInfo: bankDetails,
                location: localStorage.getItem('userPrimaryLocation') 
            })
        });

        if (res.ok) {
            const result = await res.json();
            socket.emit('newTransactionRequest', {
                adminId: result.adminId,
                username: username,
                amount: amount,
                type: transactionType,
                currency: zoneCurrency
            });
            await checkTransactionStatus();
        } else {
            const error = await res.json();
            alert(error.error || "An error occurred.");
        }
    } catch (err) {
        alert("An error occurred while submitting the request.");
    }
}


async function checkTransactionStatus() {
    const myName = localStorage.getItem('myUsername');
    try {
        const res = await fetch(`/api/topup/status?username=${myName}`);
        const data = await res.json();

        const formSec = document.getElementById('section-topup-form');
        const chatSec = document.getElementById('section-pending-chat');

        if (data.hasPending) {
            currentRequestId = data.requestId;
            const isWithdraw = data.type === 'WITHDRAW';
            
            formSec.style.display = 'none';
            chatSec.style.display = 'flex';
            
            const statusLabel = chatSec.querySelector('span');
            statusLabel.style.background = isWithdraw ? '#fff5f5' : '#fff9e6';
            statusLabel.style.color = isWithdraw ? '#e74c3c' : '#f1c40f';
            statusLabel.style.borderColor = isWithdraw ? '#e74c3c' : '#f1c40f';
            statusLabel.innerHTML = isWithdraw 
				? translations[currentLang].status_waiting_withdraw 
				: translations[currentLang].status_pending_review;

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô ‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô | ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            const headerHTML = isWithdraw ? `
    <div style="background: white; border-radius: 12px; border: 1px solid #ffcdd2; padding: 15px; font-size: 0.9em;">
        <b style="color: #e74c3c;">${translations[currentLang].lbl_your_withdraw_info}</b><br>
        ${translations[currentLang].lbl_amount} <b>${data.amount.toFixed(2)} USD</b><br>
        ${translations[currentLang].lbl_transfer_to} ${data.bankInfo.replace(/\n/g, '<br>')}
    </div>
` : `
    <details open style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden;">
        <summary style="padding: 10px 15px; background: #f8fafc; font-weight: bold; color: var(--primary);">
            ${translations[currentLang].title_admin_bank_info}
        </summary>
        <div style="padding: 15px; font-size: 0.9em; border-top: 1px solid #eee;">
            <b>${translations[currentLang].lbl_admin_bank_acc}</b><br>
            ${data.adminMessage.bankInfo.replace(/\n/g, '<br>')}
        </div>
    </details>
`;

            document.getElementById('admin-auto-reply-wrapper').innerHTML = headerHTML;

            await loadChatHistory(data.requestId);
            socket.emit('joinRequest', data.requestId);
        } else {
            formSec.style.display = 'block';
            chatSec.style.display = 'none';
        }
    } catch (err) { console.error(err); }
}



    </script>
</body>
</html>