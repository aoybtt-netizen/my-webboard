<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GedGo! - เติมเงินสมาชิก</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --primary: #11998e; --secondary: #38ef7d; --dark: #2c3e50; --light: #f8fafc; --danger: #e74c3c; }
        body { font-family: 'Kanit', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar สไตล์เดียวกับ Admin */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; backdrop-filter: blur(2px); }
        .sidebar { 
            width: 260px; background: var(--dark); color: white; height: 100vh; 
            position: fixed; left: -260px; top: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001; display: flex; flex-direction: column;
        }
        .sidebar.active { left: 0; }
        .sidebar-header { padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .sidebar-menu { flex: 1; padding: 10px 0; }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; gap: 12px; color: rgba(255,255,255,0.7); text-decoration: none; cursor: pointer; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: var(--secondary); border-left: 4px solid var(--secondary); }
        
        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; width: 100%; }
        .top-bar { background: white; padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 999; }
        .content-body { padding: 25px; max-width: 600px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        /* ส่วนของฟอร์มเติมเงิน */
        .topup-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; }
        .amount-input-group { position: relative; margin: 25px 0; }
        .amount-input { width: 100%; padding: 15px; font-size: 2em; text-align: center; border: 2px solid #eee; border-radius: 15px; outline: none; font-weight: bold; color: var(--dark); transition: 0.3s; }
        .amount-input:focus { border-color: var(--secondary); box-shadow: 0 0 10px rgba(56, 239, 125, 0.2); }
        
        .btn-submit-topup { width: 100%; padding: 15px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3); }
        .btn-submit-topup:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4); }

        /* รายการประวัติแบบย่อ */
        .history-item { background: white; border-radius: 12px; padding: 15px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .status-pending { color: #f1c40f; font-weight: bold; }
        .status-success { color: #2ecc71; font-weight: bold; }
    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 style="margin:0; color:var(--secondary);">GedGo! Wallet</h3>
            <small style="opacity:0.6;">ระบบกระเป๋าเงินสมาชิก</small>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item active" onclick="switchTab('topup')">
                <i class="fas fa-hand-holding-usd"></i> เติมเงิน
            </div>
            <div class="menu-item" onclick="switchTab('history')">
                <i class="fas fa-file-invoice-dollar"></i> ประวัติการเติมเงิน
            </div>
        </div>
        <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="usergedgo.html" class="menu-item" style="padding:0;"><i class="fas fa-user-circle"></i> กลับหน้าโปรไฟล์</a>
        </div>
    </nav>

    <main class="main-content">
        <header class="top-bar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <i class="fas fa-bars menu-btn" onclick="toggleSidebar()" style="cursor:pointer; font-size: 1.2em;"></i>
                <h2 id="content-title" style="margin:0; font-size: 1.2em;">เติมเงิน</h2>
            </div>
            <div>
                ยอดเงินปัจจุบัน: <b id="current-balance">0.00</b> USD
            </div>
        </header>

        <div class="container" style="padding-bottom: 0;">
            <div id="zone-info-display" style="margin-top: 15px; padding: 15px; background: #fff; border: 1px solid #eee; border-radius: 12px; display: flex; align-items: center; gap: 12px; text-align: left;">
                <div style="background: #e8f5e9; color: var(--primary); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div style="flex: 1;">
                    <div id="display-zone-name" style="font-weight: bold; color: var(--dark); font-size: 0.9em;">กำลังโหลด...</div>
                    <div style="font-size: 0.75em; color: #666; margin-top: 2px;">
                        <i class="fas fa-user-shield" style="color: #f1c40f;"></i> ผู้ดูแล: 
                        <span id="display-zone-admin" style="font-weight: bold; color: var(--primary);">รอการเชื่อมต่อ</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-body" id="main-display">
            
            <div id="section-topup-form">
                <div class="topup-card">
                    <div style="font-size: 50px; color: var(--primary);"><i class="fas fa-wallet"></i></div>
                    <h3>ระบุจำนวนเงินที่ต้องการเติม</h3>
                    <div class="amount-input-group">
                        <input type="number" id="topup-amount" class="amount-input" placeholder="0.00">
                        <div style="margin-top: 10px; font-weight: bold; color: var(--primary);">USD</div>
                    </div>
                    <button class="btn-submit-topup" onclick="submitTopupRequest()">
                        <i class="fas fa-paper-plane"></i> ส่งคำขอเติมเงิน
                    </button>
                </div>

                <div style="margin-top: 30px;">
                    <h4><i class="fas fa-info-circle"></i> ขั้นตอนการเติมเงิน</h4>
                    <ul style="color: #666; font-size: 0.85em; line-height: 1.8;">
                        <li>ระบุจำนวนเงิน USD ที่ต้องการ</li>
                        <li>ระบบจะส่งคำขอไปยัง <b>เจ้าของโซน</b> ที่คุณสังกัด</li>
                        <li>ชำระเงินตามวิธีที่เจ้าของโซนกำหนดในพื้นที่</li>
                        <li>เมื่อเจ้าของโซนยืนยัน ยอดเงินจะเข้าบัญชีทันที</li>
                    </ul>
                </div>
            </div>

            <div id="section-pending-chat" style="display: none;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <span style="background: #fff9e6; color: #f1c40f; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; font-weight: bold; border: 1px solid #f1c40f;">
                        <i class="fas fa-clock"></i> อยู่ระหว่างตรวจสอบ
                    </span>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <div style="width: 35px; height: 35px; background: var(--dark); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em;">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 0.75em; color: #999; margin-bottom: 5px;" id="chat-admin-name">Admin</div>
                        <div style="background: white; padding: 15px; border-radius: 0 15px 15px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative;">
                            <p style="margin: 0; font-size: 0.95em; color: #333; line-height: 1.5;" id="admin-auto-reply">
                                กำลังโหลดข้อความอัตโนมัติ...
                            </p>
                        </div>
                    </div>
                </div>

                <div style="background: #e8f5e9; padding: 15px; border-radius: 12px; text-align: center;">
                    <p style="margin: 0; color: #2e7d32; font-size: 0.85em;">
                        <i class="fas fa-info-circle"></i> เมื่อโอนเงินเสร็จแล้ว โปรดรอแอดมินยืนยันรายการ
                    </p>
                </div>
            </div>

            <div id="section-history" style="display: none;">
                <h4>ประวัติการส่งคำขอ</h4>
                <div id="history-list">
                    <p style="text-align: center; color: #999;">กำลังโหลดประวัติ...</p>
                </div>
            </div>

        </div>
    </main>

    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
        }

        function switchTab(tab) {
            const title = document.getElementById('content-title');
            const topupSec = document.getElementById('section-topup');
            const historySec = document.getElementById('section-history');
            
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (tab === 'topup') {
                title.innerText = 'เติมเงิน';
                topupSec.style.display = 'block';
                historySec.style.display = 'none';
            } else {
                title.innerText = 'ประวัติการเติมเงิน';
                topupSec.style.display = 'none';
                historySec.style.display = 'block';
                loadHistory();
            }
            if (window.innerWidth <= 768) toggleSidebar();
        }

        async function processTopup() {
            const amount = document.getElementById('topup-amount').value;
            if(!amount || amount <= 0) return alert("กรุณาระบุจำนวนเงิน");
            
            // Logic ส่งคำขอเติมเงินจะอยู่ตรงนี้
            alert(`ส่งคำขอเติมเงินจำนวน ${amount} USD เรียบร้อยแล้ว!`);
        }

        function loadHistory() {
            // จำลองการโหลดประวัติ
            const list = document.getElementById('history-list');
            list.innerHTML = `
                <div class="history-item">
                    <div><b>50.00 USD</b><br><small>2024-05-20 10:30</small></div>
                    <div class="status-pending">รอตรวจสอบ</div>
                </div>
            `;
        }

    window.onload = async () => {
    const myName = localStorage.getItem('myUsername');
	await checkTopupStatus();
    if (!myName) {
        window.location.href = 'index.html';
        return;
    }

    try {
        const savedLoc = localStorage.getItem('userPrimaryLocation');
        let locationParam = savedLoc ? `&location=${encodeURIComponent(savedLoc)}` : '';

        // ดึงข้อมูลผ่าน API ตัวเดิมที่เราใช้กับหน้าโปรไฟล์
        const res = await fetch(`/api/profile-details?username=${myName}${locationParam}`);
        const data = await res.json();

        if (data.error) throw new Error(data.error);

        // 1. อัปเดตยอดเงิน
        document.getElementById('current-balance').innerText = (data.coins || 0).toFixed(2);
        
        // 2. อัปเดตข้อมูลโซนและเจ้าของโซน (นี่คือส่วนที่สำคัญ!)
        document.getElementById('display-zone-name').innerText = data.zoneName || "นอกพื้นที่บริการ";
        document.getElementById('display-zone-admin').innerText = data.zoneOwner || "ไม่มีผู้ดูแล";

    } catch (err) {
        console.error("Load Topup Info Error:", err);
        document.getElementById('display-zone-name').innerText = "โหลดข้อมูลล้มเหลว";
    }
};



async function checkTopupStatus() {
    const myName = localStorage.getItem('myUsername');
    const savedLoc = localStorage.getItem('userPrimaryLocation');
    const locParam = savedLoc ? `&location=${encodeURIComponent(savedLoc)}` : '';

    try {
        // เรียก API เพื่อดูว่ามีคำขอค้างไหม และดึงข้อมูลแอดมินมาด้วย
        const res = await fetch(`/api/topup/status?username=${myName}${locParam}`);
        const data = await res.json();

        const formSec = document.getElementById('section-topup-form');
        const chatSec = document.getElementById('section-pending-chat');

        if (data.hasPending) {
            // ถ้ามีคำขอค้างอยู่ -> สลับไปหน้าแชท
            formSec.style.display = 'none';
            chatSec.style.display = 'block';
            document.getElementById('header-title').innerText = "สถานะการเติมเงิน";
            
            // แสดงข้อความอัตโนมัติของแอดมินคนนั้น
            document.getElementById('chat-admin-name').innerText = data.adminName;
            document.getElementById('admin-auto-reply').innerHTML = `
                <b>แจ้งรายละเอียดการโอนเงิน</b><br>
                ---------------------------<br>
                ${data.adminMessage.bankInfo}<br><br>
                ${data.adminMessage.desc}
            `;
        } else {
            // ถ้าไม่มี -> แสดงฟอร์มเติมเงินปกติ
            formSec.style.display = 'block';
            chatSec.style.display = 'none';
            document.getElementById('header-title').innerText = "เติมเงิน";
        }
    } catch (err) {
        console.error("Check status error:", err);
    }
}

async function submitTopupRequest() {
    const amount = document.getElementById('topup-amount').value;
    const username = localStorage.getItem('myUsername');
    
    if (!amount || amount <= 0) return alert("กรุณาระบุจำนวนเงิน");

    try {
        const res = await fetch('/api/topup/request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: username,
                amount: amount,
                // ระบบจะหา adminId จากพิกัดในฝั่ง Backend เอง
                location: localStorage.getItem('userPrimaryLocation') 
            })
        });

        if (res.ok) {
            // เมื่อส่งสำเร็จ ให้รีเฟรชหน้าเพื่อสลับไปหน้าแชทอัตโนมัติ
            await checkTopupStatus();
        }
    } catch (err) {
        alert("เกิดข้อผิดพลาดในการส่งคำขอ");
    }
}


    </script>
</body>
</html>