<!DOCTYPE html>
<html lang="th">
<head>

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="GedGo">
	<meta name="mobile-web-app-capable" content="yes">
	
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="/socket.io/socket.io.js"></script>
    <title>GedGo! - ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --primary: #11998e; --secondary: #38ef7d; --dark: #2c3e50; --light: #f8fafc; --danger: #e74c3c; }
        body { font-family: 'Kanit', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Admin */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; backdrop-filter: blur(2px); }
        .sidebar { 
            width: 260px; background: var(--dark); color: white; height: 100vh; 
            position: fixed; left: -260px; top: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001; display: flex; flex-direction: column;
        }
        .sidebar.active { left: 0; }
        .sidebar-header { padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .sidebar-menu { flex: 1; padding: 10px 0; }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; gap: 12px; color: rgba(255,255,255,0.7); text-decoration: none; cursor: pointer; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: var(--secondary); border-left: 4px solid var(--secondary); }
        
        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; width: 100%; }
        .top-bar { background: white; padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 999; }
        .content-body { padding: 25px; max-width: 600px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô */
        .topup-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; }
        .amount-input-group { position: relative; margin: 25px 0; }
        .amount-input { width: 100%; padding: 15px; font-size: 2em; text-align: center; border: 2px solid #eee; border-radius: 15px; outline: none; font-weight: bold; color: var(--dark); transition: 0.3s; }
        .amount-input:focus { border-color: var(--secondary); box-shadow: 0 0 10px rgba(56, 239, 125, 0.2); }
        
        .btn-submit-topup { width: 100%; padding: 15px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3); }
        .btn-submit-topup:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4); }

        /* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠ */
        .history-item { background: white; border-radius: 12px; padding: 15px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .status-pending { color: #f1c40f; font-weight: bold; }
        .status-success { color: #2ecc71; font-weight: bold; }
		
		
		
	#section-pending-chat {
    display: none; /* ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
    flex-direction: column;
    height: 100%;
    width: 100%;
}

#realtime-chats {
    flex: 1; /* ‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ä‡∏ó‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà */
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px;
}




body {
    padding-bottom: env(safe-area-inset-bottom);
    min-height: -webkit-fill-available;
}

.modal-content, .sidebar {
    padding-bottom: calc(20px + env(safe-area-inset-bottom)) !important;
}

html {
    height: -webkit-fill-available;
}

    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h3 style="margin:0; color:var(--secondary);">GedGo! Wallet</h3>
        <small style="opacity:0.6;" data-i18n-key="lbl_wallet_system">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</small>
    </div>
    
    <div class="sidebar-menu">
        <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="index.html" class="menu-item" style="padding:0;">
                <i class="fas fa-user-circle"></i> 
                <span data-i18n-key="menu_back_home">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
            </a>
        </div>

        <div class="menu-item" id="menu-topup" onclick="switchTab('topup', 'TOPUP')">
            <i class="fas fa-hand-holding-usd"></i> 
            <span data-i18n-key="menu_topup">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</span>
        </div>

        <div class="menu-item" id="menu-withdraw" onclick="switchTab('topup', 'WITHDRAW')">
            <i class="fas fa-money-bill-transfer"></i> 
            <span data-i18n-key="menu_withdraw">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
        </div>

        <div class="menu-item" onclick="switchTab('history')">
            <i class="fas fa-file-invoice-dollar"></i> 
            <span data-i18n-key="menu_topup_history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</span>
        </div>
    </div>

    <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
        <a href="index.html" class="menu-item" style="padding:0;">
            <i class="fas fa-user-circle"></i> 
            <span data-i18n-key="menu_back_home">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
        </a>
    </div>
</nav>

    <main class="main-content">
        <header class="top-bar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <i class="fas fa-bars menu-btn" onclick="toggleSidebar()" style="cursor:pointer; font-size: 1.2em;"></i>
                <h2 id="content-title" style="margin:0; font-size: 1.2em;">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h2>
            </div>
            <div>
			‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b id="current-balance">0.00</b> <span id="currency-label">USD</span>
			</div>
        </header>

        <div class="container" style="padding-bottom: 0;">
            <div id="zone-info-display" style="margin-top: 15px; padding: 15px; background: #fff; border: 1px solid #eee; border-radius: 12px; display: flex; align-items: center; gap: 12px; text-align: left;">
                <div style="background: #e8f5e9; color: var(--primary); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div style="flex: 1;">
                    <div id="display-zone-name" style="font-weight: bold; color: var(--dark); font-size: 0.9em;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    <div style="font-size: 0.75em; color: #666; margin-top: 2px;">
                        <i class="fas fa-user-shield" style="color: #f1c40f;"></i> ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•: 
                        <span id="display-zone-admin" style="font-weight: bold; color: var(--primary);">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-body" id="main-display">
            
            <div id="section-topup-form">
                <div class="topup-card">
    <div id="form-icon" style="font-size: 50px; color: var(--primary);">
        <i class="fas fa-wallet"></i>
    </div>
    <h3 id="amount-label">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h3>
    
    <div class="amount-input-group">
    <input type="number" id="topup-amount" class="amount-input" placeholder="0.00">
    <div id="input-currency-label" style="margin-top: 10px; font-weight: bold; color: var(--primary);">Loading...</div>
	</div>

    <div id="withdraw-bank-info" style="display: none; margin-bottom: 20px; text-align: left;">
        <label style="font-size: 0.85em; color: #666; font-weight: bold;">‡∏£‡∏∞‡∏ö‡∏∏‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏ä‡∏∑‡πà‡∏≠-‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ-‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£):</label>
        <textarea id="withdraw-bank-details" rows="3" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #eee; font-family: inherit; margin-top: 5px;" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ 123-4-567-890 ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢"></textarea>
    </div>

    <button class="btn-submit-topup" onclick="submitTransactionRequest()">
        <i class="fas fa-paper-plane"></i> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠
    </button>
</div>

                <div style="margin-top: 30px;">
			<h4><i class="fas fa-info-circle"></i> ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h4>
			<ul style="color: #666; font-size: 0.85em; line-height: 1.8;">
			<li>‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô <b id="step-currency-label">---</b> ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</li>
			<li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á <b>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô</b> ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</li>
			</ul>
			</div>
            </div>

            <div id="section-pending-chat" style="display: none; height: calc(100vh - 150px); flex-direction: column;">
    <div style="text-align: center; margin-bottom: 10px;">
        <span style="background: #fff9e6; color: #f1c40f; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; font-weight: bold; border: 1px solid #f1c40f;">
            <i class="fas fa-clock"></i> ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
        </span>
    </div>

    <div id="chat-messages-container" style="flex: 1; overflow-y: auto; background: #f8fafc; padding: 15px; border-radius: 15px; border: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
        <div id="admin-auto-reply-wrapper"></div>
        <div id="realtime-chats"></div>
    </div>

    <div style="display: flex; gap: 10px; background: white; padding: 10px; border-radius: 15px; align-items: center; border: 1px solid #eee;">
    <input type="file" id="slip-file-input" hidden accept="image/*" onchange="handleSlipUpload()">
    <button onclick="document.getElementById('slip-file-input').click()" style="background: #f1f5f9; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; color: #64748b;">
        <i class="fas fa-image"></i>
    </button>
    
    <input type="text" id="user-chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." style="flex: 1; border: none; padding: 10px; outline: none;">
    
    <button onclick="sendUserChat()" style="background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 10px; cursor: pointer;">
        <i class="fas fa-paper-plane"></i>
    </button>
</div>

</div>

            <div id="section-history" style="display: none;">
                <h4>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</h4>
                <div id="history-list">
                    <p style="text-align: center; color: #999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</p>
                </div>
            </div>

        </div>
    </main>

    <script>
	const socket = io();
	let currentRequestId = null;
	let transactionType = 'TOPUP';
	let zoneCurrency = 'USD';
	


const currentLang = localStorage.getItem('preferredLanguage') || 'th';
				
const translations = {
    'th': {
        'lbl_wallet_system': '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å',
        'menu_back_home': '‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å',
        'menu_topup': '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô',
        'menu_withdraw': '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
        'menu_topup_history': '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô',
    },
    'en': {
        'lbl_wallet_system': 'Member Wallet System',
        'menu_back_home': 'Back to Home',
        'menu_topup': 'Top-up',
        'menu_withdraw': 'Withdraw',
        'menu_topup_history': 'Top-up History',
    },
    'pt': {
        'lbl_wallet_system': 'Sistema de Carteira',
        'menu_back_home': 'Voltar ao In√≠cio',
        'menu_topup': 'Recarregar',
        'menu_withdraw': 'Sacar',
        'menu_topup_history': 'Hist√≥rico de Recargas',
    }
};

function applyMerchantTranslations() {
    console.log(`[i18n] Applying translations for: ${currentLang}`);
    document.querySelectorAll('[data-i18n-key]').forEach(el => {
        const key = el.getAttribute('data-i18n-key');
        const translatedText = translations[currentLang]?.[key];

        if (translatedText) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = translatedText;
            } 
            else {
                const icon = el.querySelector('i');
                if (icon) {
                    el.innerHTML = '';
                    el.appendChild(icon);
                    el.insertAdjacentHTML('beforeend', ' ' + translatedText);
                } else {
                    el.innerText = translatedText;
                }
            }
        }
    });
}

// ‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
window.addEventListener('DOMContentLoaded', () => {
    applyMerchantTranslations();
});



	
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
        }

    function switchTab(tab, type = 'TOPUP') {
    isHistoryMode = false;
    transactionType = type; // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏Ñ‡∏∑‡∏≠ TOPUP ‡∏´‡∏£‡∏∑‡∏≠ WITHDRAW
    
    const title = document.getElementById('content-title');
    const topupSec = document.getElementById('section-topup-form');
    const historySec = document.getElementById('section-history');
    const chatSec = document.getElementById('section-pending-chat');

    // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ active ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÄ‡∏°‡∏ô‡∏π
    document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
    
    if (tab === 'topup') {
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ active ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Sidebar
        if(type === 'TOPUP') document.getElementById('menu-topup').classList.add('active');
        if(type === 'WITHDRAW') document.getElementById('menu-withdraw').classList.add('active');

        title.innerText = (transactionType === 'TOPUP') ? '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô' : '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';
        
        // --- 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏±‡∏á‡∏ß‡∏• ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ---
        document.getElementById('withdraw-bank-info').style.display = (transactionType === 'WITHDRAW') ? 'block' : 'none';
        document.getElementById('form-icon').style.color = (transactionType === 'WITHDRAW') ? 'var(--danger)' : 'var(--primary)';
        
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
        const submitBtn = document.querySelector('.btn-submit-topup');
        if(transactionType === 'WITHDRAW') {
            submitBtn.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            submitBtn.innerHTML = '<i class="fas fa-money-bill-transfer"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô';
            document.getElementById('amount-label').innerText = '‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô';
        } else {
            submitBtn.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô';
            document.getElementById('amount-label').innerText = '‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°';
        }
        
        historySec.style.display = 'none';
        checkTransactionStatus(); 
    } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        const historyBtn = document.querySelector('div[onclick*="history"]');
        if(historyBtn) historyBtn.classList.add('active');
        
        title.innerText = '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°';
        if(topupSec) topupSec.style.display = 'none';
        chatSec.style.display = 'none';
        historySec.style.display = 'block';
        loadHistory();
    }
    
    if (window.innerWidth <= 768) toggleSidebar();
}

        async function processTopup() {
            const amount = document.getElementById('topup-amount').value;
            if(!amount || amount <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");
            
            // Logic ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            alert(`‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${amount} USD ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`);
        }
		

    async function loadHistory() {
    const myName = localStorage.getItem('myUsername');
    const list = document.getElementById('history-list');
    if (!list) return;

    list.innerHTML = '<p style="text-align: center; color: #999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</p>';

    try {
        const res = await fetch(`/api/topup/history?username=${myName}`);
        const history = await res.json();

        if (history.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: #999; margin-top:20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</p>';
            return;
        }

        list.innerHTML = history.map(item => {
            const isWithdraw = item.type === 'WITHDRAW';
            const typeLabel = isWithdraw ? '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' : '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô';
            const typeIcon = isWithdraw ? 'fa-money-bill-transfer' : 'fa-hand-holding-usd';
            const typeColor = isWithdraw ? '#e74c3c' : '#3498db'; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ñ‡∏≠‡∏ô ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏¥‡∏°
            
            // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å Database (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ USD ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
            const currency = item.currency || 'USD';

            // üö© ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏£‡∏¥‡∏á
            let statusColor = '#f39c12'; // ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pending
            let statusText = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';

            if (item.status === 'approved') {
                statusColor = '#2ecc71'; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                statusText = '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            } else if (item.status === 'rejected') {
                statusColor = '#e74c3c'; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                statusText = '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò';
            }

            return `
                <div class="history-item" 
                     onclick="viewArchivedChat('${item._id}', ${item.amount}, '${item.status}', '${item.createdAt}', '${item.processedAt}', '${item.type || 'TOPUP'}', '${currency}')" 
                     style="cursor:pointer; transition: 0.2s; border-left: 5px solid ${statusColor}; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                    
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="background: ${typeColor}15; color: ${typeColor}; width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2em;">
                            <i class="fas ${typeIcon}"></i>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-size: 0.75em; color: ${typeColor}; font-weight: bold; text-transform: uppercase;">${typeLabel}</div>
                            <b style="font-size: 1.1em; color: #2c3e50;">${item.amount.toFixed(2)} ${currency}</b><br>
                            <small style="color:#999; font-size: 0.8em;">${new Date(item.createdAt).toLocaleString('th-TH')}</small>
                        </div>
                    </div>

                    <div style="text-align:right;">
                        <span style="color: ${statusColor}; font-weight: bold; font-size: 0.9em;">
                            ${statusText}
                        </span><br>
                        <i class="fas fa-chevron-right" style="color:#eee; font-size: 0.8em; margin-top: 5px;"></i>
                    </div>
                </div>
            `;
        }).join('');
    } catch (err) {
        console.error("Load History UI Error:", err);
        list.innerHTML = '<p style="text-align: center; color: red;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>';
    }
}

    window.onload = async () => {
    const myName = localStorage.getItem('myUsername');
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° (‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)
    if (typeof checkTransactionStatus === 'function') {
        await checkTransactionStatus();
    } else if (typeof checkTopupStatus === 'function') {
        await checkTopupStatus();
    }

    if (!myName) {
        window.location.href = 'index.html';
        return;
    }

    try {
        const savedLoc = localStorage.getItem('userPrimaryLocation');
        let locationParam = savedLoc ? `&location=${encodeURIComponent(savedLoc)}` : '';

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÅ‡∏Å‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
        const res = await fetch(`/api/profile-details?username=${myName}${locationParam}`);
        const data = await res.json();

        if (data.error) throw new Error(data.error);
        if (typeof zoneCurrency !== 'undefined') {
            zoneCurrency = data.currency || 'USD';
        }

        // ‚úÖ 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)
        document.getElementById('current-balance').innerText = (data.coins || 0).toFixed(2);
		const inputLabel = document.getElementById('input-currency-label');
		if(inputLabel) inputLabel.innerText = zoneCurrency;
		const stepLabel = document.getElementById('step-currency-label');
		if(stepLabel) stepLabel.innerText = zoneCurrency;
        
        // ‚úÖ 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á id ‡πÑ‡∏ß‡πâ)
        // ‡∏ñ‡πâ‡∏≤ API ‡∏™‡πà‡∏á‡∏°‡∏≤‡∏ß‡πà‡∏≤ 'THB' ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡πá‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å USD ‡πÄ‡∏õ‡πá‡∏ô THB ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const currencyLabel = document.getElementById('currency-label');
        if (currencyLabel) {
            currencyLabel.innerText = data.currency || 'USD';
        }

        // ‚úÖ 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ã‡∏ô
        document.getElementById('display-zone-name').innerText = data.zoneName || "‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£";
        document.getElementById('display-zone-admin').innerText = data.zoneOwner || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•";

    } catch (err) {
        console.error("Load Topup Info Error:", err);
        const zoneDisplay = document.getElementById('display-zone-name');
        if(zoneDisplay) zoneDisplay.innerText = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß";
    }
};




socket.on('receiveMessage', (msg) => {
    // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏´‡∏°
    // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤ (msg.requestId) ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà User ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (currentRequestId)
    // 3. (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°) ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏á (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏™‡∏±‡πà‡∏á appendMessage ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏™‡πà‡∏á)
    if (typeof appendMessage === "function" && 
        msg.requestId === currentRequestId && 
        msg.sender !== localStorage.getItem('myUsername')) {
        
        appendMessage(msg); 
    }
});

socket.on('updateStatus', (data) => {
    if(data.status === 'approved') {
        alert("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß");
        checkTopupStatus(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
    } else if(data.status === 'rejected') {
        alert("‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà");
        checkTopupStatus();
    }
});

async function loadChatHistory(requestId) {
    try {
        const res = await fetch(`/api/topup/chat-history?requestId=${requestId}`);
        const history = await res.json();
        
        const chatContainer = document.getElementById('realtime-chats');
        chatContainer.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ä‡∏ó‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)

        history.forEach(msg => {
            appendMessage(msg); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        });
    } catch (err) {
        console.error("Load chat history error:", err);
    }
}

async function checkTopupStatus() {
    const myName = localStorage.getItem('myUsername');
    const savedLoc = localStorage.getItem('userPrimaryLocation');
    const locParam = savedLoc ? `&location=${encodeURIComponent(savedLoc)}` : '';

    try {
        const res = await fetch(`/api/topup/status?username=${myName}${locParam}`);
        const data = await res.json();

        const formSec = document.getElementById('section-topup-form');
        const chatSec = document.getElementById('section-pending-chat');

        if (data.hasPending) {
    currentRequestId = data.requestId;
    formSec.style.display = 'none';
    chatSec.style.display = 'flex';
    
    // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á HTML ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏ö‡πÑ‡∏î‡πâ
    document.getElementById('admin-auto-reply-wrapper').innerHTML = `
        <div style="margin-bottom: 15px; width: 100%;">
            <details open style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <summary style="padding: 10px 15px; background: #f8fafc; cursor: pointer; font-weight: bold; color: var(--primary); display: flex; justify-content: space-between; align-items: center; list-style: none;">
                    <span><i class="fas fa-university"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î)</span>
                    <i class="fas fa-chevron-down" style="font-size: 0.8em;"></i>
                </summary>
                <div style="padding: 15px; font-size: 0.9em; border-top: 1px solid #eee;">
                    <b style="color: var(--primary);">üè¶ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</b><br>
                    ${data.adminMessage.bankInfo.replace(/\n/g, '<br>')}<br><br>
                    <b style="color: var(--dark);">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</b><br>
                    ${data.adminMessage.desc.replace(/\n/g, '<br>')}
                </div>
            </details>
        </div>
    `;

    await loadChatHistory(data.requestId);
    socket.emit('joinRequest', data.requestId);

        } else {
            formSec.style.display = 'block';
            chatSec.style.display = 'none';
        }
    } catch (err) {
        console.error("üö® Check status error:", err.message);
    }
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á User
function sendUserChat() {
    if (isHistoryMode) return; // ‡∏ñ‡πâ‡∏≤‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏¢‡∏π‡πà ‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á!
    
    const input = document.getElementById('user-chat-input');
    const message = input.value.trim();
    if (!message || !currentRequestId) return;

    const chatData = {
        requestId: currentRequestId,
        sender: localStorage.getItem('myUsername'),
        message: message,
        type: 'text'
    };

    socket.emit('sendMessage', chatData);
    appendMessage(chatData);
    input.value = '';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó
function appendMessage(msg) { // ‡∏´‡∏£‡∏∑‡∏≠ appendAdminChatMessage(msg)
    const chatContainer = document.getElementById('realtime-chats'); // ‡∏´‡∏£‡∏∑‡∏≠ chat-box ‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
    if (!chatContainer) return;

    const isMe = msg.sender === localStorage.getItem('myUsername');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    let contentHTML = "";
    if (msg.type === 'image') {
        contentHTML = `<img src="${msg.message}" style="max-width: 100%; border-radius: 10px; cursor: pointer; display: block;" onclick="window.open(this.src)">`;
    } else {
        contentHTML = `<p style="margin: 0; line-height: 1.5;">${msg.message}</p>`;
    }
	
	if (msg.type === 'system') {
    const sysHTML = `
        <div style="align-self: center; margin: 15px 0; background: #fff4e5; color: #663c00; padding: 8px 20px; border-radius: 20px; font-size: 0.85em; font-weight: bold; border: 1px solid #ffe7cc;">
            ${msg.message}
        </div>
    `;
    chatContainer.innerHTML += sysHTML; // chatContainer ‡∏Ñ‡∏∑‡∏≠‡πÑ‡∏≠‡∏î‡∏µ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤
    chatContainer.scrollTop = chatContainer.scrollHeight;
    return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ
}

    const msgHTML = `
        <div style="display: flex; flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
            <div style="background: ${isMe ? 'var(--primary)' : 'white'}; 
                        color: ${isMe ? 'white' : 'var(--dark)'}; 
                        padding: ${msg.type === 'image' ? '5px' : '10px 15px'}; 
                        border-radius: ${isMe ? '15px 15px 0 15px' : '0 15px 15px 15px'}; 
                        max-width: 75%; 
                        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                        border: ${isMe ? 'none' : '1px solid #eee'};">
                ${contentHTML}
            </div>
            <small style="font-size: 0.7em; color: #999; margin-top: 4px;">
                ${isMe ? '‡∏Ñ‡∏∏‡∏ì' : msg.sender}
            </small>
        </div>
    `;
    
    chatContainer.innerHTML += msgHTML;
    chatContainer.scrollTop = chatContainer.scrollHeight;
}





function sendChat(content, type = 'text') {
    const requestId = "..."; // ‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤
    socket.emit('sendMessage', {
        requestId,
        sender: localStorage.getItem('myUsername'),
        message: content,
        type: type
    });
}

async function submitTopupRequest() {
    const amount = document.getElementById('topup-amount').value;
    const username = localStorage.getItem('myUsername');
    
    if (!amount || amount <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");

    try {
        const res = await fetch('/api/topup/request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: username,
                amount: amount,
                // ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏≤ adminId ‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏ù‡∏±‡πà‡∏á Backend ‡πÄ‡∏≠‡∏á
                location: localStorage.getItem('userPrimaryLocation') 
            })
        });

        if (res.ok) {
            const result = await res.json();
			socket.emit('newTopupRequest', {
                adminId: result.adminId,
                username: username,
                amount: amount
				});
            await checkTopupStatus();
        }
    } catch (err) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠");
    }
}

	
	async function handleSlipUpload() {
    const fileInput = document.getElementById('slip-file-input');
    const file = fileInput.files[0];
    if (!file || !currentRequestId) return;

    const originalBtn = document.querySelector('button[onclick*="slip-file-input"]');
    originalBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
        // ‚úÖ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô (Max width 1024px, Quality 70%)
        const compressedBlob = await compressImage(file, { maxWidth: 1024, quality: 0.7 });

        const formData = new FormData();
        // ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á (‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô .jpg)
        formData.append('slip', compressedBlob, 'slip_optimized.jpg');

        const res = await fetch('/api/upload-slip', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();

        if (data.url) {
            const chatData = {
                requestId: currentRequestId,
                sender: localStorage.getItem('myUsername'),
                message: data.url,
                type: 'image'
            };
            socket.emit('sendMessage', chatData);
            appendMessage(chatData);
        }
    } catch (err) {
        console.error("Upload error:", err);
        alert("‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
    } finally {
        fileInput.value = '';
        originalBtn.innerHTML = '<i class="fas fa-image"></i>';
    }
}

	// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
async function compressImage(file, { maxWidth = 1024, quality = 0.7 }) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏° (Aspect Ratio)
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Blob (‡πÑ‡∏ü‡∏•‡πå) ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 0.7 (70%)
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/jpeg', quality);
            };
        };
        reader.onerror = (error) => reject(error);
    });
}

let isHistoryMode = false; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞

async function viewArchivedChat(requestId, amount, status, createdAt, processedAt) {
    currentRequestId = requestId;
    isHistoryMode = true; 
    
    const titleElem = document.getElementById('content-title');
    const historySec = document.getElementById('section-history');
    const chatSec = document.getElementById('section-pending-chat');
    
    titleElem.innerText = "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°";
    historySec.style.display = 'none';
    chatSec.style.display = 'flex';
    chatSec.style.flexDirection = 'column';
    chatSec.style.width = '100%';
    chatSec.style.height = '100%';

    const inputArea = document.getElementById('chat-input-area');
    if(inputArea) inputArea.style.display = 'none';

    const headerWrapper = document.getElementById('admin-auto-reply-wrapper');
    headerWrapper.innerHTML = `
        <div style="background: ${status === 'approved' ? '#e8f5e9' : '#ffebee'}; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid ${status === 'approved' ? '#c8e6c9' : '#ffcdd2'}; width: 100%; box-sizing: border-box;">
            <div style="text-align: center;">
                <i class="fas ${status === 'approved' ? 'fa-check-circle' : 'fa-times-circle'}" style="font-size: 2em; color: ${status === 'approved' ? '#2e7d32' : '#c62828'};"></i>
                <div style="font-weight: bold; margin-top: 5px; color: ${status === 'approved' ? '#2e7d32' : '#c62828'};">
                    ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ${status === 'approved' ? '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò'}‡πÅ‡∏•‡πâ‡∏ß
                </div>
                <div style="font-size: 1.1em; font-weight: bold; margin: 5px 0;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: ${amount.toFixed(2)} USD</div>
            </div>
            
            <div style="border-top: 1px solid rgba(0,0,0,0.05); margin-top: 10px; padding-top: 10px; font-size: 0.85em; color: #666;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                    <span>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠:</span>
                    <span>${new Date(createdAt).toLocaleString('th-TH')}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>‚úÖ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠:</span>
                    <span>${new Date(processedAt).toLocaleString('th-TH')}</span>
                </div>
            </div>

            <button onclick="switchTab('history')" style="width:100%; margin-top:12px; border:none; background:rgba(0,0,0,0.08); padding: 10px; border-radius: 8px; cursor:pointer; font-weight:bold; color:#555;">
                <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            </button>
        </div>
    `;

    const chatDisplay = document.getElementById('realtime-chats');
    chatDisplay.style.flex = '1';
    chatDisplay.style.overflowY = 'auto';
    chatDisplay.innerHTML = '<p style="text-align:center; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó...</p>';
    
    await loadChatHistory(requestId);
}


async function submitTransactionRequest() {
    const amount = document.getElementById('topup-amount').value;
    const bankDetails = document.getElementById('withdraw-bank-details').value;
    const username = localStorage.getItem('myUsername');
    
    if (!amount || amount <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");
    if (transactionType === 'WITHDRAW' && !bankDetails) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£");

    // ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡πÄ‡∏•‡πà‡∏ô)
    const currentBalance = parseFloat(document.getElementById('current-balance').innerText);
    if (transactionType === 'WITHDRAW' && amount > currentBalance) {
        return alert("‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô");
    }

    try {
        const res = await fetch('/api/topup/request', { // ‡πÉ‡∏ä‡πâ API ‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: username,
                amount: amount,
                type: transactionType, // üö© ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ TOPUP ‡∏´‡∏£‡∏∑‡∏≠ WITHDRAW
                bankInfo: bankDetails, // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                location: localStorage.getItem('userPrimaryLocation') 
            })
        });

        if (res.ok) {
            const result = await res.json();
            socket.emit('newTransactionRequest', { // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ event socket
                adminId: result.adminId,
                username: username,
                amount: amount,
                type: transactionType,
                currency: zoneCurrency
            });
            await checkTransactionStatus(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏ä‡∏ó
        } else {
            const error = await res.json();
            alert(error.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
        }
    } catch (err) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠");
    }
}


async function checkTransactionStatus() {
    const myName = localStorage.getItem('myUsername');
    try {
        // API ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏≠‡∏ô)
        const res = await fetch(`/api/topup/status?username=${myName}`);
        const data = await res.json();

        const formSec = document.getElementById('section-topup-form');
        const chatSec = document.getElementById('section-pending-chat');

        if (data.hasPending) {
            currentRequestId = data.requestId;
            const isWithdraw = data.type === 'WITHDRAW'; // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏à‡∏≤‡∏Å server
            
            formSec.style.display = 'none';
            chatSec.style.display = 'flex';
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á UI ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            const statusLabel = chatSec.querySelector('span');
            statusLabel.style.background = isWithdraw ? '#fff5f5' : '#fff9e6';
            statusLabel.style.color = isWithdraw ? '#e74c3c' : '#f1c40f';
            statusLabel.style.borderColor = isWithdraw ? '#e74c3c' : '#f1c40f';
            statusLabel.innerHTML = isWithdraw ? '<i class="fas fa-university"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' : '<i class="fas fa-clock"></i> ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô ‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô | ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            const headerHTML = isWithdraw ? `
                <div style="background: white; border-radius: 12px; border: 1px solid #ffcdd2; padding: 15px; font-size: 0.9em;">
                    <b style="color: #e74c3c;">üìå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</b><br>
                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <b>${data.amount.toFixed(2)} USD</b><br>
                    ‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤: ${data.bankInfo.replace(/\n/g, '<br>')}
                </div>
            ` : `
                <details open style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden;">
                    <summary style="padding: 10px 15px; background: #f8fafc; font-weight: bold; color: var(--primary);">üè¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô)</summary>
                    <div style="padding: 15px; font-size: 0.9em; border-top: 1px solid #eee;">
                        <b>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô:</b><br>${data.adminMessage.bankInfo.replace(/\n/g, '<br>')}
                    </div>
                </details>
            `;

            document.getElementById('admin-auto-reply-wrapper').innerHTML = headerHTML;

            await loadChatHistory(data.requestId);
            socket.emit('joinRequest', data.requestId);
        } else {
            formSec.style.display = 'block';
            chatSec.style.display = 'none';
        }
    } catch (err) { console.error(err); }
}



    </script>
</body>
</html>