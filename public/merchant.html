<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GedGoZone - Merchant Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
            margin: 0; background-color: #f0f2f5; 
            padding-bottom: 50px;
        }
        .header {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            padding: 20px; color: white; text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        .card {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px;
        }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, textarea, select {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;
        }
        .stop-item {
            background: #f8f9fa; padding: 15px; border-radius: 10px;
            border-left: 5px solid #11998e; margin-bottom: 10px;
            position: relative;
        }
        .remove-stop {
            position: absolute; top: 10px; right: 10px;
            color: #dc3545; cursor: pointer;
        }
        .btn-add-stop {
            background: white; border: 2px dashed #11998e;
            color: #11998e; width: 100%; padding: 10px;
            border-radius: 8px; cursor: pointer; font-weight: bold;
            margin-bottom: 20px;
        }
        .btn-submit {
            background: #11998e; color: white; border: none;
            width: 100%; padding: 15px; border-radius: 30px;
            font-size: 1.1em; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
        }
        .hidden { display: none; }
		
		
		
		/* Sidebar ‡∏™‡πÑ‡∏•‡∏î‡πå‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ */
.merchant-sidebar {
    position: fixed;
    top: 0;
    left: -280px; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ */
    width: 280px;
    height: 100%;
    background: white;
    z-index: 7000;
    transition: 0.3s;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}
.merchant-sidebar.active {
    left: 0;
}
.sidebar-header {
    background: #11998e;
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.sidebar-menu {
    padding: 10px;
}
.menu-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 1.05em;
}
.menu-item:hover {
    background: #f9f9f9;
    color: #11998e;
}
.sidebar-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 6500;
}




/* ‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: flex-start; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å center ‡πÄ‡∏õ‡πá‡∏ô flex-start ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
    padding-top: 20px;       /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
    z-index: 9999;
    overflow-y: auto;        /* ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß Overlay ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤ Modal ‡∏¢‡∏≤‡∏ß */
}

/* ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á */
.modal-box {
    background: white;
    border-radius: 15px;
    width: 95%;
    max-width: 500px;
    margin-bottom: 20px;    /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏•‡πà‡∏≤‡∏á‡∏à‡∏≠ */
    box-shadow: 0 5px 25px rgba(0,0,0,0.3);
    position: relative;
    overflow: hidden;       /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏∞‡∏•‡∏±‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏ô */
    display: flex;
    flex-direction: column;
}

/* Animation ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏™‡∏ß‡∏¢‡πÜ */
@keyframes modalFadeIn {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.hidden {
    display: none !important;
}




.manage-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid #eee;
    transition: background 0.2s;
}
.manage-item:hover {
    background: #fcfcfc;
}
.manage-info {
    text-align: left;
    flex-grow: 1;
}
.manage-actions {
    display: flex;
    gap: 10px;
}
.btn-delete {
    color: #dc3545;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2em;
    padding: 5px;
}
.btn-delete:hover {
    transform: scale(1.1);
}



/* ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ */
.summary-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: white;
    border-radius: 10px;
    margin-bottom: 8px;
    border: 1px solid #eee;
}
.summary-item i {
    color: #11998e;
    font-size: 1.1em;
}
.summary-label {
    font-size: 0.85em;
    color: #888;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 5px;
}
.summary-value {
    font-weight: 600;
    color: #333;
}

    </style>
</head>
<body>

    
	
	
	<div class="header">
    <div style="float: left; cursor: pointer;" onclick="toggleMerchantSidebar()">
        <i class="fas fa-bars"></i>
    </div>
    <h2 style="margin: 0; display: inline-block;">GedGo Merchant</h2>
    <div style="float: right; cursor: pointer;" onclick="window.location.href='index.html'">
        <i class="fas fa-home"></i>
    </div>
</div>



	

<div id="merchant-sidebar" class="merchant-sidebar">
    <div class="sidebar-header">
        <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏Å‡∏±‡∏î</h3>
        <span onclick="toggleMerchantSidebar()" style="cursor:pointer;">&times;</span>
    </div>
    <div class="sidebar-menu">
        <div class="menu-item" onclick="openSaveStoreModal()">
            <i class="fas fa-store"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô (Base)
        </div>
        <div class="menu-item" onclick="openAddLocationModal()">
            <i class="fas fa-map-marked-alt"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô
        </div>
        <hr>
        <div class="menu-item" onclick="openManageLocationsModal()">
    <i class="fas fa-list"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
</div>
    </div>
</div>

<div id="sidebar-overlay" class="sidebar-overlay hidden" onclick="toggleMerchantSidebar()"></div>



    <div class="container">
        <div class="card">
    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡πâ‡∏≤‡∏á</label>
    <select id="task-category" onchange="updateTitlePreview()">
        <option value="‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£">üìÑ ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</option>
        <option value="‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">üç± ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
    </select>

    <div style="background: #e9f7ef; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #11998e;">
        <small style="color: #666;">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å:</small>
        <div id="title-preview" style="font-weight: bold; color: #11998e; font-size: 1.1em;">
            ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ 0 ‡∏à‡∏∏‡∏î
        </div>
    </div>
    
    <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡πâ‡∏≤‡∏¢‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠)</label>
    <textarea id="task-desc" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></textarea>
    
    <label>‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏à‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô (USD)</label>
    <input type="number" id="task-budget" placeholder="0.00">
</div>


	<div class="card" style="text-align: center; background: #fffbf0; border: 1px solid #f39c12;">
    <label><i class="fas fa-microphone"></i> ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á (AI Assistant)</label>
    <button class="btn-add-stop" style="background: #f39c12; color: white; border: none; padding: 15px;" id="voice-btn" onclick="startVoiceCommand()">
        <i class="fas fa-play"></i> ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô
    </button>
    <p id="voice-status" style="font-size: 0.85em; color: #666; margin-top: 10px;">
        ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: "‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢ ‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß ‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢ 50 ‡∏ö‡∏≤‡∏ó"
    </p>
</div>


        <div class="card">
            <label>üìç ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</label>
            <div id="stops-container">
                </div>
            <button class="btn-add-stop" onclick="addNewStop()">
                <i class="fas fa-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô / ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô
            </button>
        </div>

        <button class="btn-submit" onclick="postMerchantTask()">
            <i class="fas fa-paper-plane"></i> ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
        </button>
    </div>

    <script>
	
	const myUsername = localStorage.getItem('myUsername');
	
    let stopCount = 0;
    let mySavedLocations = [];
    let currentTargetStopId = null;
	let merchantMap;
	let currentMarker;
	let selectedLat, selectedLng;
	let editingLocationId = null;
	let lastVoiceAnalysis = null;
	
	
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Server ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
window.onload = async function() {
    if (!myUsername) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏ô‡∏≠‡∏£‡πå");
        window.location.href = 'index.html';
        return;
    }
    await loadSavedLocations();
};
	
	
	// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Sidebar
function toggleMerchantSidebar() {
    const sidebar = document.getElementById('merchant-sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    sidebar.classList.toggle('active');
    overlay.classList.toggle('hidden');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô)
function openSaveStoreModal() {
    toggleMerchantSidebar();
    openAddLocationModal();
    document.getElementById('map-loc-name').value = "‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô";
    document.getElementById('map-loc-voice').value = "‡∏£‡πâ‡∏≤‡∏ô";
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
function openAddLocationModal() {
    toggleMerchantSidebar(); 
    editingLocationId = null; // üö© ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ ID ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    
    document.getElementById('map-modal').classList.remove('hidden');
    document.querySelector('#map-modal h3').innerText = "üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà";
    document.querySelector('#map-modal .btn-submit').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏™‡∏°‡∏∏‡∏î";

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    initMap();

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    document.getElementById('map-loc-name').value = "";
    document.getElementById('map-loc-voice').value = "";

    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    navigator.geolocation.getCurrentPosition((pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        merchantMap.setView([lat, lng], 16);
        updateMarker(lat, lng);
        merchantMap.invalidateSize(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏£‡∏≠‡∏ö
    });
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î
function updateMarker(lat, lng) {
    selectedLat = lat;
    selectedLng = lng;
    if (currentMarker) merchantMap.removeLayer(currentMarker);
    currentMarker = L.marker([lat, lng], { draggable: true }).addTo(merchantMap);
    document.getElementById('map-coords-display').innerText = `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
}


async function loadSavedLocations() {
    const res = await fetch(`/api/merchant/locations?username=${myUsername}`);
    const data = await res.json();
    if (data.success) {
        mySavedLocations = data.locations;
        console.log("‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", mySavedLocations);
    }
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏™‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
async function confirmMapLocation() {
    const name = document.getElementById('map-loc-name').value.trim();
    const voice = document.getElementById('map-loc-voice').value.trim();

    if (!name || !selectedLat) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î");

    const payload = {
        username: myUsername,
        label: name,
        voiceKeyword: voice || name,
        lat: selectedLat,
        lng: selectedLng
    };

    let url = '/api/merchant/locations';
    let method = 'POST';

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡πÅ‡∏•‡∏∞ Method
    if (editingLocationId) {
        url = `/api/merchant/locations/${editingLocationId}`;
        method = 'PUT';
    }

    const res = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (data.success) {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        editingLocationId = null; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        document.querySelector('#map-modal .btn-submit').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏™‡∏°‡∏∏‡∏î";
        await loadSavedLocations(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Server
        closeMapModal();
    }
}

function closeMapModal() {
    document.getElementById('map-modal').classList.add('hidden');
}


    // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
    function addNewStop() {
        stopCount++;
        const container = document.getElementById('stops-container');
        const stopHtml = `
            <div class="stop-item" id="stop-${stopCount}">
                <span class="remove-stop" onclick="removeStop(${stopCount})"><i class="fas fa-times"></i></span>
                <label>‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà <span class="stop-number"></span></label>
                
                <div style="margin-bottom: 10px;">
                    <button class="btn-add-stop" style="border-color: #f39c12; color: #f39c12; width: auto; padding: 5px 15px; font-size: 0.85em;" 
                        onclick="showSavedLocationsModal(${stopCount})">
                        <i class="fas fa-bookmark"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
                    </button>
                </div>

                <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏™‡∏≤‡∏Ç‡∏≤ 1)" class="stop-label" id="label-${stopCount}">
                
                <div style="display: flex; gap: 5px;">
                    <button class="btn-add-stop" style="border-color: #666; color: #666; font-size: 0.8em; flex: 1;" onclick="getStopLocation(${stopCount})">
                        <i class="fas fa-map-marker-alt"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    </button>
                    <button id="save-btn-${stopCount}" class="btn-add-stop hidden" 
                        style="border-color: #28a745; color: #28a745; font-size: 0.8em; flex: 1;" onclick="saveToMyBook(${stopCount})">
                        <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏•‡∏á‡∏™‡∏°‡∏∏‡∏î
                    </button>
                </div>

                <div id="loc-status-${stopCount}" style="font-size: 0.8em; color: gray;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î</div>
                <input type="hidden" class="stop-lat" id="lat-${stopCount}">
                <input type="hidden" class="stop-lng" id="lng-${stopCount}">
            </div>
        `;
        container.insertAdjacentHTML('beforeend', stopHtml);
        reorderStops();
    }

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
    function reorderStops() {
        const stops = document.querySelectorAll('.stop-item');
        stops.forEach((stop, index) => {
            stop.querySelector('.stop-number').innerText = index + 1;
        });
        updateTitlePreview();
    }

    function removeStop(id) {
        document.getElementById(`stop-${id}`).remove();
        reorderStops();
    }

    function updateTitlePreview() {
        const category = document.getElementById('task-category').value;
        const currentStops = document.querySelectorAll('.stop-item').length;
        const previewEl = document.getElementById('title-preview');
        const finalTitle = `${category} ${currentStops} ‡∏à‡∏∏‡∏î`;
        previewEl.innerText = finalTitle;
        return finalTitle;
    }

    // 3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (Saved Locations)
    function saveToMyBook(id) {
        const label = document.getElementById(`label-${id}`).value;
        const lat = document.getElementById(`lat-${id}`).value;
        const lng = document.getElementById(`lng-${id}`).value;
        if (!label || !lat) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô");
        
        mySavedLocations.push({ label, lat, lng });
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏™‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
    }

    function showSavedLocationsModal(stopId) {
        currentTargetStopId = stopId;
        const listContent = document.getElementById('saved-list-content');
        listContent.innerHTML = "";
        if (mySavedLocations.length === 0) {
            listContent.innerHTML = "<p style='text-align:center; color:#999;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>";
        } else {
            mySavedLocations.forEach((loc, index) => {
                listContent.innerHTML += `
                    <div onclick="selectLocation(${index})" style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;">
                        <i class="fas fa-map-pin" style="color:#f39c12;"></i> <b>${loc.label}</b><br>
                        <small style="color:#888;">‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${parseFloat(loc.lat).toFixed(4)}, ${parseFloat(loc.lng).toFixed(4)}</small>
                    </div>`;
            });
        }
        document.getElementById('saved-locations-modal').classList.remove('hidden');
    }

    function selectLocation(index) {
        const selected = mySavedLocations[index];
        const id = currentTargetStopId;
        document.getElementById(`label-${id}`).value = selected.label;
        document.getElementById(`lat-${id}`).value = selected.lat;
        document.getElementById(`lng-${id}`).value = selected.lng;
        document.getElementById(`loc-status-${id}`).innerText = "‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏™‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
        document.getElementById(`loc-status-${id}`).style.color = "#28a745";
        closeSavedModal();
    }

    function closeSavedModal() {
        document.getElementById('saved-locations-modal').classList.add('hidden');
    }

    // 4. ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î (Geolocation)
    function getStopLocation(id) {
        const status = document.getElementById(`loc-status-${id}`);
        status.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                document.getElementById(`lat-${id}`).value = position.coords.latitude;
                document.getElementById(`lng-${id}`).value = position.coords.longitude;
                status.innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
                status.style.color = "#28a745";
                document.getElementById(`save-btn-${id}`).classList.remove('hidden');
            }, () => alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ"));
        }
    }

    // 5. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô
    function postMerchantTask() {
        const finalTitle = updateTitlePreview();
        const stops = [];
        const stopElements = document.querySelectorAll('.stop-item');
        if (stopElements.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏à‡∏∏‡∏î");

        stopElements.forEach((el, index) => {
            const id = el.id.split('-')[1];
            stops.push({
                step: index + 1,
                label: document.getElementById(`label-${id}`).value || `‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${index+1}`,
                lat: document.getElementById(`lat-${id}`).value,
                lng: document.getElementById(`lng-${id}`).value,
                status: 'pending'
            });
        });

        const taskData = {
            title: finalTitle,
            desc: document.getElementById('task-desc').value,
            budget: document.getElementById('task-budget').value,
            stops: stops,
            isMerchantTask: true
        };
        console.log("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤:", taskData);
        alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console)");
    }
	
	
	
	// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ß‡πà‡∏≤‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏´‡∏°
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognition) {
    const recognition = new SpeechRecognition();
    recognition.lang = 'th-TH'; // ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    recognition.interimResults = false;

    function startVoiceCommand() {
        recognition.start();
        document.getElementById('voice-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...';
        document.getElementById('voice-btn').style.background = "#e67e22";
    }

    recognition.onresult = (event) => {
        const text = event.results[0][0].transcript;
        console.log("‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:", text);
        processVoiceOrder(text); // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        resetVoiceBtn();
    };

    recognition.onerror = () => {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡∏Ñ‡πå");
        resetVoiceBtn();
    };

    function resetVoiceBtn() {
        document.getElementById('voice-btn').innerHTML = '<i class="fas fa-play"></i> ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô';
        document.getElementById('voice-btn').style.background = "#f39c12";
    }
}

// --- ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö: ‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á ---
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
function processVoiceOrder(speechText) {
    console.log("AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:", speechText);

    // 1. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô
    let category = "‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
    if (speechText.includes("‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£")) category = "‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£";

    // 2. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
    let budget = "0";
    const priceMatch = speechText.match(/\d+/);
    if (priceMatch) {
    budget = priceMatch[0];
} else {
    budget = "0"; // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏≠‡∏á
}

    // 3. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å Keyword
    let foundStops = [];
    mySavedLocations.forEach(loc => {
        const keyword = loc.voiceKeyword || loc.label;
        if (speechText.includes(keyword)) {
            foundStops.push({ ...loc, indexInSpeech: speechText.indexOf(keyword) });
        }
    });
    foundStops.sort((a, b) => a.indexInSpeech - b.indexInSpeech);

    // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    const finalTitle = `${category} ${foundStops.length || 1} ‡∏à‡∏∏‡∏î`;

    // 5. ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    lastVoiceAnalysis = {
        category: category,
        title: finalTitle,
        stops: foundStops,
        budget: budget
    };

    // 6. ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ
    showVoiceSummaryModal();
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡∏£‡∏≠‡∏Å Keyword ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î
function startVoiceForKeyword() {
    if (!SpeechRecognition) return alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
    
    const voiceRec = new SpeechRecognition();
    voiceRec.lang = 'th-TH';
    
    const btn = event.currentTarget;
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    voiceRec.start();
    
    voiceRec.onresult = (event) => {
        const text = event.results[0][0].transcript;
        document.getElementById('map-loc-voice').value = text.replace(/\s+/g, ''); // ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å
        btn.innerHTML = originalContent;
    };
    
    voiceRec.onerror = () => {
        btn.innerHTML = originalContent;
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏û‡∏π‡∏î‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
    };
}



function showVoiceSummaryModal() {
    const data = lastVoiceAnalysis;
    if(!data) return;

    document.getElementById('sum-title').innerText = data.title;
    document.getElementById('sum-budget').innerText = data.budget.toLocaleString(); // ‡πÉ‡∏™‡πà‡∏Ñ‡∏≠‡∏°‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°

    const stopsContainer = document.getElementById('sum-stops');
    stopsContainer.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤

    if (data.stops && data.stops.length > 0) {
        data.stops.forEach((s, i) => {
            stopsContainer.innerHTML += `
                <div class="summary-item">
                    <div style="background: #11998e; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em;">
                        ${i + 1}
                    </div>
                    <div class="summary-value">${s.label}</div>
                </div>
            `;
        });
    } else {
        stopsContainer.innerHTML = `
            <div style="text-align: center; padding: 15px; background: #fff1f1; color: #d9534f; border-radius: 10px; border: 1px solid #f5c6cb;">
                <i class="fas fa-exclamation-triangle"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ
            </div>
        `;
    }

    document.getElementById('voice-summary-modal').classList.remove('hidden');
}


function confirmVoiceSummary() {
    const data = lastVoiceAnalysis;
    if (!data) return;

    // ‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
    document.getElementById('task-category').value = data.category;
    document.getElementById('task-budget').value = data.budget;

    // ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà
    document.getElementById('stops-container').innerHTML = "";
    stopCount = 0;

    if (data.stops.length > 0) {
        data.stops.forEach(stop => {
            addNewStop();
            const id = stopCount;
            document.getElementById(`label-${id}`).value = stop.label;
            document.getElementById(`lat-${id}`).value = stop.lat;
            document.getElementById(`lng-${id}`).value = stop.lng;
            document.getElementById(`loc-status-${id}`).innerText = "‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢ AI";
            document.getElementById(`loc-status-${id}`).style.color = "#28a745";
        });
    } else {
        addNewStop(); // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏∏‡∏î‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ 1 ‡∏à‡∏∏‡∏î
    }

    reorderStops(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    closeVoiceSummary();
}

function closeVoiceSummary() {
    document.getElementById('voice-summary-modal').classList.add('hidden');
}




// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
function openManageLocationsModal() {
    toggleMerchantSidebar(); // ‡∏õ‡∏¥‡∏î Sidebar
    renderManageList();
    document.getElementById('manage-locations-modal').classList.remove('hidden');
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Render)
function renderManageList() {
    const container = document.getElementById('manage-list-container');
    container.innerHTML = "";

    if (mySavedLocations.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding: 20px; color: #999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
        return;
    }

    mySavedLocations.forEach((loc, index) => {
        container.innerHTML += `
            <div class="manage-item" style="cursor: pointer;" onclick="editLocation(${index})">
                <div class="manage-info">
                    <strong style="color: #11998e;">${loc.label}</strong><br>
                    <small><i class="fas fa-microphone"></i> "${loc.voiceKeyword || loc.label}"</small>
                </div>
                <div class="manage-actions">
                    <button class="btn-delete" onclick="event.stopPropagation(); deleteLocation(${index})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>`;
    });
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î
async function deleteLocation(index) {
    const loc = mySavedLocations[index];
    if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${loc.label}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
        const res = await fetch(`/api/merchant/locations/${loc._id}`, {
            method: 'DELETE'
        });
        const data = await res.json();
        if (data.success) {
            mySavedLocations.splice(index, 1);
            renderManageList();
            alert("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        }
    }
}

function editLocation(index) {
    const loc = mySavedLocations[index];
    if (!loc) return;
    
    editingLocationId = loc._id; // üö© ‡πÄ‡∏Å‡πá‡∏ö ID ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≠‡∏ô PUT (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)
    
    // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏•‡∏¥‡∏™‡∏ï‡πå ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    closeManageModal();
    document.getElementById('map-modal').classList.remove('hidden');
    
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏°
    document.querySelector('#map-modal h3').innerText = "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏¥‡∏Å‡∏±‡∏î";
    document.querySelector('#map-modal .btn-submit').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    initMap();

    // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å
    document.getElementById('map-loc-name').value = loc.label;
    document.getElementById('map-loc-voice').value = loc.voiceKeyword || "";

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
    const lat = parseFloat(loc.lat);
    const lng = parseFloat(loc.lng);
    
    merchantMap.setView([lat, lng], 17);
    updateMarker(lat, lng);
    
    // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î Modal
    setTimeout(() => {
        merchantMap.invalidateSize();
    }, 300);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
function initMap() {
    if (merchantMap) return; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≥

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    merchantMap = L.map('map-container').setView([13.7563, 100.5018], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(merchantMap);

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î
    merchantMap.on('click', function(e) {
        updateMarker(e.latlng.lat, e.latlng.lng);
    });
    
    console.log("üó∫Ô∏è Map Initialized");
}


//  ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal
function closeManageModal() {
    document.getElementById('manage-locations-modal').classList.add('hidden');
}

</script>
	
	
	<div id="saved-locations-modal" class="modal-overlay hidden" style="z-index: 6000;">
    <div class="modal-box" style="max-width: 400px;">
        <h3>üîñ ‡∏™‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
        <div id="saved-list-content" style="max-height: 300px; overflow-y: auto; text-align: left;">
            </div>
        <button class="sidebar-btn" onclick="closeSavedModal()" style="margin-top: 15px; background: #eee;">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>




	<div id="map-modal" class="modal-overlay hidden" style="z-index: 8000;">
    <div class="modal-box" style="max-width: 500px; padding: 0; overflow: hidden;">
        <div style="background: #11998e; color: white; padding: 15px; text-align: center;">
            <h3 style="margin: 0;">üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á</h3>
        </div>
        
        <div id="map-container" style="height: 250px; width: 100%;"></div>

        <div style="padding: 20px; padding-bottom: 30px;"> 
            <label><i class="fas fa-tag"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ A)</label>
            <input type="text" id="map-loc-name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà...">

            <label><i class="fas fa-microphone"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Keyword ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô)</label>
            <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                <input type="text" id="map-loc-voice" placeholder="‡∏û‡∏π‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß" style="margin-bottom: 0;">
                <button onclick="startVoiceForKeyword()" style="background: #f39c12; color: white; border: none; border-radius: 8px; width: 50px; cursor: pointer;">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
            
            <p id="map-coords-display" style="font-size: 0.8em; color: #888; margin-bottom: 15px;">
                ‡∏û‡∏¥‡∏Å‡∏±‡∏î: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            </p>

            <div style="display: flex; gap: 10px;">
                <button class="btn-submit" onclick="confirmMapLocation()" style="flex: 2; border-radius: 8px;">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏™‡∏°‡∏∏‡∏î
                </button>
                <button class="btn-submit" onclick="closeMapModal()" style="flex: 1; background: #999; border-radius: 8px;">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>
</div>



	
	<div id="manage-locations-modal" class="modal-overlay hidden" style="z-index: 8500;">
    <div class="modal-box" style="max-width: 500px; width: 95%;">
        <div style="background: #11998e; color: white; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 15px 15px 0 0;">
            <h3 style="margin: 0;"><i class="fas fa-list"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏Å‡∏±‡∏î</h3>
        </div>
        
        <div id="manage-list-container" style="max-height: 400px; overflow-y: auto;">
            </div>

        <button class="btn-submit" onclick="closeManageModal()" style="background: #999; margin-top: 20px; border-radius: 8px;">
            ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
        </button>
    </div>
</div>




		<div id="voice-summary-modal" class="modal-overlay hidden" style="z-index: 9999;">
    <div class="modal-box" style="max-width: 450px; background: #fdfdfd;">
        <div style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white; padding: 20px; text-align: center;">
            <i class="fas fa-robot" style="font-size: 2em; margin-bottom: 10px;"></i>
            <h3 style="margin: 0; font-weight: 600;">AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
            <p style="margin: 5px 0 0 0; font-size: 0.85em; opacity: 0.9;">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</p>
        </div>

        <div style="padding: 20px;">
            <div class="summary-label"><i class="fas fa-file-signature"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</div>
            <div id="sum-title" style="background: #fff; border: 1px solid #ddd; padding: 12px; border-radius: 10px; font-weight: bold; color: #11998e; margin-bottom: 20px;">
                -
            </div>

            <div class="summary-label"><i class="fas fa-map-marked-alt"></i> ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö</div>
            <div id="sum-stops" style="margin-bottom: 20px;">
                </div>

            <div style="background: #fff4e5; padding: 15px; border-radius: 12px; border: 1px dashed #f39c12; text-align: center; margin-bottom: 25px;">
                <div class="summary-label" style="justify-content: center;"><i class="fas fa-coins"></i> ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏à‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô (‡∏ö‡∏≤‡∏ó)</div>
                <div style="font-size: 2em; color: #e67e22; font-weight: bold;">
                    <small style="font-size: 0.5em; vertical-align: middle;">‡∏ø</small> <span id="sum-budget">0</span>
                </div>
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="btn-submit" onclick="confirmVoiceSummary()" style="flex: 2; height: 55px; box-shadow: 0 4px 12px rgba(17,153,142,0.2);">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ
                </button>
                <button class="btn-submit" onclick="closeVoiceSummary()" style="flex: 1; background: #eee; color: #666; height: 55px;">
                    ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>
    </div>
</div>








</body>
</html>