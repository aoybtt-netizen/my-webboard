<!DOCTYPE html>
<html lang="th">
<head>

	
	<script src="/socket.io/socket.io.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GedGoZone - Merchant Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
            margin: 0; background-color: #f0f2f5; 
            padding-bottom: 50px;
        }
        .header {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            padding: 20px; color: white; text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        .card {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px;
        }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, textarea, select {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;
        }
        .stop-item {
            background: #f8f9fa; padding: 15px; border-radius: 10px;
            border-left: 5px solid #11998e; margin-bottom: 10px;
            position: relative;
        }
        .remove-stop {
            position: absolute; top: 10px; right: 10px;
            color: #dc3545; cursor: pointer;
        }
        .btn-add-stop {
            background: white; border: 2px dashed #11998e;
            color: #11998e; width: 100%; padding: 10px;
            border-radius: 8px; cursor: pointer; font-weight: bold;
            margin-bottom: 20px;
        }
        .btn-submit {
            background: #11998e; color: white; border: none;
            width: 100%; padding: 15px; border-radius: 30px;
            font-size: 1.1em; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
        }
        .hidden { display: none; }
		
		
		
		/* Sidebar ‡∏™‡πÑ‡∏•‡∏î‡πå‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ */
.merchant-sidebar {
    position: fixed;
    top: 0;
    left: -280px; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ */
    width: 280px;
    height: 100%;
    background: white;
    z-index: 7000;
    transition: 0.3s;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}
.merchant-sidebar.active {
    left: 0;
}
.sidebar-header {
    background: #11998e;
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.sidebar-menu {
    padding: 10px;
}
.menu-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 1.05em;
}
.menu-item:hover {
    background: #f9f9f9;
    color: #11998e;
}
.sidebar-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 6500;
}




/* ‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: flex-start; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å center ‡πÄ‡∏õ‡πá‡∏ô flex-start ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
    padding-top: 20px;       /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
    z-index: 9999;
    overflow-y: auto;        /* ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß Overlay ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤ Modal ‡∏¢‡∏≤‡∏ß */
}

/* ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á */
.modal-box {
    background: white;
    border-radius: 15px;
    width: 95%;
    max-width: 500px;
    margin-bottom: 20px;    /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏•‡πà‡∏≤‡∏á‡∏à‡∏≠ */
    box-shadow: 0 5px 25px rgba(0,0,0,0.3);
    position: relative;
    overflow: hidden;       /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏∞‡∏•‡∏±‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏ô */
    display: flex;
    flex-direction: column;
}

/* Animation ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏™‡∏ß‡∏¢‡πÜ */
@keyframes modalFadeIn {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.hidden {
    display: none !important;
}




.manage-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid #eee;
    transition: background 0.2s;
}
.manage-item:hover {
    background: #fcfcfc;
}
.manage-info {
    text-align: left;
    flex-grow: 1;
}
.manage-actions {
    display: flex;
    gap: 10px;
}
.btn-delete {
    color: #dc3545;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2em;
    padding: 5px;
}
.btn-delete:hover {
    transform: scale(1.1);
}



/* ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ */
.summary-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: white;
    border-radius: 10px;
    margin-bottom: 8px;
    border: 1px solid #eee;
}
.summary-item i {
    color: #11998e;
    font-size: 1.1em;
}
.summary-label {
    font-size: 0.85em;
    color: #888;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 5px;
}
.summary-value {
    font-weight: 600;
    color: #333;
}


#sum-stops {
    max-height: 200px; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á */
    overflow-y: auto;  /* ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡πÑ‡∏î‡πâ */
    padding-right: 5px;
    margin-bottom: 15px;
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Scrollbar ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
#sum-stops::-webkit-scrollbar {
    width: 5px;
}
#sum-stops::-webkit-scrollbar-thumb {
    background: #11998e;
    border-radius: 10px;
}



/* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà */
.add-job-card {
    background: white;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    border: 2px dashed #11998e;
    color: #11998e;
    font-size: 1.2em;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
    margin-top: 10px;
}
.add-job-card:hover {
    background: #e8f5e9;
    transform: translateY(-2px);
}

/* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ */
.active-task-card {
    background: white;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    border-left: 5px solid #f39c12; /* ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô In Progress */
}
.task-progress-bar {
    height: 8px;
    background: #eee;
    border-radius: 10px;
    margin: 10px 0;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: #11998e;
    transition: 0.5s;
}



.right-sidebar {
    position: fixed;
    top: 0; right: -320px; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ */
    width: 320px; height: 100%;
    background: white; z-index: 9000;
    transition: 0.3s; box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    display: flex; flex-direction: column;
}
.right-sidebar.active { right: 0; }

.tab-menu { display: flex; background: #eee; }
.tab-item { 
    flex: 1; text-align: center; padding: 15px; 
    cursor: pointer; color: #888; border-bottom: 3px solid transparent; 
}
.tab-item.active { 
    color: #11998e; border-bottom: 3px solid #11998e; background: white; 
}

.tab-content { padding: 15px; flex-grow: 1; overflow-y: auto; }
.chat-msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 80%; font-size: 0.9em; }
.msg-me { background: #11998e; color: white; align-self: flex-end; margin-left: auto; }
.msg-them { background: #eee; color: #333; }


    </style>
</head>
<body>
    <div class="header">
        <div style="float: left; cursor: pointer;" onclick="toggleMerchantSidebar()">
            <i class="fas fa-bars"></i>
        </div>
        <h2 style="margin: 0; display: inline-block;">GedGo Merchant</h2>
        <div style="float: right; cursor: pointer;" onclick="window.location.href='index.html'">
            <i class="fas fa-home"></i>
        </div>
    </div>

    <div id="merchant-sidebar" class="merchant-sidebar">
        <div class="sidebar-header">
            <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏Å‡∏±‡∏î</h3>
            <span onclick="toggleMerchantSidebar()" style="cursor:pointer;">&times;</span>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item" onclick="openSaveStoreModal()">
                <i class="fas fa-store"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô (Base)
            </div>
            <div class="menu-item" onclick="openAddLocationModal()">
                <i class="fas fa-map-marked-alt"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô
            </div>
            <hr>
            <div class="menu-item" onclick="openManageLocationsModal()">
                <i class="fas fa-list"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </div>
        </div>
    </div>
    <div id="sidebar-overlay" class="sidebar-overlay hidden" onclick="toggleMerchantSidebar()"></div>

    <div class="container" style="margin-bottom: 0;">
        <div class="add-job-card" onclick="toggleTaskForm()">
            <i class="fas fa-plus-circle"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏à‡πâ‡∏≤‡∏á‡∏Ç‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
        </div>
    </div>

    <div class="container" id="active-tasks-container">
        <h4 style="color: #666; margin-left: 10px;"><i class="fas fa-clock"></i> ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h4>
        <div id="active-tasks-list">
            </div>
    </div>

    <div class="container hidden" id="task-form-container">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; color: #11998e;">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <span onclick="toggleTaskForm()" style="cursor:pointer; font-size: 1.5em; color: #999;">&times;</span>
            </div>
            <hr>

            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
            <select id="task-category" onchange="updateTitlePreview()">
                <option value="‡∏™‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏™‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                <option value="‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£">‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</option>
                <option value="‡∏™‡πà‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏/‡∏Ç‡∏≠‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏´‡∏ç‡πà">‡∏™‡πà‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏/‡∏Ç‡∏≠‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏´‡∏ç‡πà</option>
            </select>

            <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á, ‡∏Ç‡∏ô‡∏≤‡∏î)</label>
            <textarea id="task-desc" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏á‡∏≤‡∏ô..." rows="3"></textarea>

            <label>‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏à‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" id="task-budget" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡πâ‡∏≤‡∏á..." oninput="updateTitlePreview()">

            <div id="stops-container">
                </div>

            <button class="btn-add-stop" onclick="addNewStop()">
                <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô
            </button>

            <button id="voice-btn" class="btn-submit" style="background: #f39c12; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);" onclick="startVoiceCommand()">
                <i class="fas fa-play"></i> ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô
            </button>

            <button id="submit-btn" class="btn-submit" onclick="postMerchantTask()">
                <i class="fas fa-paper-plane"></i> ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏á‡∏≤‡∏ô‡∏à‡πâ‡∏≤‡∏á (‡∏™‡πà‡∏á <span id="title-preview">-</span>)
            </button>
        </div>
    </div>

    <script>
	const socket = io();
	const myUsername = localStorage.getItem('myUsername');
	
    let stopCount = 0;
    let mySavedLocations = [];
    let currentTargetStopId = null;
	let merchantMap;
	let currentMarker;
	let selectedLat, selectedLng;
	let editingLocationId = null;
	let lastVoiceAnalysis = null;
	let mapMode = 'book';
	
	let activeTaskInSidebar = null;
	
	

	
	
	// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Sidebar
function toggleMerchantSidebar() {
    const sidebar = document.getElementById('merchant-sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    sidebar.classList.toggle('active');
    overlay.classList.toggle('hidden');
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô
function toggleTaskForm() {
    const form = document.getElementById('task-form-container');
    const activeList = document.getElementById('active-tasks-container');
    form.classList.toggle('hidden');
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏° ‡πÉ‡∏´‡πâ‡∏î‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏•‡∏á‡πÑ‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ
    if(!form.classList.contains('hidden')) {
        window.scrollTo({ top: form.offsetTop, behavior: 'smooth' });
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö
async function loadActiveMerchantTasks() {
    const listContainer = document.getElementById('active-tasks-list');
    listContainer.innerHTML = '<p style="text-align:center; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô...</p>';

    try {
        const res = await fetch(`/api/merchant/tasks?username=${myUsername}`);
        const data = await res.json();

        if (data.success && data.posts.length > 0) {
            let finalHtml = ''; 

            data.posts.forEach(post => {
                // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ
                const totalStops = post.stops.length;
                const completedStops = post.stops.filter(s => s.status === 'success').length;
                const progressPercent = (completedStops / totalStops) * 100;
                const canConfirm = (completedStops === totalStops);
                const postTime = new Date(post.id).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                const refCode = post.id.toString().slice(-4);

                // 2. [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] Logic ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Action
                let actionBtnHtml = '';
                
                if (post.acceptedBy) {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                    if (canConfirm) {
                        actionBtnHtml = '<button onclick="event.stopPropagation(); confirmAndRate(\'' + post.id + '\', \'' + post.acceptedBy + '\')" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.85em; cursor: pointer; font-weight:bold;">‚úÖ ‡∏à‡∏ö‡∏á‡∏≤‡∏ô & ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>';
                    } else {
                        actionBtnHtml = '<small style="color: #11998e; font-weight: bold;">üõµ ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</small>';
                    }
                } else if (post.pendingRider) {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏°‡∏µ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡∏î‡∏Ç‡∏≠‡∏á‡∏≤‡∏ô (‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)
                    // ‡πÉ‡∏ä‡πâ event.stopPropagation() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡πÑ‡∏õ‡πÄ‡∏õ‡∏¥‡∏î Sidebar ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°
                    actionBtnHtml = `
                        <div style="text-align:right;">
                            <small style="display:block; margin-bottom:5px; color:#f39c12;">Rider <b>${post.pendingRider}</b> ‡∏Ç‡∏≠‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</small>
                            <button onclick="event.stopPropagation(); approveRider('${post.id}')" style="background: #f39c12; color: white; border: none; padding: 6px 15px; border-radius: 15px; font-size: 0.8em; cursor: pointer; font-weight:bold;">‡∏ï‡∏Å‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏á‡∏≤‡∏ô</button>
                        </div>`;
                } else {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 3: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
                    actionBtnHtml = '<small style="color: #999;">‚åõ ‡∏£‡∏≠‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô...</small>';
                }

                const borderStyle = canConfirm ? 'border-left: 6px solid #27ae60;' : 'border-left: 6px solid #f39c12;';

                // 3. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡πà‡∏≤‡∏á HTML
                finalHtml += `
                    <div class="active-task-card" onclick="openRightSidebar('${post.id}')" style="${borderStyle} padding: 15px; background: white; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor:pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <span style="background: #eee; color: #666; font-size: 0.7em; padding: 2px 6px; border-radius: 4px;">#${refCode}</span>
                                <small style="color: #999; margin-left: 5px;">‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${postTime}</small>
                                <div style="font-weight: bold; font-size: 1.1em; color: #333; margin-top: 3px;">${post.title}</div>
                            </div>
                            <b style="color: #e67e22; font-size: 1.2em;">‡∏ø${post.budget}</b>
                        </div>
                        
                        <div style="font-size: 0.85em; color: #666; margin: 10px 0;">
                            üë§ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô: <span style="color: #11998e; font-weight: 600;">${post.acceptedBy || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ'}</span>
                        </div>
                        
                        <div class="task-progress-bar" style="height: 6px; background: #eee; border-radius: 10px; overflow: hidden; margin-bottom: 5px;">
                            <div class="progress-fill" style="width: ${progressPercent}%; height: 100%; background: #11998e; transition: 0.5s;"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                            <small style="color: #888; font-weight: bold;">
                                ‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ${completedStops}/${totalStops} ‡∏à‡∏∏‡∏î
                            </small>
                            ${actionBtnHtml}
                        </div>
                    </div>
                `;
            });

            listContainer.innerHTML = finalHtml;
        } else {
            listContainer.innerHTML = '<div style="text-align:center; padding: 30px; color: #999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà</div>';
        }
    } catch (e) {
        console.error(e);
        listContainer.innerHTML = '<p style="color:red; text-align:center;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>';
    }
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
window.onload = async function() {
    if (!myUsername) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏ô‡∏≠‡∏£‡πå");
        window.location.href = 'index.html';
        return;
    }
    await loadSavedLocations();        // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
    await loadActiveMerchantTasks();  // ‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
};


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô)
function openSaveStoreModal() {
    toggleMerchantSidebar();
    
    // üîç 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Flag 'isStore' ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠
    const existingStore = mySavedLocations.find(loc => loc.isStore === true);
    
    if (existingStore) {
        editingLocationId = existingStore._id;
        selectedLat = parseFloat(existingStore.lat);
        selectedLng = parseFloat(existingStore.lng);
        document.getElementById('map-loc-name').value = existingStore.label; // ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ
    } else {
        editingLocationId = null;
        document.getElementById('map-loc-name').value = ""; // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏≠‡∏á
    }

    mapMode = 'book';
    isStoreMode = true; // üö© ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î Confirm
    
    document.getElementById('map-modal').classList.remove('hidden');
    document.getElementById('map-extra-info').classList.remove('hidden');
	document.getElementById('map-label-name').innerHTML = '<i class="fas fa-store"></i> ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
    
    // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ
    const nameInput = document.getElementById('map-loc-name');
    nameInput.readOnly = false;
    nameInput.placeholder = "‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠...";

    document.querySelector('#map-modal h3').innerText = "üè† ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô (Base)";
    document.querySelector('#map-modal .btn-submit:first-child').innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô";
    
    initMap();
    if (existingStore && merchantMap) {
        merchantMap.setView([selectedLat, selectedLng], 17);
        updateMarker(selectedLat, selectedLng);
    }
}

function openStopMap(id) {
    currentTargetStopId = id;
    mapMode = 'stop';
    
    document.getElementById('map-modal').classList.remove('hidden');
    document.getElementById('map-extra-info').classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏Ñ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠
    
    document.querySelector('#map-modal h3').innerText = "üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô";
    document.querySelector('#map-modal .btn-submit:first-child').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ";
    
    initMap();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
function openAddLocationModal() {
    toggleMerchantSidebar(); 
    editingLocationId = null;
    mapMode = 'book';
	isStoreMode = false;
    
    document.getElementById('map-modal').classList.remove('hidden');
    document.getElementById('map-extra-info').classList.remove('hidden');
	document.getElementById('map-label-name').innerHTML = '<i class="fas fa-tag"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ A)';
    
    // üö© ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
    const nameInput = document.getElementById('map-loc-name');
    nameInput.value = "";
    nameInput.readOnly = false;
    nameInput.style.background = "white";

    document.getElementById('map-loc-voice').value = "";
    document.querySelector('#map-modal h3').innerText = "üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà";
    document.querySelector('#map-modal .btn-submit:first-child').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏™‡∏°‡∏∏‡∏î";
    
    initMap();
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î
function updateMarker(lat, lng) {
    selectedLat = lat;
    selectedLng = lng;
    if (currentMarker) merchantMap.removeLayer(currentMarker);
    currentMarker = L.marker([lat, lng], { draggable: true }).addTo(merchantMap);
    document.getElementById('map-coords-display').innerText = `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
}


async function loadSavedLocations() {
    const res = await fetch(`/api/merchant/locations?username=${myUsername}`);
    const data = await res.json();
    if (data.success) {
        mySavedLocations = data.locations;
        console.log("‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", mySavedLocations);
    }
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏™‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
let isStoreMode = false; 

async function confirmMapLocation() {
    if (!selectedLat || !selectedLng) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà");

    if (mapMode === 'stop') {
        // ... (Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ...
        return;
    }

    const name = document.getElementById('map-loc-name').value.trim();
    if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î");

    const payload = {
        username: myUsername,
        label: name,
        phone: document.getElementById('map-loc-phone').value,
        voiceKeyword: document.getElementById('map-loc-voice').value || name,
        lat: selectedLat,
        lng: selectedLng,
        isStore: isStoreMode // üö© ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server
    };

    let url = '/api/merchant/locations';
    let method = 'POST';
    if (editingLocationId) {
        url = `/api/merchant/locations/${editingLocationId}`;
        method = 'PUT';
    }

    const res = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (data.success) {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
        isStoreMode = false; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤
        await loadSavedLocations();
        closeMapModal();
    }
}

function closeMapModal() {
    document.getElementById('map-modal').classList.add('hidden');
}


    // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
    function addNewStop() {
    stopCount++;
    const container = document.getElementById('stops-container');
    const isPickup = (document.querySelectorAll('.stop-item').length === 0);
    const themeColor = isPickup ? "#27ae60" : "#11998e";
    const bgColor = isPickup ? "#f0fff4" : "#f0f7f7";
    const labelTitle = isPickup ? "üü¢ ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (Pickup)" : "üìç ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô (Drop-off)";

    const stopHtml = `
        <div class="stop-item" id="stop-${stopCount}" style="border-left: 6px solid ${themeColor}; background-color: ${bgColor}; padding: 15px; border-radius: 12px; margin-bottom: 12px; position: relative;">
            <span class="remove-stop" onclick="removeStop(${stopCount})"><i class="fas fa-times-circle"></i></span>
            
            <label style="color: ${themeColor}; font-weight: bold;">${labelTitle} <span class="stop-display-number"></span></label>

            <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." class="stop-label" id="label-${stopCount}" 
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px;">
            
            <input type="tel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ)..." id="phone-${stopCount}" 
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 5px;">

            <div id="coords-display-${stopCount}" style="font-size: 0.7em; color: #999; margin-bottom: 10px;">‡∏û‡∏¥‡∏Å‡∏±‡∏î: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏</div>
            
            <div style="display: flex; gap: 6px;">
                <button class="btn-add-stop" onclick="openStopMap(${stopCount})"><i class="fas fa-map"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
                <button class="btn-add-stop" onclick="showSavedLocationsModal(${stopCount})"><i class="fas fa-bookmark"></i> ‡∏à‡∏≤‡∏Å‡∏™‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</button>
            </div>

            <input type="hidden" id="lat-${stopCount}">
            <input type="hidden" id="lng-${stopCount}">
        </div>
    `;
    container.insertAdjacentHTML('beforeend', stopHtml);
    reorderStops();
}

function reorderStops() {
    const stops = document.querySelectorAll('.stop-item');
    stops.forEach((stop, index) => {
        const isPickup = (index === 0);
        
        // üö© ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å .stop-number ‡πÄ‡∏õ‡πá‡∏ô .stop-display-number ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö HTML
        const displayNum = stop.querySelector('.stop-display-number'); 
        const label = stop.querySelector('label');
        
        if (isPickup) {
            if (displayNum) displayNum.innerText = ""; 
            label.innerHTML = "üü¢ ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (Pickup)";
            label.style.color = "#27ae60";
            stop.style.borderLeftColor = "#27ae60";
        } else {
            if (displayNum) displayNum.innerText = index; // ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà 1, 2, 3...
            label.innerHTML = `üìç ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${index}`;
            label.style.color = "#11998e";
            stop.style.borderLeftColor = "#11998e";
        }
    });

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ Preview ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    updateTitlePreview();
}

    function removeStop(id) {
        document.getElementById(`stop-${id}`).remove();
        reorderStops();
    }

    function updateTitlePreview() {
    const category = document.getElementById('task-category').value;
    const totalStops = document.querySelectorAll('.stop-item').length;
    
    const deliveryStops = totalStops > 1 ? totalStops - 1 : 0;
    
    // üö© ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
    const finalTitle = `${category} (‡∏™‡πà‡∏á ${deliveryStops} ‡∏à‡∏∏‡∏î)`;
    
    const previewEl = document.getElementById('title-preview');
    if (previewEl) {
        previewEl.innerText = finalTitle;
    }

    return finalTitle; // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß
}

    // 3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (Saved Locations)
    function saveToMyBook(id) {
        const label = document.getElementById(`label-${id}`).value;
        const lat = document.getElementById(`lat-${id}`).value;
        const lng = document.getElementById(`lng-${id}`).value;
        if (!label || !lat) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô");
        
        mySavedLocations.push({ label, lat, lng });
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏™‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
    }

    function showSavedLocationsModal(stopId) {
    currentTargetStopId = stopId;
    const listContent = document.getElementById('saved-list-content');
    listContent.innerHTML = "";

    // üö© ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢
    // (‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏µ‡∏Å‡∏≤‡∏£ loc.isStore !== true ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ)
    const selectableLocations = mySavedLocations; 

    if (selectableLocations.length === 0) {
        listContent.innerHTML = "<p style='text-align:center; color:#999;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>";
    } else {
        selectableLocations.forEach((loc) => {
            const originalIndex = mySavedLocations.findIndex(l => l._id === loc._id);
            
            // üö© ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏´‡∏°‡∏∏‡∏î)
            const iconClass = loc.isStore ? 'fa-store' : 'fa-map-pin';
            const iconColor = loc.isStore ? '#11998e' : '#f39c12';
            const storeTag = loc.isStore ? ' <span style="font-size:0.7em; background:#e8f5e9; color:#11998e; padding:2px 6px; border-radius:10px; font-weight:normal;">(‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤)</span>' : '';

            listContent.innerHTML += `
                <div onclick="selectLocation(${originalIndex})" style="padding: 12px; border-bottom: 1px solid #eee; cursor: pointer;">
                    <i class="fas ${iconClass}" style="color:${iconColor}; width: 20px;"></i> 
                    <b>${loc.label}</b> ${storeTag}<br>
                    <small style="color:#888;">‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${parseFloat(loc.lat).toFixed(4)}, ${parseFloat(loc.lng).toFixed(4)}</small>
                </div>`;
        });
    }
    document.getElementById('saved-locations-modal').classList.remove('hidden');
}

    function selectLocation(index) {
    const selected = mySavedLocations[index];
    const id = currentTargetStopId;
    document.getElementById(`label-${id}`).value = selected.label;
    document.getElementById(`phone-${id}`).value = selected.phone || ""; // üö© ‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    document.getElementById(`lat-${id}`).value = selected.lat;
    document.getElementById(`lng-${id}`).value = selected.lng;
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏ó‡∏≤‡πÜ
    document.getElementById(`coords-display-${id}`).innerText = `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${parseFloat(selected.lat).toFixed(5)}, ${parseFloat(selected.lng).toFixed(5)}`;
    closeSavedModal();
}

    function closeSavedModal() {
        document.getElementById('saved-locations-modal').classList.add('hidden');
    }


    // 4. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô
    async function postMerchantTask() {
    const btn = document.getElementById('submit-btn');
    
    // üö© 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    btn.disabled = true;
    btn.style.opacity = "0.6";
    btn.style.cursor = "not-allowed";
    
    let timeLeft = 10;
    const originalContent = btn.innerHTML; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ (‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô + ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)
    
    const timer = setInterval(() => {
        if (timeLeft <= 0) {
            clearInterval(timer);
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.style.cursor = "pointer";
            btn.innerHTML = originalContent; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°
        } else {
            btn.innerHTML = `<i class="fas fa-hourglass-half"></i> ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà (${timeLeft}s)`;
            timeLeft--;
        }
    }, 1000);

    // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
    const finalTitle = updateTitlePreview();
    const stops = [];
    const stopElements = document.querySelectorAll('.stop-item');

    if (stopElements.length === 0) {
        // ‡∏´‡∏≤‡∏Å error ‡πÉ‡∏´‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        clearInterval(timer);
        btn.disabled = false;
        btn.style.opacity = "1";
        btn.innerHTML = originalContent;
        return alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏à‡∏∏‡∏î");
    }

    let hasError = false;
    stopElements.forEach((el, index) => {
        const id = el.id.split('-')[1];
        const label = document.getElementById(`label-${id}`).value;
        const phone = document.getElementById(`phone-${id}`).value;
        const lat = document.getElementById(`lat-${id}`).value;
        const lng = document.getElementById(`lng-${id}`).value;

        if (!lat || !lng) {
            hasError = true;
            return;
        }

        stops.push({
            step: index + 1,
            label: label || (index === 0 ? "‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô" : `‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà ${index}`),
            phone: phone,
            lat: parseFloat(lat),
            lng: parseFloat(lng),
            status: 'pending'
        });
    });

    if (hasError) {
        clearInterval(timer);
        btn.disabled = false;
        btn.style.opacity = "1";
        btn.innerHTML = originalContent;
        return alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏á‡∏≤‡∏ô");
    }

    const formData = new FormData();
    formData.append('author', myUsername);
    formData.append('category', 'task');
    formData.append('title', finalTitle);
    formData.append('content', document.getElementById('task-desc').value);
    formData.append('budget', document.getElementById('task-budget').value || 0);
    formData.append('isMerchantTask', true);
    formData.append('stops', JSON.stringify(stops));
    const mainLocation = { lat: stops[0].lat, lng: stops[0].lng };
    formData.append('location', JSON.stringify(mainLocation));

    try {
        const res = await fetch('/api/posts', {
            method: 'POST',
            body: formData
        });

        const data = await res.json();

        if (data.success) {
            alert("üöÄ ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
            window.location.href = 'index.html'; 
        } else {
            alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + data.error);
            // ‡∏Å‡∏£‡∏ì‡∏µ error ‡∏à‡∏≤‡∏Å server ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
            clearInterval(timer);
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.innerHTML = originalContent;
        }
    } catch (error) {
        console.error("Post Error:", error);
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Server ‡πÑ‡∏î‡πâ");
        clearInterval(timer);
        btn.disabled = false;
        btn.style.opacity = "1";
        btn.innerHTML = originalContent;
    }
}
	
	
	
	// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ß‡πà‡∏≤‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏´‡∏°
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognition) {
    const recognition = new SpeechRecognition();
    recognition.lang = 'th-TH'; // ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    recognition.interimResults = false;

    function startVoiceCommand() {
        recognition.start();
        document.getElementById('voice-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...';
        document.getElementById('voice-btn').style.background = "#e67e22";
    }

    recognition.onresult = (event) => {
        const text = event.results[0][0].transcript;
        console.log("‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:", text);
        processVoiceOrder(text); // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        resetVoiceBtn();
    };

    recognition.onerror = () => {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡∏Ñ‡πå");
        resetVoiceBtn();
    };

    function resetVoiceBtn() {
        document.getElementById('voice-btn').innerHTML = '<i class="fas fa-play"></i> ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô';
        document.getElementById('voice-btn').style.background = "#f39c12";
    }
}

// --- ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö: ‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á ---
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
function processVoiceOrder(speechText) {
    console.log("AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏à‡∏£‡∏¥‡∏á:", speechText);
    
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡∏°‡πà
    lastVoiceAnalysis = null;

    // 1. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô (Category) - ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î
    let category = "‡∏™‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"; 
    if (speechText.includes("‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£") || speechText.includes("‡∏™‡πà‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢")) {
        category = "‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£";
    }

    // 2. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Price) 
    // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà: ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤ "‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ä‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢" ‡∏ó‡∏µ‡πà‡∏û‡∏π‡∏î ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤
    let budget = "0";
    const allNumbers = speechText.match(/\d+/g); // ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Array
    if (allNumbers && allNumbers.length > 0) {
        budget = allNumbers[allNumbers.length - 1]; // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
    }

    // 3. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏¥‡∏Å‡∏±‡∏î (Locations)
    let foundStops = [];
    
    // ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡∏û‡∏π‡∏î‡∏≠‡∏≠‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
    const cleanSpeech = speechText.replace(/\s+/g, '');

    mySavedLocations.forEach(loc => {
        const keyword = (loc.voiceKeyword || loc.label).replace(/\s+/g, '');
        
        // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡∏û‡∏π‡∏î ‡∏°‡∏µ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà
        if (cleanSpeech.includes(keyword)) {
            // ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö 1, 2, 3
            foundStops.push({
                ...loc,
                indexInSpeech: cleanSpeech.indexOf(keyword)
            });
        }
    });

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≥‡∏û‡∏π‡∏î (‡πÉ‡∏Ñ‡∏£‡∏û‡∏π‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏∏‡∏î‡πÅ‡∏£‡∏Å)
    foundStops.sort((a, b) => a.indexInSpeech - b.indexInSpeech);

    // 4. ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal
    lastVoiceAnalysis = {
        category: category,
        title: `${category} ${foundStops.length} ‡∏à‡∏∏‡∏î`,
        stops: foundStops,
        budget: budget
    };

    // 5. ‡∏™‡∏±‡πà‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
    showVoiceSummaryModal();
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡∏£‡∏≠‡∏Å Keyword ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î
function startVoiceForKeyword(btn) { // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ btn ‡∏°‡∏≤‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    if (!SpeechRecognition) return alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
    
    const voiceRec = new SpeechRecognition();
    voiceRec.lang = 'th-TH';
    
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏ô
    
    voiceRec.start();
    
    voiceRec.onresult = (event) => {
        const text = event.results[0][0].transcript;
        document.getElementById('map-loc-voice').value = text.replace(/\s+/g, '');
        btn.innerHTML = originalContent; // ‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    };
    
    voiceRec.onerror = () => {
        btn.innerHTML = originalContent; // ‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ Error
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏û‡∏π‡∏î‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
    };
}



function showVoiceSummaryModal() {
    const data = lastVoiceAnalysis;
    if (!data) return;

    document.getElementById('sum-title').innerText = data.title;
    document.getElementById('sum-budget').innerText = Number(data.budget).toLocaleString();

    const stopsContainer = document.getElementById('sum-stops');
    stopsContainer.innerHTML = "";

    if (data.stops.length > 0) {
        data.stops.forEach((s, i) => {
            const isPickup = (i === 0);
            const icon = isPickup ? "fa-store" : "fa-box";
            const color = isPickup ? "#27ae60" : "#11998e";
            const typeText = isPickup ? "‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á/‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö" : `‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà ${i}`;

            stopsContainer.innerHTML += `
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px; padding: 12px; background: white; border-radius: 10px; border: 1px solid ${isPickup ? color : '#eee'};">
                    <div style="background: ${color}; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9em;">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.75em; color: ${color}; font-weight: bold;">${typeText}</div>
                        <div style="font-weight: bold; color: #333;">${s.label}</div>
                    </div>
                </div>
            `;
        });
    } else {
        stopsContainer.innerHTML = `<div style="color: red; text-align: center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î</div>`;
    }

    document.getElementById('voice-summary-modal').classList.remove('hidden');
}


function confirmVoiceSummary() {
    const data = lastVoiceAnalysis;
    if (!data) return;

    // 1. ‡πÄ‡∏ï‡∏¥‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
    document.getElementById('task-category').value = data.category;
    document.getElementById('task-budget').value = data.budget;

    // 2. ‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
    const container = document.getElementById('stops-container');
    container.innerHTML = "";
    stopCount = 0; 

    // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà AI ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö
    if (data.stops && data.stops.length > 0) {
        data.stops.forEach((stop, index) => {
            addNewStop(); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á HTML
            
            const currentId = stopCount; 
            
            // üö© ‡πÉ‡∏ä‡πâ setTimeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Element
            setTimeout(() => {
                const labelInput = document.getElementById(`label-${currentId}`);
                const latInput = document.getElementById(`lat-${currentId}`);
                const lngInput = document.getElementById(`lng-${currentId}`);
                const phoneInput = document.getElementById(`phone-${currentId}`);
                const statusLabel = document.getElementById(`loc-status-${currentId}`);
                const coordsDisplay = document.getElementById(`coords-display-${currentId}`);

                // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ Element ‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)
                if (labelInput) labelInput.value = stop.label;
                if (latInput) latInput.value = stop.lat;
                if (lngInput) lngInput.value = stop.lng;
                if (phoneInput) phoneInput.value = stop.phone || "";

                if (coordsDisplay) {
                    coordsDisplay.innerText = `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${parseFloat(stop.lat).toFixed(5)}, ${parseFloat(stop.lng).toFixed(5)}`;
                }
                
                if (statusLabel) {
                    if (index === 0) {
                        statusLabel.innerText = "‚úÖ ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (AI)";
                        statusLabel.style.color = "#27ae60";
                    } else {
                        statusLabel.innerText = `‚úÖ ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${index} (AI)`;
                        statusLabel.style.color = "#11998e";
                    }
                }
            }, 0);
        });
    } else {
        addNewStop();
    }

    // 4. ‡∏™‡∏±‡πà‡∏á‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö Loop)
    setTimeout(() => reorderStops(), 50); 
    
    closeVoiceSummary();
    console.log("‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å AI ‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏Å‡∏•‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
}

function closeVoiceSummary() {
    document.getElementById('voice-summary-modal').classList.add('hidden');
}




// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
function openManageLocationsModal() {
    toggleMerchantSidebar(); // ‡∏õ‡∏¥‡∏î Sidebar
    renderManageList();
    document.getElementById('manage-locations-modal').classList.remove('hidden');
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Render)
function renderManageList() {
    const container = document.getElementById('manage-list-container');
    container.innerHTML = "";

    // üö© ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô) ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏°
    const filteredList = mySavedLocations.filter(loc => 
        loc.isStore !== true && loc.label.trim() !== "‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô"
    );

    if (filteredList.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding: 20px; color: #999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</div>`;
        return;
    }

    filteredList.forEach((loc) => {
        const actualIndex = mySavedLocations.findIndex(l => l._id === loc._id);
        container.innerHTML += `
            <div class="manage-item" style="cursor: pointer;" onclick="editLocation(${actualIndex})">
                <div class="manage-info">
                    <strong style="color: #11998e;">${loc.label}</strong><br>
                    <small><i class="fas fa-phone"></i> ${loc.phone || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå'}</small>
                </div>
                <div class="manage-actions">
                    <button class="btn-delete" onclick="event.stopPropagation(); deleteLocation(${actualIndex})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>`;
    });
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î
async function deleteLocation(index) {
    const loc = mySavedLocations[index];
    if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${loc.label}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
        const res = await fetch(`/api/merchant/locations/${loc._id}`, {
            method: 'DELETE'
        });
        const data = await res.json();
        if (data.success) {
            mySavedLocations.splice(index, 1);
            renderManageList();
            alert("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        }
    }
}

function editLocation(index) {
    const loc = mySavedLocations[index];
    if (!loc) return;
    
    editingLocationId = loc._id; // üö© ‡πÄ‡∏Å‡πá‡∏ö ID ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≠‡∏ô PUT (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)
    
    // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏•‡∏¥‡∏™‡∏ï‡πå ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    closeManageModal();
    document.getElementById('map-modal').classList.remove('hidden');
    
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏°
    document.querySelector('#map-modal h3').innerText = "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏¥‡∏Å‡∏±‡∏î";
    document.querySelector('#map-modal .btn-submit').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    initMap();

    // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å
    document.getElementById('map-loc-name').value = loc.label;
    document.getElementById('map-loc-voice').value = loc.voiceKeyword || "";

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
    const lat = parseFloat(loc.lat);
    const lng = parseFloat(loc.lng);
    
    merchantMap.setView([lat, lng], 17);
    updateMarker(lat, lng);
    
    // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î Modal
    setTimeout(() => {
        merchantMap.invalidateSize();
    }, 300);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
function initMap() {
    if (merchantMap) {
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏Ñ‡πà‡∏™‡∏±‡πà‡∏á‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
        goToCurrentLocation();
        return;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    merchantMap = L.map('map-container').setView([13.7563, 100.5018], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(merchantMap);

    merchantMap.on('click', function(e) {
        updateMarker(e.latlng.lat, e.latlng.lng);
    });

    // ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à
    goToCurrentLocation();
}

function goToCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            merchantMap.setView([lat, lng], 16);
            updateMarker(lat, lng);
            setTimeout(() => merchantMap.invalidateSize(), 200);
        }, (err) => {
            console.warn("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï");
        });
    }
}



//  ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal
function closeManageModal() {
    document.getElementById('manage-locations-modal').classList.add('hidden');
}




	async function openRightSidebar(postId) {
    const res = await fetch(`/api/posts/${postId}`);
    const data = await res.json();
    if (!data.success) return;

    activeTaskInSidebar = data.post;
    document.getElementById('sidebar-task-title').innerText = `‡∏á‡∏≤‡∏ô: ${activeTaskInSidebar.title}`;
    
    // üö© ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Notif Tab)
    const notifList = document.getElementById('notif-list');
    notifList.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤
    
    if (activeTaskInSidebar.pendingRider) {
    notifList.innerHTML = `
        <div style="background: #fff4e5; padding: 15px; border-radius: 10px; border-left: 5px solid #f39c12;">
            <b style="color: #e67e22;"><i class="fas fa-user-tag"></i> ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</b><br>
            ‡∏Ñ‡∏∏‡∏ì <b>${activeTaskInSidebar.pendingRider}</b> ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ<br>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button onclick="approveRider('${postId}')" style="flex:1; background:#27ae60; color:white; border:none; padding:10px; border-radius:10px;">‡∏ï‡∏Å‡∏•‡∏á</button>
                <button onclick="rejectRider('${postId}')" style="flex:1; background:#dc3545; color:white; border:none; padding:10px; border-radius:10px;">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
            </div>
        </div>
        `;
    } else if (activeTaskInSidebar.acceptedBy) {
        notifList.innerHTML = `<p style="text-align:center; color:#27ae60;">üü¢ ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì ${activeTaskInSidebar.acceptedBy} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>`;
    } else {
        notifList.innerHTML = `<p style="text-align:center; color:#999;">‚åõ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</p>`;
    }

    renderSidebarDetails();
    loadSidebarChat(postId);
	socket.emit('join-post', postId);
    document.getElementById('right-sidebar').classList.add('active');
    document.getElementById('right-sidebar-overlay').classList.remove('hidden');
    switchTab('notif'); 
}

function closeRightSidebar() {
    document.getElementById('right-sidebar').classList.remove('active');
    document.getElementById('right-sidebar-overlay').classList.add('hidden');
    activeTaskInSidebar = null;
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
    
    document.getElementById(`tab-${tabName}`).classList.remove('hidden');
    // ‡∏´‡∏≤ Tab Item ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö tabName ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà class active (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ä‡πà‡∏ô index)
    const tabs = ['notif', 'details', 'chat'];
    document.querySelectorAll('.tab-item')[tabs.indexOf(tabName)].classList.add('active');
}

function renderSidebarDetails() {
    const container = document.getElementById('sidebar-details-content');
    let html = '';
    activeTaskInSidebar.stops.forEach((stop, i) => {
        const isDone = stop.status === 'success';
        html += `
            <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; opacity: ${isDone ? 0.5 : 1}">
                <i class="fas ${isDone ? 'fa-check-circle' : 'fa-circle'}" style="color: ${isDone ? '#27ae60' : '#ccc'}"></i>
                <div>
                    <div style="font-weight: bold; font-size: 0.9em;">${i === 0 ? 'üè† ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á' : 'üìç ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà '+i}</div>
                    <div style="font-size: 0.85em;">${stop.label}</div>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

// ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ä‡∏ó (‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö post.html)
async function loadSidebarChat(postId) {
    const chatBox = document.getElementById('chat-box');
    chatBox.innerHTML = '<small style="color:#999">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...</small>';
    
    const res = await fetch(`/api/posts/${postId}/comments`); // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÉ‡∏ä‡πâ API ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ä‡∏ó
    const comments = await res.json();
    
    chatBox.innerHTML = '';
    comments.forEach(msg => {
        const isMe = msg.author === myUsername;
        chatBox.innerHTML += `
            <div class="chat-msg ${isMe ? 'msg-me' : 'msg-them'}">
                ${msg.text}
            </div>
        `;
    });
    chatBox.scrollTop = chatBox.scrollHeight;
}

async function sendSidebarChat() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î
    if (!text || !activeTaskInSidebar) return;

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏´‡∏≤ Server
    try {
        const res = await fetch(`/api/posts/${activeTaskInSidebar.id}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ author: myUsername, text: text })
        });

        if (res.ok) {
            // ‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠ 
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å loadSidebarChat() ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Socket ‡∏à‡∏∞‡∏î‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÄ‡∏≠‡∏á
            input.value = ''; 
        }
    } catch (e) {
        console.error("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", e);
    }
}


async function approveRider(postId) {
    if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏Å‡∏•‡∏á‡πÉ‡∏´‡πâ Rider ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
    
    try {
        const res = await fetch(`/api/posts/${postId}/approve-rider`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
            alert("‚úÖ ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            loadActiveMerchantTasks(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
        }
    } catch (e) { alert("Error"); }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå
async function rejectRider(postId) {
    if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≤‡∏Å‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
    
    try {
        const res = await fetch(`/api/posts/${postId}/reject-rider`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
            alert("‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß");
            closeRightSidebar(); // ‡∏õ‡∏¥‡∏î‡πÅ‡∏ñ‡∏ö‡∏Ç‡∏ß‡∏≤
            loadActiveMerchantTasks(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        }
    } catch (e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
}










// üîî ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡∏î "‡∏Ç‡∏≠‡∏á‡∏≤‡∏ô"
socket.on('rider-applied', (data) => {
    // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° "‡∏ï‡∏Å‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏á‡∏≤‡∏ô" ‡∏õ‡∏£‡∏≤‡∏Å‡∏è
    loadActiveMerchantTasks();
    
    // 2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Sidebar ‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô Tab Notif
    if (activeTaskInSidebar && activeTaskInSidebar.id === data.postId) {
        const notifList = document.getElementById('notif-list');
        notifList.innerHTML = `
            <div style="background: #fff4e5; padding: 15px; border-radius: 10px; border-left: 5px solid #f39c12; margin-bottom: 10px;">
                <b style="color: #e67e22;"><i class="fas fa-user-tag"></i> ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà!</b><br>
                ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå <b>${data.riderName}</b> ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ<br>
                <button onclick="approveRider('${data.postId}')" style="margin-top:10px; background:#27ae60; color:white; border:none; padding:8px 15px; border-radius:20px; width:100%;">‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏á‡∏≤‡∏ô</button>
            </div>
        ` + notifList.innerHTML;
    }
});

// üí¨ ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà" (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏´‡πá‡∏ô)
socket.on('new-comment', (data) => {
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (activeTaskInSidebar && activeTaskInSidebar.id === data.postId) {
        
        const chatBox = document.getElementById('chat-box');
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô
        const isMe = data.comment.author === myUsername;
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
        const newMsgHtml = `
            <div class="chat-msg ${isMe ? 'msg-me' : 'msg-them'}">
                ${data.comment.text}
            </div>
        `;
        
        // ‡πÅ‡∏ó‡∏£‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        chatBox.insertAdjacentHTML('beforeend', newMsgHtml);
        
        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô ScrollBar ‡∏•‡∏á‡πÑ‡∏õ‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        chatBox.scrollTop = chatBox.scrollHeight;
    }
});


</script>
	
	
	<div id="saved-locations-modal" class="modal-overlay hidden" style="z-index: 6000;">
    <div class="modal-box" style="max-width: 400px;">
        <h3>üîñ ‡∏™‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
        <div id="saved-list-content" style="max-height: 300px; overflow-y: auto; text-align: left;">
            </div>
        <button class="sidebar-btn" onclick="closeSavedModal()" style="margin-top: 15px; background: #eee;">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>




	<div id="map-modal" class="modal-overlay hidden" style="z-index: 8000;">
    <div class="modal-box" style="max-width: 500px; padding: 0; overflow: hidden;">
        <div style="background: #11998e; color: white; padding: 15px; text-align: center;">
            <h3 style="margin: 0;">üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î</h3>
        </div>
        
        <div id="map-container" style="height: 250px; width: 100%;"></div>

        <div style="padding: 20px; padding-bottom: 30px;"> 
            <div id="map-extra-info">
                <label id="map-label-name"><i class="fas fa-tag"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ A)</label>
                <input type="text" id="map-loc-name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà...">
				
				<label><i class="fas fa-phone"></i> ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
				<input type="tel" id="map-loc-phone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 081-234-5678">

                <label><i class="fas fa-microphone"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Keyword ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô)</label>
                <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                    <input type="text" id="map-loc-voice" placeholder="‡∏û‡∏π‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß" style="margin-bottom: 0;">
                    <button onclick="startVoiceForKeyword(this)" style="background: #f39c12; color: white; border: none; border-radius: 8px; width: 50px; cursor: pointer;">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
            </div>
            
            <p id="map-coords-display" style="font-size: 0.8em; color: #888; margin-bottom: 15px;">
                ‡∏û‡∏¥‡∏Å‡∏±‡∏î: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            </p>

            <div style="display: flex; gap: 10px;">
                <button class="btn-submit" onclick="confirmMapLocation()" style="flex: 2; border-radius: 8px;">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î
                </button>
                <button class="btn-submit" onclick="closeMapModal()" style="flex: 1; background: #999; border-radius: 8px;">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>
</div>



	
	<div id="manage-locations-modal" class="modal-overlay hidden" style="z-index: 8500;">
    <div class="modal-box" style="max-width: 500px; width: 95%;">
        <div style="background: #11998e; color: white; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 15px 15px 0 0;">
            <h3 style="margin: 0;"><i class="fas fa-list"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏Å‡∏±‡∏î</h3>
        </div>
        
        <div id="manage-list-container" style="max-height: 400px; overflow-y: auto;">
            </div>

        <button class="btn-submit" onclick="closeManageModal()" style="background: #999; margin-top: 20px; border-radius: 8px;">
            ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
        </button>
    </div>
</div>




		<div id="voice-summary-modal" class="modal-overlay hidden" style="z-index: 9999;">
    <div class="modal-box" style="max-width: 450px; background: #fdfdfd;">
        <div style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white; padding: 20px; text-align: center;">
            <i class="fas fa-robot" style="font-size: 2em; margin-bottom: 10px;"></i>
            <h3 style="margin: 0; font-weight: 600;">AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
            <p style="margin: 5px 0 0 0; font-size: 0.85em; opacity: 0.9;">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</p>
        </div>

        <div style="padding: 20px;">
            <div class="summary-label"><i class="fas fa-file-signature"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</div>
            <div id="sum-title" style="background: #fff; border: 1px solid #ddd; padding: 12px; border-radius: 10px; font-weight: bold; color: #11998e; margin-bottom: 20px;">
                -
            </div>

            <div class="summary-label"><i class="fas fa-map-marked-alt"></i> ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö</div>
            <div id="sum-stops" style="margin-bottom: 20px;">
                </div>

            <div style="background: #fff4e5; padding: 15px; border-radius: 12px; border: 1px dashed #f39c12; text-align: center; margin-bottom: 25px;">
                <div class="summary-label" style="justify-content: center;"><i class="fas fa-coins"></i> ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏à‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô (‡∏ö‡∏≤‡∏ó)</div>
                <div style="font-size: 2em; color: #e67e22; font-weight: bold;">
                    <small style="font-size: 0.5em; vertical-align: middle;">‡∏ø</small> <span id="sum-budget">0</span>
                </div>
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="btn-submit" onclick="confirmVoiceSummary()" style="flex: 2; height: 55px; box-shadow: 0 4px 12px rgba(17,153,142,0.2);">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ
                </button>
                <button class="btn-submit" onclick="closeVoiceSummary()" style="flex: 1; background: #eee; color: #666; height: 55px;">
                    ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>
    </div>
</div>






	<div id="right-sidebar" class="right-sidebar">
    <div class="sidebar-header" style="background: #11998e;">
        <span onclick="closeRightSidebar()" style="cursor:pointer;"><i class="fas fa-times"></i></span>
        <h3 id="sidebar-task-title" style="margin: 0; font-size: 1.1em;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h3>
    </div>
    
    <div class="tab-menu">
        <div class="tab-item active" onclick="switchTab('notif')"><i class="fas fa-bell"></i></div>
        <div class="tab-item" onclick="switchTab('details')"><i class="fas fa-info-circle"></i></div>
        <div class="tab-item" onclick="switchTab('chat')"><i class="fas fa-comments"></i></div>
    </div>

    <div id="tab-notif" class="tab-content">
        <h4><i class="fas fa-bell"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h4>
        <div id="notif-list"></div>
    </div>

    <div id="tab-details" class="tab-content hidden">
        <h4><i class="fas fa-list-ol"></i> ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</h4>
        <div id="sidebar-details-content"></div>
    </div>

    <div id="tab-chat" class="tab-content hidden" style="display: flex; flex-direction: column; height: 100%;">
        <h4><i class="fas fa-comments"></i> ‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå</h4>
        <div id="chat-box" style="flex-grow: 1; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 10px; margin-bottom: 10px;">
            </div>
        <div style="display: flex; gap: 5px;">
            <input type="text" id="chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." style="margin-bottom: 0;">
            <button onclick="sendSidebarChat()" style="width: 50px; background: #11998e; color: white; border: none; border-radius: 8px;">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>
<div id="right-sidebar-overlay" class="sidebar-overlay hidden" onclick="closeRightSidebar()"></div>








</body>
</html>