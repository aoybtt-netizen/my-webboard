<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GedGo Marketplace | ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f4f7f6;
            --white: #ffffff;
            --text-muted: #7f8c8d;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
        }

        /* Header */
        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡πà‡∏ß‡∏ô Header ‡πÉ‡∏´‡∏°‡πà */
header {
    background: linear-gradient(135deg, #11998e, #38ef7d); /* ‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
    padding: 25px 20px;
    color: white;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom-left-radius: 20px;
    border-bottom-right-radius: 20px;
    display: block; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å flex ‡πÄ‡∏õ‡πá‡∏ô block ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ text-align: center ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Header */
.header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
}

.header-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
}





        /* Shop Grid */
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }

        /* Shop Card */
        .shop-card {
            background: var(--white);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            cursor: pointer;
            position: relative;
        }

        .shop-card:hover {
            transform: translateY(-5px);
        }

        .shop-image {
            width: 100%;
            height: 120px;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .shop-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .distance-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .shop-info {
            padding: 10px;
        }

        .shop-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .shop-meta {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .rating {
            color: #f1c40f;
        }

        /* Loading Overlay */
        #loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            width: 100%;
        }

    </style>
</head>
<body>

<header style="background: linear-gradient(135deg, #11998e, #38ef7d); padding: 20px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);">
    
    <div style="display: flex; justify-content: space-between; align-items: center; color: white;">
    <div onclick="history.back()" style="cursor:pointer; width: 40px;"><i class="fas fa-chevron-left"></i></div>
    
    <div id="currentZoneName" style="font-weight: 600; font-size: 1.2rem;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...</div>
    
    <div style="width: 40px; text-align: right;"><i class="fas fa-filter"></i></div>
</div>

</header>



<div class="container">
    <h3 style="margin-bottom: 15px;">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì</h3>
    
    <div id="loader">
        <i class="fas fa-circle-notch fa-spin fa-2x" style="color:var(--accent);"></i>
    </div>

    <div class="shop-grid" id="shopGrid">
        </div>
</div>

<script>
    let userCoords = null;
    let allShops = [];

    // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
    window.onload = async () => {
        // ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    userCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    loadShops();
                },
                (err) => {
                    console.warn("‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", err);
                    loadShops(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 0)
                }
            );
        } else {
            loadShops();
        }
    };

    // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å API
    async function loadShops() {
    if (!userCoords) {
        console.warn("‚ö†Ô∏è [Debug] ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (userCoords is null)");
        return; 
    }

    try {
        console.log(`üì° [Debug] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏¥‡∏Å‡∏±‡∏î: lat=${userCoords.lat}, lng=${userCoords.lng}`);
        
        const res = await fetch(`/api/marketplace/all-merchants?lat=${userCoords.lat}&lng=${userCoords.lng}`);
        
        if (!res.ok) {
            const errorText = await res.text();
            console.error(`‚ùå [Debug] Server ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö Error ${res.status}:`, errorText);
            throw new Error(`Server Error ${res.status}`);
        }

        const data = await res.json();
        console.log("‚úÖ [Debug] ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å API:", data);
        
        if (data.success) {
            const zoneDisplay = document.getElementById('currentZoneName');
            console.log("üìç [Debug] ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:", data.currentZone);
            
            if (data.currentZone) {
                zoneDisplay.innerText = `‡πÇ‡∏ã‡∏ô: ${data.currentZone}`;
            } else {
                zoneDisplay.innerText = "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (‡∏ô‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô)";
            }
            
            allShops = data.shops;
            console.log(`üõí [Debug] ‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${allShops.length} ‡∏£‡πâ‡∏≤‡∏ô`);
            renderShops(allShops);
        } else {
            console.warn("‚ö†Ô∏è [Debug] API ‡∏™‡πà‡∏á success: false", data.message);
        }
        document.getElementById('loader').style.display = 'none';
    } catch (e) {
        console.error("‚ùå [Debug] Fetch error:", e);
        document.getElementById('currentZoneName').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (Error)";
    }
}

    // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
    function renderShops(shops) {
        const grid = document.getElementById('shopGrid');
        grid.innerHTML = '';

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        if (userCoords) {
            shops.forEach(s => {
                s.distance = calculateDistance(userCoords.lat, userCoords.lng, s.lat, s.lng);
            });
            shops.sort((a, b) => a.distance - b.distance);
        }

        shops.forEach(s => {
            grid.innerHTML += `
                <div class="shop-card" onclick="goToShop('${s.username}')">
                    <div class="shop-image">
                        <img src="${s.shopImage || 'https://via.placeholder.com/150'}" alt="${s.shopName}">
                        <div class="distance-badge">
                            <i class="fas fa-location-arrow"></i> ${s.distance ? s.distance.toFixed(1) + ' ‡∏Å‡∏°.' : 'N/A'}
                        </div>
                    </div>
                    <div class="shop-info">
                        <div class="shop-name">${s.shopName || s.username}</div>
                        <div class="shop-meta">
                            <span class="rating"><i class="fas fa-star"></i> ${s.rating || '5.0'}</span>
                            <span>‚Ä¢ ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ${s.completedJobs || 0}</span>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    // 4. ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á Haversine (‡∏Å‡∏°.)
    function calculateDistance(lat1, lon1, lat2, lon2) {
        if (!lat1 || !lon1 || !lat2 || !lon2) return null;
        const R = 6371; // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÇ‡∏•‡∏Å
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // 5. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
    function filterShops() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allShops.filter(s => 
            (s.shopName && s.shopName.toLowerCase().includes(term)) || 
            s.username.toLowerCase().includes(term)
        );
        renderShops(filtered);
    }

    function goToShop(username) {
        // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
        window.location.href = `viewshop.html?merchant=${username}`;
    }
</script>

</body>
</html>