<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GedGo Marketplace | ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
	<script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f4f7f6;
            --white: #ffffff;
            --text-muted: #7f8c8d;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
        }

        /* Header */
        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡πà‡∏ß‡∏ô Header ‡πÉ‡∏´‡∏°‡πà */
header {
    background: linear-gradient(135deg, #11998e, #38ef7d); /* ‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
    padding: 25px 20px;
    color: white;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom-left-radius: 20px;
    border-bottom-right-radius: 20px;
    display: block; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å flex ‡πÄ‡∏õ‡πá‡∏ô block ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ text-align: center ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Header */
.header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
}

.header-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
}





        /* Shop Grid */
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }

        /* Shop Card */
        .shop-card {
            background: var(--white);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            cursor: pointer;
            position: relative;
        }

        .shop-card:hover {
            transform: translateY(-5px);
        }

        .shop-image {
            width: 100%;
            height: 120px;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .shop-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .distance-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .shop-info {
            padding: 10px;
        }

        .shop-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .shop-meta {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .rating {
            color: #f1c40f;
        }

        /* Loading Overlay */
        #loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            width: 100%;
        }
		
		
		
.menu-item-row {
    display: flex;
    justify-content: space-between;
    padding: 12px;
    border-bottom: 1px border-radius: 8px;
    border-bottom: 1px solid #eee;
    margin-bottom: 5px;
}
.menu-item-name { font-weight: 500; color: #333; }
.menu-item-price { font-weight: bold; color: #11998e; }


.product-modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000; /* ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ Header */
}

.product-modal-card {
    background: white;
    width: 90%;
    max-width: 450px;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: modalSlideUp 0.3s ease-out;
}

@keyframes modalSlideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.product-modal-header {
    padding: 20px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn-close-modal {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
}

.product-modal-body {
    padding: 20px;
    max-height: 70vh;
    overflow-y: auto;
}

/* ‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡πà‡∏≠‡∏ô Element */
.hidden {
    display: none !important;
}


    </style>
</head>
<body>

<header style="background: linear-gradient(135deg, #11998e, #38ef7d); padding: 20px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);">
    
    <div style="display: flex; justify-content: space-between; align-items: center; color: white;">
    <div onclick="history.back()" style="cursor:pointer; width: 40px;"><i class="fas fa-chevron-left"></i></div>
    
    <div id="currentZoneName" 
     data-i18n-key="shop_loading" 
     style="font-weight: 600; font-size: 1.2rem;">
     ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...
</div>
    
    <div id="user-balance-display" style="min-width: 80px; text-align: right; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-weight: bold;">
    <span id="top-balance">0.00</span> 
    <span id="top-currency">...</span>
</div>
</div>

</header>



<div class="container">
    <h3 data-i18n-key="shop_nearby" 
    style="margin-bottom: 15px;">
    ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì
</h3>
    
    <div id="loader">
        <i class="fas fa-circle-notch fa-spin fa-2x" style="color:var(--accent);"></i>
    </div>

    <div class="shop-grid" id="shopGrid">
        </div>
</div>

<script>
    let userCoords = null;
    let allShops = [];
	const socket = io();
	
	
	const currentLang = localStorage.getItem('preferredLanguage') || 'th';
				
const translations = {
    'th': {
        'shop_nearby': '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (‡∏ô‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô)',
        'shop_select': '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤',
        'shop_error': '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        'shop_loading': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
        'shop_distance': '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á',
        'shop_sold': '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
        'shop_open': '‡πÄ‡∏õ‡∏¥‡∏î',
        'shop_closed': '‡∏õ‡∏¥‡∏î',
        'msg_merchant_fee_info': '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
        'free_first_time': '‡∏ü‡∏£‡∏µ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å',
		'shop_loading': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...',
        'shop_nearby': '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì',
        'shop_select': '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤',
        'shop_error': '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
		'price_exclude_delivery': '* ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á',
		
    },
    'en': {
        'shop_nearby': 'Nearby Shops (Outside Zone)',
        'shop_select': 'Select Shop',
        'shop_error': 'An error occurred',
        'shop_loading': 'Loading...',
        'shop_distance': 'Distance',
        'shop_sold': 'Sold',
        'shop_open': 'Open',
        'shop_closed': 'Closed',
        'msg_merchant_fee_info': 'Processing Fee',
        'free_first_time': 'First time free',
		'shop_loading': 'Identifying location...',
        'shop_nearby': 'Recommended Shops Near You',
        'shop_select': 'Select Shop',
        'shop_error': 'An error occurred',
		'price_exclude_delivery': '* Prices exclude delivery fee',
		
    },
    'pt': {
        'shop_nearby': 'Lojas Pr√≥ximas (Fora da Zona)',
        'shop_select': 'Selecionar Loja',
        'shop_error': 'Ocorreu um erro',
        'shop_loading': 'Carregando...',
        'shop_distance': 'Dist√¢ncia',
        'shop_sold': 'Vendido',
        'shop_open': 'Aberto',
        'shop_closed': 'Fechado',
        'msg_merchant_fee_info': 'Taxa de processamento',
        'free_first_time': 'Primeira vez gr√°tis',
		'shop_loading': 'Identificando localiza√ß√£o...',
        'shop_nearby': 'Lojas Recomendadas Pr√≥ximas',
        'shop_select': 'Selecionar Loja',
        'shop_error': 'Ocorreu um erro',
		'price_exclude_delivery': '* Pre√ßos n√£o incluem taxa de entrega',
    }
};

function applyMerchantTranslations() {
    console.log(`[i18n] Applying translations for: ${currentLang}`);
    document.querySelectorAll('[data-i18n-key]').forEach(el => {
        const key = el.getAttribute('data-i18n-key');
        const translatedText = translations[currentLang]?.[key];

        if (translatedText) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = translatedText;
            } 
            else {
                const icon = el.querySelector('i');
                if (icon) {
                    el.innerHTML = '';
                    el.appendChild(icon);
                    el.insertAdjacentHTML('beforeend', ' ' + translatedText);
                } else {
                    el.innerText = translatedText;
                }
            }
        }
    });
}

window.addEventListener('DOMContentLoaded', () => {
    applyMerchantTranslations();
});

    // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
    window.onload = async () => {
        // ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    userCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    loadShops();
                },
                (err) => {
                    console.warn("‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", err);
                    loadShops(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 0)
                }
            );
        } else {
            loadShops();
        }
    };
	
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Marketplace
async function updateTopBalance(lat, lng) {
    try {
        const myUsername = localStorage.getItem('myUsername');
        if (!myUsername) return;

        // üö© 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô JSON string ‡πÅ‡∏•‡∏∞ Encode ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô URL
        const locationObj = JSON.stringify({ lat: lat, lng: lng });
        const locationParam = encodeURIComponent(locationObj);

        // üö© 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ API ‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Path ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° Parameter location)
        const res = await fetch(`/api/profile-details?username=${encodeURIComponent(myUsername)}&location=${locationParam}`);

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô SyntaxError (‡∏Å‡∏£‡∏ì‡∏µ Server ‡∏™‡πà‡∏á Error 404 ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤ HTML)
        const contentType = res.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
            console.error("üö® Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á JSON ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤");
            return;
        }

        const data = await res.json();

        // üö© 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ error ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        if (data && !data.error) {
            const balanceEl = document.getElementById('top-balance');
            const currencyEl = document.getElementById('top-currency');
            const zoneDisplay = document.getElementById('currentZoneName'); // ‡πÅ‡∏ñ‡∏°: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡∏ô‡∏î‡πâ‡∏ß‡∏¢

            if (balanceEl && currencyEl) {
                // üí° ‡πÉ‡∏ô API ‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ 'coins' ‡πÅ‡∏•‡∏∞‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ä‡πâ 'currency'
                const balanceValue = data.coins || 0;
                balanceEl.innerText = Number(balanceValue).toLocaleString(undefined, {minimumFractionDigits: 2});
                currencyEl.innerText = data.currency || 'USD';
            }

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ó‡∏µ‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà API ‡∏™‡πà‡∏á‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
            if (zoneDisplay && data.zoneName) {
                zoneDisplay.innerText = data.zoneName;
            }
        }
    } catch (e) {
        console.error("üö® Update Balance Error:", e);
    }
}


    // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å API
async function loadShops() {
    if (!userCoords) {
        console.warn("‚ö†Ô∏è [Debug] ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");
        return; 
    }

    try {
        const res = await fetch(`/api/marketplace/all-merchants?lat=${userCoords.lat}&lng=${userCoords.lng}`);
        
        if (!res.ok) {
            console.error(`‚ùå [Debug] Server Error ${res.status}`);
            throw new Error(`Server Error`);
        }
		if (userCoords) {
			updateTopBalance(userCoords.lat, userCoords.lng);
		}

        const data = await res.json();
        
        if (data.success) {
            const zoneDisplay = document.getElementById('currentZoneName');
            
            if (data.currentZone) {
                zoneDisplay.innerText = data.currentZone;
            } else {
                zoneDisplay.innerText = translations[currentLang].shop_nearby;
            }
            
            // üö© 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏à‡∏≤‡∏Å DB
            allShops = data.shops.map(shop => {
                const dist = calculateDistance(
                    userCoords.lat, 
                    userCoords.lng, 
                    shop.lat, 
                    shop.lng
                );
                return { ...shop, distance: dist };
            });

            // üö© 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å ‡∏ô‡πâ‡∏≠‡∏¢ ‡πÑ‡∏õ ‡∏°‡∏≤‡∏Å (‡πÉ‡∏Å‡∏•‡πâ -> ‡πÑ‡∏Å‡∏•)
            allShops.sort((a, b) => (a.distance || 0) - (b.distance || 0));

            renderShops(allShops);
        }
        document.getElementById('loader').style.display = 'none';
    } catch (e) {
        console.error("‚ùå [Debug] Fetch error:", e);
        document.getElementById('currentZoneName').innerText = 
            `${translations[currentLang].shop_select} (${translations[currentLang].shop_error})`;
    }
}

    // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
function renderShops(shops) {
    const grid = document.getElementById('shopGrid');
    grid.innerHTML = '';
    
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏°‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ
    const txtSold = translations[currentLang].shop_sold;

    shops.forEach(s => {
        grid.innerHTML += `
            <div class="shop-card" onclick="goToShop('${s.username}')">
                <div class="shop-image">
                    <img src="${s.shopImage || 'https://via.placeholder.com/150'}" alt="${s.shopName}">
                    <div class="distance-badge">
                        <i class="fas fa-location-arrow"></i> ${s.distance ? s.distance.toFixed(1) + ' km' : 'N/A'}
                    </div>
                </div>
                <div class="shop-info">
                    <div class="shop-name">${s.shopName || s.username}</div>
                    <div class="shop-meta">
                        <span class="rating"><i class="fas fa-star"></i> ${s.rating || '5.0'}</span>
                        <span>‚Ä¢ ${txtSold} ${s.completedJobs || 0}</span>
                    </div>
                </div>
            </div>
        `;
    });
}

    // 4. ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á Haversine (‡∏Å‡∏°.)
    function calculateDistance(lat1, lon1, lat2, lon2) {
        if (!lat1 || !lon1 || !lat2 || !lon2) return null;
        const R = 6371; // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÇ‡∏•‡∏Å
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // 5. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
    function filterShops() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput) {
        renderShops(allShops);
        return;
    }
    const term = searchInput.value.toLowerCase();
    
    const filtered = allShops.filter(s => 
        (s.shopName && s.shopName.toLowerCase().includes(term)) || 
        (s.username && s.username.toLowerCase().includes(term))
    );    
    renderShops(filtered);
}


	
	
	
// üö© ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö Real-time
socket.on('shop-status-changed', (data) => {
    const { username, isOpen, shopDetails } = data;

    if (isOpen) {
        const exists = allShops.find(s => s.username === username);
        if (!exists) {
            // üö© ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà
            const dist = calculateDistance(userCoords.lat, userCoords.lng, shopDetails.lat, shopDetails.lng);
            shopDetails.distance = dist;
            
            allShops.push(shopDetails);
        }
    } else {
        allShops = allShops.filter(s => s.username !== username);
    }

    // üö© ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    allShops.sort((a, b) => (a.distance || 0) - (b.distance || 0));

    if (typeof filterShops === 'function') {
        filterShops(); 
    } else {
        renderShops(allShops);
    }
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
function goToShop(username) {
    const shop = allShops.find(s => s.username === username);
    if (!shop) return;

    // 1. ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô
    document.getElementById('modalShopName').innerText = shop.shopName || shop.username;

    // üö© 2. ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ)
    const phoneLink = document.getElementById('modalShopPhone');
    if (shop.phone) {
        phoneLink.href = `tel:${shop.phone}`;
        phoneLink.querySelector('span').innerText = shop.phone;
        phoneLink.style.display = 'inline-block'; // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    } else {
        phoneLink.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
    }

    // üö© 3. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    const mapContent = document.getElementById('map-content');
    mapContent.innerHTML = `
        <iframe 
            width="100%" 
            height="100%" 
            frameborder="0" 
            style="border:0" 
            src="https://maps.google.com/maps?q=${shop.lat},${shop.lng}&hl=th&z=15&output=embed" 
            allowfullscreen>
        </iframe>
        <div onclick="window.open('https://www.google.com/maps/search/?api=1&query=${shop.lat},${shop.lng}', '_blank')" 
             style="position:absolute; top:0; left:0; width:100%; height:100%; cursor:pointer; background:transparent;">
        </div>
    `;

    // 4. ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const container = document.getElementById('menu-items-container');
    container.innerHTML = '';
    const currency = shop.zoneCurrency || 'USD';

    if (shop.products && shop.products.length > 0) {
        shop.products.forEach(item => {
            container.innerHTML += `
                <div class="menu-item-row" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                    <span class="menu-item-name">${item.name}</span>
                    <span class="menu-item-price" style="font-weight: bold; color: #11998e;">
                        ${Number(item.price).toLocaleString()} ${currency}
                    </span>
                </div>
            `;
        });
    } else {
        container.innerHTML = `<p style="text-align:center; color:#999; padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</p>`;
    }

    document.getElementById('shopMenuModal').classList.remove('hidden');
}

function closeShopMenuModal() {
    document.getElementById('shopMenuModal').classList.add('hidden');
}

</script>




<div id="shopMenuModal" class="product-modal-overlay hidden">
    <div class="product-modal-card">
        <div class="product-modal-header" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
            <div style="display: flex; flex-direction: column;">
                <h3 id="modalShopName" style="margin: 0;">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <a id="modalShopPhone" href="#" style="color: white; text-decoration: none; font-size: 0.9rem; margin-top: 4px;">
                    <i class="fas fa-phone-alt"></i> <span>-</span>
                </a>
            </div>
            <button class="btn-close-modal" onclick="closeShopMenuModal()">&times;</button>
        </div>
        
        <div class="product-modal-body">
            <div id="shop-mini-map" style="width: 100%; height: 140px; background: #eee; border-radius: 12px; margin-bottom: 15px; overflow: hidden; position: relative; border: 1px solid #ddd;">
    <div id="map-content" style="width: 100%; height: 100%;"></div>
</div>

            <div id="menu-items-container">
                </div>
            
            <p style="font-size: 0.8em; color: #888; text-align: center; margin-top: 15px;" data-i18n-key="price_exclude_delivery">
                * ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
            </p>
        </div>
    </div>
</div>



</body>
</html>