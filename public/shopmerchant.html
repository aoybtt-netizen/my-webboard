<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GedGo Marketplace | ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f4f7f6;
            --white: #ffffff;
            --text-muted: #7f8c8d;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
        }

        /* Header */
        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡πà‡∏ß‡∏ô Header ‡πÉ‡∏´‡∏°‡πà */
header {
    background: linear-gradient(135deg, #11998e, #38ef7d); /* ‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
    padding: 25px 20px;
    color: white;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom-left-radius: 20px;
    border-bottom-right-radius: 20px;
    display: block; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å flex ‡πÄ‡∏õ‡πá‡∏ô block ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ text-align: center ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Header */
.header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
}

.header-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
}





        /* Shop Grid */
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }

        /* Shop Card */
        .shop-card {
            background: var(--white);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            cursor: pointer;
            position: relative;
        }

        .shop-card:hover {
            transform: translateY(-5px);
        }

        .shop-image {
            width: 100%;
            height: 120px;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .shop-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .distance-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .shop-info {
            padding: 10px;
        }

        .shop-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .shop-meta {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .rating {
            color: #f1c40f;
        }

        /* Loading Overlay */
        #loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            width: 100%;
        }
		
		
		
.menu-item-row {
    display: flex;
    justify-content: space-between;
    padding: 12px;
    border-bottom: 1px border-radius: 8px;
    border-bottom: 1px solid #eee;
    margin-bottom: 5px;
}
.menu-item-name { font-weight: 500; color: #333; }
.menu-item-price { font-weight: bold; color: #11998e; }


.product-modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000; /* ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ Header */
}

.product-modal-card {
    background: white;
    width: 90%;
    max-width: 450px;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: modalSlideUp 0.3s ease-out;
}

@keyframes modalSlideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.product-modal-header {
    padding: 20px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn-close-modal {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
}

.product-modal-body {
    padding: 20px;
    max-height: 70vh;
    overflow-y: auto;
}

/* ‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡πà‡∏≠‡∏ô Element */
.hidden {
    display: none !important;
}

.swal2-container {
        z-index: 20000 !important;
    }
	
	

/* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢‡∏ï‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏ß‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ */
.floating-customer-btn {
    position: fixed;
    right: -10px;
    top: 60%; /* ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
    transform: translateY(-50%);
    background: linear-gradient(135deg, #11998e, #38ef7d);
    color: white;
    padding: 12px 15px 12px 20px;
    border-radius: 25px 0 0 25px;
    box-shadow: -2px 4px 10px rgba(0,0,0,0.2);
    z-index: 998;
    cursor: pointer;
    display: none; /* ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á */
    transition: all 0.3s ease;
}

.floating-customer-btn:hover {
    right: 0;
}

.customer-order-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.status-badge {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: bold;
}

.status-waiting { background: #fff4e5; color: #f39c12; }
.status-accepted { background: #e8f5e9; color: #2e7d32; }

.btn-cancel-order {
    background: #fff0f0;
    color: #e74c3c;
    border: 1px solid #ffcccc;
    padding: 6px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s;
}

.btn-cancel-order:hover {
    background: #e74c3c;
    color: white;
}

.customer-order-item:hover {
    background: #f9f9f9;
}




.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6); /* ‡∏™‡∏µ‡∏î‡∏≥‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á */
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 20000; /* ‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ Sidebar ‡πÅ‡∏ä‡∏ó */
    transition: opacity 0.3s ease;
}

/* ‡∏ã‡πà‡∏≠‡∏ô Modal */
.modal-overlay.hidden {
    display: none;
    pointer-events: none;
}

/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
.modal-content {
    background: white;
    padding: 25px;
    border-radius: 20px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.3);
    position: relative;
    animation: slideUp 0.3s ease-out;
}

/* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ï‡∏≠‡∏ô‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ */
@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏î‡∏≤‡∏ß */
.star-rating i {
    font-size: 2rem; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏î‡∏≤‡∏ß‡πÉ‡∏´‡∏ç‡πà‡πÜ ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢ */
    color: #ddd;
    cursor: pointer;
    margin: 0 5px;
    transition: transform 0.1s;
}

.star-rating i:active {
    transform: scale(1.3); /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏≠‡∏ô‡∏Å‡∏î */
}



    </style>
</head>
<body>

<header style="background: linear-gradient(135deg, #11998e, #38ef7d); padding: 20px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);">
    
    <div style="display: flex; justify-content: space-between; align-items: center; color: white;">
    <div onclick="safeBack()" style="cursor:pointer; width: 40px;">
    <i class="fas fa-chevron-left"></i>
</div>
    
    <div id="currentZoneName" 
     data-i18n-key="shop_loading" 
     style="font-weight: 600; font-size: 1.2rem;">
     ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...
</div>
    
    <div id="user-balance-display" style="min-width: 80px; text-align: right; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-weight: bold;">
    <span id="top-balance">0.00</span> 
    <span id="top-currency">...</span>
</div>
</div>

</header>



<div class="container">
    <h3 data-i18n-key="shop_nearby" 
    style="margin-bottom: 15px;">
    ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì
</h3>
    
    <div id="loader">
        <i class="fas fa-circle-notch fa-spin fa-2x" style="color:var(--accent);"></i>
    </div>

    <div class="shop-grid" id="shopGrid">
        </div>
</div>




<script>
    let userCoords = null;
    let allShops = [];
	const socket = io();
	let cart = {}; 
	let currentMerchantId = '';
	let lastTotalItemsPrice = 0;
	let currentShopCurrency = '';
	let currentZoneFee = 0;
	let currentSystemZone = 0;
	let myActiveOrders = [];
	let currentChatPostId = null;
	let merchantUser = "";
	let riderUser = "";
	
	let currentRatingOrderId = null;
	let ratings = { riderSat: 0, riderPolite: 0, merchantRate: 0 };
	const myUsername = localStorage.getItem('myUsername');
	if (myUsername) {
    socket.emit('register-user', myUsername);
    console.log(`üîå Socket connected as: ${myUsername}`);
	}
	
	const currentLang = localStorage.getItem('preferredLanguage') || 'th';
				
const translations = {
    'th': {
        'shop_nearby': '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (‡∏ô‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô)',
        'shop_select': '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤',
        'shop_error': '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        'shop_loading': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
        'shop_distance': '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á',
        'shop_sold': '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
        'shop_open': '‡πÄ‡∏õ‡∏¥‡∏î',
        'shop_closed': '‡∏õ‡∏¥‡∏î',
        'msg_merchant_fee_info': '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
        'free_first_time': '‡∏ü‡∏£‡∏µ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å',
		'shop_loading': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...',
        'shop_nearby': '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì',
        'shop_select': '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤',
        'shop_error': '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
		'price_exclude_delivery': '* ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á',
		'no_menu_items': '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ',
		'btn_checkout': '‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå',
		'order_summary': '‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠',
		'rider_wage': '‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå',
		'total_items': '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:',
		'total_all': '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:',
		'btn_confirm_order': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠',
		'confirm_payment_title': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô?',
		'subtotal_label': '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:',
		'rider_wage_label': '‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå:',
		'total_deduction_label': '‡∏¢‡∏≠‡∏î‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°:',
		'confirm_btn': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
		'bpconfirm_btn': 'Bypass To Finish Order',
		'cancel_btn': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
		'please_select_item': '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
		'order_success_title': '‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
		'order_success_text': '‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
		'payment_failed': '‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
		'connection_error': '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠',
		'total_label': '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:',
		'contact_phone_label': '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:',
		'my_orders_btn': '‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô',
		'my_orders_title': '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå',
		'status_waiting': '‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö',
        'status_accepted': '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß',
        'no_active_orders': '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
        'chat_wait_merchant': '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏ó',
        'confirm_cancel_title': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?',
        'confirm_cancel_text': '‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ (‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö)',
        'btn_confirm_cancel': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        'btn_back': '‡∏Å‡∏•‡∏±‡∏ö',
        'cancel_success': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        'cancel_failed': '‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
        'err_cancel_msg': '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ',
        'err_connection': '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á',
		'status_finished_rating': '‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à / ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô',
        'btn_rate_service': '‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô',
        'order_accepted_title': '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß!',
        'order_accepted_text': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì',
        'err_rating_incomplete': '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠',
        'msg_rating_success': '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô!',
		'confirm_delivery_title': '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß?',
        'confirm_delivery_text': '‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
		'alert_active_order_title': '‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà!',
        'alert_active_order_text': '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ',
    },
    'en': {
        'shop_nearby': 'Nearby Shops (Outside Zone)',
        'shop_select': 'Select Shop',
        'shop_error': 'An error occurred',
        'shop_loading': 'Loading...',
        'shop_distance': 'Distance',
        'shop_sold': 'Sold',
        'shop_open': 'Open',
        'shop_closed': 'Closed',
        'msg_merchant_fee_info': 'Processing Fee',
        'free_first_time': 'First time free',
		'shop_loading': 'Identifying location...',
        'shop_nearby': 'Recommended Shops Near You',
        'shop_select': 'Select Shop',
        'shop_error': 'An error occurred',
		'price_exclude_delivery': '* Prices exclude delivery fee',
		'no_menu_items': 'No menu items available at the moment.',
		'btn_checkout': 'Checkout',
		'order_summary': 'Order Summary',
		'rider_wage': 'Rider Wage',
		'total_items': 'Subtotal:',
		'total_all': 'Total Amount:',
		'btn_confirm_order': 'Confirm Order',
		'confirm_payment_title': 'Confirm Payment?',
		'subtotal_label': 'Subtotal:',
		'rider_wage_label': 'Rider Wage:',
		'total_deduction_label': 'Total Amount:',
		'confirm_btn': 'Confirm & Pay Now',
		'bpconfirm_btn': 'Bypass To Finish Order',
		'cancel_btn': 'Cancel',
		'please_select_item': 'Please select at least 1 item',
		'order_success_title': 'Order Successful!',
		'order_success_text': 'Payment has been processed',
		'payment_failed': 'Payment Failed',
		'connection_error': 'Connection Error',
		'total_label': 'Total:',
		'contact_phone_label': 'Contact Phone:',
		'my_orders_btn': 'My Orders',
		'my_orders_title': 'Order Tracking',
		'status_waiting': 'Waiting for Merchant',
        'status_accepted': 'Merchant Accepted',
        'no_active_orders': 'No active orders at the moment',
        'chat_wait_merchant': 'Please wait for merchant acceptance to start chatting',
        'confirm_cancel_title': 'Confirm Cancellation?',
        'confirm_cancel_text': 'Refund will be processed (system fees may apply)',
        'btn_confirm_cancel': 'Confirm Cancel',
        'btn_back': 'Back',
        'cancel_success': 'Cancelled successfully',
        'cancel_failed': 'Failed',
        'err_cancel_msg': 'Unable to cancel',
        'err_connection': 'Connection Error',
		'status_finished_rating': 'Delivered / Wait for Rating',
        'btn_rate_service': 'Rate Now',
        'order_accepted_title': 'Order Accepted!',
        'order_accepted_text': 'Preparing food and searching for rider...',
        'err_rating_incomplete': 'Please complete all rating categories',
        'msg_rating_success': 'Thank you for your feedback!',
		'confirm_delivery_title': 'Received your items?',
        'confirm_delivery_text': 'If you have received your order, you can confirm to finish the job.',
		'alert_active_order_title': 'Active Orders Remaining!',
        'alert_active_order_text': 'Please wait for your orders to complete or cancel them before leaving.',
    },
    'pt': {
        'shop_nearby': 'Lojas Pr√≥ximas (Fora da Zona)',
        'shop_select': 'Selecionar Loja',
        'shop_error': 'Ocorreu um erro',
        'shop_loading': 'Carregando...',
        'shop_distance': 'Dist√¢ncia',
        'shop_sold': 'Vendido',
        'shop_open': 'Aberto',
        'shop_closed': 'Fechado',
        'msg_merchant_fee_info': 'Taxa de processamento',
        'free_first_time': 'Primeira vez gr√°tis',
		'shop_loading': 'Identificando localiza√ß√£o...',
        'shop_nearby': 'Lojas Recomendadas Pr√≥ximas',
        'shop_select': 'Selecionar Loja',
        'shop_error': 'Ocorreu um erro',
		'price_exclude_delivery': '* Pre√ßos n√£o incluem taxa de entrega',
		'no_menu_items': 'Nenhum item de menu dispon√≠vel no momento.',
		'btn_checkout': 'Finalizar Pedido',
		'order_summary': 'Resumo do Pedido',
		'rider_wage': 'Taxa do Entregador',
		'total_items': 'Subtotal:',
		'total_all': 'Valor Total:',
		'btn_confirm_order': 'Confirmar Pedido',
		'confirm_payment_title': 'Confirmar Pagamento?',
		'subtotal_label': 'Subtotal:',
		'rider_wage_label': 'Taxa do Entregador:',
		'total_deduction_label': 'Total:',
		'confirm_btn': 'Confirmar e Pagar Agora',
		'bpconfirm_btn': 'Bypass To Finish Order',
		'cancel_btn': 'Cancelar',
		'please_select_item': 'Selecione pelo menos 1 item',
		'order_success_title': 'Pedido com Sucesso!',
		'order_success_text': 'O pagamento foi processado',
		'payment_failed': 'Falha no Pagamento',
		'connection_error': 'Erro de Conex√£o',
		'total_label': 'Total:',
		'contact_phone_label': 'Telefone de contato:',
		'my_orders_btn': 'Meus Pedidos',
		'my_orders_title': 'Acompanhar Pedidos',
		'status_waiting': 'Aguardando Lojista',
        'status_accepted': 'Lojista Aceitou',
        'no_active_orders': 'Nenhum pedido ativo no momento',
        'chat_wait_merchant': 'Aguarde a aceita√ß√£o do lojista para iniciar o chat',
        'confirm_cancel_title': 'Confirmar Cancelamento?',
        'confirm_cancel_text': 'O reembolso ser√° processado (taxas do sistema podem ser aplicadas)',
        'btn_confirm_cancel': 'Confirmar Cancelamento',
        'btn_back': 'Voltar',
        'cancel_success': 'Cancelado com sucesso',
        'cancel_failed': 'Falhou',
        'err_cancel_msg': 'N√£o foi poss√≠vel cancelar',
        'err_connection': 'Erro de conex√£o',
		'status_finished_rating': 'Entregue / Aguardando Avalia√ß√£o',
        'btn_rate_service': 'Avaliar Agora',
        'order_accepted_title': 'Pedido Aceito!',
        'order_accepted_text': 'Preparando comida e procurando entregador...',
        'err_rating_incomplete': 'Por favor, complete todas as categorias',
        'msg_rating_success': 'Obrigado pela sua avalia√ß√£o!',
		'confirm_delivery_title': 'Recebeu seu pedido?',
        'confirm_delivery_text': 'Se voc√™ j√° recebeu seu pedido, pode confirmar para finalizar o servi√ßo.',
		'alert_active_order_title': 'Pedidos Ativos!',
        'alert_active_order_text': 'Por favor, aguarde a conclus√£o dos seus pedidos ou cancele-os antes de sair.',
    }
};

function applyMerchantTranslations() {
    console.log(`[i18n] Applying translations for: ${currentLang}`);
    document.querySelectorAll('[data-i18n-key]').forEach(el => {
        const key = el.getAttribute('data-i18n-key');
        const translatedText = translations[currentLang]?.[key];

        if (translatedText) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = translatedText;
            } 
            else {
                const icon = el.querySelector('i');
                if (icon) {
                    el.innerHTML = '';
                    el.appendChild(icon);
                    el.insertAdjacentHTML('beforeend', ' ' + translatedText);
                } else {
                    el.innerText = translatedText;
                }
            }
        }
    });
}

window.addEventListener('DOMContentLoaded', () => {
    applyMerchantTranslations();
});

    // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
    window.onload = async () => {
	loadMyOrders();
        // ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    userCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    loadShops();
                },
                (err) => {
                    console.warn("‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", err);
                    loadShops(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 0)
                }
            );
        } else {
            loadShops();
        }
    };
	
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Marketplace
async function updateTopBalance(lat, lng) {
    try {
        const myUsername = localStorage.getItem('myUsername');
        if (!myUsername) return;

        // üö© 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô JSON string ‡πÅ‡∏•‡∏∞ Encode ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô URL
        const locationObj = JSON.stringify({ lat: lat, lng: lng });
        const locationParam = encodeURIComponent(locationObj);

        // üö© 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ API ‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Path ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° Parameter location)
        const res = await fetch(`/api/profile-details?username=${encodeURIComponent(myUsername)}&location=${locationParam}`);

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô SyntaxError (‡∏Å‡∏£‡∏ì‡∏µ Server ‡∏™‡πà‡∏á Error 404 ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤ HTML)
        const contentType = res.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
            console.error("üö® Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á JSON ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤");
            return;
        }

        const data = await res.json();

        // üö© 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ error ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        if (data && !data.error) {
            const balanceEl = document.getElementById('top-balance');
            const currencyEl = document.getElementById('top-currency');
            const zoneDisplay = document.getElementById('currentZoneName'); // ‡πÅ‡∏ñ‡∏°: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡∏ô‡∏î‡πâ‡∏ß‡∏¢

            if (balanceEl && currencyEl) {
                // üí° ‡πÉ‡∏ô API ‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ 'coins' ‡πÅ‡∏•‡∏∞‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ä‡πâ 'currency'
                const balanceValue = data.coins || 0;
                balanceEl.innerText = Number(balanceValue).toLocaleString(undefined, {minimumFractionDigits: 2});
                currencyEl.innerText = data.currency || 'USD';
            }

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ó‡∏µ‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà API ‡∏™‡πà‡∏á‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
            if (zoneDisplay && data.zoneName) {
                zoneDisplay.innerText = data.zoneName;
            }
        }
    } catch (e) {
        console.error("üö® Update Balance Error:", e);
    }
}


    // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å API
async function loadShops() {
    if (!userCoords) {
        console.warn("‚ö†Ô∏è [Debug] ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");
        return; 
    }

    try {
        const res = await fetch(`/api/marketplace/all-merchants?lat=${userCoords.lat}&lng=${userCoords.lng}`);
        
        if (!res.ok) {
            console.error(`‚ùå [Debug] Server Error ${res.status}`);
            throw new Error(`Server Error`);
        }
		if (userCoords) {
			updateTopBalance(userCoords.lat, userCoords.lng);
		}

        const data = await res.json();
        
        if (data.success) {
            const zoneDisplay = document.getElementById('currentZoneName');
			currentZoneFee = data.zoneFee || 0;
            currentSystemZone = data.systemZone || 0;
            
            if (data.currentZone) {
                zoneDisplay.innerText = data.currentZone;
            } else {
                zoneDisplay.innerText = translations[currentLang].shop_nearby;
            }
            
            // üö© 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏à‡∏≤‡∏Å DB
            allShops = data.shops.map(shop => {
                const dist = calculateDistance(
                    userCoords.lat, 
                    userCoords.lng, 
                    shop.lat, 
                    shop.lng
                );
                return { ...shop, distance: dist };
            });

            // üö© 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å ‡∏ô‡πâ‡∏≠‡∏¢ ‡πÑ‡∏õ ‡∏°‡∏≤‡∏Å (‡πÉ‡∏Å‡∏•‡πâ -> ‡πÑ‡∏Å‡∏•)
            allShops.sort((a, b) => (a.distance || 0) - (b.distance || 0));

            renderShops(allShops);
        }
        document.getElementById('loader').style.display = 'none';
    } catch (e) {
        console.error("‚ùå [Debug] Fetch error:", e);
        document.getElementById('currentZoneName').innerText = 
            `${translations[currentLang].shop_select} (${translations[currentLang].shop_error})`;
    }
}

    // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
function renderShops(shops) {
    const grid = document.getElementById('shopGrid');
    grid.innerHTML = '';
    
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏°‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ
    const txtSold = translations[currentLang].shop_sold;

    shops.forEach(s => {
        grid.innerHTML += `
            <div class="shop-card" onclick="goToShop('${s.username}')">
                <div class="shop-image">
                    <img src="${s.shopImage || 'https://via.placeholder.com/150'}" alt="${s.shopName}">
                    <div class="distance-badge">
                        <i class="fas fa-location-arrow"></i> ${s.distance ? s.distance.toFixed(1) + ' km' : 'N/A'}
                    </div>
                </div>
                <div class="shop-info">
                    <div class="shop-name">${s.shopName || s.username}</div>
                    <div class="shop-meta">
                        <span class="rating"><i class="fas fa-star"></i> ${s.rating || '5.0'}</span>
                        <span>‚Ä¢ ${txtSold} ${s.completedJobs || 0}</span>
                    </div>
                </div>
            </div>
        `;
    });
}

    // 4. ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á Haversine (‡∏Å‡∏°.)
    function calculateDistance(lat1, lon1, lat2, lon2) {
        if (!lat1 || !lon1 || !lat2 || !lon2) return null;
        const R = 6371; // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÇ‡∏•‡∏Å
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // 5. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
    function filterShops() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput) {
        renderShops(allShops);
        return;
    }
    const term = searchInput.value.toLowerCase();
    
    const filtered = allShops.filter(s => 
        (s.shopName && s.shopName.toLowerCase().includes(term)) || 
        (s.username && s.username.toLowerCase().includes(term))
    );    
    renderShops(filtered);
}


	
	
	
// üö© ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö Real-time
socket.on('shop-status-changed', (data) => {
    const { username, isOpen, shopDetails } = data;

    if (isOpen) {
        const exists = allShops.find(s => s.username === username);
        if (!exists) {
            // üö© ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà
            const dist = calculateDistance(userCoords.lat, userCoords.lng, shopDetails.lat, shopDetails.lng);
            shopDetails.distance = dist;
            
            allShops.push(shopDetails);
        }
    } else {
        allShops = allShops.filter(s => s.username !== username);
    }

    // üö© ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    allShops.sort((a, b) => (a.distance || 0) - (b.distance || 0));

    if (typeof filterShops === 'function') {
        filterShops(); 
    } else {
        renderShops(allShops);
    }
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
function goToShop(username) {
	currentMerchantId = username;
    const shop = allShops.find(s => s.username === username);
    if (!shop) return;

    // 1. ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô
    document.getElementById('modalShopName').innerText = shop.shopName || shop.username;

    // 2. ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
    const phoneLink = document.getElementById('modalShopPhone');
    if (shop.phone) {
        phoneLink.href = `tel:${shop.phone}`;
        phoneLink.querySelector('span').innerText = shop.phone;
        phoneLink.style.display = 'inline-block';
    } else {
        phoneLink.style.display = 'none';
    }

    // 3. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    const mapContent = document.getElementById('map-content');
    mapContent.innerHTML = `
        <iframe 
            width="100%" 
            height="100%" 
            frameborder="0" 
            style="border:0" 
            src="https://maps.google.com/maps?q=${shop.lat},${shop.lng}&hl=${currentLang}&z=15&output=embed" 
            allowfullscreen>
        </iframe>
        <div onclick="window.open('https://www.google.com/maps/search/?api=1&query=${shop.lat},${shop.lng}', '_blank')" 
             style="position:absolute; top:0; left:0; width:100%; height:100%; cursor:pointer; background:transparent;">
        </div>
    `;

    // 4. ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏° + ‡πÅ‡∏•‡∏∞ -
    const container = document.getElementById('menu-items-container');
    container.innerHTML = '';
    const currency = shop.zoneCurrency || 'USD';

    if (shop.products && shop.products.length > 0) {
        shop.products.forEach((item, index) => {
            container.innerHTML += `
                <div class="menu-item-row" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee;">
                    <span class="menu-item-name" style="flex: 1;">${item.name}</span>
                    
                    <div class="price-qty-control" style="display: flex; align-items: center; gap: 10px;">
                        <button onclick="changeQty('${username}', ${index}, 1)" style="width: 28px; height: 28px; border-radius: 50%; border: none; background: #11998e; color: white; cursor: pointer;">+</button>
                        
                        <div style="text-align: center; min-width: 80px;">
                            <div class="menu-item-price" style="font-weight: bold; color: #11998e; font-size: 0.9rem;">
                                ${Number(item.price).toLocaleString()} ${currency}
                            </div>
                            <small id="qty-${username}-${index}" style="color: #666; font-size: 0.7rem;">x 0</small>
                        </div>

                        <button onclick="changeQty('${username}', ${index}, -1)" style="width: 28px; height: 28px; border-radius: 50%; border: none; background: #ff4d4d; color: white; cursor: pointer;">-</button>
                    </div>
                </div>
            `;
        });
    } else {
        const noMenuText = (typeof translations !== 'undefined' && translations[currentLang]) ? translations[currentLang].no_menu_items : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π';
        container.innerHTML = `<p style="text-align:center; color:#999; padding:20px;">${noMenuText}</p>`;
    }

    document.getElementById('shopMenuModal').classList.remove('hidden');
}





function changeQty(merchantId, productIndex, delta) {
    const key = `${merchantId}-${productIndex}`;
    if (!cart[key]) cart[key] = 0;
    cart[key] += delta;
    if (cart[key] < 0) cart[key] = 0;

    const qtyEl = document.getElementById(`qty-${key}`);
    if (qtyEl) {
        qtyEl.innerText = `x ${cart[key]}`;
        qtyEl.style.color = cart[key] > 0 ? '#11998e' : '#666';
    }

    // üö© ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏°‡πÑ‡∏´‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå
    const hasItems = Object.keys(cart).some(k => k.startsWith(merchantId) && cart[k] > 0);
    document.getElementById('btn-goto-checkout').style.display = hasItems ? 'block' : 'none';
}

function openCheckoutModal() {
    const shop = allShops.find(s => s.username === currentMerchantId);
    if (!shop) return;

    const listContainer = document.getElementById('checkout-items-list');
    listContainer.innerHTML = '';
    let totalItemsPrice = 0;

    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
    shop.products.forEach((product, index) => {
        const qty = cart[`${currentMerchantId}-${index}`] || 0;
        if (qty > 0) {
            const itemTotal = product.price * qty;
            totalItemsPrice += itemTotal;
            listContainer.innerHTML += `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem;">
                    <span>${product.name} (x${qty})</span>
                    <span>${itemTotal.toLocaleString()} ${shop.zoneCurrency}</span>
                </div>
            `;
        }
    });

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ
    document.getElementById('sum-items-price').innerText = `${totalItemsPrice.toLocaleString()} ${shop.zoneCurrency}`;
    document.querySelectorAll('.currency-label-summary').forEach(el => el.innerText = shop.zoneCurrency);
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πà‡∏≠
    window.lastTotalItemsPrice = totalItemsPrice;
    window.currentShopCurrency = shop.zoneCurrency;

    updateCheckoutTotal();
    document.getElementById('checkoutModal').classList.remove('hidden');
}

function updateCheckoutTotal() {
    const riderWage = parseFloat(document.getElementById('rider-wage-input').value) || 0;
    const totalAll = (window.lastTotalItemsPrice || 0) + riderWage;
    
    document.getElementById('sum-total-all').innerText = `${totalAll.toLocaleString()} ${window.currentShopCurrency}`;
}

async function confirmFinalOrder() {
    const shop = allShops.find(s => s.username === currentMerchantId);
    if (!shop) return;

    const lang = translations[currentLang]; // ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏©‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const phone = document.getElementById('customer-phone-input').value.trim();
    const riderWage = parseFloat(document.getElementById('rider-wage-input').value) || 0;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
    if (!phone) {
        return Swal.fire({ icon: 'warning', text: translations[currentLang].err_no_phone || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå' });
    }
    if (riderWage <= 0) {
        return Swal.fire({ icon: 'warning', text: translations[currentLang].err_no_wage || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå' });
    }

    let subtotal = 0;
    let itemsText = "";
    shop.products.forEach((product, index) => {
        const qty = cart[`${currentMerchantId}-${index}`] || 0;
        if (qty > 0) {
            const itemPrice = product.price * qty;
            subtotal += itemPrice;
            itemsText += `- ${product.name} x${qty}<br>`;
        }
    });

    const totalAmount = subtotal + riderWage + currentZoneFee + currentSystemZone;
    const currency = shop.zoneCurrency || 'USD';

    // üö© ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡πÅ‡∏•‡∏∞ HTML)
    const { isConfirmed } = await Swal.fire({
        title: lang.confirm_payment_title,
        html: `
            <div style="text-align: left; background: #f9f9f9; padding: 15px; border-radius: 10px; font-size: 0.9rem;">
                ${itemsText}
                <hr>
                <div>${lang.subtotal_label || '‡∏¢‡∏≠‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:'} ${subtotal.toLocaleString()} ${currency}</div>
                <div>${lang.rider_wage_label || '‡∏Ñ‡πà‡∏≤‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå:'} ${riderWage.toLocaleString()} ${currency}</div>
                <div style="color: #666;">${lang.zone_fee_label || '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÇ‡∏ã‡∏ô:'} ${(currentZoneFee + currentSystemZone).toLocaleString()} ${currency}</div>
                <hr>
                <b style="font-size: 1.1rem; color: #11998e;">${lang.total_label} ${totalAmount.toLocaleString()} ${currency}</b><br>
                <small>${lang.contact_phone_label} ${phone}</small>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#11998e',
        cancelButtonColor: '#d33',
        confirmButtonText: lang.confirm_btn,
        cancelButtonText: lang.cancel_btn
    });

    if (isConfirmed) {
        try {
            const response = await fetch('/api/order/process-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: localStorage.getItem('myUsername'),
                    merchant: currentMerchantId,
                    amount: totalAmount,
                    currency: currency,
                    items: itemsText.replace(/<br>/g, "\n"),
                    phone: phone,
                    riderWage: riderWage,
                    userLocation: userCoords,
					zoneFee: currentZoneFee,
                    systemZone: currentSystemZone
                })
            });

            const result = await response.json();
            if (result.success) {
                await Swal.fire({ icon: 'success', title: lang.order_success_title, timer: 2000 });
                cart = {};
                document.getElementById('customer-phone-input').value = '';
                document.getElementById('rider-wage-input').value = '';
				loadMyOrders();
                closeCheckoutModal();
                closeShopMenuModal();
                if (typeof updateTopBalance === 'function') updateTopBalance(userCoords.lat, userCoords.lng);
            } else {
                Swal.fire({ icon: 'error', text: result.message });
            }
        } catch (error) {
            Swal.fire({ icon: 'error', text: 'Connection Error' });
        }
    }
}

function closeCheckoutModal() {
    document.getElementById('checkoutModal').classList.add('hidden');
}

function closeShopMenuModal() {
    document.getElementById('shopMenuModal').classList.add('hidden');
}




// 1. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
async function loadMyOrders() {
    const username = localStorage.getItem('myUsername');
    if (!username) return;

    try {
        const res = await fetch(`/api/my-active-orders?username=${username}`);
        const data = await res.json();
        
        if (data.success) {
            myActiveOrders = data.orders;
            updateCustomerUI();
        }
    } catch (e) { console.error("Load orders error:", e); }
}



// 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢
function updateCustomerUI() {
    const btn = document.getElementById('floatingCustomerBtn');
    if (myActiveOrders.length > 0) {
        btn.style.display = 'block';
    } else {
        btn.style.display = 'none';
    }
}

// 3. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô Modal
function openMyOrdersModal() {
    const container = document.getElementById('myOrdersContainer');
    if (!container) return;

    container.innerHTML = '';

    const ordersHtml = myActiveOrders.map(order => {
        // --- 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ---
        const isWaiting = order.status === 'waiting_merchant';
        const isAccepted = order.status === 'accepted'; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
        const isFinished = order.status === 'finished' || order.status === 'done';
        
        let statusText = translations[currentLang].status_waiting;
        let statusClass = 'status-waiting';

        if (isAccepted) {
            statusText = translations[currentLang].status_accepted;
            statusClass = 'status-accepted';
        } else if (isFinished) {
            statusText = translations[currentLang].status_finished_rating;
            statusClass = 'status-finished';
        }

        const shortId = order.orderId.slice(-5);
        const postIdValue = order.postId || 'null';

        // --- 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° Action (‡πÅ‡∏ä‡∏ó / ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô) ---
        let actionIcon = '';
        if (isFinished) {
            actionIcon = `<i class="fas fa-star" style="color:#f1c40f; font-size:1.3rem; cursor:pointer;" 
                           title="${translations[currentLang].btn_rate_service}"></i>`;
        } else if (!isWaiting) {
            actionIcon = `<i class="fas fa-comments" style="color:#11998e; font-size:1.2rem; cursor:pointer;"></i>`;
        }

        // --- üö© ‡∏õ‡∏∏‡πà‡∏° Bypass ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô accepted) ---
        const bypassBtn = isAccepted 
            ? `<button onclick="event.stopPropagation(); confirmCustomerBypass('${order.postId}', '${order.orderId}')" 
                style="background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 0.7rem; font-weight: bold; display: flex; align-items: center; gap: 4px;">
                <i class="fas fa-check-double"></i> Confirm
               </button>`
            : '';

        // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô)
        //const cancelBtn = isWaiting 
		const bypassBtn = isAccepted
            ? `<button class="btn-cancel-order" onclick="event.stopPropagation(); cancelOrder(event, '${order.orderId}')">
                <i class="fas fa-trash-alt"></i> cancel
               </button>`
            : '';

        // --- 3. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ HTML ---
        return `
            <div class="customer-order-item" onclick="handleOrderClick('${order.orderId}', '${order.status}', ${postIdValue})" 
                 style="border-left: 5px solid ${isFinished ? '#f1c40f' : '#11998e'};">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-weight:bold; color:#2c3e50;">#${shortId}</div>
                        <span class="status-badge ${statusClass}" style="font-size: 0.65rem;">${statusText}</span>
                    </div>
                    <div style="font-size:0.85rem; color:#7f8c8d; margin-top: 2px;">
                        <i class="fas fa-store" style="font-size: 0.8rem;"></i> ${order.merchant}
                    </div>
                </div>
                <div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        ${bypassBtn} 
                        ${actionIcon}
                        ${cancelBtn}
                    </div>
                </div>
            </div>`;
    }).join('');

    container.innerHTML = ordersHtml || `<p style="text-align:center; padding:30px; color:#999;">${translations[currentLang].no_active_orders}</p>`;
    
    const modal = document.getElementById('myOrdersModal');
    if (modal) modal.classList.remove('hidden');
}


async function confirmCustomerBypass(postId, orderId) {
    const { isConfirmed } = await Swal.fire({
        title: translations[currentLang].confirm_delivery_title || '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß?',
        text: translations[currentLang].confirm_delivery_text || '‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#11998e',
        confirmButtonText: translations[currentLang].bpconfirm_btn,
        cancelButtonText: translations[currentLang].cancel_btn
    });

    if (isConfirmed) {
        try {
            const res = await fetch(`/api/posts/${postId}/customer-bypass`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username: localStorage.getItem('myUsername') 
                })
            });
            const data = await res.json();

            if (data.success) {
                Swal.fire({ icon: 'success', title: 'Success', timer: 1500, showConfirmButton: false });
                loadMyOrders(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏≤‡∏ß‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            }
        } catch (e) {
            console.error("Bypass error:", e);
        }
    }
}


// 4. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å (‡∏ñ‡πâ‡∏≤ Accept ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ä‡∏ó)
async function handleOrderClick(orderId, status, postId) {
    if (status === 'finished' || status === 'done') {
        // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ 3 ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)
        openRatingModal(orderId, postId);
    } else if (status === 'accepted') {
        // ‡πÄ‡∏õ‡∏¥‡∏î Sidebar ‡πÅ‡∏ä‡∏ó
        openRightSidebar(postId);
    }
}

// 5. ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô)
async function cancelOrder(event, orderId) {
    event.stopPropagation();
    
    const { isConfirmed } = await Swal.fire({
        title: translations[currentLang].confirm_cancel_title,
		text: translations[currentLang].confirm_cancel_text,
		icon: 'warning',
		showCancelButton: true,
		confirmButtonColor: '#d33',
		confirmButtonText: translations[currentLang].btn_confirm_cancel,
		cancelButtonText: translations[currentLang].btn_back
		});

    if (isConfirmed) {
        try {
            const res = await fetch('/api/order/customer-cancel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    orderId: orderId, 
                    username: localStorage.getItem('myUsername') 
                })
            });

            const result = await res.json();

            if (res.ok && result.success) {
                Swal.fire({ icon: 'success', title: translations[currentLang].cancel_success, timer: 2000 });
                loadMyOrders(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
            } else {
                Swal.fire(translations[currentLang].cancel_failed, result.message || translations[currentLang].err_cancel_msg, 'error');
            }
        } catch (e) {
            Swal.fire('Error', translations[currentLang].err_connection, 'error');
        }
    }
}

function closeMyOrdersModal() {
    document.getElementById('myOrdersModal').classList.add('hidden');
}




function openRightSidebar(postId) {
    currentChatPostId = postId;
    document.getElementById('rightSidebar').style.right = '0';
    document.getElementById('sidebarOverlay').style.display = 'block';
    
    const chatContainer = document.getElementById('chatMessages');
    chatContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">loading chat...</div>';
    
    socket.emit('join-post', postId);
    loadChatHistory(postId);
}

function closeRightSidebar() {
    document.getElementById('rightSidebar').style.right = '-100%';
    document.getElementById('sidebarOverlay').style.display = 'none';
    currentChatPostId = null;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó
async function loadChatHistory(postId) {
    try {
        const res = await fetch(`/api/posts/${postId}`);
        const data = await res.json();
        if (data.success) {
            const post = data.post;
            merchantUser = post.author;     
            riderUser = post.acceptedBy;    
            
            const chatContainer = document.getElementById('chatMessages');
            chatContainer.innerHTML = '';

            if (post.comments) {
                post.comments.forEach(msg => {
                    const label = getRoleLabel(msg.author);
					
                    appendMessage(label, msg.text || msg.content, msg.author === localStorage.getItem('myUsername'), msg.imageUrl);
                });
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    } catch (e) { console.error(e); }
}

function getRoleLabel(username) {
    const myUser = localStorage.getItem('myUsername');

    if (username === myUser) {
        return `<i class="fas fa-user-circle"></i>`;
    } else if (username === merchantUser) {
        return `<i class="fas fa-store" style="color: #e67e22;"></i> Business`;
    } else if (username === riderUser) {
        return `<i class="fas fa-motorcycle" style="color: #3498db;"></i> Rider`;
    } else {
        return `<i class="fas fa-user"></i> ${username}`; // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô
    }
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    const myUsername = localStorage.getItem('myUsername');
    
    if (text && currentChatPostId) {
        const msgData = {
            postId: currentChatPostId,
            author: myUsername,
            text: text,
            createdAt: new Date()
        };
        
        socket.emit('send-comment', msgData);
        input.value = '';
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        appendMessage(myUsername, text, true);
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏î‡πÑ‡∏î‡πâ
function formatCustomerMsgLinks(text) {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, (url) => {
        return `<a href="${url}" target="_blank" style="color: inherit; text-decoration: underline; font-weight: bold;"> üìç</a>`;
    });
}




// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
function appendMessage(senderHtml, text, isMe, imageUrl = null) {
    const chatContainer = document.getElementById('chatMessages');
    const msgDiv = document.createElement('div');
    
    // --- 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Style (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏µ‡πà‡∏ä‡∏≠‡∏ö) ---
    msgDiv.style.maxWidth = '80%';
    msgDiv.style.padding = '10px 15px';
    msgDiv.style.borderRadius = '15px';
    msgDiv.style.fontSize = '0.9rem';
    msgDiv.style.lineHeight = '1.4';
    msgDiv.style.marginBottom = '10px';
    msgDiv.style.display = 'flex';
    msgDiv.style.flexDirection = 'column';
    
    if (isMe) {
        msgDiv.style.alignSelf = 'flex-end';
        msgDiv.style.background = '#11998e';
        msgDiv.style.color = 'white';
        msgDiv.style.borderRadius = '15px 15px 0 15px';
    } else {
        msgDiv.style.alignSelf = 'flex-start';
        msgDiv.style.background = '#eee';
        msgDiv.style.color = '#333';
        msgDiv.style.borderRadius = '15px 15px 15px 0';
    }

    // --- 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà) ---
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    let formattedText = text.replace(urlRegex, (url) => {
        return `<a href="${url}" target="_blank" style="color: ${isMe ? '#fff' : '#007bff'}; text-decoration: underline; font-weight: bold;"> üìç</a>`;
    });

    // --- 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ---
    let imageHtml = '';
    if (imageUrl) {
        const fullPath = imageUrl.startsWith('http') ? imageUrl : `/${imageUrl}`;
        imageHtml = `<img src="${fullPath}" style="width:100%; border-radius:10px; margin-top:8px; cursor:pointer;" onclick="window.open(this.src)">`;
    }
    
    // --- 4. ‡∏ß‡∏≤‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏•‡∏á‡πÑ‡∏õ ---
    msgDiv.innerHTML = `
        <small style="display:block; font-size:0.75rem; font-weight:600; opacity:0.8; margin-bottom:4px;">
            ${senderHtml}
        </small>
        <div>${formattedText}</div>
        ${imageHtml}
    `;
    
    chatContainer.appendChild(msgDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Socket
socket.on('new-comment', (data) => {
    const comment = data.comment || data;
    if (data.postId == currentChatPostId) {
        if (comment.author !== localStorage.getItem('myUsername')) {
            const roleLabel = getRoleLabel(comment.author);
            // ‚úÖ ‡∏™‡πà‡∏á comment.imageUrl ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
            appendMessage(roleLabel, comment.text || comment.content, false, comment.imageUrl);
        }
    }
});


// ‡∏ù‡∏±‡πà‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (index.html ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠)
socket.on('order_accepted_update', async (data) => {
    console.log("üîî Order Accepted Update received:", data);
    
    if (typeof loadMyOrders === 'function') {
        await loadMyOrders(); 
        
        const modal = document.getElementById('myOrdersModal');
        if (modal && !modal.classList.contains('hidden')) {
            openMyOrdersModal();
        }
    }

    Swal.fire({
        icon: 'success',
        title: translations[currentLang].order_accepted_title,
        text: translations[currentLang].order_accepted_text,
        timer: 3000,
        toast: true,
        position: 'top-end',
        showConfirmButton: false
    });
});



// ‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
function shareCustomerLocation() {
    if (!navigator.geolocation) return alert("GPS not supported");
    navigator.geolocation.getCurrentPosition((position) => {
        const { latitude, longitude } = position.coords;
        const mapLink = `https://www.google.com/maps?q=${latitude},${longitude}`;
        const message = `üìç: ${mapLink}`;
        
        // ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô Socket ‡∏´‡∏£‡∏∑‡∏≠ API ‡∏ï‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å (‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ Socket ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        const msgData = { postId: currentChatPostId, author: localStorage.getItem('myUsername'), text: message };
        socket.emit('send-comment', msgData);
        appendMessage("‡∏â‡∏±‡∏ô", message, true);
    });
}

// ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
async function handleCustomerPhotoSelect(input) {
    const file = input.files[0];
    if (!file) return;

    Swal.fire({ title: 'sending photo...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

    const imageUrl = URL.createObjectURL(file);
    const resizedBlob = await compressImage(imageUrl, 1024, 0.6); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°
    
    const formData = new FormData();
    formData.append('image', resizedBlob, `cust_${Date.now()}.jpg`);
    formData.append('author', localStorage.getItem('myUsername'));
    formData.append('text', 'üì∑ send photo');

    const res = await fetch(`/api/posts/${currentChatPostId}/comments`, { method: 'POST', body: formData });
    const data = await res.json();
    
    if (data.success) {
        appendMessage("", 'üì∑ send photo', true, data.comment.imageUrl);
        URL.revokeObjectURL(imageUrl);
        Swal.close();
    }
    input.value = '';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
function compressImage(url, maxWidth, quality) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.src = url;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            if (width > maxWidth) {
                height = (maxWidth / width) * height;
                width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob((blob) => {
                if (blob) resolve(blob);
                else reject(new Error('Canvas to Blob failed'));
            }, 'image/jpeg', quality);
        };
        img.onerror = (err) => reject(err);
    });
}



async function openRatingModal(orderId, postId) {
    currentRatingOrderId = orderId;
    
    // 1. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πà‡∏≤
    resetStars(); 
    
    // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≠‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏´‡∏•‡∏î
    document.getElementById('displayRiderName').innerText = "Loading Rider...";
    document.getElementById('displayMerchantName').innerText = "Loading Shop...";
    
    // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏ã‡∏ï‡∏Ñ‡πà‡∏≤ riderUser ‡πÅ‡∏•‡∏∞ merchantUser ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤)
    await loadChatHistory(postId); 
    
    document.getElementById('displayRiderName').innerText = `Rider: ${riderUser || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}`;
    document.getElementById('displayMerchantName').innerText = `Shop: ${merchantUser || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}`;
    
    // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
    const modal = document.getElementById('customerRatingModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function resetStars() {
    ratings = { riderSat: 0, riderPolite: 0, merchantRate: 0 };
    const allStars = document.querySelectorAll('.star-rating i');
    allStars.forEach(s => {
        s.classList.remove('fas');
        s.classList.add('far');
        s.style.color = '#ddd';
    });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
function closeRatingModal() {
    const modal = document.getElementById('customerRatingModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏≤‡∏ß
function setStar(el, score) {
    const parent = el.parentElement;
    const category = parent.getAttribute('data-category');
    ratings[category] = score;
    
    const stars = parent.querySelectorAll('i');
    stars.forEach((s, idx) => {
        if (idx < score) {
            s.classList.replace('far', 'fas');
            s.style.color = '#f1c40f';
        } else {
            s.classList.replace('fas', 'far');
            s.style.color = '#ddd';
        }
    });
}


async function submitTripleRating() {
    if (ratings.riderSat === 0 || ratings.riderPolite === 0 || ratings.merchantRate === 0) {
        return Swal.fire(translations[currentLang].err_rating_incomplete, '', 'warning');
    }

    // üö© ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateTopBalance)
    const zoneNameDisplay = document.getElementById('currentZoneName').innerText;

    try {
        const res = await fetch('/api/orders/submit-full-rating', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                orderId: currentRatingOrderId,
                riderName: riderUser,
                merchantName: merchantUser,
                ratings: ratings,
                zoneName: zoneNameDisplay // üö© ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡∏ô‡πÑ‡∏õ‡πÉ‡∏´‡πâ Server ‡∏î‡πâ‡∏ß‡∏¢
            })
        });
        
        const data = await res.json();
        if (data.success) {
            Swal.fire(translations[currentLang].msg_rating_success, '', 'success');
            closeRatingModal();
            loadMyOrders(); 
        }
    } catch (e) { console.error(e); }
}


function safeBack() {
    if (myActiveOrders && myActiveOrders.length > 0) {
        Swal.fire({
            icon: 'warning',
            title: translations[currentLang].alert_active_order_title,
            text: translations[currentLang].alert_active_order_text,
            confirmButtonColor: '#11998e',
            confirmButtonText: 'Confirm'
        });
    } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥
        history.back();
    }
}


</script>




<div id="shopMenuModal" class="product-modal-overlay hidden">
    <div class="product-modal-card">
        <div class="product-modal-header" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
            <div style="display: flex; flex-direction: column;">
                <h3 id="modalShopName" style="margin: 0; color: white;">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <a id="modalShopPhone" href="#" style="color: white; text-decoration: none; font-size: 0.9rem; margin-top: 4px;">
                    <i class="fas fa-phone-alt"></i> <span>-</span>
                </a>
            </div>
            <button class="btn-close-modal" onclick="closeShopMenuModal()">√ó</button>
        </div>
        
        <div class="product-modal-body">
            <div id="shop-mini-map" style="width: 100%; height: 140px; background: #eee; border-radius: 12px; margin-bottom: 15px; overflow: hidden; position: relative; border: 1px solid #ddd;">
                <div id="map-content" style="width: 100%; height: 100%;"></div>
            </div>

            <div id="menu-items-container"></div>
            
            <p style="font-size: 0.8em; color: #888; text-align: center; margin-top: 15px;" data-i18n-key="price_exclude_delivery">
                * ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
            </p>

            <button id="btn-goto-checkout" onclick="openCheckoutModal()" style="display:none; width: 100%; margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                <i class="fas fa-shopping-cart"></i> <span data-i18n-key="btn_checkout">‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå</span>
            </button>
        </div>
    </div>
</div>

<div id="checkoutModal" class="product-modal-overlay hidden">
    <div class="product-modal-card">
        <div class="product-modal-header" style="background: #2c3e50;">
            <h3 data-i18n-key="order_summary" style="color: white; margin: 0;">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
            <button class="btn-close-modal" onclick="closeCheckoutModal()">√ó</button>
        </div>
        <div class="product-modal-body">
            <div id="checkout-items-list" style="margin-bottom: 20px;"></div>
            <hr>
			
    <label style="font-size: 0.9rem; font-weight: bold;" data-i18n-key="customer_phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
    <div style="margin-bottom: 15px; margin-top: 5px;">
        <input type="tel" id="customer-phone-input" placeholder="08x-xxx-xxxx" 
               style="width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
    </div>
	
            <div style="margin-top: 15px;">
                <label style="font-size: 0.9rem; font-weight: bold;" data-i18n-key="rider_wage">‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå</label>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                    <input type="number" id="rider-wage-input" oninput="updateCheckoutTotal()" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" style="flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 8px; font-size: 1rem;">
                    <span class="currency-label-summary" style="font-weight: bold;">-</span>
                </div>
            </div>
            <div style="margin-top: 20px; background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px dashed #ccc;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span data-i18n-key="total_items">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span>
                    <span id="sum-items-price">0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; color: #11998e;">
                    <span data-i18n-key="total_all">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</span>
                    <span id="sum-total-all">0.00</span>
                </div>
            </div>
            <button onclick="confirmFinalOrder()" style="width: 100%; margin-top: 20px; padding: 15px; background: #11998e; color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;">
                <span data-i18n-key="btn_confirm_order">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
            </button>
        </div>
    </div>
</div>



<div id="floatingCustomerBtn" class="floating-customer-btn" onclick="openMyOrdersModal()">
    <i class="fas fa-receipt"></i>
    <span style="margin-left: 8px; font-weight: bold;" data-i18n-key="my_orders_btn">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
</div>

<div id="myOrdersModal" class="product-modal-overlay hidden">
    <div class="product-modal-card">
        <div class="product-modal-header" style="background: #11998e;">
            <h3 data-i18n-key="my_orders_title" style="color:white; margin:0;">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>
            <button class="btn-close-modal" onclick="closeMyOrdersModal()">&times;</button>
        </div>
        <div class="product-modal-body" id="myOrdersContainer" style="padding: 0;">
            </div>
    </div>
</div>


<div id="rightSidebar" class="sidebar-chat" style="position: fixed; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100%; background: white; z-index: 10000; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column;">
    <div style="background: linear-gradient(135deg, #11998e, #38ef7d); padding: 20px; color: white; display: flex; justify-content: space-between; align-items: center;">
        <h3 id="chatTitle" style="margin: 0; font-size: 1.1rem;">Chat Business/Rider</h3>
        <button onclick="closeRightSidebar()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>
    </div>
    
    <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: #f9f9f9; display: flex; flex-direction: column; gap: 10px;">
        </div>

    <div style="padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; align-items: center; background: white;">
    <input type="file" id="customerPhotoInput" accept="image/*" style="display:none;" onchange="handleCustomerPhotoSelect(this)">
    <button onclick="document.getElementById('customerPhotoInput').click()" style="background:none; border:none; color:#11998e; font-size: 1.3rem; cursor:pointer;">
        <i class="fas fa-camera"></i>
    </button>

    <button onclick="shareCustomerLocation()" style="background:none; border:none; color:#11998e; font-size: 1.3rem; cursor:pointer;">
        <i class="fas fa-map-marker-alt"></i>
    </button>

    <input type="text" id="chatInput" placeholder="Aa..." style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none;" onkeypress="if(event.key==='Enter') sendChatMessage()">
    
    <button onclick="sendChatMessage()" style="background: #11998e; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer;">
        <i class="fas fa-paper-plane"></i>
    </button>
</div>
</div>

<div id="sidebarOverlay" onclick="closeRightSidebar()" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: none;"></div>




<div id="customerRatingModal" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <h3 style="margin-bottom: 20px;"><i class="fas fa-star" style="color:#f1c40f;"></i> ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
        
        <div class="rating-group" style="margin-bottom: 20px; background: #f0f7ff; padding: 10px; border-radius: 10px;">
            <p style="font-weight: bold; margin-bottom: 2px;">1. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏≠‡πÉ‡∏à‡πÉ‡∏ô‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå</p>
            <div id="displayRiderName" style="color: #3498db; font-size: 0.85rem; margin-bottom: 8px; font-weight: 600;">Rider: Loading...</div>
            <div id="rider-satisfaction-stars" class="star-rating" data-category="riderSat">
                <i class="far fa-star" onclick="setStar(this, 1)"></i>
                <i class="far fa-star" onclick="setStar(this, 2)"></i>
                <i class="far fa-star" onclick="setStar(this, 3)"></i>
                <i class="far fa-star" onclick="setStar(this, 4)"></i>
                <i class="far fa-star" onclick="setStar(this, 5)"></i>
            </div>
        </div>

        <div class="rating-group" style="margin-bottom: 20px;">
            <p style="font-weight: bold; margin-bottom: 5px;">2. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå</p>
            <div id="rider-polite-stars" class="star-rating" data-category="riderPolite">
                <i class="far fa-star" onclick="setStar(this, 1)"></i>
                <i class="far fa-star" onclick="setStar(this, 2)"></i>
                <i class="far fa-star" onclick="setStar(this, 3)"></i>
                <i class="far fa-star" onclick="setStar(this, 4)"></i>
                <i class="far fa-star" onclick="setStar(this, 5)"></i>
            </div>
        </div>

        <div class="rating-group" style="margin-bottom: 25px; background: #fff5eb; padding: 10px; border-radius: 10px;">
            <p style="font-weight: bold; margin-bottom: 2px;">3. ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</p>
            <div id="displayMerchantName" style="color: #e67e22; font-size: 0.85rem; margin-bottom: 8px; font-weight: 600;">Shop: Loading...</div>
            <div id="merchant-stars" class="star-rating" data-category="merchantRate">
                <i class="far fa-star" onclick="setStar(this, 1)"></i>
                <i class="far fa-star" onclick="setStar(this, 2)"></i>
                <i class="far fa-star" onclick="setStar(this, 3)"></i>
                <i class="far fa-star" onclick="setStar(this, 4)"></i>
                <i class="far fa-star" onclick="setStar(this, 5)"></i>
            </div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="btn-cancel" style="flex:1" onclick="closeRatingModal()">‡∏õ‡∏¥‡∏î</button>
            <button class="btn-confirm" style="flex:1" onclick="submitTripleRating()">‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
        </div>
    </div>
</div>


</body>
</html>