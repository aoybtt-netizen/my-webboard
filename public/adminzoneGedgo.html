<!DOCTYPE html>
<html lang="th">
<head>
	
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="/socket.io/socket.io.js"></script>
    <title>GedGo! - Admin Zone Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/all.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary: #11998e; --secondary: #38ef7d; --dark: #2c3e50; --light: #f8fafc; --danger: #e74c3c; }
body { font-family: 'Kanit', sans-serif; background: var(--light); margin: 0; display: flex; height: 100dvh; overflow: hidden; }

* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent; /* ‡∏•‡∏ö‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ï‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
}

/* ‡πÅ‡∏ú‡πà‡∏ô‡πÉ‡∏™‡∏™‡∏µ‡∏î‡∏≥‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
.sidebar-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
    backdrop-filter: blur(2px);
}

/* ‡∏ï‡∏±‡∏ß Sidebar ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ -260px */
.sidebar { 
    width: 260px; 
    background: var(--dark); 
    color: white; 
    height: 100vh; 
    position: fixed; 
    left: -260px; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ */
    top: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1001;
    display: flex;
    flex-direction: column;
}

/* ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏•‡∏≤‡∏™ active ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ */
.sidebar.active {
    left: 0;
}

.sidebar-header { padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
.sidebar-menu { flex: 1; padding: 10px 0; }
.menu-item { 
    padding: 15px 25px; display: flex; align-items: center; gap: 12px; 
    color: rgba(255,255,255,0.7); text-decoration: none; cursor: pointer; transition: 0.2s;
}
.menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: var(--secondary); border-left: 4px solid var(--secondary); }
.menu-item i { width: 20px; }
.badge { background: var(--danger); color: white; font-size: 0.7em; padding: 2px 8px; border-radius: 10px; margin-left: auto; }

/* Main Content Area */
.main-content { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    height: 100dvh; /* ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÅ‡∏ö‡∏ö Dynamic */
    overflow: hidden; /* ‚ùå ‡∏´‡πâ‡∏≤‡∏° Scroll ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏°‡πà (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏ß‡∏≤) */
    width: 100%; 
    background: var(--light);
}
.top-bar { 
    background: white; 
    /* ‡∏à‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡∏≠‡∏ö: ‡∏ö‡∏ô(‡∏´‡∏•‡∏ö Notch) ‡∏Ç‡∏ß‡∏≤ ‡∏•‡πà‡∏≤‡∏á ‡∏ã‡πâ‡∏≤‡∏¢ */
    padding: calc(15px + env(safe-area-inset-top)) 20px 15px 20px; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    width: 100%; 
    flex-shrink: 0; /* ‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏î‡∏ï‡∏±‡∏ß */
    z-index: 10;
}
.content-body { 
    flex: 1; /* ‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ */
    overflow-y: auto; /* ‚úÖ Scrollbar ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏Ñ‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */
    padding: 15px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡∏à‡∏≤‡∏Å 25px ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 15px ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    padding-bottom: calc(20px + env(safe-area-inset-bottom)); /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏´‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏Æ‡∏° */
    -webkit-overflow-scrolling: touch; /* ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏∑‡πà‡∏ô‡πÜ ‡∏ö‡∏ô iPhone */
}

/* Card Style */
.admin-card { 
    background: white; 
    border-radius: 15px; 
    padding: 20px; 
    margin-bottom: 15px; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
    border: 1px solid #f1f5f9;
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    width: 100%; /* ‡∏¢‡∏∑‡∏î‡πÄ‡∏ï‡πá‡∏° */
}
.status-btn { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-left: 5px; }
.btn-approve { background: #e8f5e9; color: #2e7d32; }
.btn-reject { background: #ffebee; color: #c62828; }





    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h3 style="margin:0; color:var(--secondary);">GedGo! Zone</h3>
        <small style="opacity:0.6;">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô</small>
    </div>
	
	<div style="margin-top: 15px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); text-align: left;">
        <small style="color: var(--secondary); display: block; margin-bottom: 5px;">‡∏ó‡∏∏‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (USDT)</small>
        <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;" id="sidebar-usdt-balance">0.00 USDT</div>
        <button onclick="openExchangeModal()" style="width: 100%; background: var(--secondary); color: var(--dark); border: none; padding: 8px; border-radius: 8px; cursor: pointer; font-weight: bold; font-family: 'Kanit';">
            üí± ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏ã‡∏ô
        </button>
    </div>
	
    <div class="sidebar-menu">
    <div class="menu-item active" onclick="showContent('topup')">
    <i class="fas fa-exchange-alt"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
    <span class="badge" id="topup-count">0</span>
	</div>
    <div class="menu-item" onclick="showContent('kyc')">
        <i class="fas fa-id-card"></i> ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
        <span class="badge" id="kyc-count">0</span>
    </div>
	<div class="menu-item" onclick="showContent('members')">
    <i class="fas fa-users"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
	</div>
    <div class="menu-item" onclick="showContent('automessage')">
        <i class="fas fa-comment-dots"></i> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)
    </div>
    <div class="menu-item" onclick="showContent('history')">
        <i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô
    </div>
</div>
</nav>


    <main class="main-content">
    <header class="top-bar">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fas fa-bars" onclick="toggleSidebar()" style="cursor:pointer; font-size: 1.2em; color: var(--dark); padding: 5px;"></i>
            <h2 id="content-title" style="margin:0; font-size: 1.1em; font-weight: 600;">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h2>
        </div>

        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="admin-info" style="text-align: right; display: none;"> <small style="display:block; color:#999; font-size:0.7em;">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô</small>
                <b id="admin-name" style="font-size: 0.9em;">...</b>
            </div>
            
            <a href="index.html" style="
                text-decoration: none; 
                background: #f1f5f9; 
                color: var(--dark); 
                width: 38px; 
                height: 38px; 
                border-radius: 10px; 
                display: flex; 
                align-items: center; 
                justify-content: center;
                border: 1px solid #e2e8f0;
            ">
                <i class="fas fa-home"></i>
            </a>
        </div>
    </header>

    <div class="content-body" id="main-display">
        <div style="text-align:center; margin-top: 50px; color: #999;">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>
</main>

    <script>
	const socket = io();
	let currentZoneId = null;
	let zoneCurrency = 'USD';
	let zoneRate = 1.0;

	let currentChatRequestId = null;
	let currentKYCRequestId = null;
	
	
    function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    
    sidebar.classList.toggle('active');
    
    if (sidebar.classList.contains('active')) {
        overlay.style.display = 'block';
    } else {
        overlay.style.display = 'none';
    }
}

    async function showContent(type) {
    const display = document.getElementById('main-display');
    const title = document.getElementById('content-title');
	const membersListSec = document.getElementById('section-members-list');
    
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢ (‡∏£‡∏ß‡∏° KYC ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏•‡∏±‡∏ö) ---
    const topupListSec = document.getElementById('section-topup-list');
    const adminChatSec = document.getElementById('section-admin-chat');
    const kycListSec = document.getElementById('section-kyc-list'); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏™‡πà‡∏ß‡∏ô KYC

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏î‡∏∂‡∏á "‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏•‡∏±‡∏ö"
    let storage = document.getElementById('hidden-storage');
    if (!storage) {
        storage = document.createElement('div');
        storage.id = 'hidden-storage';
        storage.style.display = 'none';
        document.body.appendChild(storage);
    }

    // 3. ‡∏¢‡πâ‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å Section ‡πÑ‡∏õ‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô storage ‡∏Å‡πà‡∏≠‡∏ô (‡∏Ç‡∏≠‡∏á‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥)
    if (topupListSec) storage.appendChild(topupListSec);
    if (adminChatSec) storage.appendChild(adminChatSec);
    if (kycListSec) storage.appendChild(kycListSec); // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡πà‡∏ß‡∏ô KYC ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏î‡πâ‡∏ß‡∏¢

    // 4. ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Element ‡∏à‡∏£‡∏¥‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà storage ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏•‡∏≤‡∏¢)
    display.innerHTML = ''; 

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π (Active)
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    let targetItem = document.querySelector(`.menu-item[onclick*="'${type}'"]`);
    if (targetItem) targetItem.classList.add('active');

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Switch View) ---

    if (type === 'topup') {
        title.innerText = '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° (‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô/‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô)';
        // ‡∏î‡∏∂‡∏á‡∏Ç‡∏≠‡∏á‡∏à‡∏≤‡∏Å storage ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
        display.appendChild(topupListSec);
        display.appendChild(adminChatSec);

        adminChatSec.style.display = 'none';
        topupListSec.style.display = 'block';
        
        document.getElementById('topup-list-container').innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
        loadTopupRequests(); 

    } else if (type === 'kyc') { // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ KYC
        title.innerText = '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô (20 ‡πÄ‡∏°‡∏ï‡∏£)';
        // ‡∏î‡∏∂‡∏á‡∏™‡πà‡∏ß‡∏ô KYC ‡∏à‡∏≤‡∏Å storage ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å
        display.appendChild(kycListSec);
        
        kycListSec.style.display = 'block';
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
        document.getElementById('kyc-list-container').innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';
        loadKYCRequests(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°)

    } else if (type === 'automessage') {
        title.innerText = '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
        display.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';
        try {
            const adminName = localStorage.getItem('myUsername');
            const res = await fetch(`/api/admin/get-settings?admin=${adminName}`);
            const settings = await res.json();
            display.innerHTML = renderAutoMessageForm(settings.bankInfo, settings.desc);
        } catch (e) {
            display.innerHTML = renderAutoMessageForm();
        }

    } else if (type === 'history') {
        title.innerText = '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô';
        display.innerHTML = `<div id="admin-history-container" style="padding: 10px;"><p style="text-align:center; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>`;
        loadAdminHistory(); 
    }else if (type === 'members') {
    title.innerText = '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
    display.appendChild(membersListSec);
    membersListSec.style.display = 'block';
    loadMemberList(); 
}
    
    if(window.innerWidth <= 768 && document.getElementById('sidebar')?.classList.contains('active')) {
        toggleSidebar();
    }
}


async function loadAdminHistory() {
    const adminName = localStorage.getItem('myUsername');
    const container = document.getElementById('admin-history-container');
    if (!container) return;

    try {
        const res = await fetch(`/api/admin/topup-history?admin=${adminName}`);
        const history = await res.json();

        if (history.length === 0) {
            container.innerHTML = '<div style="text-align:center; margin-top:50px; color:#999;"><i class="fas fa-history fa-3x"></i><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</p></div>';
            return;
        }

        container.innerHTML = history.map(item => {
            // üö© ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
            const isWithdraw = item.type === 'WITHDRAW';
            const color = isWithdraw ? 'var(--danger)' : 'var(--primary)';
            const label = isWithdraw ? '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô';
            const icon = isWithdraw ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
            const statusLabel = item.status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß';

            return `
            <div class="admin-card" onclick="viewArchivedAdminChat('${item._id}', '${item.username}', ${item.amount}, '${item.status}', '${item.slipUrl || ""}', '${item.createdAt}', '${item.processedAt}')" 
                 style="cursor:pointer; display:flex; justify-content:space-between; align-items:center; border-left: 5px solid ${item.status === 'approved' ? 'var(--primary)' : 'var(--danger)'};">
                <div style="flex: 1;">
                    <div style="font-size: 0.8em; color: ${color}; font-weight: bold; margin-bottom: 2px;">
                        <i class="${icon}"></i> ${label}
                    </div>
                    <strong>User: ${item.username}</strong><br>
                    <span style="color:${item.status === 'approved' ? 'var(--primary)' : 'var(--danger)'}; font-weight:bold;">
                        ${statusLabel}: ${item.amount.toFixed(2)} USD
                    </span>
                </div>
                <div style="text-align:right;">
                    <small style="color:#999; display:block;">${new Date(item.processedAt).toLocaleString('th-TH')}</small>
                    <i class="fas fa-chevron-right" style="color:#eee; margin-top:5px;"></i>
                </div>
            </div>
            `;
        }).join('');
    } catch (err) {
        container.innerHTML = '<p style="text-align:center; color:red;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>';
    }
}


async function viewArchivedAdminChat(requestId, username, amount, status, slipUrl, createdAt, processedAt) {
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Section ‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏≤‡∏¢ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    const topupListSec = document.getElementById('section-topup-list');
    const adminChatSec = document.getElementById('section-admin-chat');
    let storage = document.getElementById('hidden-storage') || document.createElement('div');
    if (!storage.id) { storage.id = 'hidden-storage'; storage.style.display = 'none'; document.body.appendChild(storage); }
    if (topupListSec) storage.appendChild(topupListSec);
    if (adminChatSec) storage.appendChild(adminChatSec);

    currentChatRequestId = requestId;
    const display = document.getElementById('main-display');
    
    let slipSection = "";
    if (slipUrl && slipUrl !== "") {
        slipSection = `<div style="align-self: flex-start; background: white; padding: 10px; border-radius: 10px; border: 1px solid #ddd; max-width: 70%; margin-bottom:10px;">
            <div style="font-size: 0.8em; color: #666; margin-bottom: 5px;"><i class="fas fa-info-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
            <img src="${slipUrl}" style="max-width: 100%; border-radius: 5px; cursor: pointer;" onclick="window.open('${slipUrl}')">
            <div style="margin-top: 5px; font-weight: bold; color: var(--dark);">‡∏¢‡∏≠‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏¥‡∏°: ${amount.toFixed(2)} USD</div>
        </div>`;
    }

    display.innerHTML = `
        <div id="full-chat-container" style="display: flex; flex-direction: column; height: calc(100vh - 100px); background: white; margin: -25px; position: relative;">
            <div style="padding: 15px 20px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px;">
                <button onclick="showContent('history')" style="border:none; background:#f8fafc; width:40px; height:40px; border-radius:50%; cursor:pointer;"><i class="fas fa-arrow-left"></i></button>
                <div>
                    <h4 style="margin:0;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: ${username}</h4>
                    <small style="color:${status === 'approved' ? 'var(--primary)' : 'var(--danger)'}; font-weight:bold;">
                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß'} (${amount.toFixed(2)} USD)
                    </small>
                </div>
            </div>

            <div id="chat-box" style="flex: 1; padding: 20px; background: #f1f5f9; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                ${slipSection} 
            </div>

            <div style="padding: 15px; background: #fff; border-top: 1px solid #eee; color: #666; font-size: 0.85em; line-height: 1.6;">
    <div style="display: flex; justify-content: space-between;">
        <span><i class="far fa-clock"></i> ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠:</span>
        <b>${createdAt ? new Date(createdAt).toLocaleString('th-TH') : '-'}</b>
    </div>
    <div style="display: flex; justify-content: space-between;">
        <span><i class="fas fa-check-double"></i> ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:</span>
        <b>${processedAt ? new Date(processedAt).toLocaleString('th-TH') : '-'}</b>
    </div>
    <div style="text-align: center; color: #ccc; margin-top: 8px; font-size: 0.9em;">
        <i class="fas fa-lock"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                </div>
            </div>
        </div>`;

    await loadAdminChatHistory(requestId);
}



        // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£ Render ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ KYC
    function renderKYCList() {
    return `
        <div class="admin-card">
            <div>
                <strong>User: Maria_Brazil</strong><br>
                <small style="color:#666;">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</small>
            </div>
            <div>
                <button class="status-btn btn-approve">‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
            </div>
        </div>
    `;
}

    function confirmTopup(user, amount) {
    if(confirm(`‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏á‡∏¥‡∏ô ${amount} USD ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì ${user}?`)) {
        alert('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
}

    window.onload = async () => {
    const myUsername = localStorage.getItem('myUsername');
    if (!myUsername) { 
        window.location.href = 'index.html'; 
        return; 
    }

    document.getElementById('admin-name').innerText = myUsername;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ã‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡∏π‡πÅ‡∏• ---
    await fetchAdminZoneInfo(myUsername);

    updateBadges();
    loadTopupRequests();
    showContent('topup'); 
};



	function renderAutoMessageForm(bankInfo = "", desc = "") {
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const displayBank = bankInfo || "";
    const displayDesc = desc || "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó";

    return `
        <div class="admin-card" style="display: block; max-width: 600px; margin: 0 auto;">
            <h3 style="margin-top:0; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:10px;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; display: block; margin-bottom: 8px;">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ / ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå:</label>
                <textarea id="bank-info-input" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-family: inherit;">${displayBank}</textarea>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; display: block; margin-bottom: 8px;">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô:</label>
                <textarea id="topup-desc-input" rows="4" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-family: inherit;">${displayDesc}</textarea>
            </div>
            <button onclick="saveAutoMessage()" style="width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s;">
                <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        </div>
    `;
}

async function saveAutoMessage() {
    const bankInfo = document.getElementById('bank-info-input').value;
    const desc = document.getElementById('topup-desc-input').value;
    const adminName = localStorage.getItem('myUsername'); // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô

    try {
        const res = await fetch('/api/admin/save-settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminName, bankInfo, desc })
        });

        if (res.ok) {
            // ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏ã‡∏ü‡∏•‡∏á localStorage ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
            localStorage.setItem('adminBankInfo', bankInfo);
            localStorage.setItem('adminTopupDesc', desc);
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!");
        } else {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
        }
    } catch (e) {
        console.error(e);
        alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
    }
}





	async function updateBadges() {
    const myUsername = localStorage.getItem('myUsername');
    try {
        const res = await fetch(`/api/admin/pending-counts?admin=${myUsername}`);
        if (!res.ok) throw new Error('API Not Ready');
        const data = await res.json();
        document.getElementById('topup-count').innerText = data.topupCount || 0;
        document.getElementById('kyc-count').innerText = data.kycCount || 0;
    } catch(e) {
        console.warn("Badge API ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
    }
}





async function loadTopupRequests() {
    const adminName = localStorage.getItem('myUsername');
    const container = document.getElementById('topup-list-container');
    if (!container) return;

    try {
        // ‡πÉ‡∏ä‡πâ API ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡∏°‡∏µ‡∏ü‡∏¥‡∏•‡∏î‡πå type ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
        const res = await fetch(`/api/admin/topup-list?admin=${adminName}`);
        const requests = await res.json();
        
        if (requests.length === 0) {
            container.innerHTML = '<div style="text-align:center; margin-top:50px; color:#999;"><i class="fas fa-inbox fa-3x"></i><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</p></div>';
            return;
        }

        container.innerHTML = requests.map(req => {
            const reqType = (req.type || 'TOPUP').toUpperCase(); 
			const isWithdraw = reqType === 'WITHDRAW';
    
			const color = isWithdraw ? 'var(--danger)' : 'var(--primary)';
			const label = isWithdraw ? '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô';
			const icon = isWithdraw ? 'fas fa-arrow-circle-up' : 'fas fa-arrow-circle-down';

            return `
			<div class="admin-card" onclick="openFullChat('${req._id}', '${req.username}', ${req.amount}, '${reqType}', '${encodeURIComponent(req.bankInfo || "")}')" 
             style="cursor:pointer; display:flex; justify-content:space-between; align-items:center; border-left: 5px solid ${color};">
            <div>
                <div style="font-size: 0.85em; color: ${color}; font-weight: bold; margin-bottom: 5px;">
                    <i class="${icon}"></i> ${label}
                </div>
                <strong style="font-size: 1.1em; color: var(--dark);">@${req.username}</strong><br>
                <span style="color:${color}; font-weight:bold; font-size: 1.2em;">${req.amount.toFixed(2)} USD</span>
            </div>
            <div style="text-align:right; color:#999;">
                <small>${new Date(req.createdAt).toLocaleTimeString('th-TH')} ‡∏ô.</small><br>
                <i class="fas fa-chevron-right" style="margin-top: 10px; opacity: 0.3;"></i>
            </div>
        </div>
			`;
		}).join('');
    } catch (err) {
        container.innerHTML = '<p style="text-align:center; color:red;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>';
    }
}


async function handleQuickAction(requestId, status, username, amount = 0) {
    const actionText = status === 'approved' ? `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô ${amount} USD ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì ${username}?` : `‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ${username}?`;
    
    if (!confirm(actionText)) return;

    try {
        const res = await fetch('/api/admin/process-topup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                requestId: requestId, 
                status: status,
                adminName: localStorage.getItem('myUsername')
            })
        });

        if (res.ok) {
            alert("‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            
            // ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì Socket ‡∏ö‡∏≠‡∏Å User ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Ç‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            socket.emit('statusChanged', { 
                requestId: requestId, 
                status: status 
            });

            // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å
            loadTopupRequests();
            updateBadges();
        } else {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        }
    } catch (e) {
        console.error(e);
        alert("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤");
    }
}


async function loadAdminChatHistory(requestId) {
    const chatBox = document.getElementById('chat-box');
    try {
        const res = await fetch(`/api/topup/chat-history?requestId=${requestId}`);
        const history = await res.json();
        
        if (Array.isArray(history)) {
            history.forEach(msg => {
                appendAdminChatMessage(msg);
            });
        }
    } catch (err) {
        console.error("üö® Load chat history error:", err);
    }
}


// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏ó
async function openFullChat(requestId, username, amount, type, bankInfoEncoded) {
    currentChatRequestId = requestId;
    const isWithdraw = type === 'WITHDRAW';
    const bankInfo = decodeURIComponent(bankInfoEncoded);
    const themeColor = isWithdraw ? 'var(--danger)' : 'var(--primary)';
    
    socket.emit('joinRequest', requestId);

    // --- 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° ---
    const titleHeader = isWithdraw ? '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' : '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô';
    const mainIcon = isWithdraw ? 'fas fa-money-bill-transfer' : 'fas fa-hand-holding-usd';
    const cardBorderColor = isWithdraw ? '#ffcdd2' : '#c8e6c9';
    const cardBgColor = isWithdraw ? '#fff5f5' : '#e8f5e9';
    const textStatusColor = isWithdraw ? '#c62828' : '#2e7d32';

    // --- 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô) ---
    let withdrawInfoHtml = "";
    if (isWithdraw) {
        withdrawInfoHtml = `
            <div style="background: #f8fafc; padding: 15px; border-radius: 15px; border: 1px dashed #e74c3c; margin-bottom: 25px;">
                <b style="color: #c62828; display: block; margin-bottom: 5px;"><i class="fas fa-university"></i> ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b>
                <div style="background: white; padding: 10px; border-radius: 8px; font-family: monospace; user-select: all; border: 1px solid #eee;">
                    ${bankInfo.replace(/\n/g, '<br>')}
                </div>
                <small style="color: #666; margin-top: 5px; display: block;">* ‡πÇ‡∏õ‡∏£‡∏î‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</small>
            </div>`;
    }

    // --- 3. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö HTML ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô ---
    const display = document.getElementById('main-display');
    display.innerHTML = `
    <div id="topup-full-modal" style="position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100dvh; background: white; overflow-y: auto; display: flex; flex-direction: column;">
        
        <div style="position: sticky; top: 0; background: white; z-index: 100; padding: calc(15px + env(safe-area-inset-top)) 20px 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button onclick="closeFullChatModal()" style="border: none; background: #f1f5f9; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div>
                    <h3 style="margin: 0; font-size: 1.1em; color: var(--dark);">${titleHeader}</h3>
                    <small style="color: #666;">‡∏à‡∏≤‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: <b>${username}</b></small>
                </div>
            </div>
            <i class="fas fa-ellipsis-v" style="color: #ccc;"></i>
        </div>

        <div style="padding: 20px; max-width: 500px; margin: 0 auto; width: 100%; box-sizing: border-box; flex: 1;">
            
            <div style="display: flex; align-items: center; gap: 12px; padding: 18px; border-radius: 15px; border: 1px solid ${cardBorderColor}; margin-bottom: 25px; background: ${cardBgColor};">
                <div style="background: ${themeColor}; color: white; width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3em;">
                    <i class="${mainIcon}"></i>
                </div>
                <div style="text-align: left; flex: 1;">
                    <div style="font-weight: bold; color: ${textStatusColor}; font-size: 1em;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (${type})</div>
                    <div style="font-size: 1.2em; color: ${themeColor}; font-weight: bold;">${amount.toFixed(2)} USD</div>
                </div>
            </div>

            ${withdrawInfoHtml}

            <div style="display: flex; gap: 15px; margin-bottom: 30px;">
                <button class="status-btn btn-reject" onclick="processAction('rejected', '${username}', ${amount}, '${type}')" style="flex: 1; padding: 16px; border-radius: 15px; font-weight: bold; cursor: pointer;">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                <button class="status-btn btn-approve" onclick="processAction('approved', '${username}', ${amount}, '${type}')" style="flex: 2; padding: 16px; border-radius: 15px; font-weight: bold; font-size: 1em; cursor: pointer; background: ${themeColor};">
                    <i class="fas fa-check-circle"></i> ${isWithdraw ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô'}
                </button>
            </div>

            <div style="background: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; overflow: hidden; margin-bottom: 40px;">
                <div style="padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; color: var(--dark); display: flex; align-items: center; gap: 10px; background: #f8fafc;">
                    <i class="fas fa-comments" style="color: ${themeColor};"></i> ‡πÅ‡∏ä‡∏ó‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô
                </div>
                <div id="chat-box" style="height: 350px; overflow-y: auto; padding: 15px; background: #f1f5f9; display: flex; flex-direction: column; gap: 10px;"></div>
                <div style="padding: 15px; background: white; display: flex; gap: 10px; border-top: 1px solid #eee;">
                     <input type="file" id="admin-slip-input" hidden accept="image/*" onchange="handleAdminSlipUpload()">
                     <button onclick="document.getElementById('admin-slip-input').click()" style="background: #f1f5f9; border: none; width: 45px; height: 45px; border-radius: 10px; cursor: pointer;"><i class="fas fa-image"></i></button>
                     <input type="text" id="admin-chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." style="flex:1; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; outline: none;">
                     <button onclick="sendAdminMessage()" style="background: ${themeColor}; color: white; border: none; width: 45px; height: 45px; border-radius: 10px;"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
    `;
    
    // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ä‡∏ó‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å innerHTML ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
    await loadAdminChatHistory(requestId);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å)
function closeFullChatModal() {
    const modal = document.getElementById('topup-full-modal');
    if (modal) {
        modal.remove(); // ‡∏•‡∏ö Modal ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    }
    showContent('topup'); // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ List ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô
}


//2.1
async function processAction(status, username, initialAmount = 0, type = 'TOPUP') {
    let finalAmount = initialAmount;
    const isWithdraw = type === 'WITHDRAW';
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    const actionLabel = status === 'approved' 
        ? (isWithdraw ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤')
        : (isWithdraw ? '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô');

    if (status === 'approved') {
        const confirmMsg = isWithdraw 
            ? `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÉ‡∏´‡πâ @${username} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${initialAmount.toFixed(2)} USD ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÇ‡∏≠‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)`
            : `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ @${username} (USD):`;

        if (!isWithdraw) {
            const inputAmount = prompt(confirmMsg, initialAmount);
            if (inputAmount === null) return;
            finalAmount = parseFloat(inputAmount);
        } else {
            if (!confirm(confirmMsg)) return;
        }
    } else {
        if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${actionLabel} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    }

    try {
        const res = await fetch('/api/admin/process-topup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                requestId: currentChatRequestId, 
                status: status,
                finalAmount: finalAmount,
                adminName: localStorage.getItem('myUsername')
            })
        });

        const data = await res.json();
        if (res.ok) {
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', data.message, 'success');
            socket.emit('statusChanged', { requestId: currentChatRequestId, status: status });
            
            // ‡∏™‡πà‡∏á System Message ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó
            const sysMsg = {
                requestId: currentChatRequestId,
                sender: 'System',
                message: status === 'approved' 
                    ? `‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${isWithdraw ? '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' : '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô'} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${finalAmount.toFixed(2)} USD` 
                    : `‚ùå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô`,
                type: 'system'
            };
            socket.emit('sendMessage', sysMsg);

            showContent('topup'); // ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏°
            updateBadges();
        } else {
            Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", 'error');
        }
    } catch (e) {
        Swal.fire('Error', "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ", 'error');
    }
}



// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
async function processRequest(status) {
    const action = status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò';
    if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${action} ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

    try {
        const res = await fetch(`/api/admin/process-topup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                requestId: currentChatRequestId, 
                status: status,
                adminName: localStorage.getItem('myUsername')
            })
        });

        if (res.ok) {
        // ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì Real-time ‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ User ‡πÄ‡∏î‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        socket.emit('statusChanged', { 
            requestId: currentChatRequestId, 
            status: status 
        });
        
        alert("‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        showContent('topup');
        }
    } catch (e) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå");
    }
}



// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
function sendAdminMessage() {
    const input = document.getElementById('admin-chat-input');
    const message = input.value.trim();
    if (!message || !currentChatRequestId) return;

    const chatData = {
        requestId: currentChatRequestId,
        sender: localStorage.getItem('myUsername'),
        message: message,
        type: 'text'
    };

    socket.emit('sendMessage', chatData); // ‡∏™‡πà‡∏á‡πÑ‡∏õ Server
    appendAdminChatMessage(chatData);     // ‡πÅ‡∏™‡∏î‡∏á‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    input.value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏ó‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
function appendAdminChatMessage(msg) {
    const chatBox = document.getElementById('chat-box');
    if (!chatBox) return;

    const isMe = msg.sender === localStorage.getItem('myUsername');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    let contentHTML = "";
    if (msg.type === 'image') {
        contentHTML = `<img src="${msg.message}" style="max-width: 100%; border-radius: 10px; cursor: pointer; display: block;" onclick="window.open(this.src)">`;
    } else {
        contentHTML = `<p style="margin: 0; line-height: 1.5;">${msg.message}</p>`;
    }
	
	if (msg.type === 'system') {
    const sysHTML = `
        <div style="align-self: center; margin: 15px 0; background: #fff4e5; color: #663c00; padding: 8px 20px; border-radius: 20px; font-size: 0.85em; font-weight: bold; border: 1px solid #ffe7cc;">
            ${msg.message}
        </div>
    `;
    chatBox.innerHTML += sysHTML;
    chatBox.scrollTop = chatBox.scrollHeight; 
    return;
}

    const msgHTML = `
        <div style="display: flex; flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
            <div style="background: ${isMe ? 'var(--primary)' : 'white'}; 
                        color: ${isMe ? 'white' : 'var(--dark)'}; 
                        padding: ${msg.type === 'image' ? '5px' : '10px 15px'}; 
                        border-radius: ${isMe ? '15px 15px 0 15px' : '15px 15px 15px 0'}; 
                        max-width: 70%; 
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        border: ${isMe ? 'none' : '1px solid #eee'};">
                ${contentHTML}
            </div>
            <small style="font-size: 0.7em; color: #94a3b8; margin-top: 3px;">
                ${isMe ? '‡∏Ñ‡∏∏‡∏ì (Admin)' : msg.sender}
            </small>
        </div>
    `;

    chatBox.innerHTML += msgHTML;
    chatBox.scrollTop = chatBox.scrollHeight;
}

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Socket ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ appendAdminChatMessage
socket.on('receiveMessage', (msg) => {
    const myName = localStorage.getItem('myUsername');
    if (msg.sender === myName) return; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏î‡∏ã‡πâ‡∏≥ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ß‡∏≤‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á)

    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
    if (msg.requestId === currentChatRequestId) {
        if (typeof appendAdminChatMessage === "function") {
            appendAdminChatMessage(msg);
        }
    }

    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡πÅ‡∏ä‡∏ó KYC (‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
    if (msg.requestId === currentKYCRequestId) {
        if (typeof appendKYCChatMessage === "function") {
            appendKYCChatMessage(msg);
        }
    }
});

socket.on('notifyAdminNewRequest', (data) => {
    const myName = localStorage.getItem('myUsername');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (data.adminId === myName) {
        // 1. ‡∏™‡∏±‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ pending ‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå)
        if (typeof loadTopupList === "function") {
            loadTopupList(); 
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            // ‡πÄ‡∏ä‡πà‡∏ô fetchPendingRequests();
            location.reload(); // ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏Å‡πâ‡∏Ç‡∏±‡∏î‡πÑ‡∏î‡πâ)
        }

        // 2. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏´‡∏£‡∏∑‡∏≠ Toast (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        console.log("üîî ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤!");
        // alert("‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì " + data.username);
    }
});


// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ù‡∏±‡πà‡∏á User)
async function compressImage(file, { maxWidth = 1024, quality = 0.7 }) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                canvas.toBlob((blob) => resolve(blob), 'image/jpeg', quality);
            };
        };
        reader.onerror = (error) => reject(error);
    });
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
async function handleAdminSlipUpload() {
    const fileInput = document.getElementById('admin-slip-input');
    const file = fileInput.files[0];
    if (!file || !currentChatRequestId) return;

    const btn = document.getElementById('admin-image-btn');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î

    try {
        // ‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
        const compressedBlob = await compressImage(file, { maxWidth: 1024, quality: 0.7 });
        
        const formData = new FormData();
        formData.append('slip', compressedBlob, 'admin_receipt.jpg');

        // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á API ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ (Cloudinary - ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå topup_slips)
        const res = await fetch('/api/upload-slip', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();

        if (data.url) {
            const chatData = {
                requestId: currentChatRequestId,
                sender: localStorage.getItem('myUsername'),
                message: data.url,
                type: 'image'
            };
            // ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô Socket ‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
            socket.emit('sendMessage', chatData);
            appendAdminChatMessage(chatData);
        }
    } catch (err) {
        console.error("Upload error:", err);
        alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
    } finally {
        fileInput.value = '';
        btn.innerHTML = '<i class="fas fa-image"></i>';
    }
}





//=====KYC 
// ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠ KYC ‡πÉ‡∏´‡∏°‡πà
socket.on('admin-notification', (data) => {
	const myName = localStorage.getItem('myUsername');
	if (data.adminId !== myName) return;
    if (data.type === 'KYC_REQUEST') {
        updateBadges(); 
        
        let audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');
        audio.play();

        console.log("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà:", data.message);
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡πà‡∏ß‡∏ô KYC ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const mainDisplay = document.getElementById('main-display');
        const kycInDisplay = mainDisplay.querySelector('#section-kyc-list');
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ section-kyc-list ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å (‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ) ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
        if (kycInDisplay && kycInDisplay.style.display !== 'none') {
            console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ KYC ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠...");
            loadKYCRequests(); 
        }
    }
});

async function loadKYCRequests() {
    const container = document.getElementById('kyc-list-container');
    container.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠...</div>';

    try {
        const adminName = localStorage.getItem('myUsername');
        const res = await fetch(`/api/admin/kyc-list?admin=${adminName}`);
        const requests = await res.json();

        if (requests.length === 0) {
            container.innerHTML = '<div style="text-align:center; margin-top:50px; color:#999;"><i class="fas fa-user-shield fa-3x"></i><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÉ‡∏´‡∏°‡πà</p></div>';
            return;
        }

        // 1. ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Promise ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
        const getPosition = () => {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject);
            });
        };

        let adminPos = null;
        try {
            // ‡∏£‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô
            adminPos = await Promise.race([
                getPosition(),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 1500))
            ]);
        } catch (e) {
            console.log("‡∏¢‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î GPS");
        }

        container.innerHTML = requests.map(req => {
            let distanceText = "‡∏£‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
            let distanceVal = 0;
            let isClose = false;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏´‡∏°
            if (adminPos && req.coords) {
                distanceVal = calculateDistance(
                    adminPos.coords.latitude, 
                    adminPos.coords.longitude, 
                    req.coords.lat, 
                    req.coords.lng
                );
                distanceText = `‡∏´‡πà‡∏≤‡∏á ${distanceVal.toFixed(1)} ‡∏°.`;
                isClose = distanceVal <= 20;
            }

            // ‡πÉ‡∏ä‡πâ encodeURIComponent ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏ô JSON
            const dataStr = encodeURIComponent(JSON.stringify(req));

            return `
            <div class="admin-card" onclick="viewKYCDetail('${dataStr}')" style="cursor:pointer; transition: 0.2s; position: relative; display: flex; justify-content: space-between; align-items: center; padding: 15px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 10px; background: white;">
                <div style="display: flex; gap: 12px; align-items: center; flex: 1;">
                    <img src="${req.userImg || 'https://via.placeholder.com/60'}" style="width: 50px; height: 50px; border-radius: 10px; object-fit: cover; border: 1px solid #ddd;">
                    <div style="text-align: left;">
                        <strong style="font-size: 1em; color: var(--dark);">${req.fullName}</strong><br>
                        <small style="color: ${isClose ? 'var(--primary)' : '#666'}; font-weight: bold;">
                            <i class="fas fa-map-marker-alt"></i> ${distanceText}
                        </small>
                    </div>
                </div>
                <div style="color: var(--primary); font-size: 0.85em; font-weight: bold; white-space: nowrap;">
                    ‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <i class="fas fa-chevron-right" style="font-size: 0.8em; margin-left: 5px;"></i>
                </div>
            </div>`;
        }).join('');

    } catch (err) {
        console.error("Load KYC Error:", err);
        container.innerHTML = '<p style="text-align:center; color:red; padding:20px;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á</p>';
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Haversine ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î 2 ‡∏à‡∏∏‡∏î
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000; // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÇ‡∏•‡∏Å (‡πÄ‡∏°‡∏ï‡∏£)
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function viewKYCFullImage(src) {
    document.getElementById('kyc-modal-img').src = src;
    document.getElementById('kyc-image-modal').style.display = 'flex';
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
function viewKYCDetail(dataStr) {
    const data = JSON.parse(decodeURIComponent(dataStr));
    currentKYCRequestId = data.username; 
    const modal = document.getElementById('admin-kyc-detail-modal');
    
    // 1. ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ
    document.getElementById('det-user-img').style.backgroundImage = `url(${data.userImg})`;
    document.getElementById('det-name').innerText = data.fullName;
    document.getElementById('det-id').innerText = data.idNumber;
    document.getElementById('det-phone').innerText = data.phone;
    document.getElementById('det-username').innerText = `@${data.username}`;
    document.getElementById('det-address').innerText = data.address;
    
    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
    window.updateModalDistance = () => {
        navigator.geolocation.getCurrentPosition((pos) => {
            const dist = calculateDistance(pos.coords.latitude, pos.coords.longitude, data.coords.lat, data.coords.lng);
            const isClose = dist <= 20;
            
            const distElem = document.getElementById('det-distance');
            const titleElem = document.getElementById('det-title');
            const badgeElem = document.getElementById('det-status-badge');
            // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å btnApprove ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            const btnApprove = document.getElementById('btn-det-approve');

            distElem.innerHTML = `<i class="fas fa-map-marker-alt"></i> ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${dist.toFixed(1)} ‡πÄ‡∏°‡∏ï‡∏£`;

            if (isClose) {
                titleElem.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞)";
                badgeElem.style.background = "#e8f5e9";
                badgeElem.style.borderColor = "#c8e6c9";
                btnApprove.style.background = "var(--primary)"; 
            } else {
                titleElem.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÑ‡∏Å‡∏•‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ 20‡∏°.)";
                badgeElem.style.background = "#fff3e0";
                badgeElem.style.borderColor = "#ffe0b2";
                btnApprove.style.background = "#94a3b8";
            }
        });
    };

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î
    updateModalDistance();

    // 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î
    document.getElementById('btn-det-approve').onclick = () => { 
        checkDistanceBeforeApprove(data._id, data.username, data.coords.lat, data.coords.lng); 
    };
    
    document.getElementById('btn-det-reject').onclick = () => { 
        deleteKYCRequest(data._id, data.username); 
    };

    modal.scrollTop = 0;
    modal.style.display = 'block';
    
    document.getElementById('kyc-chat-box').innerHTML = '<div style="text-align:center; padding:10px; color:#999; font-size:0.8em;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó...</div>';
    loadKYCChatHistory(data.username); 
    socket.emit('joinRequest', data.username); 
}

function closeKYCDetail() {
    document.getElementById('admin-kyc-detail-modal').style.display = 'none';
}


// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó KYC
async function loadKYCChatHistory(requestId) {
    try {
        const res = await fetch(`/api/kyc/chat-history?requestId=${requestId}`);
        const history = await res.json();
        const chatBox = document.getElementById('kyc-chat-box');
        chatBox.innerHTML = '';
        
        if (Array.isArray(history)) {
            history.forEach(msg => appendKYCChatMessage(msg));
        }
    } catch (err) {
        console.error("Load KYC chat error:", err);
    }
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
function sendKYCAdminMessage() {
    const input = document.getElementById('kyc-admin-input');
    const message = input.value.trim();
    if (!message || !currentKYCRequestId) return;

    const chatData = {
        requestId: currentKYCRequestId,
        sender: localStorage.getItem('myUsername'),
        message: message,
        type: 'text',
        category: 'kyc' 
    };

    socket.emit('sendMessage', chatData);
    appendKYCChatMessage(chatData);
    input.value = '';
}

// 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
function appendKYCChatMessage(msg) {
    const chatBox = document.getElementById('kyc-chat-box');
    if (!chatBox) return;

    const isMe = msg.sender === localStorage.getItem('myUsername');
    
    const msgHTML = `
        <div style="display: flex; flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'}; margin-bottom: 8px;">
            <div style="background: ${isMe ? 'var(--primary)' : 'white'}; 
                        color: ${isMe ? 'white' : 'var(--dark)'}; 
                        padding: 8px 12px; border-radius: 12px; 
                        max-width: 85%; font-size: 0.9em;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                        border: ${isMe ? 'none' : '1px solid #e2e8f0'};">
                ${msg.message}
            </div>
            <small style="font-size: 0.6em; color: #94a3b8; margin-top: 2px; padding: 0 5px;">
                ${isMe ? '‡∏Ñ‡∏∏‡∏ì' : msg.sender} ‚Ä¢ ${new Date(msg.timestamp || new Date()).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}
            </small>
        </div>
    `;
    chatBox.insertAdjacentHTML('beforeend', msgHTML);
    chatBox.scrollTop = chatBox.scrollHeight;
}

async function deleteKYCRequest(requestId, username) {
    if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡∏∞ "‡∏•‡∏ö" ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á @${username} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`)) {
        return;
    }

    try {
        const res = await fetch('/api/admin/delete-kyc', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ requestId, username })
        });

        const data = await res.json();

        if (data.success) {
            alert("‡∏•‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
            closeKYCDetail(); 
            loadKYCRequests();
            updateBadges(); 
        } else {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + data.error);
        }
    } catch (err) {
        console.error(err);
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ");
    }
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
async function checkDistanceBeforeApprove(requestId, username, memberLat, memberLng) {
    const adminName = localStorage.getItem('myUsername');
    
    // 1. ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...',
	allowOutsideClick: false,
	target: document.getElementById('admin-kyc-detail-modal'),
	didOpen: () => Swal.showLoading() });

    navigator.geolocation.getCurrentPosition(async (pos) => {
        const adminLat = pos.coords.latitude;
        const adminLng = pos.coords.longitude;
        
        // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á
        const dist = calculateDistance(adminLat, adminLng, memberLat, memberLng);
        const isPass = dist <= 20;

        // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
        Swal.fire({
            title: isPass ? '‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á',
            html: `‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b>${dist.toFixed(1)} ‡πÄ‡∏°‡∏ï‡∏£</b><br>${isPass ? '<span style="color:green">‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞ 20 ‡πÄ‡∏°‡∏ï‡∏£‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>' : '<span style="color:red">‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏Å‡∏•‡πÄ‡∏Å‡∏¥‡∏ô 20 ‡πÄ‡∏°‡∏ï‡∏£</span>'}`,
            icon: isPass ? 'success' : 'warning',
			target: document.getElementById('admin-kyc-detail-modal'),
            showCancelButton: true,
            confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: isPass ? '#11998e' : '#94a3b8',
        }).then((result) => {
            if (result.isConfirmed) {
				if (!isPass) {
				return Swal.fire({
					title: '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
					text: '‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 20 ‡πÄ‡∏°‡∏ï‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
					icon: 'error',
					target: document.getElementById('admin-kyc-detail-modal')
				});
			}
    executeApprove(requestId, username, adminName);
}
        });
    }, (err) => {
        Swal.fire({
            title: '‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ä‡πá‡∏Å‡∏£‡∏∞‡∏¢‡∏∞',
            icon: 'error',
            target: document.getElementById('admin-kyc-detail-modal')
        });
    });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á API ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
async function executeApprove(requestId, username, adminName) {
    try {
        const res = await fetch('/api/admin/approve-kyc', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ requestId, username, adminName })
        });
        if (res.ok) {
            Swal.fire({
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                icon: 'success',
                target: document.getElementById('admin-kyc-detail-modal')
            }).then(() => {
                closeKYCDetail();
                loadKYCRequests();
            });
        }
    } catch (e) { console.error(e); }
}


async function loadMemberList() {
    const container = document.getElementById('members-list-container');
    const search = document.getElementById('member-search-input').value;
    const filterStatus = document.getElementById('member-filter-status').value; // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Filter
    const adminName = localStorage.getItem('myUsername');
    
    container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å...</p>';

    try {
        const res = await fetch(`/api/users-list?requestBy=${adminName}&search=${search}&limit=100`);
        const data = await res.json();
        let members = data.users;

        // ‚úÖ ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡∏ù‡∏±‡πà‡∏á Frontend
        if (filterStatus === 'kyc') {
            members = members.filter(u => u.isVerified === true);
        } else if (filterStatus === 'not_kyc') {
            members = members.filter(u => u.isVerified !== true);
        } else if (filterStatus === 'banned') {
            members = members.filter(u => u.isBanned === true);
        }

        if (!members || members.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
            return;
        }

        // ‡∏ß‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (Map ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        container.innerHTML = members.map(user => {
            const username = user.name;
            const coins = user.coins || 0;
            const relation = user.relationType;

            return `
                <div class="admin-card" style="display: flex; align-items: center; gap: 15px; padding: 15px; border-left: 5px solid ${user.isBanned ? 'var(--danger)' : (relation === 'OWNED' ? 'var(--primary)' : '#f1c40f')};">
                    <img src="${user.profileImg || 'https://via.placeholder.com/50'}" 
                         style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; opacity: ${user.isBanned ? '0.5' : '1'};">
                    
                    <div style="flex: 1;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <strong style="font-size: 1em; color: ${user.isBanned ? 'var(--danger)' : 'var(--dark)'};">${username}</strong>
                            ${user.isVerified ? '<i class="fas fa-check-circle" style="color:var(--primary); font-size:0.8em;"></i>' : ''}
                            ${user.isBanned ? '<small style="background:#ffebee; color:red; padding:1px 5px; border-radius:5px; font-size:0.6em;">BANNED</small>' : ''}
                        </div>
                        <div style="font-size: 0.8em; color: var(--primary); font-weight: bold;">
                            Balance: ${coins.toFixed(2)} USD
                        </div>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button onclick="viewUserProfile('${username}')" 
                                style="border: none; background: #f1f5f9; color: var(--dark); padding: 8px 15px; border-radius: 10px; font-size: 0.85em; cursor: pointer; font-family:'Kanit'; font-weight:bold;">
                            <i class="fas fa-search"></i> ‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
                        </button>
                    </div>
                </div>
            `;
        }).join('');

    } catch (err) {
        container.innerHTML = '<p style="text-align:center; color:red;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ</p>';
    }
}


async function viewUserProfile(username) {
    Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå...',
        target: document.getElementById('user-profile-modal'),
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });

    try {
        const adminName = localStorage.getItem('myUsername');
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡πà‡∏≤‡∏ô API ‡πÄ‡∏î‡∏¥‡∏°
        const res = await fetch(`/api/users-list?requestBy=${adminName}&search=${username}`);
        const data = await res.json();
        const user = data.users.find(u => u.name === username);

        if (!user) {
            Swal.fire({ title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', icon: 'error', target: document.getElementById('user-profile-modal') });
            return;
        }

        Swal.close();
        const content = document.getElementById('user-profile-content');
        
        // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• KYC (‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà Verified ‡πÅ‡∏•‡πâ‡∏ß)
        let kycHtml = "";
        if (user.isVerified) {
            kycHtml = `
                <div style="background: #e8f5e9; border-radius: 20px; padding: 20px; border: 1px solid #c8e6c9; margin-bottom: 25px;">
                    <h4 style="margin: 0 0 15px 0; color: #2e7d32; font-size: 1em;">
                        <i class="fas fa-id-card"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
                    </h4>
                    <div style="display: grid; gap: 10px; font-size: 0.9em;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #666;">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</span>
                            <b>${user.idNumber || '-'}</b>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #666;">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</span>
                            <b>${user.phone || '-'}</b>
                        </div>
                        <div style="border-top: 1px solid #c8e6c9; padding-top: 10px;">
                            <small style="color: #666;">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</small>
                            <div style="font-weight: bold; margin-top: 2px;">${user.address || '-'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        content.innerHTML = `
            <div style="text-align: center; margin-bottom: 25px;">
                <div style="position: relative; display: inline-block;">
                    <img src="${user.profileImg || 'https://via.placeholder.com/120'}" 
                         style="width: 110px; height: 110px; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    ${user.isVerified ? '<div style="position: absolute; bottom: 0; right: 0; background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white;"><i class="fas fa-check" style="font-size: 0.8em;"></i></div>' : ''}
                </div>
                <h3 style="margin: 15px 0 5px;">@${user.name}</h3>
                <div style="color: #f1c40f; font-weight: bold;">
                    <i class="fas fa-star"></i> ${user.rating.toFixed(1)} 
                    <span style="color: #94a3b8; font-weight: normal; font-size: 0.8em;">(${user.ratingCount} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)</span>
                </div>
                <p style="color: #64748b; font-size: 0.9em; margin-top: 5px;">${user.fullName || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 25px;">
                <div style="background: #f8fafc; padding: 12px; border-radius: 12px; text-align: center; border: 1px solid #eee;">
                    <div style="font-size: 0.7em; color: #94a3b8; text-transform: uppercase;">‡πÇ‡∏û‡∏™‡∏ï‡πå</div>
                    <div style="font-weight: bold; font-size: 1.1em;">${user.totalPosts}</div>
                </div>
                <div style="background: #f8fafc; padding: 12px; border-radius: 12px; text-align: center; border: 1px solid #eee;">
                    <div style="font-size: 0.7em; color: #94a3b8; text-transform: uppercase;">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</div>
                    <div style="font-weight: bold; font-size: 1.1em;">${user.totalJobs}</div>
                </div>
                <div style="background: #e8f5e9; padding: 12px; border-radius: 12px; text-align: center; border: 1px solid #c8e6c9;">
                    <div style="font-size: 0.7em; color: #2e7d32; text-transform: uppercase;">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                    <div style="font-weight: bold; font-size: 1.1em; color: #2e7d32;">${user.completedJobs}</div>
                </div>
            </div>

            <div style="background: white; padding: 15px; border-radius: 15px; border: 1px solid #eee; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #666;"><i class="fas fa-coins" style="color: #f1c40f;"></i> ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
                <b style="font-size: 1.2em; color: var(--primary);">${user.coins.toFixed(2)} USD</b>
            </div>

            ${kycHtml}

            <div style="padding-bottom: 30px;">
                <button onclick="manageUserBan('${user.name}', ${user.isBanned})" 
                        style="width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-family: 'Kanit';
                        background: ${user.isBanned ? 'var(--primary)' : '#ffebee'}; 
                        color: ${user.isBanned ? 'white' : '#c62828'};">
                    <i class="fas fa-ban"></i> ${user.isBanned ? '‡∏õ‡∏•‡∏î‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (BAN)'}
                </button>
            </div>
        `;

        document.getElementById('user-profile-modal').style.display = 'block';

    } catch (err) {
        console.error(err);
        Swal.fire({ title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', icon: 'error', target: document.getElementById('user-profile-modal') });
    }
}

function closeUserProfile() {
    document.getElementById('user-profile-modal').style.display = 'none';
}


// ‚úÖ 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏ö‡∏ô (1, 3, 7, 15, 30 ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏≤‡∏ß‡∏£)
async function manageUserBan(username, isCurrentlyBanned) {
    if (isCurrentlyBanned) {
        const result = await Swal.fire({
            title: '‡∏õ‡∏•‡∏î‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô?',
            text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô‡∏Ñ‡∏∏‡∏ì @${username} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô‡πÄ‡∏•‡∏¢',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            target: document.getElementById('user-profile-modal')
        });

        if (result.isConfirmed) {
            executeBanAction(username, 0); // 0 = ‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô
        }
    } else {
        const { value: days } = await Swal.fire({
            title: `‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô @${username}`,
            input: 'select',
            inputOptions: {
                '1': '1 ‡∏ß‡∏±‡∏ô',
                '3': '3 ‡∏ß‡∏±‡∏ô',
                '7': '7 ‡∏ß‡∏±‡∏ô',
                '15': '15 ‡∏ß‡∏±‡∏ô',
                '30': '30 ‡∏ß‡∏±‡∏ô',
                '9999': '‡∏ñ‡∏≤‡∏ß‡∏£ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≥‡∏´‡∏ô‡∏î)'
            },
            inputPlaceholder: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô',
            showCancelButton: true,
            confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: '#e74c3c',
			target: document.getElementById('user-profile-modal'),
            inputValidator: (value) => {
                if (!value) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤'
            }
        });

        if (days) {
            executeBanAction(username, parseInt(days));
        }
    }
}

// ‚úÖ 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server (‡πÉ‡∏ä‡πâ API /api/admin/toggle-ban ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
async function executeBanAction(username, days) {
    Swal.fire({ 
			title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...',
			target: document.getElementById('user-profile-modal'),
			didOpen: () => Swal.showLoading() });

    try {
        const adminName = localStorage.getItem('myUsername');
        const res = await fetch('/api/admin/toggle-ban', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                targetUser: username,
                shouldBan: days > 0, // ‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏°‡∏≤‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏ö‡∏ô (true) ‡∏ñ‡πâ‡∏≤ 0 ‡∏Ñ‡∏∑‡∏≠‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô (false)
                requestBy: adminName,
                banDays: days,
                lang: 'th'
            })
        });

        const data = await res.json();
        if (res.ok && data.success) {
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', days > 0 ? '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => {
                closeUserProfile(); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
                loadMemberList();   // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            });
        } else {
            Swal.fire('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ', data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    } catch (err) {
        console.error(err);
        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error');
    }
}

//‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô
async function fetchAdminZoneInfo(username) {
    try {
        const res = await fetch(`/api/admin/my-zone-info?admin=${username}`);
        const data = await res.json();
        if(data.success) {
            currentZoneId = data.zone.id;
            zoneCurrency = data.zone.zoneCurrency;
            zoneRate = data.zone.zoneExchangeRate;
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç (coins) ‡πÉ‡∏ô sidebar
            document.getElementById('sidebar-usdt-balance').innerText = `${data.adminCoins.toFixed(2)} USDT`;
        }
    } catch (e) { console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ã‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", e); }
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏á‡∏¥‡∏ô
async function openExchangeModal() {
    if (!currentZoneId) {
        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ã‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏î‡∏π‡πÅ‡∏•', 'error');
        return;
    }

    const adminName = localStorage.getItem('myUsername');

    try {
        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏¢‡∏≠‡∏î coins ‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)
        const res = await fetch(`/api/admin/get-zone-detail/${currentZoneId}?adminId=${adminName}`);
        const data = await res.json();
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÑ‡∏´‡∏°
        if (!data.success) throw new Error(data.message);

        // 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å data.admin.usdtBalance ‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≤)
        const myUsdt = data.admin.usdtBalance || 0; 

        const { value: usdtAmount } = await Swal.fire({
            title: '‡πÅ‡∏õ‡∏•‡∏á USDT ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô',
            html: `
                <div style="text-align:left; font-family:'Kanit',sans-serif;">
                    <p><b>‡πÄ‡∏£‡∏ó‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</b> 1 USDT = ${zoneRate} ${zoneCurrency}</p>
                    <p><b>‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</b> <span style="color:var(--primary)">${myUsdt.toFixed(2)} USDT</span></p>
                    <hr>
                    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô USDT ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á:</label>
                    <input id="ex-usdt" type="number" step="0.01" class="swal2-input" placeholder="0.00" style="width:100%; margin:10px 0;">
                    <div id="ex-preview" style="background:#f1f5f9; padding:10px; border-radius:10px; text-align:center; font-weight:bold; color:var(--primary);">
                        ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: 0.00 ${zoneCurrency}
                    </div>
                </div>
            `,
            didOpen: () => {
                const input = document.getElementById('ex-usdt');
                input.addEventListener('input', () => {
                    const val = parseFloat(input.value) || 0;
                    document.getElementById('ex-preview').innerText = `‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${(val * zoneRate).toLocaleString()} ${zoneCurrency}`;
                });
            },
            showCancelButton: true,
            confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: 'var(--primary)',
            preConfirm: () => {
                const val = parseFloat(document.getElementById('ex-usdt').value);
                if (!val || val <= 0 || val > myUsdt) {
                    Swal.showValidationMessage('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ USDT ‡πÑ‡∏°‡πà‡∏û‡∏≠');
                }
                return val;
            }
        });

        if (usdtAmount) {
            executeExchange(usdtAmount);
        }
    } catch (e) {
        console.error(e);
        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏î‡πâ', 'error');
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
async function executeExchange(amount) {
    try {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', didOpen: () => Swal.showLoading() });
        const adminName = localStorage.getItem('myUsername');
        
        const res = await fetch('/api/admin/convert-currency', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                adminId: adminName,
                usdtToConvert: amount,
                zoneId: currentZoneId
            })
        });

        const result = await res.json();
        if (result.success) {
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', `‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${result.received} ${result.currency}`, 'success')
            .then(() => location.reload());
        } else {
            Swal.fire('‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', result.message, 'error');
        }
    } catch (e) { Swal.fire('Error', '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á', 'error'); }
}



socket.on('kyc-location-updated', (data) => {
    if (currentKYCRequestId === data.username) {
        console.log("‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà -> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡πÉ‡∏´‡∏°‡πà");
        if (typeof updateModalDistance === "function") updateModalDistance();
        loadKYCRequests(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏î‡πâ‡∏ß‡∏¢
    }
});




    </script>
	
	
	
<div id="hidden-storage" style="display: none;">
        
        <div id="section-topup-list">
            <div id="topup-list-container">
            </div>
        </div>

        <div id="section-admin-chat" style="display: none;">
            <button onclick="showContent('topup')" style="background: none; border: none; color: var(--primary); cursor: pointer; margin-bottom: 15px;">
                <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠
            </button>

            <div id="chat-box" style="background: #f1f3f5; padding: 20px; border-radius: 15px; height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;">
            </div>

            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button class="status-btn btn-reject" style="flex: 1; padding: 15px;" onclick="processRequest('rejected')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
                <button class="status-btn btn-approve" style="flex: 1; padding: 15px;" onclick="processRequest('approved')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
        </div>
        
        <div id="section-kyc-list" style="display: none;">
            <div id="kyc-list-container" style="display: flex; flex-direction: column; gap: 15px;">
            </div>
        </div>

    </div> 
    <div id="kyc-image-modal" class="modal" onclick="this.style.display='none'" style="display:none; position:fixed; z-index:100000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); align-items:center; justify-content:center;">
        <img id="kyc-modal-img" src="" style="max-width:95%; max-height:95%; border-radius:10px; box-shadow:0 0 20px rgba(255,255,255,0.2);">
        <div style="position:absolute; top:20px; right:20px; color:white; font-size:2em; cursor:pointer;"><i class="fas fa-times"></i></div>
    </div>

    <div id="admin-kyc-detail-modal" class="modal" style="display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; background: white; overflow-y: auto;">
        
        <div style="position: sticky; top: 0; background: white; z-index: 10; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button onclick="closeKYCDetail()" style="border: none; background: #f1f5f9; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h3 style="margin: 0; font-size: 1.1em; color: var(--dark);">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h3>
            </div>
            <i class="fas fa-ellipsis-v" style="color: #ccc;"></i>
        </div>

        <div style="padding: 20px; max-width: 500px; margin: 0 auto;">
            
            <div id="det-user-img" style="width: 100%; height: 350px; background-size: cover; background-position: center; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; position: relative; border: 4px solid #fff;">
                <div style="position: absolute; bottom: 15px; left: 15px; background: rgba(0,0,0,0.6); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; backdrop-filter: blur(5px);">
                    <i class="fas fa-camera"></i> ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                </div>
            </div>

            <div id="det-status-badge" style="display: flex; align-items: center; gap: 12px; padding: 18px; border-radius: 15px; border: 1px solid #c8e6c9; margin-bottom: 25px; background: #e8f5e9;">
                <div id="det-icon-bg" style="background: #2e7d32; color: white; width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3em;">
                    <i class="fas fa-check-double"></i>
                </div>
                <div style="text-align: left; flex: 1;">
                    <div id="det-title" style="font-weight: bold; color: #2e7d32; font-size: 1em;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                    <div id="det-distance" style="font-size: 0.85em; color: #4caf50; font-weight: bold;">‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì: 0.0 ‡πÄ‡∏°‡∏ï‡∏£</div>
                </div>
                <i class="fas fa-shield-alt" style="color: #2e7d32; font-size: 1.5em; opacity: 0.5;"></i>
            </div>

            <div style="background: #f8fafc; border-radius: 20px; padding: 20px; margin-bottom: 30px; border: 1px solid #e2e8f0;">
                <h4 style="margin: 0 0 15px; color: var(--dark); border-bottom: 2px solid #eee; padding-bottom: 8px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h4>
                <div style="display: grid; gap: 15px;">
                    <div>
                        <small style="color: #94a3b8; display: block;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</small>
                        <span id="det-name" style="font-weight: bold; font-size: 1.1em;">-</span>
                    </div>
                    <div>
                        <small style="color: #94a3b8; display: block;">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</small>
                        <span id="det-id" style="font-weight: bold;">-</span>
                    </div>
                    <div style="display: flex; gap: 20px;">
                        <div style="flex: 1;">
                            <small style="color: #94a3b8; display: block;">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</small>
                            <span id="det-phone" style="font-weight: bold;">-</span>
                        </div>
                        <div style="flex: 1;">
                            <small style="color: #94a3b8; display: block;">Username</small>
                            <span id="det-username" style="font-weight: bold; color: var(--primary);">-</span>
                        </div>
                    </div>
                    <div>
                        <small style="color: #94a3b8; display: block;">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î</small>
                        <span id="det-address" style="font-size: 0.9em; color: #475569;">-</span>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; padding-bottom: 30px;">
                <button id="btn-det-reject" class="status-btn btn-reject" style="flex: 1; padding: 16px; border-radius: 15px; font-weight: bold;">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                <button id="btn-det-approve" class="status-btn btn-approve" style="flex: 2; padding: 16px; border-radius: 15px; font-weight: bold; font-size: 1em;">
                    <i class="fas fa-check-circle"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                </button>
            </div>
        </div>
        
        
        <div style="background: white; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); margin-top: 20px;">
            <div style="padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-comments" style="color: var(--primary);"></i> ‡πÅ‡∏ä‡∏ó‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
            </div>
            
            <div id="kyc-chat-box" style="height: 300px; overflow-y: auto; padding: 15px; background: #f1f5f9; display: flex; flex-direction: column; gap: 10px;">
                <div style="align-self: center; background: #fff; padding: 5px 15px; border-radius: 20px; font-size: 0.75em; color: #94a3b8; border: 1px solid #e2e8f0;">
                    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏î‡∏û‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
                </div>
            </div>

            <div style="padding: 15px; background: white; display: flex; gap: 10px; border-top: 1px solid #eee;">
    <input type="file" id="admin-slip-input" hidden accept="image/*" onchange="handleAdminSlipUpload()">
    
    <button id="admin-image-btn" onclick="document.getElementById('admin-slip-input').click()" style="background: #f1f5f9; border: none; width: 45px; height: 45px; border-radius: 10px; cursor: pointer;">
        <i class="fas fa-image"></i>
    </button>

    <input type="text" id="admin-chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." style="flex:1; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; outline: none;">
    <button onclick="sendAdminMessage()" style="background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 10px;">
        <i class="fas fa-paper-plane"></i>
    </button>
</div>
        </div>
            
    </div>
	
	
	
	<div id="user-profile-modal" class="modal" style="display: none; position: fixed; z-index: 10002; left: 0; top: 0; width: 100%; height: 100dvh; background: white; overflow-y: auto;">
    
    <div style="position: sticky; top: 0; background: white; z-index: 10; padding: calc(15px + env(safe-area-inset-top)) 20px 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button onclick="closeUserProfile()" style="border: none; background: #f1f5f9; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h3 style="margin: 0; font-size: 1.1em; color: var(--dark);">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
        </div>
        <i class="fas fa-ellipsis-v" style="color: #ccc;"></i>
    </div>

    <div id="user-profile-content" style="padding: 20px; max-width: 500px; margin: 0 auto; width: 100%;">
        </div>
</div>

	
	
	
	<div id="section-members-list" style="display: none;">
    <div style="margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px;">
        <div style="display: flex; gap: 10px;">
            <input type="text" id="member-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Username ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠..." 
                   style="flex: 1; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; outline: none; font-family: 'Kanit';">
            <button onclick="loadMemberList()" style="background: var(--primary); color: white; border: none; padding: 0 20px; border-radius: 12px; cursor: pointer;">
                <i class="fas fa-search"></i>
            </button>
        </div>
        
        <select id="member-filter-status" onchange="loadMemberList()" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; font-family: 'Kanit'; outline: none; background: white;">
            <option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="kyc">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÅ‡∏•‡πâ‡∏ß (KYC)</option>
            <option value="not_kyc">‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</option>
            <option value="banned">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡∏ô</option>
        </select>
    </div>

    <div id="members-list-container" style="display: flex; flex-direction: column; gap: 12px;">
    </div>
</div>


	



</body>
</html>