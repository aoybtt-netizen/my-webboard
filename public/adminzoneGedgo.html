<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="/socket.io/socket.io.js"></script>
    <title>GedGo! - Admin Zone Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/all.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { --primary: #11998e; --secondary: #38ef7d; --dark: #2c3e50; --light: #f8fafc; --danger: #e74c3c; }
body { font-family: 'Kanit', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; }

/* แผ่นใสสีดำพื้นหลัง */
.sidebar-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: none; /* ซ่อนไว้เริ่มต้น */
    backdrop-filter: blur(2px);
}

/* ตัว Sidebar ปรับให้ซ่อนไว้ทางซ้าย -260px */
.sidebar { 
    width: 260px; 
    background: var(--dark); 
    color: white; 
    height: 100vh; 
    position: fixed; 
    left: -260px; /* ซ่อนไว้ */
    top: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1001;
    display: flex;
    flex-direction: column;
}

/* เมื่อมีคลาส active ให้แสดงออกมา */
.sidebar.active {
    left: 0;
}

.sidebar-header { padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
.sidebar-menu { flex: 1; padding: 10px 0; }
.menu-item { 
    padding: 15px 25px; display: flex; align-items: center; gap: 12px; 
    color: rgba(255,255,255,0.7); text-decoration: none; cursor: pointer; transition: 0.2s;
}
.menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: var(--secondary); border-left: 4px solid var(--secondary); }
.menu-item i { width: 20px; }
.badge { background: var(--danger); color: white; font-size: 0.7em; padding: 2px 8px; border-radius: 10px; margin-left: auto; }

/* Main Content Area */
.main-content { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    overflow-y: auto;
    width: 100%; /* ให้เต็มจอ */
}
.top-bar { 
    background: white; padding: 15px 25px; display: flex; align-items: center; 
    justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
}
.content-body { padding: 25px; }

/* Card Style */
.admin-card { 
    background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; 
    box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #eee;
    display: flex; justify-content: space-between; align-items: center;
}
.status-btn { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-left: 5px; }
.btn-approve { background: #e8f5e9; color: #2e7d32; }
.btn-reject { background: #ffebee; color: #c62828; }

    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h3 style="margin:0; color:var(--secondary);">GedGo! Zone</h3>
        <small style="opacity:0.6;">แผงควบคุมเจ้าของโซน</small>
    </div>
    <div class="sidebar-menu">
    <div class="menu-item active" onclick="showContent('topup')">
        <i class="fas fa-wallet"></i> คำขอเติมเงิน
        <span class="badge" id="topup-count">0</span>
    </div>
    <div class="menu-item" onclick="showContent('kyc')">
        <i class="fas fa-id-card"></i> คำขอยืนยันตัวตน
        <span class="badge" id="kyc-count">0</span>
    </div>
    <div class="menu-item" onclick="showContent('automessage')">
        <i class="fas fa-comment-dots"></i> ข้อความอัตโนมัติ (เลขบัญชี)
    </div>
    <div class="menu-item" onclick="showContent('history')">
        <i class="fas fa-history"></i> ประวัติธุรกรรมในโซน
    </div>
</div>
    <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
        <a href="index.html" class="menu-item" style="padding:0;"><i class="fas fa-home"></i> กลับหน้าหลัก</a>
    </div>
</nav>


    <main class="main-content">
        <header class="top-bar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <i class="fas fa-bars" onclick="toggleSidebar()" style="cursor:pointer; font-size: 1.2em;"></i>
                <h2 id="content-title" style="margin:0; font-size: 1.2em;">คำขอเติมเงิน</h2>
            </div>
            <div id="admin-info">
                <small>เจ้าของโซน: <b id="admin-name">Loading...</b></small>
            </div>
        </header>

        <div class="content-body" id="main-display">
            <div style="text-align:center; margin-top: 50px; color: #999;">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>กำลังโหลดข้อมูล...</p>
            </div>
        </div>
    </main>

    <script>
	const socket = io();
	let currentChatRequestId = null;
	
    function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    
    sidebar.classList.toggle('active');
    
    if (sidebar.classList.contains('active')) {
        overlay.style.display = 'block';
    } else {
        overlay.style.display = 'none';
    }
}

    async function showContent(type) {
    const display = document.getElementById('main-display');
    const title = document.getElementById('content-title');
    
    // 1. ดึง Element ส่วนรายการและแชทมาเตรียมไว้
    const topupListSec = document.getElementById('section-topup-list');
    const adminChatSec = document.getElementById('section-admin-chat');

    // ลบสีเขียว (active) ออกจากทุกเมนูก่อน
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    let targetItem = window.event?.currentTarget || document.querySelector(`.menu-item[onclick*="'${type}'"]`);
    if (targetItem) targetItem.classList.add('active');

    // --- ส่วนจัดการเนื้อหา ---

    if (type === 'topup') {
        title.innerText = 'รายการคำขอเติมเงิน';
        
        // ✅ เคลียร์หน้าจอหลักก่อนเพื่อให้เหลือแค่โครงสร้าง Section
        display.innerHTML = ''; 
        // ✅ ใส่ Section กลับคืนไป (กรณีที่โดน automessage ล้างทิ้ง)
        display.appendChild(topupListSec);
        display.appendChild(adminChatSec);

        adminChatSec.style.display = 'none';
        topupListSec.style.display = 'block';
        
        // เคลียร์ด้านใน container ก่อนโหลดใหม่ป้องกันการ์ดซ้อน
        document.getElementById('topup-list-container').innerHTML = 'กำลังโหลด...';
        loadTopupRequests(); 

    } else if (type === 'automessage') {
        title.innerText = 'ตั้งค่าข้อความอัตโนมัติ';
        
        // ✅ ล้างทุกอย่างใน display ทิ้ง (รวมถึงพวก section topup ด้วย) 
        // เพื่อให้ฟอร์มตั้งค่าแสดงผลอันเดียวเพียวๆ
        display.innerHTML = '<p style="text-align:center; color:#999;">กำลังดึงข้อมูลจากเซิร์ฟเวอร์...</p>';

        try {
            const adminName = localStorage.getItem('myUsername');
            const res = await fetch(`/api/admin/get-settings?admin=${adminName}`);
            const settings = await res.json();
            
            // ✅ วาดฟอร์มทับลงไปเลย
            display.innerHTML = renderAutoMessageForm(settings.bankInfo, settings.desc);
        } catch (e) {
            display.innerHTML = renderAutoMessageForm();
        }

    } else {
        // ส่วนอื่นๆ kyc หรือ history
        title.innerText = type === 'kyc' ? 'ตรวจสอบการยืนยันตัวตน' : 'ประวัติธุรกรรมในโซน';
        display.innerHTML = `<p style="text-align:center; color:#999; margin-top:50px;">กำลังพัฒนาส่วนนี้...</p>`;
    }

    if(window.innerWidth <= 768 && document.getElementById('sidebar').classList.contains('active')) {
        toggleSidebar();
    }
}



        // ตัวอย่างการ Render รายการ KYC
    function renderKYCList() {
    return `
        <div class="admin-card">
            <div>
                <strong>User: Maria_Brazil</strong><br>
                <small style="color:#666;">รอการตรวจเอกสารยืนยันตัวตน</small>
            </div>
            <div>
                <button class="status-btn btn-approve">ตรวจเอกสาร</button>
            </div>
        </div>
    `;
}

    function confirmTopup(user, amount) {
    if(confirm(`อนุมัติเงิน ${amount} USD ให้คุณ ${user}?`)) {
        alert('อนุมัติสำเร็จ');
    }
}

    window.onload = async () => {
    const myUsername = localStorage.getItem('myUsername');
    // เช็คสิทธิ์ Admin
    if (!myUsername) { 
        window.location.href = 'index.html'; 
        return; 
    }

    document.getElementById('admin-name').innerText = myUsername;

    // อัปเดตตัวเลขแจ้งเตือนบนเมนู (Badge)
    updateBadges();
    loadTopupRequests();
    // ✅ บังคับเปิดหน้ารายการคำขอเติมเงินทันที
    showContent('topup'); 
};



	function renderAutoMessageForm(bankInfo = "", desc = "") {
    // กำหนดค่าเริ่มต้นถ้าไม่มีข้อมูล
    const displayBank = bankInfo || "";
    const displayDesc = desc || "กรุณาโอนเงินตามยอดที่ระบุ และแนบสลิปในแชท";

    return `
        <div class="admin-card" style="display: block; max-width: 600px; margin: 0 auto;">
            <h3 style="margin-top:0; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:10px;">ตั้งค่าการรับเงิน</h3>
            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; display: block; margin-bottom: 8px;">เลขบัญชี / พร้อมเพย์:</label>
                <textarea id="bank-info-input" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-family: inherit;">${displayBank}</textarea>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; display: block; margin-bottom: 8px;">คำอธิบายขั้นตอนการเติมเงิน:</label>
                <textarea id="topup-desc-input" rows="4" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-family: inherit;">${displayDesc}</textarea>
            </div>
            <button onclick="saveAutoMessage()" style="width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s;">
                <i class="fas fa-save"></i> บันทึกข้อมูลลงฐานข้อมูล
            </button>
        </div>
    `;
}

async function saveAutoMessage() {
    const bankInfo = document.getElementById('bank-info-input').value;
    const desc = document.getElementById('topup-desc-input').value;
    const adminName = localStorage.getItem('myUsername'); // ดึงชื่อแอดมิน

    try {
        const res = await fetch('/api/admin/save-settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminName, bankInfo, desc })
        });

        if (res.ok) {
            // ยังคงเซฟลง localStorage ไว้ด้วยเพื่อให้แสดงผลในหน้า Admin เร็วขึ้น
            localStorage.setItem('adminBankInfo', bankInfo);
            localStorage.setItem('adminTopupDesc', desc);
            alert("บันทึกลงระบบเรียบร้อยแล้ว สมาชิกจะเห็นข้อมูลนี้ทันที!");
        } else {
            alert("เกิดข้อผิดพลาดในการบันทึก");
        }
    } catch (e) {
        console.error(e);
        alert("เชื่อมต่อเซิร์ฟเวอร์ไม่ได้");
    }
}





	async function updateBadges() {
    const myUsername = localStorage.getItem('myUsername');
    try {
        const res = await fetch(`/api/admin/pending-counts?admin=${myUsername}`);
        if (!res.ok) throw new Error('API Not Ready');
        const data = await res.json();
        document.getElementById('topup-count').innerText = data.topupCount || 0;
        document.getElementById('kyc-count').innerText = data.kycCount || 0;
    } catch(e) {
        console.warn("Badge API ยังไม่พร้อมใช้งาน");
    }
}





async function loadTopupRequests() {
    const adminName = localStorage.getItem('myUsername');
    const container = document.getElementById('topup-list-container');
    if (!container) return;

    try {
        const res = await fetch(`/api/admin/topup-list?admin=${adminName}`);
        const requests = await res.json();
        
        if (requests.length === 0) {
            container.innerHTML = '<div style="text-align:center; margin-top:50px; color:#999;"><i class="fas fa-inbox fa-3x"></i><p>ไม่มีคำขอใหม่</p></div>';
            return;
        }

        container.innerHTML = requests.map(req => `
            <div class="admin-card" onclick="openFullChat('${req._id}', '${req.username}', ${req.amount})" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <strong style="font-size: 1.1em;">${req.username}</strong><br>
                    <span style="color:var(--primary); font-weight:bold;">ยอดเติม: ${req.amount.toFixed(2)} USD</span>
                </div>
                <div style="text-align:right; color:#ccc;">
                    <small>${new Date(req.createdAt).toLocaleTimeString('th-TH')} น.</small><br>
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
        `).join('');
    } catch (err) {
        container.innerHTML = '<p style="text-align:center; color:red;">โหลดข้อมูลล้มเหลว</p>';
    }
}


async function handleQuickAction(requestId, status, username, amount = 0) {
    const actionText = status === 'approved' ? `ยืนยันเติมเงิน ${amount} USD ให้คุณ ${username}?` : `ปฏิเสธคำขอของคุณ ${username}?`;
    
    if (!confirm(actionText)) return;

    try {
        const res = await fetch('/api/admin/process-topup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                requestId: requestId, 
                status: status,
                adminName: localStorage.getItem('myUsername')
            })
        });

        if (res.ok) {
            alert("ดำเนินการสำเร็จ!");
            
            // ส่งสัญญาณ Socket บอก User ให้หน้าจอเขาอัปเดตทันที
            socket.emit('statusChanged', { 
                requestId: requestId, 
                status: status 
            });

            // โหลดรายการใหม่เพื่อลบการ์ดที่จัดการเสร็จแล้วออก
            loadTopupRequests();
            updateBadges();
        } else {
            alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
        }
    } catch (e) {
        console.error(e);
        alert("การเชื่อมต่อเซิร์ฟเวอร์มีปัญหา");
    }
}



socket.on('receiveMessage', (msg) => {
        if(msg.requestId === currentChatRequestId) {
            appendAdminChatMessage(msg);
        }
    });
// 2. ฟังก์ชันเปิดหน้าแชท
async function openFullChat(requestId, username, amount) {
    currentChatRequestId = requestId;
    socket.emit('joinRequest', requestId);

    const display = document.getElementById('main-display');
    
    // เปลี่ยนเนื้อหาใน main-display ให้เป็นหน้าแชทเต็มรูปแบบ
    display.innerHTML = `
        <div id="full-chat-container" style="display: flex; flex-direction: column; height: calc(100vh - 100px); background: white; margin: -25px; position: relative;">
            
            <div style="padding: 15px 20px; background: white; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button onclick="showContent('topup')" style="border:none; background:#f8fafc; width:40px; height:40px; border-radius:50%; cursor:pointer; color:var(--dark);">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div>
                        <h4 style="margin:0; color:var(--dark);">${username}</h4>
                        <small style="color:var(--primary); font-weight:bold;">ยอดคำขอ: ${amount.toFixed(2)} USD</small>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="status-btn btn-reject" onclick="processAction('rejected', '${username}')">ปฏิเสธ</button>
                    <button class="status-btn btn-approve" onclick="processAction('approved', '${username}', ${amount})">อนุมัติเติมเงิน</button>
                </div>
            </div>

            <div id="chat-box" style="flex: 1; padding: 20px; background: #f1f5f9; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                <div style="align-self: center; background: #fff; padding: 5px 15px; border-radius: 20px; font-size: 0.75em; color: #94a3b8; border: 1px solid #e2e8f0; margin-bottom: 10px;">
                    เริ่มการสนทนาตรวจสอบยอดเงิน
                </div>
                <div style="align-self: flex-start; background: white; padding: 12px; border-radius: 0 15px 15px 15px; max-width: 80%; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <b>ระบบ:</b> สมาชิกแจ้งความประสงค์เติมเงินจำนวน <b>${amount.toFixed(2)} USD</b><br>
                    <small style="color:#94a3b8;">${new Date().toLocaleString('th-TH')}</small>
                </div>
            </div>

            <div style="padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px;">
                <input type="text" id="admin-chat-input" placeholder="พิมพ์ข้อความตอบกลับ..." style="flex:1; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; outline: none;">
                <button onclick="sendAdminMessage()" style="background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 10px; cursor: pointer;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    `;
}


//2.1
async function processAction(status, username, amount = 0) {
    const actionName = status === 'approved' ? 'อนุมัติการเติมเงิน' : 'ยกเลิกคำขอ';
    if (!confirm(`คุณต้องการ ${actionName} ให้คุณ ${username} ใช่หรือไม่?`)) return;

    try {
        const res = await fetch('/api/admin/process-topup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                requestId: currentChatRequestId, 
                status: status,
                adminName: localStorage.getItem('myUsername')
            })
        });

        const data = await res.json();

        if (res.ok) {
            alert(data.message);
            // แจ้งเตือน Real-time ให้ User
            socket.emit('statusChanged', { requestId: currentChatRequestId, status: status });
            // กลับหน้าหลัก (การ์ดจะหายไปเองเพราะสถานะเปลี่ยนแล้ว)
            showContent('topup');
            updateBadges();
        } else {
            alert(data.error || "เกิดข้อผิดพลาด");
        }
    } catch (e) {
        alert("ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้");
    }
}



// 3. ฟังก์ชันอนุมัติหรือปฏิเสธ
async function processRequest(status) {
    const action = status === 'approved' ? 'อนุมัติ' : 'ปฏิเสธ';
    if (!confirm(`คุณต้องการ ${action} คำขอนี้ใช่หรือไม่?`)) return;

    try {
        const res = await fetch(`/api/admin/process-topup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                requestId: currentChatRequestId, 
                status: status,
                adminName: localStorage.getItem('myUsername')
            })
        });

        if (res.ok) {
        // ส่งสัญญาณ Real-time ไปให้หน้าจอ User เด้งทันที
        socket.emit('statusChanged', { 
            requestId: currentChatRequestId, 
            status: status 
        });
        
        alert("ดำเนินการสำเร็จ!");
        showContent('topup');
        }
    } catch (e) {
        alert("เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์");
    }
}



    </script>
	
	
	
	<div class="content-body" id="main-display">
    
    <div id="section-topup-list">
        <div id="topup-list-container">
            </div>
    </div>

    <div id="section-admin-chat" style="display: none;">
        <button onclick="showContent('topup')" style="background: none; border: none; color: var(--primary); cursor: pointer; margin-bottom: 15px;">
            <i class="fas fa-arrow-left"></i> กลับไปรายการคำขอ
        </button>

        <div id="chat-box" style="background: #f1f3f5; padding: 20px; border-radius: 15px; height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;">
            </div>

        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button class="status-btn btn-reject" style="flex: 1; padding: 15px;" onclick="processRequest('rejected')">ปฏิเสธคำขอ</button>
            <button class="status-btn btn-approve" style="flex: 1; padding: 15px;" onclick="processRequest('approved')">อนุมัติและเติมเงิน</button>
        </div>
    </div>

</div>



</body>
</html>