<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GedGo! - Admin Zone Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/all.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { --primary: #11998e; --secondary: #38ef7d; --dark: #2c3e50; --light: #f8fafc; --danger: #e74c3c; }
body { font-family: 'Kanit', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; }

/* แผ่นใสสีดำพื้นหลัง */
.sidebar-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: none; /* ซ่อนไว้เริ่มต้น */
    backdrop-filter: blur(2px);
}

/* ตัว Sidebar ปรับให้ซ่อนไว้ทางซ้าย -260px */
.sidebar { 
    width: 260px; 
    background: var(--dark); 
    color: white; 
    height: 100vh; 
    position: fixed; 
    left: -260px; /* ซ่อนไว้ */
    top: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1001;
    display: flex;
    flex-direction: column;
}

/* เมื่อมีคลาส active ให้แสดงออกมา */
.sidebar.active {
    left: 0;
}

.sidebar-header { padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
.sidebar-menu { flex: 1; padding: 10px 0; }
.menu-item { 
    padding: 15px 25px; display: flex; align-items: center; gap: 12px; 
    color: rgba(255,255,255,0.7); text-decoration: none; cursor: pointer; transition: 0.2s;
}
.menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: var(--secondary); border-left: 4px solid var(--secondary); }
.menu-item i { width: 20px; }
.badge { background: var(--danger); color: white; font-size: 0.7em; padding: 2px 8px; border-radius: 10px; margin-left: auto; }

/* Main Content Area */
.main-content { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    overflow-y: auto;
    width: 100%; /* ให้เต็มจอ */
}
.top-bar { 
    background: white; padding: 15px 25px; display: flex; align-items: center; 
    justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
}
.content-body { padding: 25px; }

/* Card Style */
.admin-card { 
    background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; 
    box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #eee;
    display: flex; justify-content: space-between; align-items: center;
}
.status-btn { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-left: 5px; }
.btn-approve { background: #e8f5e9; color: #2e7d32; }
.btn-reject { background: #ffebee; color: #c62828; }

    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h3 style="margin:0; color:var(--secondary);">GedGo! Zone</h3>
        <small style="opacity:0.6;">แผงควบคุมเจ้าของโซน</small>
    </div>
    <div class="sidebar-menu">
    <div class="menu-item active" onclick="showContent('topup')">
        <i class="fas fa-wallet"></i> คำขอเติมเงิน
        <span class="badge" id="topup-count">0</span>
    </div>
    <div class="menu-item" onclick="showContent('kyc')">
        <i class="fas fa-id-card"></i> คำขอยืนยันตัวตน
        <span class="badge" id="kyc-count">0</span>
    </div>
    <div class="menu-item" onclick="showContent('automessage')">
        <i class="fas fa-comment-dots"></i> ข้อความอัตโนมัติ (เลขบัญชี)
    </div>
    <div class="menu-item" onclick="showContent('history')">
        <i class="fas fa-history"></i> ประวัติธุรกรรมในโซน
    </div>
</div>
    <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
        <a href="index.html" class="menu-item" style="padding:0;"><i class="fas fa-home"></i> กลับหน้าหลัก</a>
    </div>
</nav>


    <main class="main-content">
        <header class="top-bar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <i class="fas fa-bars" onclick="toggleSidebar()" style="cursor:pointer; font-size: 1.2em;"></i>
                <h2 id="content-title" style="margin:0; font-size: 1.2em;">คำขอเติมเงิน</h2>
            </div>
            <div id="admin-info">
                <small>เจ้าของโซน: <b id="admin-name">Loading...</b></small>
            </div>
        </header>

        <div class="content-body" id="main-display">
            <div style="text-align:center; margin-top: 50px; color: #999;">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>กำลังโหลดข้อมูล...</p>
            </div>
        </div>
    </main>

    <script>
	
    function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay'); // เช็ค ID ให้ตรงกับ HTML
    
    sidebar.classList.toggle('active');
    
    if (sidebar.classList.contains('active')) {
        overlay.style.display = 'block';
    } else {
        overlay.style.display = 'none';
    }
}

    function showContent(type) {
    const display = document.getElementById('main-display');
    const title = document.getElementById('content-title');
    
    // ปรับสถานะเมนู Active (สีเขียว)
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    // ค้นหาเมนูที่ถูกกด (ป้องกัน error กรณีเรียกผ่าน onload)
    if(event) event.currentTarget.classList.add('active');

    if (type === 'topup') {
        title.innerText = 'รายการคำขอเติมเงิน';
        display.innerHTML = renderTopupList();
    } else if (type === 'kyc') {
        title.innerText = 'ตรวจสอบการยืนยันตัวตน';
        display.innerHTML = renderKYCList();
    } else if (type === 'automessage') {
        title.innerText = 'ตั้งค่าข้อความอัตโนมัติ';
        display.innerHTML = renderAutoMessageForm(); // เรียกหน้าฟอร์มกรอกเลขบัญชี
    } else if (type === 'history') {
        title.innerText = 'ประวัติธุรกรรมในโซน';
        display.innerHTML = `<p style="text-align:center; color:#999;">แสดงประวัติการเงินทั้งหมด...</p>`;
    }
    
    if(window.innerWidth <= 768) toggleSidebar();
}

        // ตัวอย่างการ Render รายการเติมเงิน
        function renderTopupList() {
            return `
                <div class="admin-card">
                    <div>
                        <strong>User: Somchai_66</strong><br>
                        <small style="color:var(--primary);">จำนวน: 50.00 USD</small>
                    </div>
                    <div>
                        <button class="status-btn btn-reject">ปฏิเสธ</button>
                        <button class="status-btn btn-approve" onclick="confirmTopup('Somchai_66', 50)">อนุมัติ</button>
                    </div>
                </div>
                `;
        }

        // ตัวอย่างการ Render รายการ KYC
        function renderKYCList() {
            return `
                <div class="admin-card">
                    <div>
                        <strong>User: Maria_Brazil</strong><br>
                        <small style="color:#666;">เบอร์โทร: 081-xxx-xxxx</small>
                    </div>
                    <div>
                        <button class="status-btn btn-approve" onclick="viewKYC('Maria_Brazil')">ตรวจเอกสาร</button>
                    </div>
                </div>
            `;
        }

        function confirmTopup(user, amount) {
            if(confirm(`ยืนยันการเติมเงิน ${amount} USD ให้กับคุณ ${user}?`)) {
                alert('ดำเนินการสำเร็จ ยอดเงินถูกเพิ่มเข้าระบบแล้ว');
            }
        }

    window.onload = async () => {
    const myUsername = localStorage.getItem('myUsername');
    if (!myUsername) { window.location.href = 'index.html'; return; }

    document.getElementById('admin-name').innerText = myUsername;

    // ดึงจำนวนตัวเลขแจ้งเตือน
    updateBadges();
    
    // ✅ บังคับให้แสดงหน้าคำขอเติมเงินทันทีเมื่อโหลดเสร็จ
    showContent('topup'); 
};



	function renderAutoMessageForm() {
    // ดึงข้อมูลเดิมที่เคยบันทึกไว้ (ถ้ามี)
    const savedBankInfo = localStorage.getItem('adminBankInfo') || "";
    const savedDesc = localStorage.getItem('adminTopupDesc') || "กรุณาโอนเงินตามยอดที่ระบุ และแนบสลิปในแชท";

    return `
        <div class="admin-card" style="display: block;">
            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; display: block; margin-bottom: 8px;">เลขบัญชี / พร้อมเพย์:</label>
                <input type="text" id="bank-info-input" value="${savedBankInfo}" 
                       placeholder="เช่น กสิกรไทย 012-3-45678-9 สมชาย" 
                       style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; display: block; margin-bottom: 8px;">คำอธิบายขั้นตอนการโอน:</label>
                <textarea id="topup-desc-input" rows="4" 
                          style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box;">${savedDesc}</textarea>
            </div>
            <button onclick="saveAutoMessage()" 
                    style="width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">
                <i class="fas fa-save"></i> บันทึกข้อมูลข้อความอัตโนมัติ
            </button>
        </div>
    `;
}

async function saveAutoMessage() {
    const bankInfo = document.getElementById('bank-info-input').value;
    const desc = document.getElementById('topup-desc-input').value;

    // 1. บันทึกไว้ในเครื่องก่อน
    localStorage.setItem('adminBankInfo', bankInfo);
    localStorage.setItem('adminTopupDesc', desc);

    // 2. ส่งไปบันทึกที่ Database (Backend) เพื่อให้ฝั่ง User ดึงไปโชว์ได้
    const adminName = localStorage.getItem('myUsername');
    try {
        const res = await fetch('/api/admin/save-auto-message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminName, bankInfo, desc })
        });
        if(res.ok) alert("บันทึกข้อมูลสำเร็จ! สมาชิกจะเห็นข้อความนี้เมื่อส่งคำขอเติมเงิน");
    } catch(e) {
        alert("บันทึกลง Server ไม่สำเร็จ แต่บันทึกในเครื่องแล้ว");
    }
}





	async function updateBadges() {
    const myUsername = localStorage.getItem('myUsername');
    const res = await fetch(`/api/admin/pending-counts?admin=${myUsername}`);
    const data = await res.json();
    
    // อัปเดตตัวเลขแจ้งเตือนบนเมนู
    document.getElementById('topup-count').innerText = data.topupCount || 0;
    document.getElementById('kyc-count').innerText = data.kycCount || 0;
}


    </script>
</body>
</html>