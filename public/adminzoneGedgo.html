<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="/socket.io/socket.io.js"></script>
    <title>GedGo! - Admin Zone Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/all.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { --primary: #11998e; --secondary: #38ef7d; --dark: #2c3e50; --light: #f8fafc; --danger: #e74c3c; }
body { font-family: 'Kanit', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; }

/* ‡πÅ‡∏ú‡πà‡∏ô‡πÉ‡∏™‡∏™‡∏µ‡∏î‡∏≥‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
.sidebar-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
    backdrop-filter: blur(2px);
}

/* ‡∏ï‡∏±‡∏ß Sidebar ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ -260px */
.sidebar { 
    width: 260px; 
    background: var(--dark); 
    color: white; 
    height: 100vh; 
    position: fixed; 
    left: -260px; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ */
    top: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1001;
    display: flex;
    flex-direction: column;
}

/* ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏•‡∏≤‡∏™ active ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ */
.sidebar.active {
    left: 0;
}

.sidebar-header { padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
.sidebar-menu { flex: 1; padding: 10px 0; }
.menu-item { 
    padding: 15px 25px; display: flex; align-items: center; gap: 12px; 
    color: rgba(255,255,255,0.7); text-decoration: none; cursor: pointer; transition: 0.2s;
}
.menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: var(--secondary); border-left: 4px solid var(--secondary); }
.menu-item i { width: 20px; }
.badge { background: var(--danger); color: white; font-size: 0.7em; padding: 2px 8px; border-radius: 10px; margin-left: auto; }

/* Main Content Area */
.main-content { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    overflow-y: auto;
    width: 100%; /* ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
}
.top-bar { 
    background: white; padding: 15px 25px; display: flex; align-items: center; 
    justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
}
.content-body { padding: 25px; }

/* Card Style */
.admin-card { 
    background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; 
    box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #eee;
    display: flex; justify-content: space-between; align-items: center;
}
.status-btn { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-left: 5px; }
.btn-approve { background: #e8f5e9; color: #2e7d32; }
.btn-reject { background: #ffebee; color: #c62828; }

    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h3 style="margin:0; color:var(--secondary);">GedGo! Zone</h3>
        <small style="opacity:0.6;">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô</small>
    </div>
    <div class="sidebar-menu">
    <div class="menu-item active" onclick="showContent('topup')">
        <i class="fas fa-wallet"></i> ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô
        <span class="badge" id="topup-count">0</span>
    </div>
    <div class="menu-item" onclick="showContent('kyc')">
        <i class="fas fa-id-card"></i> ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
        <span class="badge" id="kyc-count">0</span>
    </div>
    <div class="menu-item" onclick="showContent('automessage')">
        <i class="fas fa-comment-dots"></i> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)
    </div>
    <div class="menu-item" onclick="showContent('history')">
        <i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô
    </div>
</div>
    <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
        <a href="index.html" class="menu-item" style="padding:0;"><i class="fas fa-home"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    </div>
</nav>


    <main class="main-content">
        <header class="top-bar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <i class="fas fa-bars" onclick="toggleSidebar()" style="cursor:pointer; font-size: 1.2em;"></i>
                <h2 id="content-title" style="margin:0; font-size: 1.2em;">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h2>
            </div>
            <div id="admin-info">
                <small>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô: <b id="admin-name">Loading...</b></small>
            </div>
        </header>

        <div class="content-body" id="main-display">
            <div style="text-align:center; margin-top: 50px; color: #999;">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </div>
    </main>

    <script>
	const socket = io();
	let currentChatRequestId = null;
	
    function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    
    sidebar.classList.toggle('active');
    
    if (sidebar.classList.contains('active')) {
        overlay.style.display = 'block';
    } else {
        overlay.style.display = 'none';
    }
}

    async function showContent(type) {
    const display = document.getElementById('main-display');
    const title = document.getElementById('content-title');
    
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢ ---
    // 1. ‡∏î‡∏∂‡∏á Section ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
    const topupListSec = document.getElementById('section-topup-list');
    const adminChatSec = document.getElementById('section-admin-chat');

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á "‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏•‡∏±‡∏ö" (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏û‡∏±‡∏Å Element ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏ô‡∏•‡∏ö
    let storage = document.getElementById('hidden-storage');
    if (!storage) {
        storage = document.createElement('div');
        storage.id = 'hidden-storage';
        storage.style.display = 'none';
        document.body.appendChild(storage);
    }

    // 3. ‡∏¢‡πâ‡∏≤‡∏¢ Section ‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô storage ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    if (topupListSec) storage.appendChild(topupListSec);
    if (adminChatSec) storage.appendChild(adminChatSec);

    // 4. ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏î‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢
    display.innerHTML = ''; 
    // ------------------------------------------

    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    let targetItem = document.querySelector(`.menu-item[onclick*="'${type}'"]`);
    if (targetItem) targetItem.classList.add('active');

    if (type === 'topup') {
        title.innerText = '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô';
        const topupListSec = document.getElementById('section-topup-list');
		const adminChatSec = document.getElementById('section-admin-chat');
        // ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏à‡∏≤‡∏Å storage ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        display.appendChild(topupListSec);
        display.appendChild(adminChatSec);

        adminChatSec.style.display = 'none';
        topupListSec.style.display = 'block';
        
        document.getElementById('topup-list-container').innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
        loadTopupRequests(); 

    } else if (type === 'automessage') {
        title.innerText = '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
        display.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';

        try {
            const adminName = localStorage.getItem('myUsername');
            const res = await fetch(`/api/admin/get-settings?admin=${adminName}`);
            const settings = await res.json();
            display.innerHTML = renderAutoMessageForm(settings.bankInfo, settings.desc);
        } catch (e) {
            display.innerHTML = renderAutoMessageForm();
        }

    } else if (type === 'history') {
        title.innerText = '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô';
        display.innerHTML = `<div id="admin-history-container" style="padding: 10px;"><p style="text-align:center; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>`;
        loadAdminHistory(); 
    }
    
    // ‡∏õ‡∏¥‡∏î Sidebar ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
    if(window.innerWidth <= 768 && document.getElementById('sidebar')?.classList.contains('active')) {
        toggleSidebar();
    }
}


async function loadAdminHistory() {
    const adminName = localStorage.getItem('myUsername');
    const container = document.getElementById('admin-history-container');
    if (!container) return;

    try {
        const res = await fetch(`/api/admin/topup-history?admin=${adminName}`);
        const history = await res.json();

        if (history.length === 0) {
            container.innerHTML = '<div style="text-align:center; margin-top:50px; color:#999;"><i class="fas fa-history fa-3x"></i><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</p></div>';
            return;
        }

        container.innerHTML = history.map(item => `
    <div class="admin-card" onclick="viewArchivedAdminChat('${item._id}', '${item.username}', ${item.amount}, '${item.status}', '${item.slipUrl || ""}')" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center; border-left: 5px solid ${item.status === 'approved' ? 'var(--primary)' : 'var(--danger)'};">
        <div>
            <strong>User: ${item.username}</strong><br>
            <span style="color:${item.status === 'approved' ? 'var(--primary)' : 'var(--danger)'}; font-weight:bold;">
                ${item.status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß'}: ${item.amount.toFixed(2)} USD
            </span>
        </div>
        <div style="text-align:right;">
            <small style="color:#999;">${new Date(item.processedAt).toLocaleString('th-TH')}</small><br>
            <i class="fas fa-chevron-right" style="color:#eee;"></i>
        </div>
    </div>
`).join('');
    } catch (err) {
        container.innerHTML = '<p style="text-align:center; color:red;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>';
    }
}


async function viewArchivedAdminChat(requestId, username, amount, status, slipUrl, createdAt, processedAt) {
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Section ‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏≤‡∏¢ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    const topupListSec = document.getElementById('section-topup-list');
    const adminChatSec = document.getElementById('section-admin-chat');
    let storage = document.getElementById('hidden-storage') || document.createElement('div');
    if (!storage.id) { storage.id = 'hidden-storage'; storage.style.display = 'none'; document.body.appendChild(storage); }
    if (topupListSec) storage.appendChild(topupListSec);
    if (adminChatSec) storage.appendChild(adminChatSec);

    currentChatRequestId = requestId;
    const display = document.getElementById('main-display');
    
    let slipSection = "";
    if (slipUrl && slipUrl !== "") {
        slipSection = `<div style="align-self: flex-start; background: white; padding: 10px; border-radius: 10px; border: 1px solid #ddd; max-width: 70%; margin-bottom:10px;">
            <div style="font-size: 0.8em; color: #666; margin-bottom: 5px;"><i class="fas fa-info-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
            <img src="${slipUrl}" style="max-width: 100%; border-radius: 5px; cursor: pointer;" onclick="window.open('${slipUrl}')">
            <div style="margin-top: 5px; font-weight: bold; color: var(--dark);">‡∏¢‡∏≠‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏¥‡∏°: ${amount.toFixed(2)} USD</div>
        </div>`;
    }

    display.innerHTML = `
        <div id="full-chat-container" style="display: flex; flex-direction: column; height: calc(100vh - 100px); background: white; margin: -25px; position: relative;">
            <div style="padding: 15px 20px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px;">
                <button onclick="showContent('history')" style="border:none; background:#f8fafc; width:40px; height:40px; border-radius:50%; cursor:pointer;"><i class="fas fa-arrow-left"></i></button>
                <div>
                    <h4 style="margin:0;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: ${username}</h4>
                    <small style="color:${status === 'approved' ? 'var(--primary)' : 'var(--danger)'}; font-weight:bold;">
                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß'} (${amount.toFixed(2)} USD)
                    </small>
                </div>
            </div>

            <div id="chat-box" style="flex: 1; padding: 20px; background: #f1f5f9; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                ${slipSection} 
            </div>

            <div style="padding: 15px; background: #fff; border-top: 1px solid #eee; color: #666; font-size: 0.85em; line-height: 1.6;">
                <div style="display: flex; justify-content: space-between;">
                    <span><i class="far fa-clock"></i> ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠:</span>
                    <b>${new Date(createdAt).toLocaleString('th-TH')}</b>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span><i class="fas fa-check-double"></i> ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:</span>
                    <b>${new Date(processedAt).toLocaleString('th-TH')}</b>
                </div>
                <div style="text-align: center; color: #ccc; margin-top: 8px; font-size: 0.9em;">
                    <i class="fas fa-lock"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                </div>
            </div>
        </div>`;

    await loadAdminChatHistory(requestId);
}



        // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£ Render ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ KYC
    function renderKYCList() {
    return `
        <div class="admin-card">
            <div>
                <strong>User: Maria_Brazil</strong><br>
                <small style="color:#666;">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</small>
            </div>
            <div>
                <button class="status-btn btn-approve">‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
            </div>
        </div>
    `;
}

    function confirmTopup(user, amount) {
    if(confirm(`‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏á‡∏¥‡∏ô ${amount} USD ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì ${user}?`)) {
        alert('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
}

    window.onload = async () => {
    const myUsername = localStorage.getItem('myUsername');
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin
    if (!myUsername) { 
        window.location.href = 'index.html'; 
        return; 
    }

    document.getElementById('admin-name').innerText = myUsername;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô‡πÄ‡∏°‡∏ô‡∏π (Badge)
    updateBadges();
    loadTopupRequests();
    // ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    showContent('topup'); 
};



	function renderAutoMessageForm(bankInfo = "", desc = "") {
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const displayBank = bankInfo || "";
    const displayDesc = desc || "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó";

    return `
        <div class="admin-card" style="display: block; max-width: 600px; margin: 0 auto;">
            <h3 style="margin-top:0; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:10px;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; display: block; margin-bottom: 8px;">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ / ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå:</label>
                <textarea id="bank-info-input" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-family: inherit;">${displayBank}</textarea>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; display: block; margin-bottom: 8px;">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô:</label>
                <textarea id="topup-desc-input" rows="4" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-family: inherit;">${displayDesc}</textarea>
            </div>
            <button onclick="saveAutoMessage()" style="width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s;">
                <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        </div>
    `;
}

async function saveAutoMessage() {
    const bankInfo = document.getElementById('bank-info-input').value;
    const desc = document.getElementById('topup-desc-input').value;
    const adminName = localStorage.getItem('myUsername'); // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô

    try {
        const res = await fetch('/api/admin/save-settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminName, bankInfo, desc })
        });

        if (res.ok) {
            // ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏ã‡∏ü‡∏•‡∏á localStorage ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
            localStorage.setItem('adminBankInfo', bankInfo);
            localStorage.setItem('adminTopupDesc', desc);
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!");
        } else {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
        }
    } catch (e) {
        console.error(e);
        alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
    }
}





	async function updateBadges() {
    const myUsername = localStorage.getItem('myUsername');
    try {
        const res = await fetch(`/api/admin/pending-counts?admin=${myUsername}`);
        if (!res.ok) throw new Error('API Not Ready');
        const data = await res.json();
        document.getElementById('topup-count').innerText = data.topupCount || 0;
        document.getElementById('kyc-count').innerText = data.kycCount || 0;
    } catch(e) {
        console.warn("Badge API ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
    }
}





async function loadTopupRequests() {
    const adminName = localStorage.getItem('myUsername');
    const container = document.getElementById('topup-list-container');
    if (!container) return;

    try {
        const res = await fetch(`/api/admin/topup-list?admin=${adminName}`);
        const requests = await res.json();
        
        if (requests.length === 0) {
            container.innerHTML = '<div style="text-align:center; margin-top:50px; color:#999;"><i class="fas fa-inbox fa-3x"></i><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà</p></div>';
            return;
        }

        container.innerHTML = requests.map(req => `
            <div class="admin-card" onclick="openFullChat('${req._id}', '${req.username}', ${req.amount})" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <strong style="font-size: 1.1em;">${req.username}</strong><br>
                    <span style="color:var(--primary); font-weight:bold;">‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡∏¥‡∏°: ${req.amount.toFixed(2)} USD</span>
                </div>
                <div style="text-align:right; color:#ccc;">
                    <small>${new Date(req.createdAt).toLocaleTimeString('th-TH')} ‡∏ô.</small><br>
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
        `).join('');
    } catch (err) {
        container.innerHTML = '<p style="text-align:center; color:red;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>';
    }
}


async function handleQuickAction(requestId, status, username, amount = 0) {
    const actionText = status === 'approved' ? `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô ${amount} USD ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì ${username}?` : `‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ${username}?`;
    
    if (!confirm(actionText)) return;

    try {
        const res = await fetch('/api/admin/process-topup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                requestId: requestId, 
                status: status,
                adminName: localStorage.getItem('myUsername')
            })
        });

        if (res.ok) {
            alert("‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            
            // ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì Socket ‡∏ö‡∏≠‡∏Å User ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Ç‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            socket.emit('statusChanged', { 
                requestId: requestId, 
                status: status 
            });

            // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å
            loadTopupRequests();
            updateBadges();
        } else {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        }
    } catch (e) {
        console.error(e);
        alert("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤");
    }
}


async function loadAdminChatHistory(requestId) {
    const chatBox = document.getElementById('chat-box');
    try {
        const res = await fetch(`/api/topup/chat-history?requestId=${requestId}`);
        const history = await res.json();
        
        if (Array.isArray(history)) {
            history.forEach(msg => {
                appendAdminChatMessage(msg);
            });
        }
    } catch (err) {
        console.error("üö® Load chat history error:", err);
    }
}


// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏ó
async function openFullChat(requestId, username, amount) {
    // --- 1. ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Section ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏¢ ---
    const topupListSec = document.getElementById('section-topup-list');
    const adminChatSec = document.getElementById('section-admin-chat');
    
    let storage = document.getElementById('hidden-storage');
    if (!storage) {
        storage = document.createElement('div');
        storage.id = 'hidden-storage';
        storage.style.display = 'none';
        document.body.appendChild(storage);
    }
    if (topupListSec) storage.appendChild(topupListSec);
    if (adminChatSec) storage.appendChild(adminChatSec);

    currentChatRequestId = requestId;
    socket.emit('joinRequest', requestId);

    const display = document.getElementById('main-display');
    
    // ‚úÖ 2. ‡∏ß‡∏≤‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ id="chat-box" ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏° Action)
    display.innerHTML = `
        <div id="full-chat-container" style="display: flex; flex-direction: column; height: calc(100vh - 100px); background: white; margin: -25px; position: relative;">
            <div style="padding: 15px 20px; background: white; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button onclick="showContent('topup')" style="border:none; background:#f8fafc; width:40px; height:40px; border-radius:50%; cursor:pointer; color:var(--dark);">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div>
                        <h4 style="margin:0; color:var(--dark);">${username}</h4>
                        <small style="color:var(--primary); font-weight:bold;">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠: ${amount.toFixed(2)} USD</small>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="status-btn btn-reject" onclick="processAction('rejected', '${username}')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    <button class="status-btn btn-approve" onclick="processAction('approved', '${username}', ${amount})">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>
            </div>

            <div id="chat-box" style="flex: 1; padding: 20px; background: #f1f5f9; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                <div style="align-self: center; background: #fff; padding: 5px 15px; border-radius: 20px; font-size: 0.75em; color: #94a3b8; border: 1px solid #e2e8f0; margin-bottom: 10px;">
                    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
                </div>
            </div>

            <div style="padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; align-items: center;">
                <input type="file" id="admin-slip-input" hidden accept="image/*" onchange="handleAdminSlipUpload()">
                <button onclick="document.getElementById('admin-slip-input').click()" id="admin-image-btn" style="background: #f1f5f9; border: none; width: 45px; height: 45px; border-radius: 10px; cursor: pointer; color: #64748b;">
                    <i class="fas fa-image"></i>
                </button>
                <input type="text" id="admin-chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö..." style="flex:1; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; outline: none;">
                <button onclick="sendAdminMessage()" style="background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 10px; cursor: pointer;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    `;

    // 3. ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ä‡∏ó (‡∏à‡∏∞ Error ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ id="chat-box")
    await loadAdminChatHistory(requestId);
}


//2.1
async function processAction(status, username, initialAmount = 0) {
    let finalAmount = initialAmount;
    const actionName = status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô' : '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠';

    // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏ñ‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
    if (status === 'approved') {
        const inputAmount = prompt(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì ${username} (USD):`, initialAmount);
        if (inputAmount === null) return; // ‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Prompt
        finalAmount = parseFloat(inputAmount);
        
        if (isNaN(finalAmount) || finalAmount <= 0) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            return;
        }
    } else {
        if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${actionName} ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì ${username} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    }

    try {
        const res = await fetch('/api/admin/process-topup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                requestId: currentChatRequestId, 
                status: status,
                finalAmount: finalAmount, // ‡∏™‡πà‡∏á‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ
                adminName: localStorage.getItem('myUsername')
            })
        });

        const data = await res.json();

        if (res.ok) {
            alert(data.message);

            // 1. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ User ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö
            socket.emit('statusChanged', { requestId: currentChatRequestId, status: status });

            // 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó (System Message)
            const sysMsg = {
                requestId: currentChatRequestId,
                sender: 'System',
                message: status === 'approved' 
                    ? `‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${finalAmount.toFixed(2)} USD` 
                    : `‚ùå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô`,
                type: 'system'
            };
            socket.emit('sendMessage', sysMsg);

            showContent('topup');
            updateBadges();
        } else {
            alert(data.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
        }
    } catch (e) {
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ");
    }
}



// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
async function processRequest(status) {
    const action = status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò';
    if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${action} ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

    try {
        const res = await fetch(`/api/admin/process-topup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                requestId: currentChatRequestId, 
                status: status,
                adminName: localStorage.getItem('myUsername')
            })
        });

        if (res.ok) {
        // ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì Real-time ‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ User ‡πÄ‡∏î‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        socket.emit('statusChanged', { 
            requestId: currentChatRequestId, 
            status: status 
        });
        
        alert("‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        showContent('topup');
        }
    } catch (e) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå");
    }
}



// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
function sendAdminMessage() {
    const input = document.getElementById('admin-chat-input');
    const message = input.value.trim();
    if (!message || !currentChatRequestId) return;

    const chatData = {
        requestId: currentChatRequestId,
        sender: localStorage.getItem('myUsername'),
        message: message,
        type: 'text'
    };

    socket.emit('sendMessage', chatData); // ‡∏™‡πà‡∏á‡πÑ‡∏õ Server
    appendAdminChatMessage(chatData);     // ‡πÅ‡∏™‡∏î‡∏á‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    input.value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏ó‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
function appendAdminChatMessage(msg) {
    const chatBox = document.getElementById('chat-box');
    if (!chatBox) return;

    const isMe = msg.sender === localStorage.getItem('myUsername');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    let contentHTML = "";
    if (msg.type === 'image') {
        contentHTML = `<img src="${msg.message}" style="max-width: 100%; border-radius: 10px; cursor: pointer; display: block;" onclick="window.open(this.src)">`;
    } else {
        contentHTML = `<p style="margin: 0; line-height: 1.5;">${msg.message}</p>`;
    }
	
	if (msg.type === 'system') {
    const sysHTML = `
        <div style="align-self: center; margin: 15px 0; background: #fff4e5; color: #663c00; padding: 8px 20px; border-radius: 20px; font-size: 0.85em; font-weight: bold; border: 1px solid #ffe7cc;">
            ${msg.message}
        </div>
    `;
    chatBox.innerHTML += sysHTML;
    chatBox.scrollTop = chatBox.scrollHeight; 
    return;
}

    const msgHTML = `
        <div style="display: flex; flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
            <div style="background: ${isMe ? 'var(--primary)' : 'white'}; 
                        color: ${isMe ? 'white' : 'var(--dark)'}; 
                        padding: ${msg.type === 'image' ? '5px' : '10px 15px'}; 
                        border-radius: ${isMe ? '15px 15px 0 15px' : '15px 15px 15px 0'}; 
                        max-width: 70%; 
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        border: ${isMe ? 'none' : '1px solid #eee'};">
                ${contentHTML}
            </div>
            <small style="font-size: 0.7em; color: #94a3b8; margin-top: 3px;">
                ${isMe ? '‡∏Ñ‡∏∏‡∏ì (Admin)' : msg.sender}
            </small>
        </div>
    `;

    chatBox.innerHTML += msgHTML;
    chatBox.scrollTop = chatBox.scrollHeight;
}

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Socket ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ appendAdminChatMessage
socket.on('receiveMessage', (msg) => {
    // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤ (msg.requestId) ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ä‡∏ó‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (currentChatRequestId)
    // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏™‡πà‡∏á "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏≠‡∏á" (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏™‡∏±‡πà‡∏á appendMessage ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏™‡πà‡∏á)
    // 3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (msg.requestId === currentChatRequestId && 
        msg.sender !== localStorage.getItem('myUsername') &&
        typeof appendAdminChatMessage === "function") {
        
        appendAdminChatMessage(msg);
    }
});

socket.on('notifyAdminNewRequest', (data) => {
    const myName = localStorage.getItem('myUsername');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (data.adminId === myName) {
        // 1. ‡∏™‡∏±‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ pending ‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå)
        if (typeof loadTopupList === "function") {
            loadTopupList(); 
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            // ‡πÄ‡∏ä‡πà‡∏ô fetchPendingRequests();
            location.reload(); // ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏Å‡πâ‡∏Ç‡∏±‡∏î‡πÑ‡∏î‡πâ)
        }

        // 2. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏´‡∏£‡∏∑‡∏≠ Toast (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        console.log("üîî ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤!");
        // alert("‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì " + data.username);
    }
});


// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ù‡∏±‡πà‡∏á User)
async function compressImage(file, { maxWidth = 1024, quality = 0.7 }) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                canvas.toBlob((blob) => resolve(blob), 'image/jpeg', quality);
            };
        };
        reader.onerror = (error) => reject(error);
    });
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
async function handleAdminSlipUpload() {
    const fileInput = document.getElementById('admin-slip-input');
    const file = fileInput.files[0];
    if (!file || !currentChatRequestId) return;

    const btn = document.getElementById('admin-image-btn');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î

    try {
        // ‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
        const compressedBlob = await compressImage(file, { maxWidth: 1024, quality: 0.7 });
        
        const formData = new FormData();
        formData.append('slip', compressedBlob, 'admin_receipt.jpg');

        // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á API ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ (Cloudinary - ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå topup_slips)
        const res = await fetch('/api/upload-slip', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();

        if (data.url) {
            const chatData = {
                requestId: currentChatRequestId,
                sender: localStorage.getItem('myUsername'),
                message: data.url,
                type: 'image'
            };
            // ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô Socket ‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
            socket.emit('sendMessage', chatData);
            appendAdminChatMessage(chatData);
        }
    } catch (err) {
        console.error("Upload error:", err);
        alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
    } finally {
        fileInput.value = '';
        btn.innerHTML = '<i class="fas fa-image"></i>';
    }
}



    </script>
	
	
	
	<div class="content-body" id="main-display">
    
    <div id="section-topup-list">
        <div id="topup-list-container">
            </div>
    </div>

    <div id="section-admin-chat" style="display: none;">
        <button onclick="showContent('topup')" style="background: none; border: none; color: var(--primary); cursor: pointer; margin-bottom: 15px;">
            <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠
        </button>

        <div id="chat-box" style="background: #f1f3f5; padding: 20px; border-radius: 15px; height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;">
            </div>

        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button class="status-btn btn-reject" style="flex: 1; padding: 15px;" onclick="processRequest('rejected')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
            <button class="status-btn btn-approve" style="flex: 1; padding: 15px;" onclick="processRequest('approved')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
        </div>
    </div>

</div>



</body>
</html>