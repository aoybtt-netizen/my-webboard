<!DOCTYPE html>
<html lang="th">
<head>
	<script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
	<script>
	// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô vConsole
	var vConsole = new window.VConsole();
	</script>
	
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- GLOBAL STYLES --- */
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: #e9ebee; 
            padding: 0; 
            margin: 0;
            display: none;
            background-image: linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5)), url('https://sv1.img.in.th/7fB1Jg.png');
            background-size: cover;         
            background-position: center;    
            background-attachment: fixed;   
            background-repeat: no-repeat;   
            background-color: #f0f2f5; /* ‡∏™‡∏µ‡∏™‡∏≥‡∏£‡∏≠‡∏á */
        }
        .container { 
            max-width: 900px; 
            margin: 20px auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }

        /* --- HEADER & ACTIONS --- */
        .header-btns { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 30px; 
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .back-btn, .send-btn, .restart-btn { 
            border: none; 
            padding: 10px 18px; 
            border-radius: 20px; 
            cursor: pointer; 
            font-weight: 600;
            transition: background 0.2s;
            font-size: 14px;
        }
        .back-btn { 
            background: #6c757d; 
            color: white; 
        }
        .back-btn:hover { background: #5a6268; }

        .restart-btn { 
            background: #dc3545; 
            color: white; 
            display: none; 
        }
        .restart-btn:hover { background: #c82333; }
        
        .manual-close-btn { 
            background: #e98514; 
            color: white;
            padding: 10px 18px; 
            border-radius: 20px; 
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            font-size: 14px;
            border: none;
            display: none;
        }
        .manual-close-btn:hover { background: #cf7010; }

        /* --- POST BODY --- */
        #post-title {
            font-size: 1.5em;
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .post-meta {
            color: #6c757d; 
            font-size: 0.9em;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
        }
        .post-meta strong { color: #333; font-weight: 400;}
        
        #post-content {
            font-size: 1.1em; 
            line-height: 1.8; 
            min-height: 100px;
            padding: 20px 0;
            border-top: 1px dashed #ddd;
            white-space: pre-wrap; 
        }
        
        /* --- COMMENTS SECTION --- */
        h3 {
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-bottom: 20px;
            color: #007bff;
            font-weight: 600;
        }
        .comment-box { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 10px; 
            border-left: 5px solid #007bff; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .comment-box.odd { 
            background: #fff;
            border-left-color: #28a745; 
        } 
        .comment-author {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        .comment-content {
            font-size: 0.8em;
            margin-bottom: 8px;
        }
        .comment-time {
            font-size: 0.75em; 
            color: #999; 
            text-align: right;
        }

        /* --- COMMENT FORM --- */
        #comment-form {
            margin-top: 30px; 
            padding: 10px 0; 
            background: white; 
            border-radius: 40px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #chat-input-area {
            display: flex;
            align-items: center;
            gap: 5px; 
            padding: 0 10px;
        }
        #comment-input { 
            flex-grow: 1; 
            padding: 10px 15px; 
            border: none; 
            border-radius: 20px; 
            box-sizing: border-box; 
            font-family: 'Kanit';
            font-size: 1em;
            background-color: #f1f1f1; 
        }
        #comment-input:focus {
            outline: none; 
            background-color: #fff;
        }
        #add-media-btn, #send-comment-btn { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            transition: background 0.2s;
            font-size: 1.2em;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #add-media-btn {
            background: #e4e6eb; 
            color: #007bff;
        }
        #add-media-btn:hover { background: #d0d3d6; }
        #send-comment-btn { 
            background: #007bff; 
            color: white; 
        }
        #send-comment-btn:hover { background: #0056b3; }
        #comment-image {
            display: none !important;
        }
        
        /* --- CLOSED MESSAGE --- */
        #closed-msg {
            display:none; 
            color: #dc3545; 
            text-align:center; 
            margin-top:20px; 
            padding: 15px;
            border: 1px solid #f5c6cb;
            background-color: #f8d7da;
            border-radius: 8px;
            font-weight: 600;
        }
        
        /* --- MODAL / OVERLAY --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 2000; display: flex; 
            justify-content: center; align-items: center; 
        }
        .modal-box { 
            background: white; width: 90%; max-width: 500px; padding: 30px; 
            border-radius: 15px; max-height: 80vh; overflow-y: auto; 
        }
        .hidden { display: none !important; }

        /* --- NEW: STATUS NOTIFICATION (Toast) --- */
        #status-notif-modal {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            padding: 15px;
            background: #007bff;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 3000;
            font-size: 14px;
            transition: opacity 0.3s ease;
            opacity: 0; /* ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ */
            pointer-events: none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å */
        }
        #status-notif-modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        #notif-content {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="map-container" style="margin-top: 20px; display:none; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 id="map-title" style="margin: 0; border: none; padding: 0; font-size: 1.1rem;">üìç Location</h3>
            <button id="toggle-map-btn" onclick="toggleMap()" 
                style="background: #dbeafe; color: #007bff; border: none; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 0.85em; font-weight: 600;">
                <i class="fas fa-chevron-up"></i> ‡∏ã‡πà‡∏≠‡∏ô
            </button>
        </div>

        <div id="map-content-wrapper" style="display: block; margin-top: 15px;">
             <iframe id="post-map-iframe" width="100%" height="300" frameborder="0" style="border-radius: 10px; border:0;" allowfullscreen loading="lazy"></iframe>
             
             <button id="start-nav-btn" 
                class="send-btn" 
                style="background:#28a745; margin-top: 10px; padding: 12px; text-decoration: none; display:none; width: 100%; border-radius: 10px; color: white; border: none;">
                <i class="fas fa-route"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á (Google Maps)
             </button>
        </div>
    </div>

        <div class="header-btns">
            <button id="back-btn" class="back-btn" onclick="goBack()" data-i18n-title="btn_back_tooltip">
                <i class="fas fa-arrow-left"></i> 
            </button>

            <button id="manual-close-btn" class="manual-close-btn" onclick="manualClosePost()" 
                data-i18n-key="btn_close_post" 
                data-i18n-title="title_close_post">
                <i class="fas fa-lock"></i> ‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ
            </button>
            
            <button id="final-finish-btn" class="send-btn" style="background:#6f42c1; display:none;" onclick="requestFinishJob()" 
                data-i18n-key="btn_finish_job">
                <i class="fas fa-flag-checkered"></i> ‡∏à‡∏ö‡∏á‡∏≤‡∏ô/‡πÅ‡∏¢‡∏Å‡∏¢‡πâ‡∏≤‡∏¢
            </button>

            <button id="handover-btn" class="restart-btn" style="background:#007bff; display:none;" onclick="openHandoverModal()" 
                data-i18n-key="btn_handover" 
                data-i18n-title="title_handover">
                <i class="fas fa-check-circle"></i> ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô
            </button>
            
            <button id="restart-btn" class="restart-btn" onclick="restartPost()" 
                data-i18n-key="btn_kick" 
                data-i18n-title="title_kick">
                <i class="fas fa-redo"></i> ‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å
            </button>
        </div>
        
        <h1 id="post-title">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h1>
        <div class="post-meta">
            <span>
                <i class="fas fa-user-circle"></i> ID: 
                <strong id="post-author">...</strong>
                <span style="color:#ffc107; font-weight:bold; font-size:1.1em;" id="post-author-rating"></span>
            </span>
            <span>
                <i class="fas fa-clock"></i> 
                <strong id="post-time">...</strong>
            </span>
        </div>
        
        <div id="post-image-container"></div>
        
        <p id="post-content"></p>
        
        <h3><i class="fas fa-comments"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</h3>
        <div id="comments-list"></div>

        <div id="comment-form" style="display: flex; flex-direction: column;"> <div id="file-name-display" style="display: none; font-size: 0.85em; color: #007bff; margin-bottom: 5px; padding-left: 55px; text-align: left;"></div>

    <div id="chat-input-area" style="position: relative;">
        <button id="add-media-btn" onclick="document.getElementById('comment-image').click()" title="‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå">
            <i class="fas fa-plus"></i>
        </button>
        
        <button id="emoji-btn" onclick="toggleEmoji()" style="width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; background: #fff; font-size: 1.2em; margin-right: 5px;">
            üòä
        </button>

        <input type="file" id="comment-image" name="image" accept="image/*" class="hidden"> 

        <input type="text" id="comment-input" placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..." autocomplete="off">
        
        <button id="btn-call-author" 
        onclick="startCall(currentPostAuthor)" 
        style="background: #2ecc71; color: white; border: none; padding: 10px 15px; border-radius: 20px; cursor: pointer; margin-right: 10px; font-weight: 600; display: none; align-items: center; gap: 5px;">
    <i class="fas fa-phone-alt"></i> ‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ
</button>

        <button id="send-comment-btn" onclick="sendComment()" title="‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°">
            <i class="fas fa-paper-plane"></i>
        </button>

        <div id="comment-emoji-picker" style="display: none; position: absolute; bottom: 60px; left: 10px; z-index: 200; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border-radius: 8px;">
            <emoji-picker id="picker-comment"></emoji-picker>
        </div>
    </div>
</div>

        <div id="closed-msg">
            <i class="fas fa-lock"></i> ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤
        </div>
    </div>
    
    <div id="image-viewer-modal" class="modal-overlay hidden" onclick="closeImageViewer()" style="background: rgba(0,0,0,0.9);">
    <span style="position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; font-weight: bold;">√ó</span>
    
    <img id="full-image" style="max-width: 90%; max-height: 90%; border-radius: 5px; box-shadow: 0 0 20px rgba(255,255,255,0.2); transition: transform 0.2s;">
</div>

    
    <div id="offer-modal" class="modal-overlay hidden">
    <div class="modal-box" style="text-align:center;">
        <h2 data-i18n-key="offer_modal_title">üîî ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô</h2>
        <p data-i18n-key="offer_modal_desc">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô/‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì</p>
        
        <div style="margin-top:20px; display:flex; justify-content:center; gap:15px;">
            <button class="restart-btn" style="display:block; background:#dc3545; padding:10px 20px;" onclick="replyOffer(false)" data-i18n-key="btn_reject">
                ‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
            </button>
            <button class="send-btn" style="padding:10px 20px;" onclick="replyOffer(true)" data-i18n-key="btn_accept">
                ‚úÖ ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö
            </button>
        </div>
    </div>
</div>

    <div id="finish-job-modal" class="modal-overlay hidden">
    <div class="modal-box" style="text-align:center;">
        <h2 data-i18n-key="modal_finish_title">üèÅ ‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏à‡∏ö‡∏á‡∏≤‡∏ô</h2>
        
        <p id="finish-job-desc">
            ‡∏Ñ‡∏∏‡∏ì <strong id="finish-requester-name">...</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏¢‡∏Å‡∏¢‡πâ‡∏≤‡∏¢
        </p>

        <p data-i18n-key="modal_finish_warning">‡∏´‡∏≤‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</p>
        
        <div style="margin-top:20px; display:flex; justify-content:center; gap:15px;">
            <button class="restart-btn" style="display:block; background:#dc3545; padding:10px 20px;" onclick="replyFinishJob(false)" data-i18n-key="btn_not_yet">
                ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö
            </button>
            <button class="send-btn" style="padding:10px 20px;" onclick="replyFinishJob(true)" data-i18n-key="btn_confirm_finish">
                ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏ö‡∏á‡∏≤‡∏ô
            </button>
        </div>
    </div>
</div>
    
    <div id="rating-modal" class="modal-overlay hidden">
    <div class="modal-box" style="text-align:center;">
        <h2 data-i18n-key="rating_title">‚≠ê ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à</h2>
        
        <p data-i18n-key="rating_desc">‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</p>
        
        <div style="font-size: 2em; margin: 20px 0; cursor: pointer;">
            <span onclick="setRating(1)">‚≠ê</span>
            <span onclick="setRating(2)">‚≠ê</span>
            <span onclick="setRating(3)">‚≠ê</span>
            <span onclick="setRating(4)">‚≠ê</span>
            <span onclick="setRating(5)">‚≠ê</span>
        </div>
        
        <p>
            <span data-i18n-key="rating_selected">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</span> 
            <strong id="selected-rating" style="font-size:1.5em; color:#ffc107;">0</strong> / 5
        </p>
        
        <button class="send-btn" style="width:100%; margin-top:20px;" onclick="submitRating()" data-i18n-key="btn_submit_rating">
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        </button>
    </div>
</div>

    <div id="handover-modal" class="modal-overlay hidden">
        <div class="modal-box" style="text-align:center;">
            <h2 id="handover-title" data-i18n-key="modal_handover_title" style="margin-bottom: 10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</h2>

            <p id="handover-message" style="color: #6c757d; margin-bottom: 15px;">
                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...
            </p>

            <div id="handover-viewer-container" class="hidden" style="font-size: 1.2em; margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                <i class="fas fa-user-check" style="color: #28a745;"></i> ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô: 
                <strong id="target-viewer-display" style="color: #333;">...</strong>
            </div>

            <div id="handover-actions" class="hidden" style="margin-top: 10px;">
                <button id="send-handover-btn" class="send-btn" onclick="closeDealWithViewer()" 
                        data-i18n-key="modal_handover_btn"
                        style="
                    width: auto; 
                    background: #28a745; 
                    color: white; 
                    padding: 10px 30px; 
                    border: none; 
                    border-radius: 8px; 
                    font-weight: bold;
                    cursor: pointer;
                    margin-bottom: 10px;
                ">
                    ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô
                </button>
            </div>

            <button id="close-handover-modal" class="back-btn" 
                    onclick="document.getElementById('handover-modal').classList.add('hidden')" 
                    data-i18n-key="btn_close"
                    style="
                width:auto; 
                margin-top:20px; 
                background: #dc3545; 
                color: white;
            ">
                ‚ùå ‡∏õ‡∏¥‡∏î
            </button>
        </div>
    </div>
    
    <div id="status-notif-modal">
        <div id="notif-content">
            <i class="fas fa-info-circle"></i>
            <span id="notif-message"></span>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- GLOBAL SETUP (MOVED UP FOR SCOPE) ---
        const socket = io();
        let myCurrentLocation = null;
        let currentPostAuthor = null;
		let locationShared = false;
        
        // WebRTC Voice Call Logic P2P ---
        let localStream;
        let peerConnection;
        let currentCallUser = null; // ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∏‡∏¢‡∏î‡πâ‡∏ß‡∏¢
        const rtcConfig = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] // ‡πÉ‡∏ä‡πâ STUN ‡∏ü‡∏£‡∏µ‡∏Ç‡∏≠‡∏á Google
        };

        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏ó‡∏£‡∏´‡∏≤ (‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ó‡∏£)
        async function startCall(targetUsername) {
            if (targetUsername === myUsername) return alert('Why would you call yourself that? üòÇ');
            
            currentCallUser = targetUsername;
            showCallModal(`üìû Calling. ${targetUsername}...`, false);

            try {
                // ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡∏Ñ‡πå
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                
                peerConnection = new RTCPeerConnection(rtcConfig);
                
                // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏£‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏Ç‡∏≤
                peerConnection.ontrack = event => {
                    document.getElementById('remote-audio').srcObject = event.streams[0];
                };

                // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ICE (Network path)
                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        socket.emit('ice-candidate', { target: targetUsername, candidate: event.candidate });
                    }
                };

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Offer ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏≤‡πÄ‡∏Ç‡∏≤
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                socket.emit('call-user', { 
                    userToCall: targetUsername, 
                    signalData: offer,
                    fromUser: myUsername 
                });

            } catch (err) {
                console.error(err);
                alert('The microphone is inaccessible.');
                closeCallModal();
            }
        }

        // 2. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤ (Socket Listener)
        socket.on('call-incoming', async ({ signal, from }) => {
            currentCallUser = from;
            showCallModal(`üì≤ Incoming call from ${from}`, true);
            
            // ‡πÄ‡∏Å‡πá‡∏ö Offer ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏£‡∏≠‡πÄ‡∏Ç‡∏≤‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢
            window.pendingOffer = signal;
        });

        // 3. ‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢
        async function acceptCall() {
            document.getElementById('incoming-actions').classList.add('hidden');
            document.getElementById('btn-hangup').classList.remove('hidden');
            document.getElementById('call-status').innerText = `üîä Calling ${currentCallUser}`;

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                peerConnection = new RTCPeerConnection(rtcConfig);

                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.ontrack = event => {
                    document.getElementById('remote-audio').srcObject = event.streams[0];
                };

                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        socket.emit('ice-candidate', { target: currentCallUser, candidate: event.candidate });
                    }
                };

                await peerConnection.setRemoteDescription(new RTCSessionDescription(window.pendingOffer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                socket.emit('answer-call', { signal: answer, to: currentCallUser });

            } catch (err) {
                alert('There was an error answering the call.');
                endCall();
            }
        }

        // 4. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢‡πÄ‡∏£‡∏≤‡πÅ‡∏•‡πâ‡∏ß
        socket.on('call-accepted', async (signal) => {
            document.getElementById('call-status').innerText = `üîä Calling ${currentCallUser}`;
            await peerConnection.setRemoteDescription(new RTCSessionDescription(signal));
        });

        // 5. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ ICE Candidate (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Network)
        socket.on('ice-candidate-msg', async (candidate) => {
            if (peerConnection) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (e) { console.error('Error adding ice candidate', e); }
            }
        });

        // 6. ‡∏ß‡∏≤‡∏á‡∏™‡∏≤‡∏¢ / ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
        function endCall() {
            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            
            if (currentCallUser) {
                socket.emit('end-call', { to: currentCallUser });
            }
            
            closeCallModal();
        }

        socket.on('call-ended', () => {
            alert('The call ended.');
            closeCallModal();
        });

        socket.on('call-failed', (msg) => {
            alert(msg);
            closeCallModal();
        });

        // --- Helper UI Functions ---
        function showCallModal(statusText, isIncoming) {
            const modal = document.getElementById('call-modal');
            modal.classList.remove('hidden');
            document.getElementById('call-status').innerText = statusText;
            
            if (isIncoming) {
                document.getElementById('incoming-actions').classList.remove('hidden');
                document.getElementById('btn-hangup').classList.add('hidden');
            } else {
                document.getElementById('incoming-actions').classList.add('hidden');
                document.getElementById('btn-hangup').classList.remove('hidden');
            }
        }

        function closeCallModal() {
            document.getElementById('call-modal').classList.add('hidden');
            peerConnection = null;
            currentCallUser = null;
        }

        //  Custom Notification Function ---
        let notifTimeout;
        function showNotification(message, iconClass = 'fas fa-info-circle', duration = 3000) {
            clearTimeout(notifTimeout);
            const modal = document.getElementById('status-notif-modal');
            const content = document.getElementById('notif-message');
            const icon = modal.querySelector('i');

            icon.className = iconClass;
            content.innerText = message;
            modal.classList.add('show');

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
            notifTimeout = setTimeout(() => {
                modal.classList.remove('show');
            }, duration);
        }

        const postTranslations = {
    'th': {
        'btn_back_tooltip': '‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö',
        'btn_close_post': '‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ',
        'title_close_post': '‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå/‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô)',
        'btn_finish_job': '‡∏à‡∏ö‡∏á‡∏≤‡∏ô/‡πÅ‡∏¢‡∏Å‡∏¢‡πâ‡∏≤‡∏¢',
        'btn_handover': '‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô',
        'title_handover': '‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô/‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà',
        'btn_kick': '‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å',
        'title_kick': '‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏∞‡∏Ñ‡∏ô‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á/‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô',
        'confirm_close_post': '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ? ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡πâ‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå/‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÉ‡∏î‡πÜ ‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ',
        'alert_post_closed': '‚úÖ ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÇ‡∏î‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß',
        'modal_handover_title': '‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô / ‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•',
        'modal_handover_desc': '‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π (Viewer) ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏Å‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ',
        'modal_handover_btn': '‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡∏ô‡∏µ‡πâ',
        'modal_handover_success': '‚úÖ ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',
        'confirm_handover_offer': '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡πÑ‡∏õ‡πÉ‡∏´‡πâ "[VIEWER]" ‡∏Å‡∏î‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        'notif_offer_sent': 'üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡πÉ‡∏´‡πâ [VIEWER] ‡πÅ‡∏•‡πâ‡∏ß',
        'notif_deal_accepted': '‚úÖ [VIEWER] ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
        'notif_deal_rejected': '‚ùå [VIEWER] ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',
        'generic_viewer_name': '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',
        'handover_status_loading_title': '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡∏ä‡∏°...',
        'handover_status_loading_msg': '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Server ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà...',
        'handover_status_found_title': '‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô',
        'handover_status_found_msg': '‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏≠‡∏¢‡∏π‡πà!',
        'handover_status_not_found_title': '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',
        'handover_status_not_found_msg': '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏î‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏ä‡∏°‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ',
        'handover_status_error_title': '‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
        'handover_status_error_timeout': '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (Timeout)',
        'handover_status_error_general': '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:',
        'btn_close': '‚ùå ‡∏õ‡∏¥‡∏î',
        'offer_modal_title': 'üîî ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô',
        'offer_modal_desc': '‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô/‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì',
        'btn_reject': '‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò',
        'btn_accept': '‚úÖ ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö',
        'confirm_finish_request': '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)',
        'modal_finish_title': 'üèÅ ‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏à‡∏ö‡∏á‡∏≤‡∏ô',
        'modal_finish_desc_prefix': '‡∏Ñ‡∏∏‡∏ì',
        'modal_finish_desc_suffix': '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏¢‡∏Å‡∏¢‡πâ‡∏≤‡∏¢',
        'modal_finish_warning': '‡∏´‡∏≤‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å',
        'btn_not_yet': '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö',
        'btn_confirm_finish': '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏ö‡∏á‡∏≤‡∏ô',
        'notif_wait_finish_confirm': '‚è≥ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...',
        'SYS_FINISH_REJECTED': '‚ùå ‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏á‡∏≤‡∏ô',
        'rating_title': '‚≠ê ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à',
        'rating_desc': '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',
        'rating_selected': '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:',
        'btn_submit_rating': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô',
        'SYS_RATING_SUCCESS': 'üéâ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß',
        'SYS_RATING_ALREADY': 'üéâ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß!',
        'SYS_OPPONENT_RATED': 'üîî ‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß! ‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ö‡πâ‡∏≤‡∏á',
        'confirm_kick': '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? (‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô Admin)',
        'error_geo_required': '‚õî ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (GPS) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ',
        'error_geo_denied': '‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏î‡πâ',
        'error_geo_unsupported': '‚ùå ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',
        'checking_location': '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...',
        'btn_show_route': 'üó∫Ô∏è Google Map',
		'btn_show_map': '‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà', 
        'btn_hide_map': '‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà',
    },
    'en': {
        'btn_back_tooltip': 'Back',
        'btn_close_post': 'Close Post',
        'title_close_post': 'Close this post immediately (No comments/jobs)',
        'btn_finish_job': 'Finish Job',
        'btn_handover': 'Handover',
        'title_handover': 'Handover job/Close deal with current viewer',
        'btn_kick': 'Kick',
        'title_kick': 'Kick all viewers (except Owner/Admin)',
        'confirm_close_post': 'Are you sure you want to close this post immediately? The system will prohibit any further comments or job applications.',
        'alert_post_closed': '‚úÖ This post has been closed by the owner.',
        'modal_handover_title': 'Handover Job / Close Deal',
        'modal_handover_desc': 'You are about to close this deal to the selected Viewer. Please ensure all details and pricing are agreed upon. This action is irreversible.',
        'modal_handover_btn': 'Deal',
        'modal_handover_success': '‚úÖ Job Handover completed. Please wait for acceptance from the recipient.',
        'confirm_handover_offer': 'Send deal close request to "[VIEWER]". Confirm acceptance?',
        'notif_offer_sent': 'üì§ Handover offer sent to [VIEWER]',
        'notif_deal_accepted': '‚úÖ [VIEWER] accepted the deal! Post closed successfully.',
        'notif_deal_rejected': '‚ùå [VIEWER] rejected the deal offer.',
        'generic_viewer_name': 'The Recipient',
        'handover_status_loading_title': '‚è≥ Checking viewer status...',
        'handover_status_loading_msg': 'System is contacting server to check for viewers...',
        'handover_status_found_title': '‚úÖ Ready for Handover',
        'handover_status_found_msg': 'Active viewer found!',
        'handover_status_not_found_title': '‚ö†Ô∏è No Viewer Found',
        'handover_status_not_found_msg': 'No other members are currently viewing this post.',
        'handover_status_error_title': '‚ùå Check Failed',
        'handover_status_error_timeout': 'Connection delayed (Timeout)',
        'handover_status_error_general': 'Error occurred:',
        'btn_close': '‚ùå Close',
        'offer_modal_title': 'üîî Job Handover Offer Received',
        'offer_modal_desc': 'The post owner wants to handover/close this deal with you.',
        'btn_reject': '‚ùå Reject',
        'btn_accept': '‚úÖ Accept',
        'confirm_finish_request': 'Do you want to finish this job and leave?\n(Waiting for confirmation from the other party)',
        'modal_finish_title': 'üèÅ Finish Job Request',
        'modal_finish_desc_prefix': 'User',
        'modal_finish_desc_suffix': 'wants to finish the job.',
        'modal_finish_warning': 'If confirmed, both will be redirected to the home page.',
        'btn_not_yet': '‚ùå Not yet',
        'btn_confirm_finish': '‚úÖ Confirm Finish',
        'notif_wait_finish_confirm': '‚è≥ Request sent. Waiting for confirmation...',
        'SYS_FINISH_REJECTED': '‚ùå The other party denied the finish request.',
        'rating_title': '‚≠ê Rate Satisfaction',
        'rating_desc': 'The job is finished. Please rate the other party to close the deal.',
        'rating_selected': 'Selected Rating:',
        'btn_submit_rating': 'Submit Rating',
        'SYS_RATING_SUCCESS': 'üéâ Rating submitted! You have closed your part.',
        'SYS_RATING_ALREADY': 'üéâ You have already submitted a rating!',
        'SYS_OPPONENT_RATED': 'üîî The other party has rated you! Now it\'s your turn.',
        'confirm_kick': 'Do you want to restart the post room? (All current viewers will be kicked immediately, except Admin)',
        'error_geo_required': '‚õî Location access (GPS) is required to view this post.',
        'error_geo_denied': '‚ùå Location access denied. Cannot view content.',
        'error_geo_unsupported': '‚ùå Your browser does not support geolocation.',
        'checking_location': '‚è≥ Verifying your location...',
        'btn_show_route': 'üó∫Ô∏è Show Navigation Google Map',
		'btn_show_map': 'Show Map',
        'btn_hide_map': 'Hide Map',
    }
};

        function applyLanguage() {
            // ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏≤‡∏Å localStorage ‡∏ó‡∏µ‡πà index.html ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ ‡∏´‡∏£‡∏∑‡∏≠ default ‡πÄ‡∏õ‡πá‡∏ô 'th'
            const lang = localStorage.getItem('preferredLanguage') || 'th';
            const t = postTranslations[lang] || postTranslations['th'];

            // 1. ‡πÅ‡∏õ‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏° (innerHTML) ‡πÇ‡∏î‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤ Icon ‡πÑ‡∏ß‡πâ
            document.querySelectorAll('[data-i18n-key]').forEach(el => {
                const key = el.getAttribute('data-i18n-key');
                if (t[key]) {
                    // ‡πÄ‡∏Å‡πá‡∏ö Icon ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÑ‡∏ß‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    const iconHtml = el.querySelector('i') ? el.querySelector('i').outerHTML : '';
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
                    el.innerHTML = `${iconHtml} ${t[key]}`;
                }
            });

            // 2. ‡πÅ‡∏õ‡∏• Tooltip (title attribute)
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (t[key]) {
                    el.title = t[key];
                }
            });
        }
        
        // Emoji Logic for Comments
    function toggleEmoji() {
        const picker = document.getElementById('comment-emoji-picker');
        picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Emoji
    document.querySelector('#picker-comment').addEventListener('emoji-click', event => {
        const input = document.getElementById('comment-input');
        
        // ‡πÅ‡∏ó‡∏£‡∏Å Emoji ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å input type=text ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö selectionStart ‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô textarea ‡πÉ‡∏ô‡∏ö‡∏≤‡∏á browser ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î)
        input.value += event.detail.unicode;
        input.focus();
    });

    // ‡∏õ‡∏¥‡∏î Picker ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÅ‡∏Å‡πâ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô sendComment ‡πÄ‡∏î‡∏¥‡∏°)
    const originalSendComment = window.sendComment;
    window.sendComment = async function() {
        // ‡∏õ‡∏¥‡∏î Emoji picker
        document.getElementById('comment-emoji-picker').style.display = 'none';
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        await originalSendComment(); // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® window.sendComment = sendComment ‡πÑ‡∏ß‡πâ‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°
    }
        
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id'); 
        const myUsername = localStorage.getItem('myUsername');
        const currentLang = localStorage.getItem('preferredLanguage') || 'th';
        
        let currentDestination = null;
        let finishRequester = '';
        let currentPost = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        let currentViewerLocation = null;
		function savePostLocationAsPrimary(location) {
¬† ¬† ¬† ¬† ¬† ¬† if (location && location.lat && location.lng) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const newPrimaryLocation = { 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† lat: location.lat, 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† lng: location.lng, 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† name: location.name || 'My Location'
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏•‡∏á Local Storage
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† localStorage.setItem('userPrimaryLocation', JSON.stringify(newPrimaryLocation));
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† }

        if (!myUsername || !postId) {
            showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'fas fa-exclamation-triangle', 4000); 
            setTimeout(() => { location.href = '/'; }, 1000);
        }

        socket.on('connect', () => {
            applyLanguage();
            socket.emit('register', myUsername);
            socket.emit('join-post-room', { postId, username: myUsername, lang: currentLang });
            
            
        });

        socket.on('access-granted', ({ post, isAdmin }) => {
			locationShared = false;
			const waitMsg = document.getElementById('viewer-wait-msg');
			if (waitMsg && myUsername !== data.post.author) {
					waitMsg.style.display = 'block';
				}
            // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
            currentPost = post; 
            // ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            const lang = localStorage.getItem('preferredLanguage') || 'th';
            const t = postTranslations[lang] || postTranslations['th'];
            if (myUsername === post.author || myUsername === 'Admin' || isAdmin) { 
				myCurrentLocation = null;
				document.body.style.display = 'block';
				renderPost(post, isAdmin);
                displayMap(post.location);
                return; 
            }

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Browser ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏´‡∏°
            if (!navigator.geolocation) {
                showNotification(t['error_geo_unsupported'], 'fas fa-map-marker-slash', 4000);
                setTimeout(() => { location.href = '/'; }, 3000);
                return;
            }

            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏ô‡πá‡∏ï‡∏ä‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠ GPS ‡∏ä‡πâ‡∏≤)
            showNotification(t['checking_location'], 'fas fa-satellite-dish', 2000);

            // üöÄ ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const location = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    myCurrentLocation = location; // ‡∏à‡∏≥‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
                    savePostLocationAsPrimary(myCurrentLocation);
                    // üéâ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏ß‡πá‡∏ö
                    document.body.style.display = 'block';
                    renderPost(post, false);

                    // ‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏õ‡πÉ‡∏´‡πâ Server
                    socket.emit('update-viewer-location', { 
                        postId: postId, 
                        username: myUsername, 
                        location: location
                    });
                    
                    // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                    displayMap(post.location);
                }, 
                (error) => {
                    // ‚ùå ‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ‡∏´‡∏£‡∏∑‡∏≠ Error
                    console.warn('Geolocation blocked:', error.message);
                    
                    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏™
                    let msgKey = 'error_geo_required';
                    if (error.code === 1) msgKey = 'error_geo_denied'; // 1 = Permission Denied

                    // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô Notification (‡πÅ‡∏ï‡πà‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô)
                    document.body.style.display = 'block';
                    document.querySelector('.container').style.display = 'none'; 

                    showNotification(t[msgKey], 'fas fa-user-lock', 4000);
                    
                    // ‡∏î‡∏µ‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                    setTimeout(() => { location.href = '/'; }, 3500);
                },
                {
                    enableHighAccuracy: true, // ‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á
                    timeout: 10000,           // ‡∏£‡∏≠‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                    maximumAge: 0             // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà Cache ‡πÑ‡∏ß‡πâ
                }
            );
        });

        socket.on('access-denied', (reason) => {
            // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Å‡πà‡∏≠‡∏ô ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            document.body.style.display = 'block'; 
            showNotification(reason, 'fas fa-exclamation-triangle', 2000);
            setTimeout(() => { location.href = '/'; }, 2000); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡∏ô
        });

        socket.on('force-leave', (reason) => {
            // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô
            document.body.style.display = 'block';
            showNotification(reason, 'fas fa-door-open', 2000);
            setTimeout(() => { location.href = '/'; }, 2000); 
        });

        socket.on('restart-success', (msg) => {
            showNotification(msg, 'fas fa-redo');
        });
        
        let currentRating = 0;

        // 1. ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å Server
        socket.on('start-rating-phase', () => {
            document.getElementById('finish-job-modal').classList.add('hidden');
            document.getElementById('rating-modal').classList.remove('hidden');
        });

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏≤‡∏ß
        window.setRating = function(score) {
            currentRating = score;
            document.getElementById('selected-rating').innerText = score;
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Client)
        window.submitRating = function() {
            if (currentRating === 0) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏î‡∏ß‡∏á', 'fas fa-exclamation-circle', 2000);
                return;
            }
            const comment = "";
            
            // üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Server ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            socket.emit('submit-rating', {
                postId,
                rater: myUsername,
                rating: currentRating,
                comment: comment
            });
            
            document.getElementById('rating-modal').classList.add('hidden');
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏¢‡∏≤‡∏¢
window.openImageViewer = function(src) {
    const modal = document.getElementById('image-viewer-modal');
    const img = document.getElementById('full-image');
    img.src = src;
    modal.classList.remove('hidden');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
window.closeImageViewer = function() {
    document.getElementById('image-viewer-modal').classList.add('hidden');
}

        // 4. ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á "‡∏£‡∏≠‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢" (‡∏•‡∏ö Logic ‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ)
        socket.on('rating-waiting', (msg) => {
            showNotification('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'fas fa-check-circle', 3000);
        });
        
        // --- CORE LOGIC (unchanged for brevity) ---

        function displayMap(location) {
    const mapContainer = document.getElementById('map-container');
    const mapIframe = document.getElementById('post-map-iframe');
    const navButton = document.getElementById('start-nav-btn');
    const mapTitle = document.getElementById('map-title');
    const lang = localStorage.getItem('preferredLanguage') || 'th';
    const t = postTranslations[lang] || postTranslations['th'];            
    
    if (location && location.lat && location.lng) {
        const lat = location.lat.toFixed(6); 
        const lng = location.lng.toFixed(6);
        
        currentDestination = { lat, lng };

        let viewerText = '';
        let initialMapUrl = '';
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Viewer (‡∏°‡∏µ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á) ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å "‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á -> ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ"
        if (myCurrentLocation) {
             const distanceKm = getDistanceFromLatLonInKm(
                location.lat, location.lng, 
                myCurrentLocation.lat, myCurrentLocation.lng
            ).toFixed(2);
            
            viewerText = `<br>
                  <div style="background:#e9f7ef; padding:10px; border-radius:8px; margin-top:10px; border:1px solid #28a745; font-size: 0.9rem;">
                      <span style="color:#d63384; font-weight:bold; font-size:1.1em;">
                          üìè Distance: ${distanceKm} Km.
                      </span>
                  </div>`;

             const myLat = myCurrentLocation.lat.toFixed(6);
             const myLng = myCurrentLocation.lng.toFixed(6);
             // ‚úÖ ‡πÉ‡∏ä‡πâ URL ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô Google Maps
             initialMapUrl = `https://maps.google.com/maps?saddr=${myLat},${myLng}&daddr=${lat},${lng}&z=13&output=embed&t=m&hl=en`;

        } else {
             // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á) ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà‡∏à‡∏∏‡∏î‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ
             // ‚úÖ ‡πÉ‡∏ä‡πâ URL ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô Google Maps
             initialMapUrl = `https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed&t=m&hl=en`;
        }

        mapIframe.src = initialMapUrl;

        if (mapTitle) {
            mapTitle.innerHTML = `üìç Location${viewerText}`;
        }

        mapContainer.style.display = 'block'; 

        const isOwnerOrAdmin = myUsername === currentPost.author || myUsername === 'Admin';
        if (isOwnerOrAdmin) {
            navButton.style.display = 'none';
        } else {
            navButton.style.display = 'block';
            navButton.innerText = t['btn_show_route'];
            
            let googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
				if (myCurrentLocation) {
					googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${myCurrentLocation.lat},${myCurrentLocation.lng}&destination=${lat},${lng}`;
					}
                //window.open(googleMapsUrl, '_blank');
            };
       
        
    } else {
        mapContainer.style.display = 'none'; 
        navButton.style.display = 'none';
    }
}

	// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Show/Hide ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
	function toggleMap() {
    const content = document.getElementById('map-content-wrapper');
    const btn = document.getElementById('toggle-map-btn');
    const isHidden = content.style.display === 'none';

    // ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const lang = localStorage.getItem('preferredLanguage') || 'th';
    const t = postTranslations[lang] || postTranslations['th'];

    if (isHidden) {
        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        content.style.display = 'block';
        // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏• '‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà' ‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
        btn.innerHTML = `<i class="fas fa-chevron-up"></i> ${t['btn_hide_map']}`; 
        btn.style.background = '#dbeafe'; 
        btn.style.color = '#007bff';
    } else {
        // ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        content.style.display = 'none';
        // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏• '‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà' ‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏•‡∏á
        btn.innerHTML = `<i class="fas fa-chevron-down"></i> ${t['btn_show_map']}`;
        btn.style.background = '#e4e6eb'; 
        btn.style.color = '#333';
    }
}

	
	// ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≤‡∏Å Server (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°)
socket.on('location-shared-by-author', (data) => {
    alert("üì¢ ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß!");
    locationShared = true;
    document.getElementById('viewer-wait-msg').classList.add('hidden');
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (myCurrentLocation) {
        displayMapWithViewer(data.authorLocation, myCurrentLocation);
    }
});

	socket.on('viewer-left-reset-share', () => {
    const shareBtn = document.getElementById('share-loc-btn');
    if (shareBtn) {
        shareBtn.disabled = false;
        shareBtn.innerText = "‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°";
        shareBtn.style.background = "#28a745";
    }
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏î‡∏π‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡πá‡∏Ñ‡∏ß‡∏£‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
    // displayMapWithViewer(currentPost.location, null); 
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ)
function shareLocation() {
    // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ currentPostViewer ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏à‡∏≤‡∏Å socket ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    if (!currentPostViewer) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ");

    socket.emit('share-location-to-viewer', {
        postId: currentPost.id,
        targetViewer: currentPostViewer,
        authorLocation: currentPost.location
    });
    
    alert("‚úÖ ‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡πÅ‡∏•‡πâ‡∏ß");
    document.getElementById('share-loc-btn').disabled = true;
    document.getElementById('share-loc-btn').innerText = "‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß";
}

        
    function displayMapWithViewer(postLocation, viewerLocation) {
    const mapContainer = document.getElementById('map-container');
    const mapIframe = document.getElementById('post-map-iframe');
    const mapTitle = document.getElementById('map-title'); 
    const waitMsg = document.getElementById('viewer-wait-msg'); // ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á div ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô HTML
    
    if (!postLocation || !postLocation.lat || !postLocation.lng) {
        mapContainer.style.display = 'none'; 
        return;
    }

    const p_lat = postLocation.lat; 
    const p_lng = postLocation.lng;
    const isOwnerOrAdmin = (myUsername === currentPost.author || myUsername === 'Admin');
    
    let mapUrl = '';
    let viewerText = '';

    // --- LOGIC ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
    
    // 1. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏£‡πå -> ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    if (!isOwnerOrAdmin && !locationShared) {
        mapContainer.style.display = 'none';
        if (waitMsg) waitMsg.style.display = 'block';
        return;
    }

    // 2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß
    if (waitMsg) waitMsg.style.display = 'none';
    mapContainer.style.display = 'block';

    if (viewerLocation && viewerLocation.lat) {
        const v_lat = viewerLocation.lat;
        const v_lng = viewerLocation.lng;
        const distanceKm = getDistanceFromLatLonInKm(p_lat, p_lng, v_lat, v_lng).toFixed(2);
        
        // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á (‡∏Ñ‡∏ô‡∏î‡∏π -> ‡∏à‡∏∏‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ)
        mapUrl = `https://maps.google.com/maps?saddr=${v_lat},${v_lng}&daddr=${p_lat},${p_lng}&output=embed&t=m&z=14`;
        
        viewerText = `<br>
                      <div style="background:#e9f7ef; padding:10px; border-radius:8px; margin-top:10px; border:1px solid #28a745; font-size: 0.9rem;">
                          <span style="color:#d63384; font-weight:bold;">üìè ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á: ${distanceKm} ‡∏Å‡∏°.</span>
                      </div>`;
    } else {
        // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        mapUrl = `https://maps.google.com/maps?q=${p_lat},${p_lng}&z=15&output=embed&t=m`;
    }
    
    mapIframe.src = mapUrl;
    if (mapTitle) mapTitle.innerHTML = `üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ${viewerText}`;
}

    window.startEmbeddedNavigation = function() {
    if (!currentDestination) {
        showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á', 'fas fa-exclamation-triangle');
        return;
    }

    const destLat = currentDestination.lat;
    const destLng = currentDestination.lng;
    const mapIframe = document.getElementById('post-map-iframe');

    let mapDirectionsUrl = '';

    if (typeof myCurrentLocation !== 'undefined' && myCurrentLocation) {
        const myLat = myCurrentLocation.lat;
        const myLng = myCurrentLocation.lng;
        // ‚úÖ URL ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
        mapDirectionsUrl = `https://maps.google.com/maps?saddr=${myLat},${myLng}&daddr=${destLat},${destLng}&z=14&output=embed&hl=en`;
    } else {
        // ‚úÖ URL ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
        mapDirectionsUrl = `https://maps.google.com/maps?q=${destLat},${destLng}&z=14&output=embed&hl=en`;
    }

    mapIframe.src = mapDirectionsUrl;
    showNotification('‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á...', 'fas fa-route', 4000);
}

socket.on('viewer-location-update', (data) => {
    const isOwnerOrAdmin = myUsername === currentPost.author || myUsername === 'Admin';
    if (isOwnerOrAdmin && data.viewer !== myUsername) {
         currentPostViewer = data.viewer; // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏î‡∏π‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
         currentViewerLocation = data.location;
         displayMapWithViewer(currentPost.location, currentViewerLocation); 
    }
});

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Viewer ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö Pin)
socket.on('viewer-left-location', (data) => {
    if (myUsername === currentPost.author || myUsername === 'Admin') {
         if (data.viewer === (currentPost.acceptedViewer || '')) { // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ Viewer ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏ô‡πÉ‡∏à
             currentViewerLocation = null;
             displayMapWithViewer(currentPost.location, currentViewerLocation); 
             showNotification(`${data.viewer} Walk Out`, 'fas fa-map-marker-alt', 3000);
         }
    }
});

        function createCommentHTML(c, index) {
            const isOdd = index % 2 !== 0;
            let commentImageHtml = c.imageUrl 
                ? `<div style="margin-top: 10px; margin-bottom:5px;">
        <img src="${c.imageUrl}" 
             onclick="openImageViewer('${c.imageUrl}')"
             style="max-width: 200px; max-height: 200px; border-radius: 5px; border: 1px solid #ddd; cursor: pointer;">
       </div>`
    : '';

            return `<div class="comment-box ${isOdd ? 'odd' : ''}">
                <div class="comment-author"><i class="fas fa-user"></i> ${c.author}</div>
                <div class="comment-content">${c.content}</div>
                ${commentImageHtml} <div class="comment-time">${new Date(c.timestamp).toLocaleString()}</div>
            </div>`;
        }

        function renderPost(post, isAdmin = false) {
			const oldStats = document.getElementById('author-stats-container');
			if (oldStats) oldStats.remove();

    const total = post.authorTotalPosts || 0;
    const completed = post.authorCompletedJobs || 0;
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    const authorStats = `
        <div id="author-stats-container" style="font-size: 0.85em; color: #666; margin-top: 5px;">
            üìù Post: ${total} | ‚úÖ Job: ${completed}
        </div>
    `;

    // üéØ 2. ‡πÅ‡∏ó‡∏£‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ï‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô
    const authorEl = document.getElementById('post-author');
			if (authorEl) {
			authorEl.insertAdjacentHTML('afterend', authorStats);
			}
            // 1. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
            document.getElementById('post-title').innerText = post.title;
            document.getElementById('post-author').innerText = post.author;
            document.getElementById('post-time').innerText = new Date(post.id).toLocaleString();
            
            // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏≤‡∏ß
            const ratingDisplay = document.getElementById('post-author-rating');
            // ‚úÖ FIX: ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà Server ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô '0.00'
            const displayRating = post.authorRating || '0.00'; 
            ratingDisplay.innerHTML = ` (‚≠ê ${displayRating} / 5.0)`;
            // ------------------------

            // 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Element
            const contentDiv = document.getElementById('post-content');
            const imageContainer = document.getElementById('post-image-container');
            const mapDiv = document.getElementById('map-container');
            const list = document.getElementById('comments-list');
            const commentForm = document.getElementById('comment-form');
            const closedMsg = document.getElementById('closed-msg');
            
            const backBtn = document.getElementById('back-btn');
            const finishBtn = document.getElementById('final-finish-btn');
            const restartBtn = document.getElementById('restart-btn');
            const handoverBtn = document.getElementById('handover-btn');
            const manualCloseBtn = document.getElementById('manual-close-btn');

            contentDiv.style.display = 'block';
            imageContainer.style.display = 'block'; 
            mapDiv.style.display = 'block';
            list.style.display = 'block';
            commentForm.style.display = 'flex';
            closedMsg.style.display = 'none';

            contentDiv.innerText = post.content;
            displayMap(post.location);

            if (post.imageUrl) {
                imageContainer.innerHTML = `
        <div style="text-align:center; margin-bottom: 20px;">
            <img src="${post.imageUrl}" 
                 onclick="openImageViewer('${post.imageUrl}')"
                 style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;"
                 onmouseover="this.style.transform='scale(1.02)'" 
                 onmouseout="this.style.transform='scale(1)'">
        </div>
    `;
            } else {
                imageContainer.innerHTML = '';
                imageContainer.style.display = 'none';
            }

            list.innerHTML = post.comments.map((c, index) => createCommentHTML(c, index)).join('');
            
            const oldAlert = document.getElementById('status-alert');
            if (oldAlert) oldAlert.remove();

            // --- LOGIC ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Ñ ---
            const isOwnerOrAdmin = myUsername === post.author || myUsername === 'Admin';

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
            finishBtn.style.display = 'none';
            restartBtn.style.display = 'none';
            handoverBtn.style.display = 'none';
            manualCloseBtn.style.display = 'none'; 
            
            if (post.isPinned) {
                // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß
                if (post.isClosed) {
                    commentForm.style.display = 'none';
                    closedMsg.style.display = 'block';
                    closedMsg.innerHTML = '<i class="fas fa-lock"></i> ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß';
                    backBtn.style.display = 'block';
                    
                    // Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°? (‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ Admin ‡πÄ‡∏´‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
                    backBtn.style.display = 'block';
                    
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÑ‡∏î‡πâ
                    if (myUsername === 'Admin') {
                        manualCloseBtn.style.display = 'block';
                    }
                }
                // ‚õî ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pinned Post ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏ó‡∏≥ Logic ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏õ‡∏Å‡∏ï‡∏¥
                return; 
            }
            
            currentPostAuthor = post.author; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ
    
    const callBtn = document.getElementById('btn-call-author');
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° ‡πÅ‡∏•‡∏∞ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á -> ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°
    if (callBtn && myUsername !== post.author) {
        callBtn.style.display = 'inline-flex';
    }

            if (post.status === 'finished') {
                const isParticipant = myUsername === post.author || myUsername === post.acceptedViewer || myUsername === 'Admin';

                if (!isParticipant) {
                    contentDiv.style.display = 'none';
                    imageContainer.style.display = 'none';
                    mapDiv.style.display = 'none';
                    list.style.display = 'none';
                    commentForm.style.display = 'none';
                    
                    closedMsg.style.display = 'block';
                    closedMsg.innerHTML = `
                        <div style="background:#fff3cd; color:#856404; padding:20px; border:1px solid #ffeeba; border-radius:10px;">
                            <h2>‚õî ‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡πÅ‡∏•‡πâ‡∏ß</h2>
                            <p>‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (${post.acceptedViewer || '-'}) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                        </div>
                    `;
                    backBtn.style.display = 'block';
                } else {
                    const statusAlert = document.createElement('div');
                    statusAlert.id = 'status-alert';
                    statusAlert.innerHTML = `
                        <div style="background:#d4edda; color:#155724; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #c3e6cb; text-align:center;">
                            <strong>‚úÖ ‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</strong><br>
                            ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì <strong>${post.acceptedViewer}</strong> ‡πÅ‡∏•‡πâ‡∏ß <br>
                            ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <strong>"‡∏à‡∏ö‡∏á‡∏≤‡∏ô/‡πÅ‡∏¢‡∏Å‡∏¢‡πâ‡∏≤‡∏¢"</strong> ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
                        </div>
                    `;
                    list.parentNode.insertBefore(statusAlert, list);

                    backBtn.style.display = 'none';
                    finishBtn.style.display = 'block';
                }
            } else if (post.isClosed) {
                commentForm.style.display = 'none';
                closedMsg.style.display = 'block';
                
                const closeMessage = post.status === 'closed_by_user' || post.status === 'rating_pending' || post.status === 'closed_permanently'
                    ? '<i class="fas fa-lock"></i> ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß'
                    : '<i class="fas fa-lock"></i> ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤';
                closedMsg.innerHTML = closeMessage;
                
                backBtn.style.display = 'block';
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠ Admin ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏ñ‡∏≤‡∏ß‡∏£)
                if (isOwnerOrAdmin && post.status !== 'closed_permanently') {
                    restartBtn.style.display = 'block'; 
                }
            } else {
                // üü¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥
                backBtn.style.display = 'block';
                
                if (isOwnerOrAdmin) {
                    restartBtn.style.display = 'block';
                    handoverBtn.style.display = 'block';
                    manualCloseBtn.style.display = 'block'; 
                }
            }
        }
        
        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á ---
        async function manualClosePost() {
    const lang = localStorage.getItem('preferredLanguage') || 'th';
    const t = postTranslations[lang] || postTranslations['th'];
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î
    if (confirm(t['confirm_close_post'])) { 
        try {
            const res = await fetch(`/api/posts/${postId}/close`, { // ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà /close
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ requestBy: myUsername })
});

            const data = await res.json();

            if (data.success) {
                document.getElementById('manual-close-btn').disabled = true;
                alert(t['alert_post_closed']);
                // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                location.reload(); 
            } else {
                alert(`‚ùå Error: ${data.error || '‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'}`);
            }
        } catch (e) {
            console.error(e);
            alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
        }
    }
}
        
        function restartPost() { 
    // 1. ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏©‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const lang = localStorage.getItem('preferredLanguage') || 'th';
    const t = postTranslations[lang] || postTranslations['th'];

    // 2. ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ translation
    if(confirm(t['confirm_kick'])) {
        socket.emit('restart-post-room', postId);
    }
}

        async function sendComment() { 
            const content = document.getElementById('comment-input').value.trim();
            const imageFile = document.getElementById('comment-image').files[0];

            if(!content && !imageFile) {
                showNotification("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û", 'fas fa-exclamation-circle', 2000);
                return;
            }
            
            document.getElementById('comment-input').disabled = true;

            const formData = new FormData();
            formData.append('content', content);
            formData.append('author', myUsername);
            if (imageFile) {
                formData.append('image', imageFile);
            }

            const res = await fetch(`/api/posts/${postId}/comments`, { 
                method: 'POST',
                body: formData 
            });
            
            document.getElementById('comment-input').disabled = false;

            if (res.status === 200) {
                document.getElementById('comment-input').value = '';
                document.getElementById('comment-image').value = '';
                const fileNameDisplay = document.getElementById('file-name-display');
                fileNameDisplay.innerText = '';
                fileNameDisplay.style.display = 'none';
            } else {
                // ‚úÖ [FIXED] ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error ‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô SyntaxError
                try {
                    const d = await res.json();
                    showNotification(d.error, 'fas fa-times-circle', 4000); 
                    if (d.error.includes('‡∏õ‡∏¥‡∏î') || d.error.includes('‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤') || 
						d.error.includes('closed') || d.error.includes('finished')) {
							location.reload();
						}
                } catch (e) {
                     // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON (‡πÄ‡∏ä‡πà‡∏ô Server ‡∏ï‡∏≠‡∏ö 404 HTML)
                     showNotification(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${res.status}`, 'fas fa-times-circle', 5000); 
                }
            }
        }
        
        async function openHandoverModal() {
            document.getElementById('handover-modal').classList.remove('hidden');

            const titleEl = document.getElementById('handover-title');
            const messageEl = document.getElementById('handover-message'); 
            const viewerContainer = document.getElementById('handover-viewer-container'); 
            const viewerEl = document.getElementById('target-viewer-display'); 
            const actionsEl = document.getElementById('handover-actions');

            // --- 1. ‡∏î‡∏∂‡∏á‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏• ---
            const lang = localStorage.getItem('preferredLanguage') || 'th';
            const t = postTranslations[lang] || postTranslations['th'];
            // ------------------------

            // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•)
            titleEl.innerText = t['handover_status_loading_title'];
            messageEl.innerText = t['handover_status_loading_msg'];
            messageEl.style.color = '#6c757d'; 
            messageEl.classList.remove('hidden');

            viewerContainer.classList.add('hidden'); 
            viewerEl.innerText = '...'; 
            actionsEl.classList.add('hidden'); 

            try {
                const controller = new AbortController();
                const signal = controller.signal;
                const timeoutId = setTimeout(() => controller.abort(), 5000); 
                
                const fetchPromise = fetch(`/api/posts/${postId}/viewer-status?requestBy=${myUsername}`, { signal });
                
                const res = await fetchPromise;
                clearTimeout(timeoutId); 

                if (res.status !== 200) {
                    const errorData = await res.json().catch(() => ({ error: 'Unknown Server Error' }));
                    throw new Error(errorData.error || `HTTP error! status: ${res.status}`);
                }
                
                const data = await res.json();
                
                if (data.error) {
                    // ‚ùå ‡∏Å‡∏£‡∏ì‡∏µ Error ‡∏à‡∏≤‡∏Å Server
                    titleEl.innerText = t['handover_status_error_title'];
                    messageEl.innerText = data.error;
                    messageEl.style.color = '#dc3545';
                } else if (data.isOccupied) {
                    // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏ö Viewer
                    const ratingShow = data.rating !== undefined 
                        ? parseFloat(data.rating).toFixed(2) 
                        : '0.00'; 
						const totalPosts = data.totalPosts || 0;
						const completedJobs = data.completedJobs || 0;

                    titleEl.innerText = t['handover_status_found_title'];
                    
                    messageEl.innerHTML = `<span style="color:#28a745"><i class="fas fa-check-circle"></i> ${t['handover_status_found_msg']}</span>`;
                    
                    viewerEl.innerHTML = `
    <div>${data.viewer} <span style="color:#ffc107; margin-left:5px;">‚≠ê ${ratingShow}</span></div>
    <div style="font-size: 0.75em; color: #666; margin-top: 5px; font-weight: normal;">
        <i class="fas fa-edit"></i> : ${totalPosts} | 
        <i class="fas fa-check-double"></i> : ${completedJobs}
    </div>
`;

viewerContainer.classList.remove('hidden'); 
actionsEl.classList.remove('hidden');
                    
                } else {
                    // ‚ö†Ô∏è ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏ö Viewer
                    titleEl.innerText = t['handover_status_not_found_title'];
                    messageEl.innerText = t['handover_status_not_found_msg'];
                    messageEl.style.color = '#e0a800'; 
                    viewerContainer.classList.add('hidden');
                }

            } catch (e) {
                // ‚ùå ‡∏Å‡∏£‡∏ì‡∏µ Network Error / Timeout
                showNotification('‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ', 'fas fa-exclamation-triangle', 5000);

                titleEl.innerText = t['handover_status_error_title'];
                messageEl.innerText = (e.name === 'AbortError') 
                    ? t['handover_status_error_timeout'] 
                    : `${t['handover_status_error_general']} ${e.message}`; // ‡πÉ‡∏ä‡πâ Key + e.message
                messageEl.style.color = '#dc3545';
            }
        }
        
function closeDealWithViewer() {
            // ‡∏î‡∏∂‡∏á Element ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
            const viewerElement = document.getElementById('target-viewer-display');
            
            if (!viewerElement) {
                return showNotification('‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'fas fa-bug', 5000);
            }

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏ä‡πà‡∏ô "Aoy ‚≠ê 4.31")
            const fullText = viewerElement.textContent || ''; 
            let viewer = fullText.trim();

            // ‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏≤‡∏ß‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ (‚≠ê 4.31)
            if (viewer.includes('‚≠ê')) {
                viewer = viewer.substring(0, viewer.indexOf('‚≠ê')).trim();
            }

            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
            if (!viewer || viewer === '...' || viewer === '') {
                return showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)', 'fas fa-user-times', 3000);
            }

            // 2. ‡∏î‡∏∂‡∏á‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Notification
            const lang = localStorage.getItem('preferredLanguage') || 'th';
            const t = postTranslations[lang] || postTranslations['th']; 
            
            // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ï‡∏±‡∏î confirm() ‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            socket.emit('offer-deal', { postId, targetViewer: viewer });
            document.getElementById('handover-modal').classList.add('hidden');
            
            // 3. ‡πÅ‡∏™‡∏î‡∏á Notification ‡∏ß‡πà‡∏≤‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß
            showNotification(t['notif_offer_sent'].replace('[VIEWER]', viewer), 'fas fa-hourglass-half');
            
            // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Deal Result) ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡πà socket.on('deal-result')
        }

        // --- SOCKET LISTENERS ---

        socket.on('receive-offer', (data) => {
            if (data.postId == postId) {
                document.getElementById('offer-modal').classList.remove('hidden');
            }
        });

        function replyOffer(accepted) {
            const ownerName = document.getElementById('post-author').innerText;
            socket.emit('reply-offer', { 
                postId, 
                accepted, 
                viewer: myUsername, 
                owner: ownerName 
            });
            document.getElementById('offer-modal').classList.add('hidden');
        }

        socket.on('deal-result', (data) => {
            // ‡∏î‡∏∂‡∏á‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const lang = localStorage.getItem('preferredLanguage') || 'th';
            const t = postTranslations[lang] || postTranslations['th'];
            let message = '';
            let icon = '';
            const duration = 4000; 

            // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà] ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏õ‡∏•‡πÅ‡∏•‡πâ‡∏ß
            const fallbackViewerName = t['generic_viewer_name'];
            
            // ‚≠ê [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà] ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å Server ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡πÅ‡∏•‡πâ‡∏ß
            const viewerName = data.targetViewer || fallbackViewerName; 

            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (data.success) {
                message = t['notif_deal_accepted'].replace('[VIEWER]', viewerName);
                icon = 'fas fa-check-circle';

                location.reload(); 
            } else {
                // Deal REJECTED ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: 
                message = t['notif_deal_rejected'].replace('[VIEWER]', viewerName);
                icon = 'fas fa-times-circle';
            }
            
            showNotification(message, icon, duration);
        });
        
        // --- FINISH JOB ---

        function requestFinishJob() {
    // 1. ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•
    const lang = localStorage.getItem('preferredLanguage') || 'th';
    const t = postTranslations[lang] || postTranslations['th'];

    // 2. ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡πÉ‡∏ô confirm
    if(confirm(t['confirm_finish_request'])) {
        socket.emit('request-finish-job', { postId });
        showNotification(t['notif_wait_finish_confirm'], 'fas fa-hourglass-start', 3000); 
    }
}

        socket.on('receive-finish-request', (data) => {
    finishRequester = data.requester;
    
    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•
    const lang = localStorage.getItem('preferredLanguage') || 'th';
    const t = postTranslations[lang] || postTranslations['th'];

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ: "‡∏Ñ‡∏∏‡∏ì [Name] ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô..."
    const descElement = document.getElementById('finish-job-desc');
    descElement.innerHTML = `${t['modal_finish_desc_prefix']} <strong id="finish-requester-name">${data.requester}</strong> ${t['modal_finish_desc_suffix']}`;
    
    // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å applyLanguage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏° (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ)
    applyLanguage();

    document.getElementById('finish-job-modal').classList.remove('hidden');
});

        function replyFinishJob(accepted) {
            socket.emit('confirm-finish-job', { 
                postId, 
                accepted, 
                requester: finishRequester 
            });
            document.getElementById('finish-job-modal').classList.add('hidden');
        }

        socket.on('finish-request-rejected', (data) => {
    let msg = data; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° (‡∏Å‡∏£‡∏ì‡∏µ Server ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô String)
    
    // ‡∏ñ‡πâ‡∏≤ Server ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Object { msgKey: '...' }
    if (typeof data === 'object' && data.msgKey) {
        const lang = localStorage.getItem('preferredLanguage') || 'th';
        const t = postTranslations[lang] || postTranslations['th'];
        msg = t[data.msgKey] || data.msgKey;
    }

    showNotification(msg, 'fas fa-times-circle', 3000); 
});

        // üöÄ Event ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        socket.on('job-completed-success', (data) => {
    let msg = data;

    // ‡∏ñ‡πâ‡∏≤ Server ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Object { msgKey: ... }
    if (typeof data === 'object' && data.msgKey) {
        const lang = localStorage.getItem('preferredLanguage') || 'th';
        const t = postTranslations[lang] || postTranslations['th'];
        msg = t[data.msgKey] || data.msgKey;
    }

    showNotification(msg, 'fas fa-trophy', 4000); 
    
    // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡∏ô
    setTimeout(() => {
        window.location.replace('/'); 
    }, 2000);
});

        socket.on('new-comment', (data) => { 
            if(data.postId == postId) {
                const list = document.getElementById('comments-list');
                list.insertAdjacentHTML('beforeend', createCommentHTML(data.comment, list.children.length));
                list.scrollTop = list.scrollHeight;
            }
        });

        function goBack() {
            socket.emit('leave-post-room', postId); 
            location.href = '/';
        }

        window.onbeforeunload = function() { socket.emit('leave-post-room', postId); }; 
        document.getElementById('comment-input').addEventListener('keypress', (e) => { 
            if(e.key === 'Enter') sendComment(); 
        });
        
        // --- EXPOSE GLOBAL FUNCTIONS ---
        window.restartPost = restartPost;
        window.sendComment = sendComment;
        window.closeDealWithViewer = closeDealWithViewer;
        window.openHandoverModal = openHandoverModal;
        window.replyOffer = replyOffer;
        window.replyFinishJob = replyFinishJob;
        window.requestFinishJob = requestFinishJob;
        window.setRating = setRating;
        window.submitRating = submitRating;
        window.goBack = goBack;
        window.manualClosePost = manualClosePost;
        applyLanguage();
        
        document.getElementById('comment-image').addEventListener('change', function() {
    const fileNameDisplay = document.getElementById('file-name-display');
    if (this.files && this.files.length > 0) {
        // ‚≠ê ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô
        fileNameDisplay.innerHTML = `<i class="fas fa-image"></i> ${this.files[0].name} <span style="font-size:0.8em; color:#999;"></span>`;
        fileNameDisplay.style.display = 'block'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô block ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ö‡∏ô
    } else {
        fileNameDisplay.innerText = '';
        fileNameDisplay.style.display = 'none';
    }
});

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    const R = 6371; // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÇ‡∏•‡∏Å (‡∏Å‡∏°.)
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const d = R * c; // ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏Å‡∏°.
    return d;
}

function deg2rad(deg) {
    return deg * (Math.PI / 180);
}

    </script>
    
    <div id="call-modal" class="hidden" style="position: fixed; bottom: 20px; right: 20px; width: 300px; background: #2c3e50; color: white; border-radius: 10px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; text-align: center;">
    <h3 id="call-status" style="margin: 0 0 10px 0;">üìû ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏ó‡∏£...</h3>
    <p id="call-partner" style="font-size: 0.9em; color: #bdc3c7;">...</p>
    
    <div id="incoming-actions" class="hidden">
        <button onclick="acceptCall()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; margin-right: 5px;">
            <i class="fas fa-phone"></i> ‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢
        </button>
        <button onclick="endCall()" style="background: #c0392b; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer;">
            <i class="fas fa-phone-slash"></i> ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
        </button>
    </div>

    <button id="btn-hangup" onclick="endCall()" style="background: #c0392b; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; margin-top: 10px;">
        <i class="fas fa-phone-slash"></i> ‡∏ß‡∏≤‡∏á‡∏™‡∏≤‡∏¢
    </button>
    
    <audio id="remote-audio" autoplay></audio>
</div>

</body>
</html>