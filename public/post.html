<!DOCTYPE html>
<html lang="th">
<head>
	
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- GLOBAL STYLES --- */
        body { 
            font-family: 'Kanit', sans-serif; 
            padding: 0; 
            margin: 0;
            display: none;
            background-image: linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5)), url('https://sv1.img.in.th/7fB1Jg.png');
            background-size: cover;         
            background-position: center;    
            background-attachment: fixed;   
            background-repeat: no-repeat;   
            background-color: #f0f2f5; /* ‡∏™‡∏µ‡∏™‡∏≥‡∏£‡∏≠‡∏á */
        }
        .container { 
            max-width: 900px; 
            margin: 20px auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }

        /* --- HEADER & ACTIONS --- */
        .header-btns { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 30px; 
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .back-btn, .restart-btn { 
            border: none; 
            padding: 10px 18px; 
            border-radius: 20px; 
            cursor: pointer; 
            font-weight: 600;
            transition: background 0.2s;
            font-size: 14px;
        }
        .back-btn { 
            background: #6c757d; 
            color: white; 
        }
        .back-btn:hover { background: #5a6268; }

        .restart-btn { 
            background: #dc3545; 
            color: white; 
            display: none; 
        }
        .restart-btn:hover { background: #c82333; }
        
        .manual-close-btn { 
            background: #e98514; 
            color: white;
            padding: 10px 18px; 
            border-radius: 20px; 
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            font-size: 14px;
            border: none;
            display: none;
        }
        .manual-close-btn:hover { background: #cf7010; }

        /* --- POST BODY --- */
        #post-title {
            font-size: 1.5em;
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .post-meta {
            color: #6c757d; 
            font-size: 0.9em;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
        }
        .post-meta strong { color: #333; font-weight: 400;}
        
        #post-content {
            font-size: 1.1em; 
            line-height: 1.8; 
            min-height: 100px;
            padding: 20px 0;
            border-top: 1px dashed #ddd;
            white-space: pre-wrap; 
        }
        
        /* --- COMMENTS SECTION --- */
        h3 {
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-bottom: 20px;
            color: #007bff;
            font-weight: 600;
        }
        .comment-box { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 10px; 
            border-left: 5px solid #007bff; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .comment-box.odd { 
            background: #fff;
            border-left-color: #28a745; 
        } 
        .comment-author {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        .comment-content {
            font-size: 0.8em;
            margin-bottom: 8px;
        }
        .comment-time {
            font-size: 0.75em; 
            color: #999; 
            text-align: right;
        }

        /* --- COMMENT FORM --- */
        #comment-form {
            margin-top: 30px; 
            padding: 10px 0; 
            background: white; 
            border-radius: 40px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #chat-input-area {
            display: flex;
			align-items: center;
			gap: 5px; 
			padding: 0 10px;
			width: 100%;     /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö Container */
			box-sizing: border-box;
        }
        #comment-input { 
            flex-grow: 1; 
			min-width: 0;
            padding: 10px 15px; 
            border: none; 
            border-radius: 20px; 
            box-sizing: border-box; 
            font-family: 'Kanit';
            font-size: 1em;
            background-color: #f1f1f1; 
        }
        #comment-input:focus {
            outline: none; 
            background-color: #fff;
        }
        #add-media-btn, #send-comment-btn, #emoji-btn, #btn-call-author { 
            width: 40px; 
            height: 40px; 
			flex-shrink: 0;
            border-radius: 50%; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            transition: background 0.2s;
            font-size: 1.2em;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #add-media-btn {
            background: #e4e6eb; 
            color: #007bff;
        }
        #add-media-btn:hover { background: #d0d3d6; }
        #send-comment-btn { 
            background: #007bff; 
            color: white; 
        }
        #send-comment-btn:hover { background: #0056b3; }
        #comment-image {
            display: none !important;
        }
        
        /* --- CLOSED MESSAGE --- */
        #closed-msg {
            display:none; 
            color: #dc3545; 
            text-align:center; 
            margin-top:20px; 
            padding: 15px;
            border: 1px solid #f5c6cb;
            background-color: #f8d7da;
            border-radius: 8px;
            font-weight: 600;
        }
        
        /* --- MODAL / OVERLAY --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 3000; display: flex; 
            justify-content: center; align-items: center; 
        }
        .modal-box { 
            background: white; width: 90%; max-width: 500px; padding: 30px; 
            border-radius: 15px; max-height: 80vh; overflow-y: auto; 
        }
        .hidden { display: none !important; }

        /* --- NEW: STATUS NOTIFICATION (Toast) --- */
        #status-notif-modal {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            padding: 15px;
            background: #007bff;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 3000;
            font-size: 14px;
            transition: opacity 0.3s ease;
            opacity: 0; /* ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ */
            pointer-events: none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å */
        }
        #status-notif-modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        #notif-content {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
		
		
		
#floating-chat-btn:active { cursor: grabbing; transform: scale(0.9); }

/* ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ä‡∏ó */
#floating-chat-window {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100dvh; 
    background: white;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 2400;
}

#chat-window-header {
    background: #007bff;
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.2em;
    font-weight: 600;
}

#floating-chat-messages {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
    background: #f0f2f5;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

#floating-comment-input {
    flex-grow: 1;
    border: 1px solid #ddd;
    border-radius: 20px;
    padding: 8px 15px;
    outline: none;
}

#floating-chat-input-area button {
    background: #007bff;
    color: white;
    border: none;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
	min-width: 40px;
    min-height: 40px;
    z-index: 10;
}

#floating-chat-input-area {
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-top: 1px solid #eee;
    background: #fff;
    padding-bottom: calc(15px + env(safe-area-inset-bottom));
}

#floating-comment-input {
    flex-grow: 1;
    border: 1px solid #ddd;
    border-radius: 20px;
    padding: 8px 15px;
    font-family: 'Kanit';
    font-size: 14px;
    outline: none;
}

#floating-chat-window.hidden {
    display: none !important;
}

#floating-chat-btn {
    position: fixed;
    right: 0;
    top: 50%;
    transform: translateY(-50%); /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏û‡∏≠‡∏î‡∏µ */
    width: 35px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° */
    height: 90px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏õ‡∏∏‡πà‡∏° */
    background-color: #007bff;
    color: white;
    border-radius: 12px 0 0 12px; /* ‡πÇ‡∏Ñ‡πâ‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏∏‡∏°‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ */
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
    box-shadow: -2px 0 10px rgba(0,0,0,0.15);
    cursor: pointer;
    z-index: 2500;
    transition: all 0.3s ease;
}

/* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ï‡∏≠‡∏ô‡πÄ‡∏≠‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ß‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏Å‡∏î (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏°) */
#floating-chat-btn:hover {
    width: 45px; /* ‡πÅ‡∏á‡πâ‡∏°‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏≠‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ß‡∏≤‡∏á */
    background-color: #0056b3;
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
#floating-chat-btn i {
    transform: rotate(0deg);
}






	.sticky-handover-btn {
  position: fixed;
  bottom: calc(50%); /* ‡∏ß‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ (‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà 50%) */
  left: 0;
  transform: translateY(-50%);

  width: 70px;
  height: 50px;

  /* ‡πÉ‡∏ä‡πâ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤ (Blue Gradient) ‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á */
  background: linear-gradient(135deg, #1391e6, #7baccc);
  color: rgb(255, 254, 254);
  border: none;

  /* ‡∏Ç‡∏≠‡∏ö‡∏°‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ */
  border-top-right-radius: 30px;
  border-bottom-right-radius: 30px;
  border-top-left-radius: 0px;
  border-bottom-left-radius: 0px;

  /*box-shadow: -4px 4px 15px rgba(0, 0, 0, 0.2);*/
  z-index: 2600;

  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  font-size: 24px;
  animation: hndo-sig 2s infinite;
}

@keyframes hndo-sig {
  0% {
    box-shadow: 0 0 0 0 rgba(39, 142, 211, 2.5);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(108, 92, 231, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(108, 92, 231, 0);
  }
}


.sticky-kick-btn {
  position: fixed;
  bottom: calc(43%); /* ‡∏ß‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ (‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà 50%) */
  left: 0;
  transform: translateY(-50%);

  width: 60px;
  height: 40px;

  /* ‡πÉ‡∏ä‡πâ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤ (Blue Gradient) ‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á */
  background: linear-gradient(135deg, #dd1b1b, #d65d5d);
  color: rgb(255, 254, 254);
  border: none;

  /* ‡∏Ç‡∏≠‡∏ö‡∏°‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ */
  border-top-right-radius: 30px;
  border-bottom-right-radius: 30px;
  border-top-left-radius: 0px;
  border-bottom-left-radius: 0px;

  /*box-shadow: -4px 4px 15px rgba(0, 0, 0, 0.2);*/
  z-index: 2600;

  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  font-size: 24px;
}

	.close-post2-btn {
  position: fixed;
  bottom: calc(36%); /* ‡∏ß‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ (‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà 50%) */
  left: 0;
  transform: translateY(-50%);

  width: 50px;
  height: 40px;

  background: linear-gradient(135deg, #d16c0d, #cc811e);
  color: white;
  border: none;

  /* ‡∏Ç‡∏≠‡∏ö‡∏°‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ */
  border-top-right-radius: 30px;
  border-bottom-right-radius: 30px;
  border-top-left-radius: 0px;
  border-bottom-left-radius: 0px;

  z-index: 2000;

  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  font-size: 24px;
  animation: rdis-sig 3s infinite;
}



.send-btn { 
  border: none; 
  padding: 10px 18px; 
  border-radius: 20px; 
  cursor: pointer; 
  font-weight: 600;
  transition: background 0.2s;
  font-size: 14px;
  background-color: #0099CC;
  animation: bounce_513 1s infinite;
}

@keyframes bounce_513 {
  0%,
    100% {
    transform: translateY(-10%);
    animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
  }

  50% {
    transform: translateY(0);
    animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
  }
}


.share-lopost-btn {
  position: fixed;
  top: calc(15%); /* ‡∏ß‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ (‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà 50%) */
  left: 0;
  transform: translateY(-50%);

  width: 70px;
  height: 40px;

  background: #2baf2b;
  color: white;
  border: none;

  /* ‡∏Ç‡∏≠‡∏ö‡∏°‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ */
  border-top-right-radius: 30px;
  border-bottom-right-radius: 30px;
  border-top-left-radius: 0px;
  border-bottom-left-radius: 0px;

  z-index: 2000;

  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  font-size: 12px;
  animation: rdis-sig 3s infinite;
}











    </style>
</head>
<body>

	<div id="floating-chat-btn">
    <i class="fas fa-comments"></i>
</div>

<div id="floating-chat-window" class="hidden">
    <div id="chat-window-header">
        <span><i class="fas fa-comment-alt"></i> Chat Topic</span>
        <button onclick="toggleFloatingChat()" style="background:none; border:none; color:white; cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
    
    <div id="floating-chat-messages"></div>
    
    <div id="floating-chat-input-area" style="display: flex; align-items: flex-end; padding: 10px; gap: 5px;">
        
        <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
            
            <div style="display: flex; gap: 4px; justify-content: center; align-items: center;">
                <button type="button" 
                        onclick="sendLocationInChat()"
                        style="background: #ff4757; color: white; border: none; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 10px;"
                        title="‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
            </div>

            <button id="btn-call-author-chat" 
                    onclick="startCall(currentPostAuthor)" 
                    style="background: #2ecc71; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; flex-shrink: 0;"
                    title="‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå">
                <i class="fas fa-phone-alt"></i>
            </button>
        </div>

        <input type="text" id="floating-comment-input" placeholder="comment..." 
               style="flex-grow: 1; height: 40px; border-radius: 20px; border: 1px solid #ddd; padding: 0 15px; outline: none;">
        
        <button type="button" onclick="sendFloatingComment()" 
                style="background: #007bff; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; flex-shrink: 0;">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>


    <div class="container">
        <div id="map-container" style="margin-top: 20px; display:none;">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 id="map-title" style="margin: 0; border: none; padding: 0;"></h3>
        
        <div style="display: flex; gap: 8px;">
            <button id="share-map-btn" class="share-lopost-btn" onclick="shareMapToViewers()">
                <i class="fas fa-share-alt"></i> Location
            </button>

            <button id="toggle-map-btn" onclick="toggleMap()" 
                data-i18n-key="btn_hide_map"
                style="background: #dbeafe; color: #007bff; border: none; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 0.9em; font-weight: 600;">
                <i class="fas fa-chevron-up"></i> Hide Map
            </button>
        </div>
    </div>

    <div id="map-content-wrapper">
        <iframe id="post-map-iframe" width="100%" height="300" style="border:0; border-radius: 10px;" allowfullscreen="" loading="lazy"></iframe>
        <button id="start-nav-btn" onclick="openGoogleMapsApp()" style="display:none; width: 100%; margin-top: 10px; background: #007bff; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer;">
    üó∫Ô∏è Open On Google Maps (App)
</button>
    </div>
</div>

        <div class="header-btns">
            

            <button id="manual-close-btn" class="close-post2-btn" onclick="manualClosePost()">
                <i class="fas fa-lock"></i>
            </button>
            
            

            <button id="handover-btn" class="sticky-handover-btn" onclick="openHandoverModal()" >
                <i class="fas fa-handshake"></i>
            </button>
            
            <button id="restart-btn" class="sticky-kick-btn" onclick="restartPost()" >
                <i class="fas fa-redo"></i>
            </button>
        </div>
        
        <h1 id="post-title">Loading...</h1>
        <div class="post-meta">
            <span>
                <i class="fas fa-user-circle"></i> ID: 
                <strong id="post-author">...</strong>
                <span style="color:#ffc107; font-weight:bold; font-size:1.1em;" id="post-author-rating"></span>
            </span>
            <span>
                <i class="fas fa-clock"></i> 
                <strong id="post-time">...</strong>
            </span>
        </div>
        
        <div id="post-image-container"></div>
        
        <p id="post-content"></p>
        
        <h3><i class="fas fa-comments"></i> Comment</h3>
        <div id="comments-list"></div>

        <div id="comment-form" style="display: flex; flex-direction: column;"> <div id="file-name-display" style="display: none; font-size: 0.85em; color: #007bff; margin-bottom: 5px; padding-left: 55px; text-align: left;"></div>

    <div id="chat-input-area" style="position: relative;">
        <button id="add-media-btn" onclick="document.getElementById('comment-image').click()" title="file">
            <i class="fas fa-plus"></i>
        </button>
        
   

        <input type="file" id="comment-image" name="image" accept="image/*" class="hidden"> 

        <input type="text" id="comment-input" placeholder="comment..." autocomplete="off">
        
        

        <button type="button" id="send-comment-btn" onclick="sendComment()" title="Send">
		<i class="fas fa-paper-plane"></i>
		</button>

    </div>
</div>

        <div id="closed-msg">
            <i class="fas fa-lock"></i> Closed
        </div>
    </div>
    
    <div id="image-viewer-modal" class="modal-overlay hidden" onclick="closeImageViewer()" style="background: rgba(0,0,0,0.9);">
    <span style="position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; font-weight: bold;">√ó</span>
    
    <img id="full-image" style="max-width: 90%; max-height: 90%; border-radius: 5px; box-shadow: 0 0 20px rgba(255,255,255,0.2); transition: transform 0.2s;">
</div>

    
    <div id="offer-modal" class="modal-overlay hidden">
    <div class="modal-box" style="text-align:center;">
        <h2 data-i18n-key="offer_modal_title">üîî Received a proposal to deliver the work.</h2>
        <p data-i18n-key="offer_modal_desc">The poster wants to hand over the work/close this deal to you.</p>
        
        <div id="offer-condition-msg" style="display:none; background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0; font-weight: bold;">
            <i class="fas fa-map-marker-alt"></i> Condition: The task must be completed within 50 meters.
        </div>
		
		<div id="offer-time-display" style="background: #eef2f7; padding: 10px; border-radius: 8px; margin: 10px 0;">
    <i class="fas fa-clock" style="color: #3498db;"></i> 
    Time limit: <span id="display-time-limit" style="font-weight: bold; color: #e74c3c;">...</span>
</div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="replyOffer(false)" class="back-btn" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer;">
                <i class="fas fa-times"></i> reject
            </button>
            <button onclick="replyOffer(true)" class="send-btn" style="flex: 1; background: #28a745; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                <i class="fas fa-check"></i> Accept the job.
            </button>
        </div>
    </div>
</div>

    <div id="finish-job-modal" class="modal-overlay hidden">
    <div class="modal-box" style="text-align:center;">
        <h2 data-i18n-key="modal_finish_title">üèÅ The other party requested comfirm finished.</h2>
        
        <p id="finish-job-desc">
            ‡∏Ñ‡∏∏‡∏ì <strong id="finish-requester-name">...</strong> Comfirm finished
        </p>

        <p data-i18n-key="modal_finish_warning">If confirmed, both will leave this page and return to the main page.</p>
        
        <div style="margin-top:20px; display:flex; justify-content:center; gap:15px;">
            <button class="restart-btn" style="display:block; background:#dc3545; padding:10px 20px;" onclick="replyFinishJob(false)" data-i18n-key="btn_not_yet">
                ‚ùå reject
            </button>
            <button class="send-btn" style="padding:10px 20px;" onclick="replyFinishJob(true)" data-i18n-key="btn_confirm_finish">
                ‚úÖ Comfirm finished
            </button>
        </div>
    </div>
</div>
    
    <div id="rating-modal" class="modal-overlay hidden">
    <div class="modal-box" style="text-align:center;">
        <h2 data-i18n-key="rating_title">‚≠ê Rate your satisfaction.</h2>
        
        <p data-i18n-key="rating_desc">The task is complete. Please rate the other party to close the job.</p>
        
        <div style="font-size: 2em; margin: 20px 0; cursor: pointer;">
            <span onclick="setRating(1)">‚≠ê</span>
            <span onclick="setRating(2)">‚≠ê</span>
            <span onclick="setRating(3)">‚≠ê</span>
            <span onclick="setRating(4)">‚≠ê</span>
            <span onclick="setRating(5)">‚≠ê</span>
        </div>
        
        <p>
            <span data-i18n-key="rating_selected">Selected score:</span> 
            <strong id="selected-rating" style="font-size:1.5em; color:#ffc107;">0</strong> / 5
        </p>
        
        <button class="send-btn" style="width:100%; margin-top:20px;" onclick="submitRating()" data-i18n-key="btn_submit_rating">
            Confirm rating
        </button>
    </div>
</div>

    <div id="handover-modal" class="modal-overlay hidden">
        <div class="modal-box" style="text-align:center;">
            <h2 id="handover-title" data-i18n-key="modal_handover_title" style="margin-bottom: 10px;">Currently checking....</h2>

            <p id="handover-message" style="color: #6c757d; margin-bottom: 15px;">
                please wait...
            </p>

            <div id="handover-viewer-container" class="hidden" style="font-size: 1.2em; margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                <i class="fas fa-user-check" style="color: #28a745;"></i> Contractor: 
                <strong id="target-viewer-display" style="color: #333;">...</strong>
            </div>

            <div id="handover-actions" class="hidden" style="margin-top: 10px;">
    
    <div style="margin-bottom: 15px; background: #e9ecef; padding: 10px; border-radius: 8px; text-align: left;">
        <label style="cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: bold; color: #333;">
            <input type="checkbox" id="chk-require-proximity" style="transform: scale(1.5);">
            üîí The job must be completed within a 50-meter radius.
        </label>
        <div style="font-size: 0.8em; color: #666; margin-top: 5px; margin-left: 25px;">
            The person accepting the job must be within 50 meters of the "post location" or "you" to be able to complete the job.
        </div>
    </div>
	
	<div style="margin-top: 10px; text-align: left; padding: 10px; background: #f8f9fa; border-radius: 8px;">
    <label style="font-weight: bold; color: #333;"><i class="fas fa-hourglass-start"></i> Time Limit</label>
    <select id="selectTimeLimit" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;">
        <option value="1800000">30 Min</option>
        <option value="3600000">1 H</option>
        <option value="7200000">2 H</option>
		<option value="10800000">3 H</option>
		<option value="14400000">4 H</option>
		<option value="18000000">5 H</option>
		<option value="21600000">6 H</option>
    </select>
</div>

    <button id="send-handover-btn" class="send-btn" onclick="closeDealWithViewer()">
    ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô
</button>
</div>

            <button id="close-handover-modal" class="back-btn" 
                    onclick="document.getElementById('handover-modal').classList.add('hidden')" 
                    data-i18n-key="btn_close"
                    style="
                width:auto; 
                margin-top:20px; 
                background: #dc3545; 
                color: white;
            ">
                ‚ùå Close
            </button>
        </div>
    </div>
    
    <div id="status-notif-modal">
        <div id="notif-content">
            <i class="fas fa-info-circle"></i>
            <span id="notif-message"></span>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
			// --- GLOBAL SETUP (MOVED UP FOR SCOPE) ---
			const socket = io();
			let myCurrentLocation = null;
			let currentPostAuthor = null;
			let isProximityRequired = false; // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô‡πÑ‡∏´‡∏°
			let ownerLastLocation = null;   // ‡πÄ‡∏Å‡πá‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ
			let countdownInterval = null;
			
			// WebRTC Voice Call Logic P2P ---
			let localStream;
			let peerConnection;
			let currentCallUser = null; // ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∏‡∏¢‡∏î‡πâ‡∏ß‡∏¢
			const rtcConfig = {
				iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] // ‡πÉ‡∏ä‡πâ STUN ‡∏ü‡∏£‡∏µ‡∏Ç‡∏≠‡∏á Google
			};
			
			
        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏ó‡∏£‡∏´‡∏≤ (‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ó‡∏£)
        async function startCall(targetUsername) {
            if (targetUsername === myUsername) return alert('Why would you call yourself that? üòÇ');
            
            currentCallUser = targetUsername;
            showCallModal(`üìû Calling. ${targetUsername}...`, false);

            try {
                // ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡∏Ñ‡πå
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                
                peerConnection = new RTCPeerConnection(rtcConfig);
                
                // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏£‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏Ç‡∏≤
                peerConnection.ontrack = event => {
                    document.getElementById('remote-audio').srcObject = event.streams[0];
                };

                // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ICE (Network path)
                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        socket.emit('ice-candidate', { target: targetUsername, candidate: event.candidate });
                    }
                };

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Offer ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏≤‡πÄ‡∏Ç‡∏≤
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                socket.emit('call-user', { 
                    userToCall: targetUsername, 
                    signalData: offer,
                    fromUser: myUsername 
                });

            } catch (err) {
                console.error(err);
                alert('The microphone is inaccessible.');
                closeCallModal();
            }
        }

        // 2. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤ (Socket Listener)
        socket.on('call-incoming', async ({ signal, from }) => {
            currentCallUser = from;
            showCallModal(`üì≤ Incoming call from ${from}`, true);
            
            // ‡πÄ‡∏Å‡πá‡∏ö Offer ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏£‡∏≠‡πÄ‡∏Ç‡∏≤‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢
            window.pendingOffer = signal;
        });

        // 3. ‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢
        async function acceptCall() {
            document.getElementById('incoming-actions').classList.add('hidden');
            document.getElementById('btn-hangup').classList.remove('hidden');
            document.getElementById('call-status').innerText = `üîä Calling ${currentCallUser}`;

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                peerConnection = new RTCPeerConnection(rtcConfig);

                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.ontrack = event => {
                    document.getElementById('remote-audio').srcObject = event.streams[0];
                };

                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        socket.emit('ice-candidate', { target: currentCallUser, candidate: event.candidate });
                    }
                };

                await peerConnection.setRemoteDescription(new RTCSessionDescription(window.pendingOffer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                socket.emit('answer-call', { signal: answer, to: currentCallUser });

            } catch (err) {
                alert('There was an error answering the call.');
                endCall();
            }
        }

        // 4. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢‡πÄ‡∏£‡∏≤‡πÅ‡∏•‡πâ‡∏ß
        socket.on('call-accepted', async (signal) => {
            document.getElementById('call-status').innerText = `üîä Calling ${currentCallUser}`;
            await peerConnection.setRemoteDescription(new RTCSessionDescription(signal));
        });

        // 5. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ ICE Candidate (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Network)
        socket.on('ice-candidate-msg', async (candidate) => {
            if (peerConnection) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (e) { console.error('Error adding ice candidate', e); }
            }
        });

        // 6. ‡∏ß‡∏≤‡∏á‡∏™‡∏≤‡∏¢ / ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
        function endCall() {
            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            
            if (currentCallUser) {
                socket.emit('end-call', { to: currentCallUser });
            }
            
            closeCallModal();
        }

        socket.on('call-ended', () => {
            alert('The call ended.');
            closeCallModal();
        });

        socket.on('call-failed', (msg) => {
            alert(msg);
            closeCallModal();
        });

        // --- Helper UI Functions ---
        function showCallModal(statusText, isIncoming) {
            const modal = document.getElementById('call-modal');
            modal.classList.remove('hidden');
            document.getElementById('call-status').innerText = statusText;
            
            if (isIncoming) {
                document.getElementById('incoming-actions').classList.remove('hidden');
                document.getElementById('btn-hangup').classList.add('hidden');
            } else {
                document.getElementById('incoming-actions').classList.add('hidden');
                document.getElementById('btn-hangup').classList.remove('hidden');
            }
        }

        function closeCallModal() {
            document.getElementById('call-modal').classList.add('hidden');
            peerConnection = null;
            currentCallUser = null;
        }

        //  Custom Notification Function ---
        let notifTimeout;
        function showNotification(message, iconClass = 'fas fa-info-circle', duration = 3000) {
            clearTimeout(notifTimeout);
            const modal = document.getElementById('status-notif-modal');
            const content = document.getElementById('notif-message');
            const icon = modal.querySelector('i');

            icon.className = iconClass;
            content.innerText = message;
            modal.classList.add('show');

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
            notifTimeout = setTimeout(() => {
                modal.classList.remove('show');
            }, duration);
        }

        const postTranslations = {
    'th': {
        'btn_back_tooltip': '‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö',
        'btn_close_post': '‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ',
        'title_close_post': '‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå/‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô)',
        'btn_finish_job': '‡∏à‡∏ö‡∏á‡∏≤‡∏ô/‡πÅ‡∏¢‡∏Å‡∏¢‡πâ‡∏≤‡∏¢',
        'btn_handover': '‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô',
        'title_handover': '‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô/‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà',
        'btn_kick': '‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å',
        'title_kick': '‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏∞‡∏Ñ‡∏ô‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á/‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô',
        'confirm_close_post': '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ? ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡πâ‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå/‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÉ‡∏î‡πÜ ‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ',
        'alert_post_closed': '‚úÖ ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÇ‡∏î‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß',
        'modal_handover_title': '‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô / ‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•',
        'modal_handover_desc': '‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π (Viewer) ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏Å‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ',
        'modal_handover_btn': '‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡∏ô‡∏µ‡πâ',
        'modal_handover_success': '‚úÖ ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',
        'confirm_handover_offer': '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡πÑ‡∏õ‡πÉ‡∏´‡πâ "[VIEWER]" ‡∏Å‡∏î‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        'notif_offer_sent': 'üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡πÉ‡∏´‡πâ [VIEWER] ‡πÅ‡∏•‡πâ‡∏ß',
        'notif_deal_accepted': '‚úÖ [VIEWER] ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
        'notif_deal_rejected': '‚ùå [VIEWER] ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',
        'generic_viewer_name': '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',
        'handover_status_loading_title': '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡∏ä‡∏°...',
        'handover_status_loading_msg': '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Server ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà...',
        'handover_status_found_title': '‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô',
        'handover_status_found_msg': '‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏≠‡∏¢‡∏π‡πà!',
        'handover_status_not_found_title': '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',
        'handover_status_not_found_msg': '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏î‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏ä‡∏°‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ',
        'handover_status_error_title': '‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
        'handover_status_error_timeout': '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (Timeout)',
        'handover_status_error_general': '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:',
        'btn_close': '‚ùå ‡∏õ‡∏¥‡∏î',
        'offer_modal_title': 'üîî ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô',
        'offer_modal_desc': '‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô/‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì',
        'btn_reject': '‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò',
        'btn_accept': '‚úÖ ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö',
        'confirm_finish_request': '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)',
        'modal_finish_title': 'üèÅ ‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏à‡∏ö‡∏á‡∏≤‡∏ô',
        'modal_finish_desc_prefix': '‡∏Ñ‡∏∏‡∏ì',
        'modal_finish_desc_suffix': '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏¢‡∏Å‡∏¢‡πâ‡∏≤‡∏¢',
        'modal_finish_warning': '‡∏´‡∏≤‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å',
        'btn_not_yet': '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö',
        'btn_confirm_finish': '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏ö‡∏á‡∏≤‡∏ô',
        'notif_wait_finish_confirm': '‚è≥ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...',
        'SYS_FINISH_REJECTED': '‚ùå ‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏á‡∏≤‡∏ô',
        'rating_title': '‚≠ê ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à',
        'rating_desc': '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',
        'rating_selected': '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:',
        'btn_submit_rating': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô',
        'SYS_RATING_SUCCESS': 'üéâ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß',
        'SYS_RATING_ALREADY': 'üéâ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß!',
        'SYS_OPPONENT_RATED': 'üîî ‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß! ‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ö‡πâ‡∏≤‡∏á',
        'confirm_kick': '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? (‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô Admin)',
        'error_geo_required': '‚õî ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (GPS) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ',
        'error_geo_denied': '‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏î‡πâ',
        'error_geo_unsupported': '‚ùå ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',
        'checking_location': '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...',
        'btn_show_route': 'üó∫Ô∏è Google Map',
		'btn_show_map': '‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà', 
        'btn_hide_map': '‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà',
    },
    'en': {
        'btn_back_tooltip': 'Back',
        'btn_close_post': 'Close Post',
        'title_close_post': 'Close this post immediately (No comments/jobs)',
        'btn_finish_job': 'Finish Job',
        'btn_handover': 'Handover',
        'title_handover': 'Handover job/Close deal with current viewer',
        'btn_kick': 'Kick',
        'title_kick': 'Kick all viewers (except Owner/Admin)',
        'confirm_close_post': 'Are you sure you want to close this post immediately? The system will prohibit any further comments or job applications.',
        'alert_post_closed': '‚úÖ This post has been closed by the owner.',
        'modal_handover_title': 'Handover Job / Close Deal',
        'modal_handover_desc': 'You are about to close this deal to the selected Viewer. Please ensure all details and pricing are agreed upon. This action is irreversible.',
        'modal_handover_btn': 'Deal',
        'modal_handover_success': '‚úÖ Job Handover completed. Please wait for acceptance from the recipient.',
        'confirm_handover_offer': 'Send deal close request to "[VIEWER]". Confirm acceptance?',
        'notif_offer_sent': 'üì§ Handover offer sent to [VIEWER]',
        'notif_deal_accepted': '‚úÖ [VIEWER] accepted the deal! Post closed successfully.',
        'notif_deal_rejected': '‚ùå [VIEWER] rejected the deal offer.',
        'generic_viewer_name': 'The Recipient',
        'handover_status_loading_title': '‚è≥ Checking viewer status...',
        'handover_status_loading_msg': 'System is contacting server to check for viewers...',
        'handover_status_found_title': '‚úÖ Ready for Handover',
        'handover_status_found_msg': 'Active viewer found!',
        'handover_status_not_found_title': '‚ö†Ô∏è No Viewer Found',
        'handover_status_not_found_msg': 'No other members are currently viewing this post.',
        'handover_status_error_title': '‚ùå Check Failed',
        'handover_status_error_timeout': 'Connection delayed (Timeout)',
        'handover_status_error_general': 'Error occurred:',
        'btn_close': '‚ùå Close',
        'offer_modal_title': 'üîî Job Handover Offer Received',
        'offer_modal_desc': 'The post owner wants to handover/close this deal with you.',
        'btn_reject': '‚ùå Reject',
        'btn_accept': '‚úÖ Accept',
        'confirm_finish_request': 'Do you want to finish this job and leave?\n(Waiting for confirmation from the other party)',
        'modal_finish_title': 'üèÅ Finish Job Request',
        'modal_finish_desc_prefix': 'User',
        'modal_finish_desc_suffix': 'wants to finish the job.',
        'modal_finish_warning': 'If confirmed, both will be redirected to the home page.',
        'btn_not_yet': '‚ùå Not yet',
        'btn_confirm_finish': '‚úÖ Confirm Finish',
        'notif_wait_finish_confirm': '‚è≥ Request sent. Waiting for confirmation...',
        'SYS_FINISH_REJECTED': '‚ùå The other party denied the finish request.',
        'rating_title': '‚≠ê Rate Satisfaction',
        'rating_desc': 'The job is finished. Please rate the other party to close the deal.',
        'rating_selected': 'Selected Rating:',
        'btn_submit_rating': 'Submit Rating',
        'SYS_RATING_SUCCESS': 'üéâ Rating submitted! You have closed your part.',
        'SYS_RATING_ALREADY': 'üéâ You have already submitted a rating!',
        'SYS_OPPONENT_RATED': 'üîî The other party has rated you! Now it\'s your turn.',
        'confirm_kick': 'Do you want to restart the post room? (All current viewers will be kicked immediately, except Admin)',
        'error_geo_required': '‚õî Location access (GPS) is required to view this post.',
        'error_geo_denied': '‚ùå Location access denied. Cannot view content.',
        'error_geo_unsupported': '‚ùå Your browser does not support geolocation.',
        'checking_location': '‚è≥ Verifying your location...',
        'btn_show_route': 'üó∫Ô∏è Show Navigation Google Map',
		'btn_show_map': 'Show Map',
        'btn_hide_map': 'Hide Map',
    }
};

        function applyLanguage() {
            // ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏≤‡∏Å localStorage ‡∏ó‡∏µ‡πà index.html ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ ‡∏´‡∏£‡∏∑‡∏≠ default ‡πÄ‡∏õ‡πá‡∏ô 'th'
            const lang = localStorage.getItem('preferredLanguage') || 'th';
            const t = postTranslations[lang] || postTranslations['th'];

            // 1. ‡πÅ‡∏õ‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏° (innerHTML) ‡πÇ‡∏î‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤ Icon ‡πÑ‡∏ß‡πâ
            document.querySelectorAll('[data-i18n-key]').forEach(el => {
                const key = el.getAttribute('data-i18n-key');
                if (t[key]) {
                    // ‡πÄ‡∏Å‡πá‡∏ö Icon ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÑ‡∏ß‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    const iconHtml = el.querySelector('i') ? el.querySelector('i').outerHTML : '';
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
                    el.innerHTML = `${iconHtml} ${t[key]}`;
                }
            });

            // 2. ‡πÅ‡∏õ‡∏• Tooltip (title attribute)
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (t[key]) {
                    el.title = t[key];
                }
            });
        }
		
	
	//Chat box
	// --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏õ‡∏∏‡πà‡∏° (Draggable Logic) ---
// --- 1. ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á HTML ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ null ---
let chatBtn, chatWindow, floatingCallBtn; 

// ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ä‡∏ó‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
document.addEventListener('DOMContentLoaded', () => {
    const chatBtn = document.getElementById('floating-chat-btn');
    const chatWindow = document.getElementById('floating-chat-window');

    if (chatBtn) {
        // ‡πÉ‡∏ä‡πâ onclick ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á
        chatBtn.onclick = function() {
            toggleFloatingChat();
        };
    }

    if (chatWindow) {
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏ä‡∏ó‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ä‡∏ó
        const stopProp = (e) => e.stopPropagation();
        chatWindow.addEventListener('mousedown', stopProp);
        chatWindow.addEventListener('touchstart', stopProp, { passive: true });
    }
});


function startDragging(e) {
    if (e.type === 'touchstart') moveCount = 0; 
    const event = e.type === 'touchstart' ? e.touches[0] : e;
    startX = event.clientX;
    startY = event.clientY;
    initialX = chatBtn.offsetLeft;
    initialY = chatBtn.offsetTop;

    document.addEventListener('mousemove', drag);
    document.addEventListener('touchmove', drag, { passive: false });
    document.addEventListener('mouseup', stopDragging);
    document.addEventListener('touchend', stopDragging);
}

function drag(e) {
    moveCount++;
    if (moveCount > 5) isDragging = true;
    const event = e.type === 'touchmove' ? e.touches[0] : e;
    if (e.type === 'touchmove') e.preventDefault();

    let newX = initialX + (event.clientX - startX);
    let newY = initialY + (event.clientY - startY);
    const maxX = window.innerWidth - chatBtn.offsetWidth;
    const maxY = window.innerHeight - chatBtn.offsetHeight;
    
    chatBtn.style.left = Math.min(Math.max(0, newX), maxX) + 'px';
    chatBtn.style.top = Math.min(Math.max(0, newY), maxY) + 'px';
    chatBtn.style.right = 'auto';
    chatBtn.style.bottom = 'auto';
}

function stopDragging(e) {
    document.removeEventListener('mousemove', drag);
    document.removeEventListener('touchmove', drag);
    document.removeEventListener('mouseup', stopDragging);
    document.removeEventListener('touchend', stopDragging);
    
    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ä‡∏ó ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
    if (e.target.closest('#floating-chat-window')) return;

    if (!isDragging || moveCount <= 5) {
        toggleFloatingChat();
    }
    isDragging = false;
    moveCount = 0;
}

function toggleFloatingChat() {
    const windowEl = document.getElementById('floating-chat-window');
    if (!windowEl) return;
    
    windowEl.classList.toggle('hidden');
    
    if (!windowEl.classList.contains('hidden')) {
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ä‡∏ó: ‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô
        document.body.style.overflow = 'hidden';
        
        const msgDiv = document.getElementById('floating-chat-messages');
        if (msgDiv) msgDiv.scrollTop = msgDiv.scrollHeight;
        
        const chatInput = document.getElementById('floating-comment-input');
        if (chatInput) chatInput.focus();
    } else {
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡πÅ‡∏ä‡∏ó: ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥
        document.body.style.overflow = 'auto';
    }
}

function sendFloatingComment() {
    const fInput = document.getElementById('floating-comment-input');
    const mainInput = document.getElementById('comment-input');
    
    const content = fInput.value.trim();
    if (!content) return;

    // ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å
    if (mainInput) {
        mainInput.value = content;
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á (‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏∏ window ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô)
        if (typeof window.sendComment === 'function') {
            window.sendComment();
        }
    }
    fInput.value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ä‡∏ó
}


function sendLocationInChat() {
    if (!navigator.geolocation) {
        alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
        return;
    }

    const input = document.getElementById('floating-comment-input');
    const originalPlaceholder = input.placeholder;

    input.placeholder = "üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS...";
    input.disabled = true; 

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏™‡πà $ ‡∏´‡∏ô‡πâ‡∏≤ {lat} ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ URL ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô Google Maps
            const mapLink = `https://www.google.com/maps?q=${lat},${lng}&share=yes`;
            
            input.value = mapLink; 
            sendFloatingComment(); 

            // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
            input.disabled = false;
            input.placeholder = originalPlaceholder;
        },
        (error) => {
            console.error(error);
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ: " + error.message);
            input.disabled = false;
            input.placeholder = originalPlaceholder;
        },
        { enableHighAccuracy: true, timeout: 5000 }
    );
}

	function formatMessageOnlyMaps(text) {
    if (!text) return "";

    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏µ "‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö" ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÑ‡∏´‡∏° (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤ &)
    if (text.includes("&share=yes")) {
        return `<a href="${text}" target="_blank" style="display: inline-block; background: #ff4757; color: white; padding: 5px 12px; border-radius: 15px; text-decoration: none; font-weight: bold; font-size: 0.85em; margin-top: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <i class="fas fa-map-marker-alt"></i> Share location (Google Maps)
                </a>`;
    }

    // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ó‡∏≤‡∏á‡πÄ‡∏£‡∏≤‡πÅ‡∏ä‡∏£‡πå ‡∏Å‡πá‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
    let safeText = text.replace(/&/g, "&amp;")
                       .replace(/</g, "&lt;")
                       .replace(/>/g, "&gt;")
                       .replace(/"/g, "&quot;")
                       .replace(/'/g, "&#039;");

    return safeText;
}

        
   

    
        
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id'); 
        const myUsername = localStorage.getItem('myUsername');
        const currentLang = localStorage.getItem('preferredLanguage') || 'th';
        
        let currentDestination = null;
        let finishRequester = '';
        let currentPost = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        let currentViewerLocation = null;
		function savePostLocationAsPrimary(location) {
¬† ¬† ¬† ¬† ¬† ¬† if (location && location.lat && location.lng) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const newPrimaryLocation = { 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† lat: location.lat, 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† lng: location.lng, 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† name: location.name || 'My Location'
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏•‡∏á Local Storage
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† localStorage.setItem('userPrimaryLocation', JSON.stringify(newPrimaryLocation));
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† }

        if (!myUsername || !postId) {
            showNotification('No user or thread information found. Please log in again.', 'fas fa-exclamation-triangle', 4000); 
            setTimeout(() => { location.href = '/'; }, 1000);
        }

        socket.on('connect', () => {
            applyLanguage();
            socket.emit('register', myUsername);
            socket.emit('join-post-room', { postId, username: myUsername, lang: currentLang });
            
            
        });

    socket.on('access-granted', ({ post, isAdmin }) => {
    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
    currentPost = post; 
    isProximityRequired = post.requireProximity || false;
    
    // ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    const lang = localStorage.getItem('preferredLanguage') || 'th';
    const t = postTranslations[lang] || postTranslations['th'];

    // --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå ‡∏´‡∏£‡∏∑‡∏≠ Admin (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ GPS) ---
    if (myUsername === post.author || myUsername === 'Admin' || isAdmin) { 
        myCurrentLocation = null;
        document.body.style.display = 'block';
        renderPost(post, isAdmin);
        displayMap(post.location);

        // [NEW] ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (post.jobDeadline && post.status === 'finished') {
            startCountdown(post.jobDeadline);
        }

        // üöÄ [NEW] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏°‡∏≤‡∏î‡∏π ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô Admin)
        updateExtendButtonVisibility(); 

        return; 
    }

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Browser ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏´‡∏°
    if (!navigator.geolocation) {
        showNotification(t['error_geo_unsupported'], 'fas fa-map-marker-slash', 4000);
        setTimeout(() => { location.href = '/'; }, 3000);
        return;
    }

    // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
    showNotification(t['checking_location'], 'fas fa-satellite-dish', 2000);

    // üöÄ ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
    navigator.geolocation.getCurrentPosition(
        (position) => {
            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Success Callback) ---
            const location = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            myCurrentLocation = location; // ‡∏à‡∏≥‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            savePostLocationAsPrimary(myCurrentLocation);
            
            // üéâ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            document.body.style.display = 'block';
            renderPost(post, false);

            // ‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏õ‡πÉ‡∏´‡πâ Server
            socket.emit('update-viewer-location', { 
                postId: postId, 
                username: myUsername, 
                location: location
            });
            
            // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            displayMap(post.location);

            // --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô/‡∏Ñ‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ GPS ‡πÅ‡∏•‡πâ‡∏ß) ---
            if (post.jobDeadline && post.status === 'finished') {
                startCountdown(post.jobDeadline);
            }

            // üöÄ [NEW] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
            updateExtendButtonVisibility();
        }, 
        (error) => {
            // ... (Error handling ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ...
            console.warn('Geolocation blocked:', error.message);
            let msgKey = 'error_geo_required';
            if (error.code === 1) msgKey = 'error_geo_denied';

            document.body.style.display = 'block';
            document.querySelector('.container').style.display = 'none'; 

            showNotification(t[msgKey], 'fas fa-user-lock', 4000);
            setTimeout(() => { location.href = '/'; }, 3500);
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    ); 
});

        socket.on('access-denied', (reason) => {
            // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Å‡πà‡∏≠‡∏ô ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            document.body.style.display = 'block'; 
            showNotification(reason, 'fas fa-exclamation-triangle', 2000);
            setTimeout(() => { location.href = '/'; }, 2000); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡∏ô
        });

        socket.on('force-leave', (reason) => {
            // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô
            document.body.style.display = 'block';
            showNotification(reason, 'fas fa-door-open', 2000);
            setTimeout(() => { location.href = '/'; }, 2000); 
        });

        socket.on('restart-success', (msg) => {
            showNotification(msg, 'fas fa-redo');
        });
        
        let currentRating = 0;

        // 1. ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å Server
        socket.on('start-rating-phase', () => {
            document.getElementById('finish-job-modal').classList.add('hidden');
            document.getElementById('rating-modal').classList.remove('hidden');
        });

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏≤‡∏ß
        window.setRating = function(score) {
            currentRating = score;
            document.getElementById('selected-rating').innerText = score;
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Client)
        window.submitRating = function() {
            if (currentRating === 0) {
                showNotification('Please select Rating...', 'fas fa-exclamation-circle', 2000);
                return;
            }
            const comment = "";
            
            // üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Server ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            socket.emit('submit-rating', {
                postId,
                rater: myUsername,
                rating: currentRating,
                comment: comment
            });
            
            document.getElementById('rating-modal').classList.add('hidden');
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏¢‡∏≤‡∏¢
window.openImageViewer = function(src) {
    const modal = document.getElementById('image-viewer-modal');
    const img = document.getElementById('full-image');
    img.src = src;
    modal.classList.remove('hidden');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
window.closeImageViewer = function() {
    document.getElementById('image-viewer-modal').classList.add('hidden');
}

window.openGoogleMapsApp = function() {
    if (!currentDestination) {
        showNotification('Destination coordinates not found.', 'fas fa-exclamation-triangle');
        return;
    }

    const destLat = currentDestination.lat;
    const destLng = currentDestination.lng;
    
    let googleMapsUrl = "";

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÑ‡∏´‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å "‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" ‡πÑ‡∏õ "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢"
    if (myCurrentLocation && myCurrentLocation.lat) {
        const originLat = myCurrentLocation.lat;
        const originLng = myCurrentLocation.lng;
        // URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á (Direction) ‡∏à‡∏≤‡∏Å A ‡πÑ‡∏õ B
        googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${originLat},${originLng}&destination=${destLat},${destLng}&travelmode=driving`;
    } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏°‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÄ‡∏â‡∏¢‡πÜ
        googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${destLat},${destLng}`;
    }

    // ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î URL
    // ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡∏à‡∏∞‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ Google Maps ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ)
    // ‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏°: ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Tab ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö Google Maps
    window.open(googleMapsUrl, '_blank');
    
    showNotification('Opening Google Maps...', 'fas fa-external-link-alt', 3000);
}


        // 4. ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á "‡∏£‡∏≠‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢" (‡∏•‡∏ö Logic ‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ)
        socket.on('rating-waiting', (msg) => {
            showNotification('‚úÖ Rating successfully recorded.', 'fas fa-check-circle', 3000);
        });
        
        // --- CORE LOGIC (unchanged for brevity) ---

    function displayMap(location) {
    const mapContainer = document.getElementById('map-container');
    const mapIframe = document.getElementById('post-map-iframe');
    const navButton = document.getElementById('start-nav-btn');
    const mapTitle = document.getElementById('map-title');
    
    if (!mapIframe || !location) return;

    const lat = location.lat;
    const lng = location.lng;
    currentDestination = { lat, lng };
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
    const isAcceptedViewer = currentPost && myUsername === currentPost.acceptedViewer;
    const isOwner = myUsername === currentPostAuthor;

    let initialMapUrl = '';
    let viewerText = '';

    // ‚úÖ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏≤ + ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á + (‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏î‡∏π‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á)
    if (myCurrentLocation && !isOwner) {
        
        const myLat = myCurrentLocation.lat;
        const myLng = myCurrentLocation.lng;
        const distanceKm = getDistanceFromLatLonInKm(myLat, myLng, lat, lng).toFixed(2);
        
        // üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ ${ } ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        // ‡πÉ‡∏ä‡πâ URL ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á (Embed)
        initialMapUrl = `https://www.google.com/maps?saddr=${myLat},${myLng}&daddr=${lat},${lng}&output=embed`;
        
        viewerText = `<br><div style="color:#28a745; font-size:0.9em; margin-top:5px;">üìè Distance: ${distanceKm} km.</div>`;
        
        if (navButton) navButton.style.display = 'block';

    } else {
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏≤: ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà‡∏´‡∏°‡∏∏‡∏î‡∏õ‡∏±‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥
        initialMapUrl = `https://www.google.com/maps?q=${lat},${lng}&z=15&output=embed`;
        
        if (navButton) navButton.style.display = 'none';
    }

    mapIframe.src = initialMapUrl;
    if (mapTitle) mapTitle.innerHTML = ` ${viewerText}`;
}

	// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Show/Hide ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
	function toggleMap() {
    const content = document.getElementById('map-content-wrapper');
    const btn = document.getElementById('toggle-map-btn');
    const isHidden = content.style.display === 'none';

    // ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const lang = localStorage.getItem('preferredLanguage') || 'th';
    const t = postTranslations[lang] || postTranslations['th'];

    if (isHidden) {
        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        content.style.display = 'block';
        // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏• '‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà' ‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
        btn.innerHTML = `<i class="fas fa-chevron-up"></i> ${t['btn_hide_map']}`; 
        btn.style.background = '#dbeafe'; 
        btn.style.color = '#007bff';
    } else {
        // ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        content.style.display = 'none';
        // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏• '‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà' ‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏•‡∏á
        btn.innerHTML = `<i class="fas fa-chevron-down"></i> ${t['btn_show_map']}`;
        btn.style.background = '#e4e6eb'; 
        btn.style.color = '#333';
    }
}
        
        function displayMapWithViewer(postLocation, viewerLocation) {
    const mapContainer = document.getElementById('map-container');
    const mapIframe = document.getElementById('post-map-iframe');
    const navButton = document.getElementById('start-nav-btn'); 
    const mapTitle = document.getElementById('map-title'); 
    
    if (!postLocation || !postLocation.lat || !postLocation.lng) {
        mapContainer.style.display = 'none'; 
        return;
    }

    // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏∏‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ (‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å)
    const p_lat = postLocation.lat; 
    const p_lng = postLocation.lng;
    
    let mapUrl = '';
    let viewerText = '';
    
    const isOwnerOrAdmin = myUsername === currentPost.author || myUsername === 'Admin';

    if (viewerLocation && viewerLocation.lat && isOwnerOrAdmin) {
        const v_lat = viewerLocation.lat;
        const v_lng = viewerLocation.lng;
        
        // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á
        const distanceKm = getDistanceFromLatLonInKm(p_lat, p_lng, v_lat, v_lng).toFixed(2);
        
        // 2. ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á: saddr = ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡∏î‡∏π‡∏¢‡∏∑‡∏ô‡∏≠‡∏¢‡∏π‡πà, daddr = ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ
        // ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ maps.google.com/maps ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏ô Embed
        mapUrl = `https://maps.google.com/maps?saddr=${v_lat},${v_lng}&daddr=${p_lat},${p_lng}&output=embed&t=m&z=14`;
        
        viewerText = `<br>
                      <div style="background:#e9f7ef; padding:10px; border-radius:8px; margin-top:10px; border:1px solid #28a745; font-size: 0.9rem;">
                          <span style="color:#d63384; font-weight:bold; font-size:1.1em;">
                              üìè Distance: ${distanceKm} Km.
                          </span>
                      </div>`;
    } else {
        // 3. ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ô‡∏î‡∏π ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà‡∏à‡∏∏‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        mapUrl = `https://maps.google.com/maps?q=${p_lat},${p_lng}&z=15&output=embed&t=m`;
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Iframe
    mapIframe.src = mapUrl;
    
    if (mapTitle) mapTitle.innerHTML = `üìç Post Location${viewerText}`;
    mapContainer.style.display = 'block'; 
    navButton.style.display = 'none';
}

    window.startEmbeddedNavigation = function() {
    if (!currentDestination) {
        showNotification('Destination coordinates not found.', 'fas fa-exclamation-triangle');
        return;
    }

    const destLat = currentDestination.lat;
    const destLng = currentDestination.lng;
    const mapIframe = document.getElementById('post-map-iframe');

    let mapDirectionsUrl = '';

    if (typeof myCurrentLocation !== 'undefined' && myCurrentLocation) {
        const myLat = myCurrentLocation.lat;
        const myLng = myCurrentLocation.lng;
        // ‚úÖ URL ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
        mapDirectionsUrl = `https://maps.google.com/maps?saddr=${myLat},${myLng}&daddr=${destLat},${destLng}&z=14&output=embed&hl=en`;
    } else {
        // ‚úÖ URL ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
        mapDirectionsUrl = `https://maps.google.com/maps?q=${destLat},${destLng}&z=14&output=embed&hl=en`;
    }

    mapIframe.src = mapDirectionsUrl;
    showNotification('‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á...', 'fas fa-route', 4000);
}

	socket.on('viewer-location-update', (data) => {
    if (!currentPost) return;

    // 1. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (Viewer) ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ
    if (myUsername === currentPost.acceptedViewer && data.viewer === currentPost.author) {
        ownerLastLocation = data.location; // ‡πÄ‡∏Å‡πá‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞ 10‡∏°.
    }

    // 2. ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ)
    const isOwnerOrAdmin = myUsername === currentPost.author || myUsername === 'Admin';
    if (isOwnerOrAdmin && data.viewer !== myUsername) {
         currentViewerLocation = data.location;
         if (typeof displayMapWithViewer === 'function') {
             displayMapWithViewer(currentPost.location, currentViewerLocation); 
         }
    }
});

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Viewer ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö Pin)
socket.on('viewer-left-location', (data) => {
    if (myUsername === currentPost.author || myUsername === 'Admin') {
         if (data.viewer === (currentPost.acceptedViewer || '')) { // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ Viewer ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏ô‡πÉ‡∏à
             currentViewerLocation = null;
             displayMapWithViewer(currentPost.location, currentViewerLocation); 
             showNotification(`${data.viewer} Walk Out`, 'fas fa-map-marker-alt', 3000);
         }
    }
});

        function createCommentHTML(c, index) {
            const isOdd = index % 2 !== 0;
            let commentImageHtml = c.imageUrl 
                ? `<div style="margin-top: 10px; margin-bottom:5px;">
        <img src="${c.imageUrl}" 
             onclick="openImageViewer('${c.imageUrl}')"
             style="max-width: 200px; max-height: 200px; border-radius: 5px; border: 1px solid #ddd; cursor: pointer;">
       </div>`
    : '';

            return `<div class="comment-box ${isOdd ? 'odd' : ''}">
                <div class="comment-author"><i class="fas fa-user"></i> ${c.author}</div>
                <div class="comment-content">${c.content}</div>
                ${commentImageHtml} <div class="comment-time">${new Date(c.timestamp).toLocaleString()}</div>
            </div>`;
        }

        function renderPost(post, isAdmin = false) {
    // --- 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ ---
    const oldStats = document.getElementById('author-stats-container');
    if (oldStats) oldStats.remove();

    const total = post.authorTotalPosts || 0;
    const completed = post.authorCompletedJobs || 0;
    const authorStats = `
        <div id="author-stats-container" style="font-size: 0.85em; color: #666; margin-top: 5px;">
            üìù Post: ${total} | ‚úÖ Job: ${completed}
        </div>
    `;

    const authorEl = document.getElementById('post-author');
    if (authorEl) {
        authorEl.innerText = post.author;
        authorEl.insertAdjacentHTML('afterend', authorStats);
    }

    // --- 2. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ---
    document.getElementById('post-title').innerText = post.title;
    document.getElementById('post-time').innerText = new Date(post.id).toLocaleString();
    
    const ratingDisplay = document.getElementById('post-author-rating');
    const displayRating = post.authorRating || '0.00'; 
    ratingDisplay.innerHTML = ` (‚≠ê ${displayRating} / 5.0)`;

    // --- 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Element ‡∏´‡∏•‡∏±‡∏Å ---
    const contentDiv = document.getElementById('post-content');
    const imageContainer = document.getElementById('post-image-container');
    const mapContainer = document.getElementById('map-container');
    const list = document.getElementById('comments-list');
    const commentForm = document.getElementById('comment-form');
    const closedMsg = document.getElementById('closed-msg');
    
    const backBtn = document.getElementById('back-btn');
    const finishBtn = document.getElementById('final-finish-btn');
    const restartBtn = document.getElementById('restart-btn');
    const handoverBtn = document.getElementById('handover-btn');
    const manualCloseBtn = document.getElementById('manual-close-btn');
    const shareBtn = document.getElementById('share-map-btn');
    const callBtn = document.getElementById('btn-call-author');

    // üü¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á Element ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏ó‡∏•‡∏≠‡∏¢‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    const floatingInputArea = document.getElementById('floating-chat-input-area');

    // Reset ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
    contentDiv.style.display = 'block';
    imageContainer.style.display = 'block'; 
    list.style.display = 'block';
    commentForm.style.display = 'flex';
    closedMsg.style.display = 'none';
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global
    currentPostAuthor = post.author; 
    const isOwner = myUsername === post.author;
    const isOwnerOrAdmin = isOwner || isAdmin;
    const isAcceptedViewer = myUsername === post.acceptedViewer; 
    const isParticipant = isOwner || isAcceptedViewer || isAdmin;

    // --- 4. Logic ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ---
    // ‡∏ñ‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏à‡∏ö (Handover) ‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (AcceptedViewer) ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢
    if (isOwnerOrAdmin || isAcceptedViewer) {
        mapContainer.style.display = 'block';
        if (shareBtn) shareBtn.style.display = isOwnerOrAdmin ? 'inline-block' : 'none';
    } else {
        mapContainer.style.display = 'none';
        if (shareBtn) shareBtn.style.display = 'none';
    }

    if (post.location) {
        displayMap(post.location);
    }

    // --- 5. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ---
    contentDiv.innerText = post.content;
    if (post.imageUrl) {
        imageContainer.innerHTML = `
            <div style="text-align:center; margin-bottom: 20px;">
                <img src="${post.imageUrl}" 
                     onclick="openImageViewer('${post.imageUrl}')"
                     style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: pointer;">
            </div>`;
    } else {
        imageContainer.innerHTML = '';
        imageContainer.style.display = 'none';
    }

    // --- 6. ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô ---
    list.innerHTML = post.comments.map((c, index) => createCommentHTML(c, index)).join('');
    
    const oldAlert = document.getElementById('status-alert');
    if (oldAlert) oldAlert.remove();

    // --- 7. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ó‡∏£ ---
    const canCall = !isOwner && post.status !== 'closed_permanently' && 
                    (post.status !== 'finished' || isAcceptedViewer || isAdmin);

    if (floatingCallBtn) {
        floatingCallBtn.style.display = canCall ? 'flex' : 'none';
    }
    if (callBtn) {
        callBtn.style.display = canCall ? 'inline-flex' : 'none';
    }

    // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Action ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
    [finishBtn, restartBtn, handoverBtn, manualCloseBtn].forEach(btn => { if(btn) btn.style.display = 'none'; });

    // --- 8. LOGIC ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î (Pinned) ---
    if (post.isPinned) {
        if (post.isClosed) {
            commentForm.style.display = 'none';
            closedMsg.style.display = 'block';
            closedMsg.innerHTML = '<i class="fas fa-lock"></i> ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß';
        } else if (isAdmin) {
            manualCloseBtn.style.display = 'block';
        }
        backBtn.style.display = 'block';
        return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î
    }

    // --- 9. LOGIC ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏õ‡∏Å‡∏ï‡∏¥ ---
    commentForm.style.display = 'flex';
    if (floatingInputArea) floatingInputArea.style.display = 'flex';
    closedMsg.style.display = 'none';

    if (post.status === 'closed_permanently') {
        // ‚ùå ‡∏õ‡∏¥‡∏î‡∏ñ‡∏≤‡∏ß‡∏£: ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏ä‡∏ó
        commentForm.style.display = 'none';
        if (floatingInputArea) floatingInputArea.style.display = 'none';
        closedMsg.style.display = 'block';
        closedMsg.innerHTML = '<i class="fas fa-lock"></i> ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏ñ‡∏≤‡∏ß‡∏£‡πÅ‡∏•‡πâ‡∏ß';
        
    } else if (post.status === 'finished') {
        // ü§ù ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏ñ‡∏≤‡∏ß‡∏£)
        if (!isParticipant) {
            // ‡∏Ñ‡∏ô‡∏ô‡∏≠‡∏Å: ‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß/‡∏´‡∏£‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
            commentForm.style.display = 'none';
            if (floatingInputArea) floatingInputArea.style.display = 'none';
            closedMsg.style.display = 'block';
            closedMsg.innerHTML = '<div style="background:#fff3cd; padding:10px;"><h2>‚õî ‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡πÅ‡∏•‡πâ‡∏ß</h2><p>‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ</p></div>';
        } else {
            // ‡∏Ñ‡∏π‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤: ‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥ + ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏ö‡∏á‡∏≤‡∏ô
            if (finishBtn) finishBtn.style.display = 'block';
            
            const statusAlert = document.getElementById('status-alert') || document.createElement('div');
            statusAlert.id = 'status-alert';
            statusAlert.innerHTML = `
                <div style="background:#d1ecf1; color:#0c5460; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #bee5eb; text-align:center; font-size:0.9em;">
                    <strong>ü§ù ‡∏ä‡πà‡∏ß‡∏á‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô:</strong> ‡πÅ‡∏ä‡∏ó‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏ö‡∏á‡∏≤‡∏ô
                </div>`;
            if (!document.getElementById('status-alert')) list.parentNode.insertBefore(statusAlert, list);
        }
    } else if (post.isClosed) {
        // ‚ö†Ô∏è ‡∏õ‡∏¥‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß/‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏≤‡∏ß‡∏£)
        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ "‡∏õ‡∏Å‡∏ï‡∏¥" ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏ã‡πà‡∏≠‡∏ô commentForm ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        if (isOwnerOrAdmin) {
            if (restartBtn) restartBtn.style.display = 'block';
        }
    } else {
        // ‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
        if (isOwnerOrAdmin) {
            if (restartBtn) restartBtn.style.display = 'block';
            if (handoverBtn) handoverBtn.style.display = 'block';
            if (manualCloseBtn) manualCloseBtn.style.display = 'block';
        }
    }
	
}
		
		
		// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï"
function shareMapToViewers() {
    if (confirm("Do you want to grant visitors access to the map now?")) {
        // ‡∏™‡πà‡∏á Event ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Server (‡πÉ‡∏ä‡πâ postId ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡πâ‡∏≠‡∏á)
        socket.emit('share-map-access', { postId: postId });
        showNotification("Access to the map has been enabled.", "fas fa-check-circle");
    }
}

// 2. ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°)
socket.on('map-access-granted', (data) => {
    const isOwner = myUsername === currentPostAuthor;
    
    if (!isOwner) {
        const mapContainer = document.getElementById('map-container');
        if (mapContainer) {
            // 1. ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            mapContainer.style.display = 'block';
            
            // 2. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ myCurrentLocation ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á)
            if (currentPost && currentPost.location) {
                displayMap(currentPost.location);
            }
            
            showNotification("The host has given you permission to view the map.", "fas fa-map-marked-alt", 5000);
        }
    }
});
        
        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á ---
        async function manualClosePost() {
    const lang = localStorage.getItem('preferredLanguage') || 'th';
    const t = postTranslations[lang] || postTranslations['th'];
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î
    if (confirm(t['confirm_close_post'])) { 
        try {
            const res = await fetch(`/api/posts/${postId}/close`, { // ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà /close
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ requestBy: myUsername })
});

            const data = await res.json();

            if (data.success) {
                document.getElementById('manual-close-btn').disabled = true;
                alert(t['alert_post_closed']);
                // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                location.reload(); 
            } else {
                alert(`‚ùå Error: ${data.error || '‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'}`);
            }
        } catch (e) {
            console.error(e);
            alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
        }
    }
}
        
        function restartPost() { 
    // 1. ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏©‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const lang = localStorage.getItem('preferredLanguage') || 'th';
    const t = postTranslations[lang] || postTranslations['th'];

    // 2. ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ translation
    if(confirm(t['confirm_kick'])) {
        socket.emit('restart-post-room', postId);
    }
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÉ‡∏ä‡πâ Canvas)
function compressImage(file, quality = 0.7, maxWidth = 1200) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô maxWidth ‡πÉ‡∏´‡πâ‡∏¢‡πà‡∏≠‡∏•‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô)
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                    height = Math.round((height * maxWidth) / width);
                    width = maxWidth;
                }

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå Blob (‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó JPEG)
                canvas.toBlob((blob) => {
                    // ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô Blob ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ (‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏Ñ‡πà‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏õ‡πá‡∏ô .jpg)
                    const newFile = new File([blob], file.name.replace(/\.[^/.]+$/, "") + ".jpg", {
                        type: "image/jpeg",
                        lastModified: Date.now(),
                    });
                    resolve(newFile);
                }, 'image/jpeg', quality); // quality: 0.7 ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 70%
            };
        };
    });
}



// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
function compressImage(file, quality = 0.7, maxWidth = 1024) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                let width = img.width;
                let height = img.height;
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà
                if (width > maxWidth) {
                    height = Math.round((height * maxWidth) / width);
                    width = maxWidth;
                }
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå (‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö .jpg)
                canvas.toBlob((blob) => {
                    if (!blob) {
                        reject(new Error('Canvas is empty'));
                        return;
                    }
                    const newFile = new File([blob], file.name, {
                        type: "image/jpeg",
                        lastModified: Date.now(),
                    });
                    resolve(newFile);
                }, 'image/jpeg', quality);
            };
            img.onerror = (err) => reject(err);
        };
        reader.onerror = (err) => reject(err);
    });
}




    async function sendComment() { 
    // 1. ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡∏¥‡∏î Cooldown ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const sendBtn = document.getElementById('send-comment-btn');
    if (sendBtn && sendBtn.disabled) return; 

    const contentInput = document.getElementById('comment-input');
    const content = contentInput.value.trim();
    const fileInput = document.getElementById('comment-image');
    const imageFile = fileInput.files[0];

    // Check ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤
    if(!content && !imageFile) {
        showNotification("Please enter text or select an image.", 'fas fa-exclamation-circle', 2000);
        return;
    }
    
    // 2. ‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
    if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.style.opacity = '0.5'; // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏à‡∏≤‡∏á‡∏•‡∏á
        sendBtn.style.cursor = 'not-allowed';
    }
    contentInput.disabled = true;
    if(fileInput) fileInput.disabled = true;

    const formData = new FormData();
    formData.append('content', content);
    formData.append('author', myUsername);

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ---
    if (imageFile) {
        if (imageFile.type.startsWith('image/')) {
            try {
                const compressedFile = await compressImage(imageFile, 0.7, 1024);
                formData.append('image', compressedFile);
            } catch (error) {
                console.error("Compression failed, sending original file:", error);
                formData.append('image', imageFile);
            }
        } else {
            formData.append('image', imageFile);
        }
    }

    try {
        // ‡∏¢‡∏¥‡∏á API
        const res = await fetch(`/api/posts/${postId}/comments`, { 
            method: 'POST',
            body: formData 
        });
        
        // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
        contentInput.disabled = false;
        if(fileInput) fileInput.disabled = false;

        if (res.status === 200) {
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
            contentInput.value = '';
            fileInput.value = '';
            const fileNameDisplay = document.getElementById('file-name-display');
            if(fileNameDisplay) {
                fileNameDisplay.innerText = '';
                fileNameDisplay.style.display = 'none';
            }
        } else {
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error
            try {
                const d = await res.json();
                showNotification(d.error, 'fas fa-times-circle', 4000); 
                if (d.error && (d.error.includes('‡∏õ‡∏¥‡∏î') || d.error.includes('TimeUp') || 
                    d.error.includes('closed') || d.error.includes('finished'))) {
                    location.reload();
                }
            } catch (e) {
                showNotification(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${res.status}`, 'fas fa-times-circle', 5000); 
            }
        }
    } catch (error) {
        console.error("Fetch error:", error);
        contentInput.disabled = false;
        if(fileInput) fileInput.disabled = false;
    } finally {
        // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÑ‡∏î‡πâ‡πÉ‡∏´‡∏°‡πà
        setTimeout(() => {
            if (sendBtn) {
                sendBtn.disabled = false;
                sendBtn.style.opacity = '1';
                sendBtn.style.cursor = 'pointer';
            }
        }, 5000); // 5000 ‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ = 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    }
}
        
        async function openHandoverModal() {
            document.getElementById('handover-modal').classList.remove('hidden');

            const titleEl = document.getElementById('handover-title');
            const messageEl = document.getElementById('handover-message'); 
            const viewerContainer = document.getElementById('handover-viewer-container'); 
            const viewerEl = document.getElementById('target-viewer-display'); 
            const actionsEl = document.getElementById('handover-actions');

            // --- 1. ‡∏î‡∏∂‡∏á‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏• ---
            const lang = localStorage.getItem('preferredLanguage') || 'th';
            const t = postTranslations[lang] || postTranslations['th'];
            // ------------------------

            // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•)
            titleEl.innerText = t['handover_status_loading_title'];
            messageEl.innerText = t['handover_status_loading_msg'];
            messageEl.style.color = '#6c757d'; 
            messageEl.classList.remove('hidden');

            viewerContainer.classList.add('hidden'); 
            viewerEl.innerText = '...'; 
            actionsEl.classList.add('hidden'); 

            try {
                const controller = new AbortController();
                const signal = controller.signal;
                const timeoutId = setTimeout(() => controller.abort(), 5000); 
                
                const fetchPromise = fetch(`/api/posts/${postId}/viewer-status?requestBy=${myUsername}`, { signal });
                
                const res = await fetchPromise;
                clearTimeout(timeoutId); 

                if (res.status !== 200) {
                    const errorData = await res.json().catch(() => ({ error: 'Unknown Server Error' }));
                    throw new Error(errorData.error || `HTTP error! status: ${res.status}`);
                }
                
                const data = await res.json();
                
                if (data.error) {
                    // ‚ùå ‡∏Å‡∏£‡∏ì‡∏µ Error ‡∏à‡∏≤‡∏Å Server
                    titleEl.innerText = t['handover_status_error_title'];
                    messageEl.innerText = data.error;
                    messageEl.style.color = '#dc3545';
                } else if (data.isOccupied) {
                    // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏ö Viewer
                    const ratingShow = data.rating !== undefined 
                        ? parseFloat(data.rating).toFixed(2) 
                        : '0.00'; 
						const totalPosts = data.totalPosts || 0;
						const completedJobs = data.completedJobs || 0;

                    titleEl.innerText = t['handover_status_found_title'];
                    
                    messageEl.innerHTML = `<span style="color:#28a745"><i class="fas fa-check-circle"></i> ${t['handover_status_found_msg']}</span>`;
                    
                    viewerEl.innerHTML = `
    <div>${data.viewer} <span style="color:#ffc107; margin-left:5px;">‚≠ê ${ratingShow}</span></div>
    <div style="font-size: 0.75em; color: #666; margin-top: 5px; font-weight: normal;">
        <i class="fas fa-edit"></i> : ${totalPosts} | 
        <i class="fas fa-check-double"></i> : ${completedJobs}
    </div>
`;

viewerContainer.classList.remove('hidden'); 
actionsEl.classList.remove('hidden');
                    
                } else {
                    // ‚ö†Ô∏è ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏ö Viewer
                    titleEl.innerText = t['handover_status_not_found_title'];
                    messageEl.innerText = t['handover_status_not_found_msg'];
                    messageEl.style.color = '#e0a800'; 
                    viewerContainer.classList.add('hidden');
                }

            } catch (e) {
                // ‚ùå ‡∏Å‡∏£‡∏ì‡∏µ Network Error / Timeout
                showNotification('‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ', 'fas fa-exclamation-triangle', 5000);

                titleEl.innerText = t['handover_status_error_title'];
                messageEl.innerText = (e.name === 'AbortError') 
                    ? t['handover_status_error_timeout'] 
                    : `${t['handover_status_error_general']} ${e.message}`; // ‡πÉ‡∏ä‡πâ Key + e.message
                messageEl.style.color = '#dc3545';
            }
        }
        
	// [‡πÉ‡∏ô post.html]
	function closeDealWithViewer() {
    const viewerElement = document.getElementById('target-viewer-display');
    if (!viewerElement) return;

    let viewer = viewerElement.textContent.trim().split('‚≠ê')[0].trim();
    if (!viewer || viewer === '...' || viewer === '') return;

    // 1. ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Checkbox ‡πÄ‡∏î‡∏¥‡∏°
    const requireProximity = document.getElementById('chk-require-proximity').checked;
    
    // 2. [NEW] ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≤‡∏Å selectTimeLimit ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
    const timeLimitSelect = document.getElementById('selectTimeLimit');
    const timeLimitVal = timeLimitSelect ? timeLimitSelect.value : 0;

    socket.emit('offer-deal', { 
        postId, 
        targetViewer: viewer,
        requireProximity: requireProximity,
        timeLimit: timeLimitVal // [NEW] ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤ (‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    });

    document.getElementById('handover-modal').classList.add('hidden');
    showNotification(`üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡πâ ${viewer} ‡πÅ‡∏•‡πâ‡∏ß`, 'fas fa-hourglass-half');
}

        // --- SOCKET LISTENERS ---

    socket.on('receive-offer', (data) => {
    if (data.postId == postId) {
        // 1. ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÑ‡∏ß‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö)
        window.pendingOfferProximity = data.requireProximity;
        window.pendingTimeLimit = data.timeLimit; // [NEW] ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ß‡πâ

        // 2. [NEW] ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô Modal
        const timeDisplay = document.getElementById('display-time-limit'); // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ID ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô HTML
        if (timeDisplay) {
            let timeText = "No Limit";
            if (data.timeLimit && data.timeLimit > 0) {
                const mins = parseInt(data.timeLimit) / 60000;
                timeText = mins >= 60 ? (mins / 60) + " H" : mins + " m";
            }
            timeDisplay.innerText = timeText;
        }
        
        // 3. ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡πÄ‡∏î‡∏¥‡∏°)
        const conditionMsg = document.getElementById('offer-condition-msg');
        if (data.requireProximity) {
            conditionMsg.style.display = 'block';
        } else {
            conditionMsg.style.display = 'none';
        }
        
        // 4. ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Accept/Reject
        document.getElementById('offer-modal').classList.remove('hidden');
    }
});

    function replyOffer(accepted) {
    const ownerName = document.getElementById('post-author').innerText;
    
    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤ (Logic: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Select ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤‡∏°‡∏≤, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ù‡∏≤‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global)
    let timeLimitVal = 0;
    const timeLimitSelect = document.getElementById('selectTimeLimit');

    if (timeLimitSelect && timeLimitSelect.offsetParent !== null) { 
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Element ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞ "‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏¢‡∏π‡πà" (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô)
        timeLimitVal = parseInt(timeLimitSelect.value);
    } else if (typeof window.pendingTimeLimit !== 'undefined') {
        // ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô receive-offer
        timeLimitVal = parseInt(window.pendingTimeLimit);
    }

    console.log("‚è±Ô∏è Sending timeLimit:", timeLimitVal); // Debug ‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á

    socket.emit('reply-offer', { 
        postId, 
        accepted, 
        viewer: myUsername, 
        owner: ownerName,
        requireProximity: window.pendingOfferProximity || false, 
        timeLimit: timeLimitVal // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Int ‡πÅ‡∏•‡πâ‡∏ß
    });
    
    // ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î Modal ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const offerModal = document.getElementById('offer-modal');
    const handoverModal = document.getElementById('handover-modal');
    if (offerModal) offerModal.classList.add('hidden');
    if (handoverModal) handoverModal.classList.add('hidden');
}


	socket.on('deal-result', (data) => {
    const lang = localStorage.getItem('preferredLanguage') || 'th';
    const t = postTranslations[lang] || postTranslations['th'];
    let message = '';
    let icon = '';
    
    const viewerName = data.viewer || data.targetViewer || t['generic_viewer_name'];

    if (data.success) {
        message = t['notif_deal_accepted'].replace('[VIEWER]', viewerName);
        icon = 'fas fa-check-circle';
        
        // [NEW] ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        if (data.jobDeadline) {
            startCountdown(data.jobDeadline);

            // üöÄ [NEW] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß
            if (typeof currentPost !== 'undefined') {
                currentPost.status = 'finished';
                currentPost.acceptedViewer = viewerName; // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
            }

            // üöÄ [NEW] ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÄ‡∏•‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î)
            updateExtendButtonVisibility();
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
        showNotification(message, icon, 3000);
        setTimeout(() => {
            location.reload(); 
        }, 1500);

    } else {
        message = t['notif_deal_rejected'].replace('[VIEWER]', viewerName);
        icon = 'fas fa-times-circle';
        showNotification(message, icon, 4000);
    }
});
		
		// 5. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á (‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å Server)
	socket.on('update-owner-location', (coords) => {
    ownerLastLocation = coords; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å
});


	function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    const R = 6371; // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÇ‡∏•‡∏Å (‡∏Å‡∏°.)
    const dLat = (lat2 - lat1) * (Math.PI / 180);
    const dLon = (lon2 - lon1) * (Math.PI / 180);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£
}


	// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
	function startCountdown(deadline) {
    const timerBar = document.getElementById('countdown-bar'); 
    const timerText = document.getElementById('timer-text');
    
    // ‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏≤‡∏£‡πå‡πÄ‡∏ß‡∏•‡∏≤
    if (timerBar) timerBar.style.display = 'block';

    // üõë 1. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Interval ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
    if (countdownInterval) clearInterval(countdownInterval);

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ã‡πâ‡∏≥‡πÜ)
    const updateDisplay = () => {
        const now = Date.now();
        const diff = deadline - now;

        // ‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤
        if (diff <= 0) {
            clearInterval(countdownInterval);
            if(timerText) {
                timerText.innerText = "00:00"; // ‡∏´‡∏£‡∏∑‡∏≠ "TimeUp"
                timerText.style.color = "#e74c3c"; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏ï‡∏≠‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤
            }
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            return;
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡∏ä‡∏°:‡∏ô‡∏≤‡∏ó‡∏µ:‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((diff % (1000 * 60)) / 1000);

        // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏î‡πâ‡∏ß‡∏¢)
        const timeString = 
            (h > 0 ? h + ":" : "") + 
            (m < 10 ? "0" + m : m) + ":" + 
            (s < 10 ? "0" + s : s);

        if(timerText) {
            timerText.innerText = timeString;

            // (‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°) ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 5 ‡∏ô‡∏≤‡∏ó‡∏µ
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (h==0) ‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏ó‡∏µ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 5
            if(h === 0 && m < 5) {
                timerText.style.color = "#e74c3c"; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                // timerText.classList.add('blink'); // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö ‡πÉ‡∏™‡πà class css ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ
            } else {
                timerText.style.color = "#f1c40f"; // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ó‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
            }
        }
    };

    // üöÄ 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ! ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏Ç‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πä‡∏ö (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå 1 ‡∏ß‡∏¥)
    updateDisplay();

    // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    countdownInterval = setInterval(updateDisplay, 1000);
}


function updateExtendButtonVisibility() {
    const btn = document.getElementById('btn-extend-time');
    
    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
    if (!btn || typeof currentPost === 'undefined' || !currentPost) return;

    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô AND ‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ finished
    const isWorker = (myUsername === currentPost.acceptedViewer);
    const isJobRunning = (currentPost.status === 'finished');

    if (isWorker && isJobRunning) {
        btn.style.display = 'flex'; 
    } else {
        btn.style.display = 'none';
    }
}





	// ‡∏£‡∏±‡∏ö Event ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (Server ‡∏™‡∏±‡πà‡∏á‡∏ï‡∏±‡∏î‡∏à‡∏ö)
	socket.on('force-close-job', (data) => {

    // 1. ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
    if (typeof countdownInterval !== 'undefined') {
        clearInterval(countdownInterval);
    }

    // 2. ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô	
    const finishBtn = document.getElementById('final-finish-btn');
    if(finishBtn) {
        finishBtn.style.display = 'none';
    }
    
    // 3. ‡∏ã‡πà‡∏≠‡∏ô Modal ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á
    const modalIds = ['handover-modal', 'offer-modal', 'call-modal'];
    modalIds.forEach(id => {
        const el = document.getElementById(id);
        if(el) {
            el.classList.add('hidden');
			location.reload();
        }
    });

    // 4. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö
    
    Swal.fire({
        icon: 'error',
        title: 'TimeUp!',
        text: data.message || '‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
        allowOutsideClick: false,
        allowEscapeKey: false,
        confirmButtonText: '‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å',
        confirmButtonColor: '#d33'
    }).then((result) => {
        if (result.isConfirmed) {
            // ‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà window.location.href ‡∏Å‡πá‡∏û‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà reload() ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
            window.location.href = '/';
        }
    });
});


        // --- FINISH JOB ---

//***
    function requestFinishJob() {
    const needsCheck = isProximityRequired || (currentPost && currentPost.requireProximity);

    if (needsCheck) {
        showNotification('üõ∞Ô∏è Checking GPS....', 'fas fa-satellite-dish', 2000);

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const freshLat = position.coords.latitude;
                const freshLng = position.coords.longitude;
                myCurrentLocation = { lat: freshLat, lng: freshLng };

                const isOwner = (myUsername === currentPost.author);

                // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏´‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô
                socket.emit('update-live-location', {
                    postId: postId,
                    coords: myCurrentLocation,
                    role: isOwner ? 'owner' : 'worker'
                });

                if (isOwner) {
                    // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ" ---
                    // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á "‡∏Ñ‡∏∏‡∏ì" ‡∏Å‡∏±‡∏ö "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô" (currentViewerLocation)
                    let distToWorker = Infinity;
                    
                    if (currentViewerLocation) {
                        distToWorker = getDistanceFromLatLonInKm(
                            freshLat, freshLng,
                            currentViewerLocation.lat, currentViewerLocation.lng
                        ) * 1000;
                    }


                    if (distToWorker > 50) {
                        return alert(`‚õî The distance is incorrect! You must be within 50 meters of the recipient.Currently the distance is: ${distToWorker.toFixed(0)} m.)`);
                    }

                } else {
                    // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô" ---
                    // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ 2 ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∏‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå OR ‡πÉ‡∏Å‡∏•‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
                    const distToPost = getDistanceFromLatLonInKm(
                        freshLat, freshLng, 
                        currentPost.location.lat, currentPost.location.lng
                    ) * 1000;

                    let distToOwner = Infinity;
                    if (ownerLastLocation) {
                        distToOwner = getDistanceFromLatLonInKm(
                            freshLat, freshLng,
                            ownerLastLocation.lat, ownerLastLocation.lng
                        ) * 1000;
                    }


                    if (distToPost > 50 && distToOwner > 50) {
                        let msg = `‚õî The distance is incorrect! You need to be within 50 meters of the meeting point or the poster.`;
                        return alert(msg);
                    }
                }

                // ‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏ö‡∏á‡∏≤‡∏ô
                executeSocketFinish();
            },
            (error) => { alert("‚ùå Unable to retrieve GPS coordinates."); },
            { enableHighAccuracy: true, timeout: 5000 }
        );
    } else {
        executeSocketFinish();
    }

    function executeSocketFinish() {
    // [NEW] 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢ ‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á
    const timerText = document.getElementById('timer-text');
    if (timerText && timerText.innerText === "TimeUp") {
		location.reload();
		window.location.href = '/';
    }

    const lang = localStorage.getItem('preferredLanguage') || 'th';
    const t = postTranslations[lang] || postTranslations['th'];
    if (confirm(t['confirm_finish_request'] || '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏á‡∏≤‡∏ô?')) {
        socket.emit('request-finish-job', { postId });
    }
}
}

        socket.on('receive-finish-request', (data) => {
    finishRequester = data.requester;
    
    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•
    const lang = localStorage.getItem('preferredLanguage') || 'th';
    const t = postTranslations[lang] || postTranslations['th'];

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ: "‡∏Ñ‡∏∏‡∏ì [Name] ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô..."
    const descElement = document.getElementById('finish-job-desc');
    descElement.innerHTML = `${t['modal_finish_desc_prefix']} <strong id="finish-requester-name">${data.requester}</strong> ${t['modal_finish_desc_suffix']}`;
    
    // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å applyLanguage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏° (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ)
    applyLanguage();

    document.getElementById('finish-job-modal').classList.remove('hidden');
});

        function replyFinishJob(accepted) {
            socket.emit('confirm-finish-job', { 
                postId, 
                accepted, 
                requester: finishRequester 
            });
            document.getElementById('finish-job-modal').classList.add('hidden');
        }

        socket.on('finish-request-rejected', (data) => {
    let msg = data; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° (‡∏Å‡∏£‡∏ì‡∏µ Server ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô String)
    
    // ‡∏ñ‡πâ‡∏≤ Server ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Object { msgKey: '...' }
    if (typeof data === 'object' && data.msgKey) {
        const lang = localStorage.getItem('preferredLanguage') || 'th';
        const t = postTranslations[lang] || postTranslations['th'];
        msg = t[data.msgKey] || data.msgKey;
    }

    showNotification(msg, 'fas fa-times-circle', 3000); 
});

        // üöÄ Event ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        socket.on('job-completed-success', (data) => {
    let msg = data;

    // ‡∏ñ‡πâ‡∏≤ Server ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Object { msgKey: ... }
    if (typeof data === 'object' && data.msgKey) {
        const lang = localStorage.getItem('preferredLanguage') || 'th';
        const t = postTranslations[lang] || postTranslations['th'];
        msg = t[data.msgKey] || data.msgKey;
    }

    showNotification(msg, 'fas fa-trophy', 4000); 
    
    // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡∏ô
    setTimeout(() => {
        window.location.replace('/'); 
    }, 2000);
});

    socket.on('new-comment', (data) => { 
    if (data.postId == postId) {
        // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å
        const list = document.getElementById('comments-list');
        if (list) {
            list.insertAdjacentHTML('beforeend', createCommentHTML(data.comment, list.children.length));
            list.scrollTop = list.scrollHeight;
        }

        // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ä‡∏ó‡∏•‡∏≠‡∏¢
        const floatingList = document.getElementById('floating-chat-messages');
        if (floatingList) {
            const hasImage = data.comment.imageUrl ? ' <i class="fas fa-image"></i>' : '';
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            const displayContent = formatMessageOnlyMaps(data.comment.content); 

            const html = `
                <div style="background:white; padding:8px; border-radius:10px; font-size:0.85em; box-shadow:0 1px 2px rgba(0,0,0,0.1); margin-bottom:5px;">
                    <strong style="color:#007bff;">${data.comment.author}:</strong> 
                    <span>${displayContent}${hasImage}</span>
                </div>`;
            
            floatingList.insertAdjacentHTML('beforeend', html);
            floatingList.scrollTop = floatingList.scrollHeight;
        }
    } 
});

        function goBack() {
            socket.emit('leave-post-room', postId); 
            location.href = '/';
        }

        window.onbeforeunload = function() { socket.emit('leave-post-room', postId); }; 
        document.getElementById('comment-input').addEventListener('keypress', (e) => { 
            if(e.key === 'Enter') sendComment(); 
        });
        
        // --- EXPOSE GLOBAL FUNCTIONS ---
        window.restartPost = restartPost;
        window.sendComment = sendComment;
        window.closeDealWithViewer = closeDealWithViewer;
        window.openHandoverModal = openHandoverModal;
        window.replyOffer = replyOffer;
        window.replyFinishJob = replyFinishJob;
        window.requestFinishJob = requestFinishJob;
        window.setRating = setRating;
        window.submitRating = submitRating;
        window.goBack = goBack;
        window.manualClosePost = manualClosePost;
        applyLanguage();
        
        document.getElementById('comment-image').addEventListener('change', function() {
    const fileNameDisplay = document.getElementById('file-name-display');
    if (this.files && this.files.length > 0) {
        // ‚≠ê ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô
        fileNameDisplay.innerHTML = `<i class="fas fa-image"></i> ${this.files[0].name} <span style="font-size:0.8em; color:#999;"></span>`;
        fileNameDisplay.style.display = 'block'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô block ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ö‡∏ô
    } else {
        fileNameDisplay.innerText = '';
        fileNameDisplay.style.display = 'none';
    }
});

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    const R = 6371; // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÇ‡∏•‡∏Å (‡∏Å‡∏°.)
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const d = R * c; // ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏Å‡∏°.
    return d;
}

function deg2rad(deg) {
    return deg * (Math.PI / 180);
}

function checkShowExtendButton() {
    const btn = document.getElementById('btn-extend-time');
    // ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô finished ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (acceptedViewer)
    if (currentPost && currentPost.status === 'finished' && myUsername === currentPost.acceptedViewer) {
        if(btn) btn.style.display = 'block';
    } else {
        if(btn) btn.style.display = 'none';
    }
}

function requestExtension() {

    try {
        // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ SweetAlert ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        if (typeof Swal === 'undefined') {
            console.error("‚ùå [Debug] Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö Library 'Swal' (SweetAlert2)");
            alert("Error: Swal library is missing!");
            return;
        }

        // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Socket ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        if (typeof socket === 'undefined') {
            console.error("‚ùå [Debug] Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ 'socket'");
            alert("Error: Socket is missing!");
            return;
        }

        // 3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ postId ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
        if (typeof postId === 'undefined' || !postId) {
            console.error("‚ùå [Debug] Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ 'postId'");
            alert("Error: Post ID is missing!");
            return;
        }


        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á Popup
        Swal.fire({
            title: 'Add time request',
            text: 'select request time',
            icon: 'question',
            input: 'radio',
            inputOptions: {
                '10': '10 m',
                '20': '20 m',
                '30': '30 m'
            },
            inputValidator: (value) => {
                if (!value) return 'Please select time!';
            },
            showCancelButton: true,
            confirmButtonText: 'Send request',
            cancelButtonText: 'Cancle'
        }).then((result) => {
            
            if (result.isConfirmed) {
                const minutes = parseInt(result.value);

                // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏´‡∏≤ Server
                socket.emit('request-extend-time', { postId, minutes });
                
                Swal.fire('Request time Send...', 'Waiting Accept...', 'info');
            }
        });

    } catch (err) {
        alert("System Error: " + err.message);
    }
}

socket.on('receive-extension-request', (data) => {
    const { minutes, requester } = data;
    Swal.fire({
        title: 'Add time request!',
        text: `${requester} Add time request ${minutes} m`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Accept (Add time)',
        cancelButtonText: 'Reject',
        confirmButtonColor: '#27ae60',
        cancelButtonColor: '#d33'
    }).then((result) => {
        // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Server (True = ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥, False = ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò)
        socket.emit('reply-extension-request', { 
            postId, 
            minutes, 
            approved: result.isConfirmed 
        });
    });
});


socket.on('time-extended-success', (data) => {
    const { newDeadline, addedMinutes } = data;
    
    Swal.fire({
        icon: 'success', // ‡πÄ‡∏û‡∏¥‡πà‡∏° icon ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
        title: 'Add time success!', 
        text: `Add time ${addedMinutes} m`,
        timer: 2000,
        showConfirmButton: false
    });
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ Deadline ‡πÉ‡∏´‡∏°‡πà
    startCountdown(newDeadline); 
});

socket.on('extension-rejected', () => {
    Swal.fire('The request was rejected.', 'The client did not approve the request for an extension of time.', 'error');
});


// ‡∏õ‡∏¥‡∏î Picker ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÅ‡∏Å‡πâ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô sendComment ‡πÄ‡∏î‡∏¥‡∏°)
    const originalSendComment = window.sendComment;
    window.sendComment = async function() {
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        await originalSendComment(); // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® window.sendComment = sendComment ‡πÑ‡∏ß‡πâ‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°
    }

    </script>
    
    <div id="call-modal" class="hidden" style="position: fixed; bottom: 20px; right: 20px; width: 300px; background: #2c3e50; color: white; border-radius: 10px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 3200; text-align: center;">
    <h3 id="call-status" style="margin: 0 0 10px 0;">üìû Calling..</h3>
    <p id="call-partner" style="font-size: 0.9em; color: #bdc3c7;">...</p>
    
    <div id="incoming-actions" class="hidden">
        <button onclick="acceptCall()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; margin-right: 5px;">
            <i class="fas fa-phone"></i> Accept
        </button>
        <button onclick="endCall()" style="background: #c0392b; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer;">
            <i class="fas fa-phone-slash"></i> Reject
        </button>
    </div>

    <button id="btn-hangup" onclick="endCall()" style="background: #c0392b; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; margin-top: 10px;">
        <i class="fas fa-phone-slash"></i> End.
    </button>
    
    <audio id="remote-audio" autoplay></audio>
</div>


	<button id="back-btn" class="back-btn" onclick="goBack()" 
    data-i18n-title="btn_back_tooltip"
    style="
        position: fixed;
        top: 10px;         /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô */
        left: 10px;        /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢ */
        z-index: 2000;    /* ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ 2000) */
        width: 45px;       /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° */
        height: 45px;      /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏õ‡∏∏‡πà‡∏° */
        border-radius: 50%; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏° (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) */
        background-color: rgba(0, 0, 0, 0.6); /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á */
        color: white;      /* ‡∏™‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô */
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        cursor: pointer;
        transition: background 0.3s;
    ">
    <i class="fas fa-arrow-left"></i> 
</button>


	<button id="final-finish-btn" class="send-btn" 
    style="
        display: none; 
        position: fixed; 
        bottom: 100px; /* ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ (‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà 80px) */
        left: 5px; 
        height: 45px;      /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏õ‡∏∏‡πà‡∏° */
        background: #6f42c1; 
        color: white; 
        border: none; 
        padding: 12px 20px; 
        border-radius: 30px; 
        z-index: 2000; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
        font-family: 'Kanit', sans-serif;
        cursor: pointer;
        transition: all 0.3s ease;
    " 
    onclick="requestFinishJob()" 
    data-i18n-key="btn_finish_job">
    <i class="far fa-handshake"></i> Employ job
</button>


	<div id="countdown-bar" style="display: none; 
		position: fixed; 
		bottom: 100px; 
		right: 5px; background: 
		linear-gradient(135deg, #2c3e50, #000000); 
		color: #fff; 
		padding: 10px 20px; 
		border-radius: 50px; 
		z-index: 3000; 
		box-shadow: 0 4px 15px rgba(0,0,0,0.4); 
		font-family: 'Kanit', sans-serif;">
    <div style="display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-clock fa-spin" style="color: #f1c40f;"></i>
        <div>
            <div style="font-size: 0.8rem; opacity: 0.8;"></div>
            <div id="timer-text" style="font-size: 1.2rem; font-weight: bold; color: #f1c40f;">00:00</div>
        </div>
    </div>
</div>

	
	<button id="btn-extend-time" 
	onclick="requestExtension()"
    style="
        display: none; 
        position: fixed; 
        bottom: 150px;  /* ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ */
        right: 5px;    /* ‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢ */
        z-index: 3000; /* ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á */
        background: #87bf47; 
        color: white; 
        border: none; 
		padding: 12px 20px; 
		border-radius: 30px; 
        height: 30px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.4); 
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        justify-content: center;
		font-family: 'Kanit', sans-serif;
        transition: all 0.3s ease;
    "
    title="Add time request.">
    <i class="fas fa-hourglass-start"></i> Add time 
</button>


	


</body>
</html>