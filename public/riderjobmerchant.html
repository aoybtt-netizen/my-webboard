<!DOCTYPE html>
<html lang="th">
<head>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="GedGo">
	<meta name="mobile-web-app-capable" content="yes">
	
	<script src="/socket.io/socket.io.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GedGoZone - ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏Ç‡∏ô‡∏™‡πà‡∏á</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; margin: 0; background-color: #f4f7f6; padding-bottom: 80px; }
        .header { background: #11998e; color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 1000; }
        .container { max-width: 600px; margin: auto; padding: 15px; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô */
        .merchant-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 5px solid #f39c12; }
        .budget-badge { background: #fff4e5; color: #e67e22; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 1.2em; display: inline-block; }

        /* ‡∏£‡∏∞‡∏ö‡∏ö Timeline ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô */
        .timeline { position: relative; padding-left: 30px; margin-top: 20px; }
        .timeline::before { content: ''; position: absolute; left: 10px; top: 10px; bottom: 10px; width: 2px; background: #ddd; }
        .stop-point { position: relative; background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #eee; }
        .stop-point::after { content: ''; position: absolute; left: -25px; top: 20px; width: 12px; height: 12px; border-radius: 50%; background: #11998e; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .stop-point.pickup::after { background: #27ae60; }
        
        .btn-action { width: 100%; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-call { background: #e8f5e9; color: #2e7d32; }
        .btn-nav { background: #e3f2fd; color: #1565c0; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        .footer-action { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); display: flex; gap: 10px; }
        .btn-accept { flex: 2; background: #11998e; color: white; font-size: 1.1em; border-radius: 30px; }
        .btn-back { flex: 1; background: #eee; color: #666; border-radius: 30px; }
        
        .status-tag { float: right; font-size: 0.8em; padding: 4px 10px; border-radius: 12px; }
        .status-pending { background: #eee; color: #888; }
		
		
		
		
	.card-map-toggle {
    margin-bottom: 20px;
    background: white;
    padding: 10px;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.btn-toggle-map {
    width: 100%;
    padding: 12px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 10px;
    cursor: pointer;
    font-family: 'Kanit', sans-serif;
    font-weight: bold;
    color: #11998e;
}
.map-legend {
    display: flex;
    justify-content: space-around;
    padding: 10px;
    font-size: 0.85em;
    color: #666;
}
.hidden { display: none !important; }



	.btn-checkin {
    background: #27ae60;
    color: white;
    margin-top: 10px;
    width: 100%;
}
.btn-checkin:disabled {
    background: #ccc;
    cursor: not-allowed;
}
.btn-checkin.active {
    background: #27ae60;
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}




/* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ä‡∏ó‡∏™‡∏µ‡∏ü‡πâ‡∏≤ */
.btn-chat { 
    background: #e1f5fe; 
    color: #0288d1; 
}

/* Modal ‡πÅ‡∏ä‡∏ó‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
.chat-modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: white;
    z-index: 2000;
    display: flex;
    flex-direction: column;
}

.chat-header {
    background: #11998e;
    color: white;
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
}

#chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: #f0f2f5;
}

.chat-bubble {
    padding: 10px 15px;
    border-radius: 18px;
    max-width: 80%;
    font-size: 0.95em;
    line-height: 1.4;
}

.bubble-me {
    background: #11998e;
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}

.bubble-them {
    background: white;
    color: #333;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.chat-input-area {
    padding: 10px;
    background: white;
    display: flex;
    gap: 10px;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
}

.chat-input-area input {
    flex-grow: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 25px;
    outline: none;
}



/* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ä‡∏ó‡πÅ‡∏ö‡∏ö‡∏î‡∏π‡∏î‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏à‡∏≠‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ */
.floating-chat-btn {
    position: fixed;
    right: 0;
    top: 50%; /* ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
    transform: translateY(-50%);
    background: #11998e;
    color: white;
    padding: 15px 10px 15px 15px;
    border-radius: 30px 0 0 30px; /* ‡∏°‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ */
    box-shadow: -2px 0 10px rgba(0,0,0,0.2);
    z-index: 1500;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.3);
    border-right: none;
}

.floating-chat-btn i {
    font-size: 1.4em;
}

.floating-chat-btn span {
    font-size: 0.7em;
    font-weight: bold;
    writing-mode: vertical-rl; /* ‡∏´‡∏°‡∏∏‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ß‡∏¢‡πÜ */
    text-orientation: mixed;
}





    </style>
</head>
<body>

    <div class="header">
    <i class="fas fa-chevron-left" style="float: left; cursor: pointer;" onclick="history.back()"></i>
    <b data-i18n-key="header_job_details">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</b>
</div>

<div class="card-map-toggle">
    <button class="btn-toggle-map" onclick="toggleRouteMap()">
        <i class="fas fa-map-marked-alt"></i> 
        <span id="map-btn-text" data-i18n-key="btn_show_map">‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</span>
    </button>
    <div id="map-wrapper" class="hidden">
        <div id="route-map" style="height: 350px; width: 100%; border-radius: 12px; margin-top: 10px;"></div>
        <div class="map-legend">
            <span data-i18n-key="legend_you"><i class="fas fa-motorcycle" style="color: #3498db;"></i> ‡∏Ñ‡∏∏‡∏ì</span>
            <span data-i18n-key="legend_pickup"><i class="fas fa-store" style="color: #27ae60;"></i> ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</span>
            <span data-i18n-key="legend_dropoff"><i class="fas fa-box" style="color: #11998e;"></i> ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á</span>
        </div>
    </div>
</div>

<div class="container" id="job-details">
    <div style="text-align: center; padding: 50px;">
        <i class="fas fa-spinner fa-spin fa-2x" style="color: #11998e;"></i>
        <p data-i18n-key="loading_job_info">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô...</p>
    </div>
</div>

<div class="footer-action" id="footer-btns">
    <button id="btn-back" class="btn-action btn-back" onclick="history.back()" data-i18n-key="btn_back">‡∏Å‡∏•‡∏±‡∏ö</button>
    <button id="btn-accept-job" class="btn-action btn-accept" onclick="acceptJob()" data-i18n-key="btn_accept_job">‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>
</div>

    <script>
		const socket = io();
		let routeMap = null;
		let currentPostData = null;

        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('view_id') || urlParams.get('id');
        const myUsername = localStorage.getItem('myUsername');
		
		const currentLang = localStorage.getItem('preferredLanguage') || 'th';
		
		
		
		
const translations = {
    'th': {
        'header_job_details': '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤',
        'btn_show_map': '‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á',
        'btn_hide_map': '‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà',
        'legend_you': '‡∏Ñ‡∏∏‡∏ì',
        'legend_pickup': '‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',
        'legend_dropoff': '‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á',
        'loading_job_info': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô...',
        'btn_back': '‡∏Å‡∏•‡∏±‡∏ö',
        'btn_accept_job': '‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ',
		'btn_processing': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á (‡∏´‡πâ‡∏≤‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ)',
        'alert_pending_job': '‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ',
        'msg_already_taken': '‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß',
        'btn_waiting_merchant': '‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö...',
        'btn_accept_job': '‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ',
		'marker_your_pos': '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì',
        'marker_pickup': 'üè† ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',
        'marker_dropoff_num': (i) => `üìç ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà ${i}`,
        'status_success': '‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
        'status_current': '‚≠ê ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô',
        'status_locked': 'üîí ‡∏£‡∏≠‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö',
        'label_pickup': 'üü¢ ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',
        'label_dropoff_num': (i) => `üìç ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${i}`,
        'btn_checkin_now': '‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',
        'btn_checkin_wait': '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö',
        'btn_call': '‡πÇ‡∏ó‡∏£‡∏´‡∏≤',
        'btn_nav': '‡∏ô‡∏≥‡∏ó‡∏≤‡∏á',
        'lbl_merchant': '‡∏ú‡∏π‡πâ‡∏à‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô:',
        'lbl_job_details': '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô:',
        'lbl_no_details': '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°',
		'btn_checking_gps': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î...',
        'err_gps_not_support': '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',
        'err_gps_too_far': (dist) => `‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (${dist} ‡πÄ‡∏°‡∏ï‡∏£)\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ 100 ‡πÄ‡∏°‡∏ï‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô`,
        'confirm_checkin': (dist) => `‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ? (‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ${dist} ‡πÄ‡∏°‡∏ï‡∏£)`,
        'err_gps_denied': '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS',
        'err_not_logged_in': '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô',
        'confirm_request_job': '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        'btn_sending_request': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠...',
        'msg_request_success': 'üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
		'rating_title': 'üåü ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤',
        'rating_desc': (name) => `‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡∏ï‡πà‡∏≠ <b>${name}</b> ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?`,
        'btn_submit_rating': '‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô',
		'err_no_rating': '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô',
        'msg_rating_thanks': '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô!',
        'err_rating_failed': '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô',
		'msg_merchant_confirmed': '‚úÖ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!',
		'chat_header_merchant': '‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤',
        'rating_job_done': '‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!',
        'rating_merchant_desc': '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤',
        'btn_confirm_rating_home': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å',
        'plh_chat_input': '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...',
    },
    'en': {
        'header_job_details': 'Merchant Job Details',
        'btn_show_map': 'Show Route Map',
        'btn_hide_map': 'Hide Map',
        'legend_you': 'You',
        'legend_pickup': 'Pickup Point',
        'legend_dropoff': 'Drop-off',
        'loading_job_info': 'Loading job details...',
        'btn_back': 'Back',
        'btn_accept_job': 'Accept this Job',
		'btn_processing': 'Submitting... (Do not leave this page)',
        'alert_pending_job': '‚ö†Ô∏è You have a pending task. Please complete it before leaving.',
        'msg_already_taken': 'This job has already been taken.',
        'btn_waiting_merchant': 'Waiting for merchant approval...',
        'btn_accept_job': 'Accept this Job',
		'marker_your_pos': 'Your Location',
        'marker_pickup': 'üè† Pickup Point',
        'marker_dropoff_num': (i) => `üìç Drop-off ${i}`,
        'status_success': '‚úÖ Done',
        'status_current': '‚≠ê Current Target',
        'status_locked': 'üîí Locked (Wait)',
        'label_pickup': 'üü¢ Pickup Point',
        'label_dropoff_num': (i) => `üìç Drop-off Point ${i}`,
        'btn_checkin_now': 'Confirm Check-in',
        'btn_checkin_wait': 'Follow Sequence',
        'btn_call': 'Call',
        'btn_nav': 'Nav',
        'lbl_merchant': 'Merchant:',
        'lbl_job_details': 'Job Details:',
        'lbl_no_details': 'No additional details',
		'btn_checking_gps': 'Checking coordinates...',
        'err_gps_not_support': 'Your browser does not support geolocation',
        'err_gps_too_far': (dist) => `‚ùå You are too far from the target (${dist} m)\nPlease get within 100m before checking in`,
        'confirm_checkin': (dist) => `‚úÖ Confirm check-in at this point? (Current distance: ${dist} m)`,
        'err_gps_denied': 'Cannot access your location. Please enable GPS',
        'err_not_logged_in': 'Please log in first',
        'confirm_request_job': 'Do you want to send a job request to this merchant?',
        'btn_sending_request': 'Sending request...',
        'msg_request_success': 'üöÄ Request sent! Please wait for merchant approval',
		'rating_title': 'üåü Rate Merchant',
        'rating_desc': (name) => `How was your experience with <b>${name}</b>?`,
        'btn_submit_rating': 'Submit Rating',
		'err_no_rating': 'Please select a rating',
        'msg_rating_thanks': 'Thank you for your rating!',
        'err_rating_failed': 'Error submitting rating',
		'msg_merchant_confirmed': '‚úÖ Merchant has verified and closed the task!',
		'chat_header_merchant': 'Chat with Merchant',
        'rating_job_done': 'Job Completed!',
        'rating_merchant_desc': 'Please rate your experience with the merchant',
        'btn_confirm_rating_home': 'Confirm and Home',
        'plh_chat_input': 'Type a message...',
    },
    'pt': {
        'header_job_details': 'Detalhes do Pedido',
        'btn_show_map': 'Ver Mapa da Rota',
        'btn_hide_map': 'Ocultar Mapa',
        'legend_you': 'Voc√™',
        'legend_pickup': 'Ponto de Retirada',
        'legend_dropoff': 'Entrega',
        'loading_job_info': 'Carregando detalhes...',
        'btn_back': 'Voltar',
        'btn_accept_job': 'Aceitar este Trabalho',
		'btn_processing': 'Processando... (N√£o saia desta p√°gina)',
        'alert_pending_job': '‚ö†Ô∏è Voc√™ tem uma tarefa pendente. Por favor, conclua-a antes de sair.',
        'msg_already_taken': 'Este trabalho j√° foi aceito.',
        'btn_waiting_merchant': 'Aguardando aprova√ß√£o do lojista...',
        'btn_accept_job': 'Aceitar este Trabalho',
		'marker_your_pos': 'Sua Localiza√ß√£o',
        'marker_pickup': 'üè† Ponto de Retirada',
        'marker_dropoff_num': (i) => `üìç Entrega ${i}`,
        'status_success': '‚úÖ Conclu√≠do',
        'status_current': '‚≠ê Destino Atual',
        'status_locked': 'üîí Bloqueado',
        'label_pickup': 'üü¢ Ponto de Retirada',
        'label_dropoff_num': (i) => `üìç Ponto de Entrega ${i}`,
        'btn_checkin_now': 'Confirmar Check-in',
        'btn_checkin_wait': 'Siga a ordem',
        'btn_call': 'Ligar',
        'btn_nav': 'Navegar',
        'lbl_merchant': 'Lojista:',
        'lbl_job_details': 'Detalhes:',
        'lbl_no_details': 'Sem detalhes adicionais',
		'btn_checking_gps': 'Verificando coordenadas...',
        'err_gps_not_support': 'Seu navegador n√£o suporta geolocaliza√ß√£o',
        'err_gps_too_far': (dist) => `‚ùå Voc√™ est√° muito longe do destino (${dist} m)\nPor favor, aproxime-se a menos de 100m para fazer o check-in`,
        'confirm_checkin': (dist) => `‚úÖ Confirmar check-in neste ponto? (Dist√¢ncia atual: ${dist} m)`,
        'err_gps_denied': 'N√£o foi poss√≠vel acessar sua localiza√ß√£o. Ative o GPS',
        'err_not_logged_in': 'Por favor, fa√ßa login primeiro',
        'confirm_request_job': 'Deseja enviar uma solicita√ß√£o de trabalho para este lojista?',
        'btn_sending_request': 'Enviando solicita√ß√£o...',
        'msg_request_success': 'üöÄ Solicita√ß√£o enviada! Aguarde a aprova√ß√£o do lojista',
		'rating_title': 'üåü Avaliar Lojista',
        'rating_desc': (name) => `Como foi sua experi√™ncia com <b>${name}</b>?`,
        'btn_submit_rating': 'Enviar Avalia√ß√£o',
		'err_no_rating': 'Por favor, selecione uma avalia√ß√£o',
        'msg_rating_thanks': 'Obrigado pela sua avalia√ß√£o!',
        'err_rating_failed': 'Erro ao enviar avalia√ß√£o',
		'msg_merchant_confirmed': '‚úÖ O lojista verificou e encerrou o trabalho!',
		'chat_header_merchant': 'Chat com Lojista',
        'rating_job_done': 'Trabalho Conclu√≠do!',
        'rating_merchant_desc': 'Por favor, avalie sua experi√™ncia com o lojista',
        'btn_confirm_rating_home': 'Confirmar e In√≠cio',
        'plh_chat_input': 'Digite uma mensagem...',
    }
};

function applyMerchantTranslations() {
    console.log(`[i18n] Applying translations for: ${currentLang}`);

    // ‡πÉ‡∏ä‡πâ data-i18n-key ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö
    document.querySelectorAll('[data-i18n-key]').forEach(el => {
        const key = el.getAttribute('data-i18n-key');
        const translatedText = translations[currentLang]?.[key];

        if (translatedText) {
            // üö© ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Input / Textarea) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡πà Placeholder
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = translatedText;
            } 
            // üö© ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Element ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô <i> ‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô
            else {
                const icon = el.querySelector('i');
                if (icon) {
                    el.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
                    el.appendChild(icon); // ‡πÉ‡∏™‡πà‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°
                    el.insertAdjacentHTML('beforeend', ' ' + translatedText); // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                } else {
                    // üö© ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 3: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
                    el.innerText = translatedText;
                }
            }
        }
    });
}

// ‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
window.addEventListener('DOMContentLoaded', () => {
    applyMerchantTranslations();
});
		
		// üö© ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ID ‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ Loading
if (!jobId) {
    alert("Job code not found.");
    window.location.href = 'index.html';
}

// üö© ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Login ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
if (!myUsername) {
    alert("Please log in first.");
    window.location.href = 'login.html'; 
}

		
	socket.on('update-post-status', () => {
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    loadJobDetails(); 
});

    async function loadJobDetails() {
    try {
        const res = await fetch(`/api/posts/${jobId}`);
        const data = await res.json();
        
        if (data.success) {
            currentPostData = data.post; 
            renderJob(data.post); // ‡∏ß‡∏≤‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏á‡∏≤‡∏ô (‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á)
            
            // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô/‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£/‡∏Ø‡∏•‡∏Ø)
            updateFooterButtons(data.post); 
            
            // 2. üö© ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏á‡∏≤‡∏ô‡∏à‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
            checkJobCompletion(data.post);
        }
    } catch (error) { 
        console.error("Load Job Details Error:", error); 
    }
}

// ‡πÅ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å loadJobDetails
function updateFooterButtons(post) {
    const acceptBtn = document.getElementById('btn-accept-job');
    const backBtn = document.getElementById('btn-back'); // ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏µ ID ‡∏ô‡∏µ‡πâ
    const footerContainer = document.getElementById('footer-btns');

    // 1. ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏Ñ‡∏¢ append ‡πÑ‡∏ß‡πâ
    const oldMsg = footerContainer.querySelector('small');
    if (oldMsg) oldMsg.remove();

    // 2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
    if (post.acceptedBy) {
        if (post.acceptedBy === myUsername) {
            // --- ‡∏Å‡∏£‡∏ì‡∏µ: ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏á ---
            
            if (post.status === 'in_progress') {
                // üö© [LOCK] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô: ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö + ‡∏•‡πá‡∏≠‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                if (backBtn) backBtn.style.display = 'none';
                
                acceptBtn.style.display = 'block';
                acceptBtn.innerHTML = `<i class="fas fa-motorcycle fa-beat"></i> ${translations[currentLang].btn_processing}`;
                acceptBtn.style.background = "#2ecc71";
                acceptBtn.style.width = "100%"; // ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
                acceptBtn.disabled = true;

                // ‡∏î‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Back ‡∏Ç‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
                window.history.pushState(null, null, window.location.href);
                window.onpopstate = function() {
                    window.history.go(1);
                    alert(translations[currentLang].alert_pending_job);
                };

            } else if (post.status === 'closed_permanently') {
                // üîì [UNLOCK] ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô): ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ
                if (backBtn) backBtn.style.display = 'block';
                acceptBtn.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡πÑ‡∏õ‡πÉ‡∏ä‡πâ Modal ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ó‡∏ô
                window.onpopstate = null; // ‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° Back
            }

        } else {
            // --- ‡∏Å‡∏£‡∏ì‡∏µ: ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ---
            acceptBtn.style.display = 'none';
            if (backBtn) backBtn.style.display = 'block';
            
            const msg = document.createElement('small');
            msg.style.color = "#999";
            msg.innerText = translations[currentLang].msg_already_taken;
            footerContainer.appendChild(msg);
            window.onpopstate = null;
        }
    } 
    else if (post.pendingRider === myUsername) {
        // --- ‡∏Å‡∏£‡∏ì‡∏µ: ‡πÄ‡∏£‡∏≤‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ---
        if (backBtn) backBtn.style.display = 'block';
        acceptBtn.style.display = 'block';
        acceptBtn.innerHTML = `<i class="fas fa-clock"></i> ${translations[currentLang].btn_waiting_merchant}`;
        acceptBtn.style.background = "#f39c12";
        acceptBtn.disabled = true;
        window.onpopstate = null;
    }
    else if (post.status === 'closed_permanently' || post.status === 'closed_by_merchant' || post.isClosed) {
        // --- ‡∏Å‡∏£‡∏ì‡∏µ: ‡∏á‡∏≤‡∏ô‡∏à‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ---
        acceptBtn.style.display = 'none';
        if (backBtn) backBtn.style.display = 'block';
        window.onpopstate = null;
    } 
    else {
        // --- ‡∏Å‡∏£‡∏ì‡∏µ: ‡∏á‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ ---
        if (backBtn) backBtn.style.display = 'block';
        acceptBtn.style.display = 'block';
        acceptBtn.disabled = false;
        acceptBtn.innerHTML = translations[currentLang].btn_accept_job;
        acceptBtn.style.background = ""; // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ï‡∏≤‡∏° CSS (‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)
        acceptBtn.style.width = ""; // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
        window.onpopstate = null;
    }
}


	function toggleRouteMap() {
    const currentLang = localStorage.getItem('preferredLanguage') || 'th';
    const wrapper = document.getElementById('map-wrapper');
    const btnText = document.getElementById('map-btn-text');
    
    if (wrapper.classList.contains('hidden')) {
        wrapper.classList.remove('hidden');
        btnText.innerText = translations[currentLang].btn_hide_map || "‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á";
        
        initRouteMap();
    } else {
        wrapper.classList.add('hidden');
        btnText.innerText = translations[currentLang].btn_show_map || "‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á";
    }
}

function initRouteMap() {
    if (!currentPostData || !currentPostData.stops) return;

    // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
    if (!routeMap) {
        routeMap = L.map('route-map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(routeMap);
    }

    // 2. ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á Rider
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            const riderLat = position.coords.latitude;
            const riderLng = position.coords.longitude;
            
            drawPathOnMap(riderLat, riderLng);
        }, () => {
            // ‡∏Å‡∏£‡∏ì‡∏µ Rider ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢
            drawPathOnMap(null, null);
        });
    }
}

function drawPathOnMap(riderLat, riderLng) {
    // ‡∏•‡πâ‡∏≤‡∏á Layer ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà
    routeMap.eachLayer((layer) => {
        if (!!layer.toGeoJSON) routeMap.removeLayer(layer);
    });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(routeMap);

    const points = [];
    const markers = [];

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Rider (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    if (riderLat && riderLng) {
        const riderPos = [riderLat, riderLng];
        points.push(riderPos);
				markers.push(L.marker(riderPos, { 
				icon: L.divIcon({ html: '<i class="fas fa-motorcycle fa-2x" style="color:#3498db;"></i>', className: 'custom-div-icon' }) 
			}).bindPopup(translations[currentLang].marker_your_pos));
	}

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô (Stops) ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    currentPostData.stops.forEach((stop, index) => {
        const pos = [stop.lat, stop.lng];
        points.push(pos);
        
        const isPickup = (index === 0);
        const iconColor = isPickup ? "#27ae60" : "#11998e";
        const iconShape = isPickup ? "fa-store" : "fa-box";
        
        markers.push(L.marker(pos, {
			icon: L.divIcon({ 
				html: `<i class="fas ${iconShape} fa-2x" style="color:${iconColor};"></i>`, 
				className: 'custom-div-icon' 
			})
		}).bindPopup(isPickup ? translations[currentLang].marker_pickup : translations[currentLang].marker_dropoff_num(index)));
    });

    // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á (Polyline)
    const polyline = L.polyline(points, { color: '#11998e', weight: 4, dashArray: '10, 10', opacity: 0.7 }).addTo(routeMap);
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Marker ‡∏•‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    markers.forEach(m => m.addTo(routeMap));

    // ‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î
    routeMap.fitBounds(polyline.getBounds(), { padding: [50, 50] });
}




    function renderJob(post) {
    const currentLang = localStorage.getItem('preferredLanguage') || 'th'; // ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏©‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const container = document.getElementById('job-details');
    currentPostData = post; 

    // üö© 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const nextPendingIndex = post.stops.findIndex(s => s.status === 'pending');

    let stopsHtml = '';
    post.stops.forEach((stop, index) => {
        const isPickup = (index === 0);
        const isDone = stop.status === 'success'; 
        const isCurrentTarget = (index === nextPendingIndex); 

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ---
        const phoneText = stop.phone ? 
            ` <a href="tel:${stop.phone}" onclick="event.stopPropagation();" style="font-size: 0.85em; color: #007bff; text-decoration: underline; font-weight: normal;">(üìû ${stop.phone})</a>` 
            : '';

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô (‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•) ---
        let checkinBtnHtml = '';
        if (!isDone) {
            const btnColor = isCurrentTarget ? '#27ae60' : '#ccc';
            const btnCursor = isCurrentTarget ? 'pointer' : 'not-allowed';
            const btnText = isCurrentTarget ? translations[currentLang].btn_checkin_now : translations[currentLang].btn_checkin_wait;
            const isDisabled = !isCurrentTarget ? 'disabled' : '';

            checkinBtnHtml = `
                <button class="btn-checkin" ${isDisabled} 
                    style="width:100%; margin-top:10px; padding:12px; border-radius:8px; border:none; color:white; font-weight:bold; background:${btnColor}; cursor:${btnCursor};"
                    onclick="handleCheckIn(${index}, ${stop.lat}, ${stop.lng})">
                    <i class="fas fa-map-marker-alt"></i> ${btnText}
                </button>`;
        }

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡πà‡∏≤‡∏á HTML (‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠) ---
        const statusText = isDone ? translations[currentLang].status_success : (isCurrentTarget ? translations[currentLang].status_current : translations[currentLang].status_locked);
        const labelText = isPickup ? translations[currentLang].label_pickup : translations[currentLang].label_dropoff_num(index);

        stopsHtml += `
        <div class="stop-point ${isPickup ? 'pickup' : ''}" style="${isDone ? 'opacity: 0.7; border-left-color: #ccc;' : ''}">
            <div class="status-tag ${isDone ? 'status-success' : 'status-pending'}" 
                 style="background: ${isDone ? '#27ae60' : (isCurrentTarget ? '#f39c12' : '#eee')}; 
                        color: ${isDone || isCurrentTarget ? 'white' : '#888'};">
                ${statusText}
            </div>

            <b style="color: ${isPickup ? '#27ae60' : '#11998e'};">
                ${labelText}
            </b>
            
            <div style="margin-top: 5px; font-size: 1.1em; font-weight: 600;">
                ${stop.label}${phoneText}
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn-action btn-call" onclick="window.location.href='tel:${stop.phone}'">
                    <i class="fas fa-phone"></i> ${translations[currentLang].btn_call}
                </button>
                <button class="btn-action btn-nav" onclick="openNav(${stop.lat}, ${stop.lng})">
                    <i class="fas fa-directions"></i> ${translations[currentLang].btn_nav}
                </button>
            </div>

            ${checkinBtnHtml}
        </div>
        `;
    });

    // üö© 2. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏™‡πà‡∏ß‡∏ô Merchant Card)
    container.innerHTML = `
        <div class="merchant-card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <small style="color: #888;">${translations[currentLang].lbl_merchant}</small><br>
                    <b style="font-size: 1.2em;"><i class="fas fa-store"></i> ${post.storeName || post.author}</b>
                </div>
                <div class="budget-badge">‡∏ø ${post.budget}</div>
            </div>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
            <small style="color: #888;">${translations[currentLang].lbl_job_details}</small>
            <div style="margin-top: 5px;">${post.content || translations[currentLang].lbl_no_details}</div>
        </div>

        <div class="timeline">
            ${stopsHtml}
        </div>
    `;
}
		
		
	// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 2 ‡∏à‡∏∏‡∏î (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ï‡∏£)
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÇ‡∏•‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ï‡∏£
    const œÜ1 = lat1 * Math.PI/180;
    const œÜ2 = lat2 * Math.PI/180;
    const ŒîœÜ = (lat2-lat1) * Math.PI/180;
    const ŒîŒª = (lon2-lon1) * Math.PI/180;

    const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
              Math.cos(œÜ1) * Math.cos(œÜ2) *
              Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c; 
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
async function handleCheckIn(index, targetLat, targetLng) {
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${translations[currentLang].btn_checking_gps}`;

    if (!navigator.geolocation) {
        alert(translations[currentLang].err_gps_not_support);
        btn.disabled = false;
        btn.innerHTML = originalText;
        return;
    }

    navigator.geolocation.getCurrentPosition(async (position) => {
        const riderLat = position.coords.latitude;
        const riderLng = position.coords.longitude;

        // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
        const distance = calculateDistance(riderLat, riderLng, targetLat, targetLng);

        // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏±‡∏®‡∏°‡∏µ 100 ‡πÄ‡∏°‡∏ï‡∏£
        if (distance > 100) {
            alert(translations[currentLang].err_gps_too_far(Math.round(distance)));
            btn.disabled = false;
            btn.innerHTML = originalText;
            return;
        }

        // 3. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
        if (confirm(translations[currentLang].confirm_checkin(Math.round(distance)))) {
            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Server (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÉ‡∏ä‡πâ Endpoint ‡∏ô‡∏µ‡πâ)
            try {
                const res = await fetch(`/api/posts/${jobId}/checkin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        stopIndex: index,
                        riderName: myUsername,
                        lat: riderLat,
                        lng: riderLng
                    })
                });
                const data = await res.json();
                if (data.success) {
                    alert("Check-in successful!");
                    location.reload(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Timeline
                } else {
                    alert("mistake: " + data.error);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (e) {
                alert("Unable to connect to the server.");
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } else {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }, (error) => {
        alert(translations[currentLang].err_gps_denied);
        btn.disabled = false;
        btn.innerHTML = originalText;
    }, { enableHighAccuracy: true });
}


        function openNav(lat, lng) {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
        }

async function acceptJob() {
    if (!myUsername) return alert(translations[currentLang].err_not_logged_in);
	if (!confirm(translations[currentLang].confirm_request_job)) return;

    const btn = document.querySelector('.btn-accept');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${translations[currentLang].btn_sending_request}`;

    try {
        const res = await fetch(`/api/posts/${jobId}/apply`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ riderName: myUsername })
        });
        const data = await res.json();

        if (data.success) {
            alert(translations[currentLang].msg_request_success);
            location.reload(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö"
        } else {
            alert("‚ùå " + data.error);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    } catch (e) {
        alert("Unable to connect to the server.");
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}
		
		
	// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
function showRatingModal(merchantName) {
    
    const ratingHtml = `
        <div id="rating-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:flex; align-items:center; justify-content:center;">
            <div style="background:white; padding:25px; border-radius:15px; width:90%; max-width:400px; text-align:center;">
                <h3>${translations[currentLang].rating_title}</h3>
                <p>${translations[currentLang].rating_desc(merchantName)}</p>
                <div style="font-size: 2em; margin: 20px 0; color: #f1c40f;">
                    <i class="far fa-star star" onclick="setRating(1)"></i>
                    <i class="far fa-star star" onclick="setRating(2)"></i>
                    <i class="far fa-star star" onclick="setRating(3)"></i>
                    <i class="far fa-star star" onclick="setRating(4)"></i>
                    <i class="far fa-star star" onclick="setRating(5)"></i>
                </div>
                <button onclick="submitRating('${merchantName}')" class="btn-submit" 
                        style="background:#11998e; color:white; border:none; padding:15px; width:100%; border-radius:30px; font-weight:bold;">
                    ${translations[currentLang].btn_submit_rating}
                </button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', ratingHtml);
}

let selectedRating = 0;
function setRating(n) {
    selectedRating = n;
    const stars = document.querySelectorAll('.star');
    stars.forEach((s, i) => {
        if (i < n) { s.classList.replace('far', 'fas'); }
        else { s.classList.replace('fas', 'far'); }
    });
}

async function submitRating(merchantName) {
    if (selectedRating === 0) return alert(translations[currentLang].err_no_rating);
    const res = await fetch(`/api/posts/${jobId}/rate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ targetUser: merchantName, rating: selectedRating, role: 'rider' })
    });
    const data = await res.json();
    if (data.success) {
        alert(translations[currentLang].msg_rating_thanks);
        location.href = 'index.html'; // ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
    }
}


let chatInterval = null;

async function openRiderChat() {
    if (!currentPostData) return;
    
    document.getElementById('chat-with-name').innerText = `Chat: ${currentPostData.storeName || currentPostData.author}`;
    document.getElementById('rider-chat-modal').classList.remove('hidden');
    
    loadRiderMessages();
}

function getRiderRoleLabel(author) {
    if (author === myUsername) {
        return `<i class="fas fa-motorcycle"></i> ‡∏â‡∏±‡∏ô (Rider)`;
    } else if (currentPostData && author === currentPostData.author) {
        return `<i class="fas fa-store" style="color: #e67e22;"></i> Merchant`; // ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
    } else if (currentPostData && author === currentPostData.acceptedViewer) {
        return `<i class="fas fa-user-tag" style="color: #27ae60;"></i> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤`; // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    } else {
        return `<i class="fas fa-user"></i> ${author}`; // ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)
    }
}

function closeRiderChat() {
    document.getElementById('rider-chat-modal').classList.add('hidden');
    clearInterval(chatInterval);
}

function appendRiderMessage(author, text, isMe, imageUrl = null) {
    const container = document.getElementById('chat-messages');
    const roleLabel = getRiderRoleLabel(author);
    
    let contentHtml = `<span>${text}</span>`;
    
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ó‡πá‡∏Å img
    if (imageUrl) {
        contentHtml = `
            <div style="margin-bottom:5px;">${text}</div>
            <img src="/${imageUrl}" style="width:100%; border-radius:8px; cursor:pointer;" onclick="window.open(this.src)">
        `;
    }

    const msgHtml = `
        <div class="chat-bubble ${isMe ? 'bubble-me' : 'bubble-them'}" style="margin-bottom:12px;">
            <small style="display:block; font-size:0.7rem; font-weight:bold; opacity:0.8; margin-bottom:4px;">
                ${roleLabel}
            </small>
            ${contentHtml}
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', msgHtml);
    container.scrollTop = container.scrollHeight;
}

async function loadRiderMessages() {
    if (!jobId) return;
    
    try {
        const res = await fetch(`/api/posts/${jobId}/comments`);
        const messages = await res.json();
        
        const container = document.getElementById('chat-messages');
        container.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ä‡∏ó‡πÄ‡∏Å‡πà‡∏≤
        
        messages.forEach(msg => {
            const isMe = msg.author === myUsername;
            appendRiderMessage(msg.author, msg.text || msg.content, isMe);
        });
    } catch (e) {
        console.error("Chat load error:", e);
    }
}

async function sendRiderChat() {
    const input = document.getElementById('rider-chat-input');
    const text = input.value.trim();
    if (!text) return;

    try {
        const res = await fetch(`/api/posts/${jobId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                author: myUsername,
                text: text // ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô text ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÅ‡∏Å‡πâ‡πÉ‡∏ô server.js
            })
        });

        if (res.ok) {
            input.value = '';
            loadRiderMessages();
        }
    } catch (e) {
        alert("Unable to send message.");
    }
}

function shareRiderLocation() {
    if (!navigator.geolocation) {
        alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
        return;
    }

    navigator.geolocation.getCurrentPosition((position) => {
        const { latitude, longitude } = position.coords;
        const mapLink = `https://www.google.com/maps?q=${latitude},${longitude}`;
        const message = `üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô: ${mapLink}`;
        
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó
        sendRiderCustomMessage(message);
    }, (err) => {
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS");
    });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô)
async function sendRiderCustomMessage(text) {
    if (!jobId) return;
    try {
        await fetch(`/api/posts/${jobId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ author: myUsername, text: text })
        });
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á append ‡πÄ‡∏≠‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ socket ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ
    } catch (e) { console.error(e); }
}


async function handlePhotoSelect(input) {
    const file = input.files[0];
    if (!file) return;

    // ‡πÇ‡∏ä‡∏ß‡πå Loading ‡∏™‡∏±‡πâ‡∏ô‡πÜ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...");

    const resizedBlob = await compressImage(file, 800, 0.7); // ‡∏Å‡∏ß‡πâ‡∏≤‡∏á 800px, ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 70%
    sendRiderPhoto(resizedBlob);
}

function compressImage(file, maxWidth, quality) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/jpeg', quality);
            };
        };
    });
}

async function sendRiderPhoto(blob) {
    const formData = new FormData();
    formData.append('image', blob, 'rider_photo.jpg');
    formData.append('author', myUsername);
    formData.append('text', 'üì∑ ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û');

    try {
        const res = await fetch(`/api/posts/${jobId}/comments`, {
            method: 'POST',
            body: formData
        });
        if (res.ok) {
            console.log("‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
    } catch (e) {
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ");
    }
}




let selectedMerchantRating = 0;

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏™‡∏µ‡∏î‡∏≤‡∏ß
function setMerchantRating(n) {
    selectedMerchantRating = n;
    const stars = document.querySelectorAll('#merchant-stars i');
    stars.forEach((s, i) => {
        s.style.color = i < n ? '#f1c40f' : '#ddd';
    });
    const btn = document.getElementById('btn-submit-rating');
    btn.disabled = false;
    btn.style.background = '#11998e';
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô loadJobDetails ‡∏ß‡πà‡∏≤‡∏á‡∏≤‡∏ô‡∏à‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
function checkJobCompletion(post) {
    if (post.status === 'closed_permanently' && post.acceptedBy === myUsername) {
        const modal = document.getElementById('rating-merchant-modal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.style.display = 'flex'; // ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
        }
    }
}

// ‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server
async function submitMerchantRating() {
    try {
        const res = await fetch(`/api/posts/${jobId}/rate-merchant`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                rating: selectedMerchantRating,
                riderName: myUsername 
            })
        });

        const data = await res.json();
        if (data.success) {
            alert(translations[currentLang].msg_rating_thanks);
            location.href = '/index.html'; // ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (‡∏õ‡∏£‡∏±‡∏ö path ‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á)
        }
    } catch (e) {
        alert(translations[currentLang].err_rating_failed);
    }
}

	// ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô Rider ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ
window.addEventListener('load', () => {
    if (jobId) {
        socket.emit('join-post', jobId);
        console.log("Joined Room:", jobId);
    }
});

// ‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏ó‡∏™‡∏î‡∏ù‡∏±‡πà‡∏á Rider ‡∏î‡πâ‡∏ß‡∏¢
socket.on('new-comment', (data) => {
    const comment = data.comment || data;
    
    if (data.postId == jobId) {
        if (comment.author !== myUsername) {
            appendRiderMessage(comment.author, comment.text || comment.content, false);
        }
    }
});

// 1. ‡∏î‡∏±‡∏Å‡∏ü‡∏±‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î‡∏à‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏ö‡∏á‡∏≤‡∏ô)
socket.on('update-post-status', () => {
    loadJobDetails(); // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡∏ß‡∏≤‡∏î UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤
});

// 2. ‡∏î‡∏±‡∏Å‡∏ü‡∏±‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Bypass ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á
socket.on('update-job-status', (data) => {
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (data.postId == jobId) {
        loadJobDetails(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å Bypass
    }
});

// 3. ‡∏î‡∏±‡∏Å‡∏ü‡∏±‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
socket.on('job-finished-complete', (data) => {
    if (data.postId == jobId) {
        alert(translations[currentLang].msg_merchant_confirmed);
        location.reload(); // ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ
    }
});


        window.onload = loadJobDetails;
    </script>
	
	
	<div id="rider-chat-modal" class="chat-modal hidden">
    <div class="chat-header">
        <i class="fas fa-arrow-left" onclick="closeRiderChat()" style="cursor:pointer;"></i>
        <b id="chat-with-name">‡πÅ‡∏ä‡∏ó</b>
    </div>
    <div id="chat-messages"></div>
    
    <div class="chat-input-area" style="display: flex; align-items: center; gap: 8px; padding: 10px;">
        <input type="file" id="rider-photo-input" accept="image/*" style="display:none;" onchange="handlePhotoSelect(this)">
        <button onclick="document.getElementById('rider-photo-input').click()" style="background:none; border:none; color:#11998e; font-size: 1.2rem;">
            <i class="fas fa-camera"></i>
        </button>

        <button onclick="shareRiderLocation()" style="background:none; border:none; color:#11998e; font-size: 1.2rem;">
            <i class="fas fa-map-marker-alt"></i>
        </button>

        <input type="text" id="rider-chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." style="flex:1;" onkeypress="if(event.key==='Enter') sendRiderChat()">
        
        <button onclick="sendRiderChat()" style="background:#11998e; color:white; border:none; width:45px; height:45px; border-radius:50%;">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>



	<div class="floating-chat-btn" onclick="openRiderChat()">
    <i class="fas fa-comments"></i>
    <span>CHAT</span>
</div>


	<div id="rating-merchant-modal" class="chat-modal hidden" style="z-index: 2000; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;">
    <div style="background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; text-align: center;">
        <div style="font-size: 3em; color: #f1c40f; margin-bottom: 15px;"><i class="fas fa-store"></i></div>
        <h3 style="margin: 0 0 10px 0;" data-i18n-key="rating_job_done">‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h3>
        <p style="color: #666; font-size: 0.9em;" data-i18n-key="rating_merchant_desc">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</p>
        
        <div style="margin: 20px 0; font-size: 2em; color: #ddd;" id="merchant-stars">
            <i class="fas fa-star" onclick="setMerchantRating(1)" style="cursor:pointer;"></i>
            <i class="fas fa-star" onclick="setMerchantRating(2)" style="cursor:pointer;"></i>
            <i class="fas fa-star" onclick="setMerchantRating(3)" style="cursor:pointer;"></i>
            <i class="fas fa-star" onclick="setMerchantRating(4)" style="cursor:pointer;"></i>
            <i class="fas fa-star" onclick="setMerchantRating(5)" style="cursor:pointer;"></i>
        </div>

        <button onclick="submitMerchantRating()" id="btn-submit-rating" disabled 
            style="width: 100%; padding: 12px; background: #ccc; color: white; border: none; border-radius: 12px; font-weight: bold;"
            data-i18n-key="btn_confirm_rating_home">
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
        </button>
    </div>
</div>


</body>
</html>