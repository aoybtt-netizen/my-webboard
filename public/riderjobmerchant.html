<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GedGoZone - ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏Ç‡∏ô‡∏™‡πà‡∏á</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; margin: 0; background-color: #f4f7f6; padding-bottom: 80px; }
        .header { background: #11998e; color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 1000; }
        .container { max-width: 600px; margin: auto; padding: 15px; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô */
        .merchant-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 5px solid #f39c12; }
        .budget-badge { background: #fff4e5; color: #e67e22; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 1.2em; display: inline-block; }

        /* ‡∏£‡∏∞‡∏ö‡∏ö Timeline ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô */
        .timeline { position: relative; padding-left: 30px; margin-top: 20px; }
        .timeline::before { content: ''; position: absolute; left: 10px; top: 10px; bottom: 10px; width: 2px; background: #ddd; }
        .stop-point { position: relative; background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #eee; }
        .stop-point::after { content: ''; position: absolute; left: -25px; top: 20px; width: 12px; height: 12px; border-radius: 50%; background: #11998e; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .stop-point.pickup::after { background: #27ae60; }
        
        .btn-action { width: 100%; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-call { background: #e8f5e9; color: #2e7d32; }
        .btn-nav { background: #e3f2fd; color: #1565c0; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        .footer-action { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); display: flex; gap: 10px; }
        .btn-accept { flex: 2; background: #11998e; color: white; font-size: 1.1em; border-radius: 30px; }
        .btn-back { flex: 1; background: #eee; color: #666; border-radius: 30px; }
        
        .status-tag { float: right; font-size: 0.8em; padding: 4px 10px; border-radius: 12px; }
        .status-pending { background: #eee; color: #888; }
		
		
		
		
	.card-map-toggle {
    margin-bottom: 20px;
    background: white;
    padding: 10px;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.btn-toggle-map {
    width: 100%;
    padding: 12px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 10px;
    cursor: pointer;
    font-family: 'Kanit', sans-serif;
    font-weight: bold;
    color: #11998e;
}
.map-legend {
    display: flex;
    justify-content: space-around;
    padding: 10px;
    font-size: 0.85em;
    color: #666;
}
.hidden { display: none !important; }



	.btn-checkin {
    background: #27ae60;
    color: white;
    margin-top: 10px;
    width: 100%;
}
.btn-checkin:disabled {
    background: #ccc;
    cursor: not-allowed;
}
.btn-checkin.active {
    background: #27ae60;
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}



    </style>
</head>
<body>

    <div class="header">
        <i class="fas fa-chevron-left" style="float: left; cursor: pointer;" onclick="history.back()"></i>
        <b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</b>
    </div>
	
	
	<div class="card-map-toggle">
    <button class="btn-toggle-map" onclick="toggleRouteMap()">
        <i class="fas fa-map-marked-alt"></i> <span id="map-btn-text">‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</span>
    </button>
    <div id="map-wrapper" class="hidden">
        <div id="route-map" style="height: 350px; width: 100%; border-radius: 12px; margin-top: 10px;"></div>
        <div class="map-legend">
            <span><i class="fas fa-motorcycle" style="color: #3498db;"></i> ‡∏Ñ‡∏∏‡∏ì</span>
            <span><i class="fas fa-store" style="color: #27ae60;"></i> ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</span>
            <span><i class="fas fa-box" style="color: #11998e;"></i> ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á</span>
        </div>
    </div>
</div>


    <div class="container" id="job-details">
        <div style="text-align: center; padding: 50px;">
            <i class="fas fa-spinner fa-spin fa-2x" style="color: #11998e;"></i>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô...</p>
        </div>
    </div>

    <div class="footer-action" id="footer-btns">
        <button class="btn-action btn-back" onclick="history.back()">‡∏Å‡∏•‡∏±‡∏ö</button>
        <button class="btn-action btn-accept" onclick="acceptJob()">‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>

    <script>
	
		let routeMap = null;
		let currentPostData = null;

        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('view_id');
        const myUsername = localStorage.getItem('myUsername');

    async function loadJobDetails() {
    try {
        const res = await fetch(`/api/posts/${jobId}`);
        const data = await res.json();
        if (data.success) {
            currentPostData = data.post; // üö© ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ
            renderJob(data.post);
        }
    } catch (error) { console.error(error); }
}


	function toggleRouteMap() {
    const wrapper = document.getElementById('map-wrapper');
    const btnText = document.getElementById('map-btn-text');
    
    if (wrapper.classList.contains('hidden')) {
        wrapper.classList.remove('hidden');
        btnText.innerText = "‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á";
        initRouteMap(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡∏≤‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    } else {
        wrapper.classList.add('hidden');
        btnText.innerText = "‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á";
    }
}

function initRouteMap() {
    if (!currentPostData || !currentPostData.stops) return;

    // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
    if (!routeMap) {
        routeMap = L.map('route-map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(routeMap);
    }

    // 2. ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á Rider
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            const riderLat = position.coords.latitude;
            const riderLng = position.coords.longitude;
            
            drawPathOnMap(riderLat, riderLng);
        }, () => {
            // ‡∏Å‡∏£‡∏ì‡∏µ Rider ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢
            drawPathOnMap(null, null);
        });
    }
}

function drawPathOnMap(riderLat, riderLng) {
    // ‡∏•‡πâ‡∏≤‡∏á Layer ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà
    routeMap.eachLayer((layer) => {
        if (!!layer.toGeoJSON) routeMap.removeLayer(layer);
    });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(routeMap);

    const points = [];
    const markers = [];

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Rider (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    if (riderLat && riderLng) {
        const riderPos = [riderLat, riderLng];
        points.push(riderPos);
        markers.push(L.marker(riderPos, { 
            icon: L.divIcon({ html: '<i class="fas fa-motorcycle fa-2x" style="color:#3498db;"></i>', className: 'custom-div-icon' }) 
        }).bindPopup("‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"));
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô (Stops) ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    currentPostData.stops.forEach((stop, index) => {
        const pos = [stop.lat, stop.lng];
        points.push(pos);
        
        const isPickup = (index === 0);
        const iconColor = isPickup ? "#27ae60" : "#11998e";
        const iconShape = isPickup ? "fa-store" : "fa-box";
        
        markers.push(L.marker(pos, {
            icon: L.divIcon({ 
                html: `<i class="fas ${iconShape} fa-2x" style="color:${iconColor};"></i>`, 
                className: 'custom-div-icon' 
            })
        }).bindPopup(isPickup ? "üè† ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô" : `üìç ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà ${index}`));
    });

    // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á (Polyline)
    const polyline = L.polyline(points, { color: '#11998e', weight: 4, dashArray: '10, 10', opacity: 0.7 }).addTo(routeMap);
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Marker ‡∏•‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    markers.forEach(m => m.addTo(routeMap));

    // ‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î
    routeMap.fitBounds(polyline.getBounds(), { padding: [50, 50] });
}




    function renderJob(post) {
    const container = document.getElementById('job-details');
    currentPostData = post; 

    // üö© 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ‡∏à‡∏∏‡∏î‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô 'pending'
    const nextPendingIndex = post.stops.findIndex(s => s.status === 'pending');

    let stopsHtml = '';
    post.stops.forEach((stop, index) => {
        const isPickup = (index === 0);
        const isDone = stop.status === 'success'; 
        const isCurrentTarget = (index === nextPendingIndex); 

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ---
        const phoneText = stop.phone ? 
            ` <a href="tel:${stop.phone}" onclick="event.stopPropagation();" style="font-size: 0.85em; color: #007bff; text-decoration: underline; font-weight: normal;">(üìû ${stop.phone})</a>` 
            : '';

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÅ‡∏¢‡∏Å Logic ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Editor ‡∏™‡∏µ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô) ---
        let checkinBtnHtml = '';
        if (!isDone) {
            const btnColor = isCurrentTarget ? '#27ae60' : '#ccc';
            const btnCursor = isCurrentTarget ? 'pointer' : 'not-allowed';
            const btnText = isCurrentTarget ? '‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á' : '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö';
            const isDisabled = !isCurrentTarget ? 'disabled' : '';

            checkinBtnHtml = `
                <button class="btn-checkin" ${isDisabled} 
                    style="width:100%; margin-top:10px; padding:12px; border-radius:8px; border:none; color:white; font-weight:bold; background:${btnColor}; cursor:${btnCursor};"
                    onclick="handleCheckIn(${index}, ${stop.lat}, ${stop.lng})">
                    <i class="fas fa-map-marker-alt"></i> ${btnText}
                </button>`;
        }

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡πà‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Stop ---
        stopsHtml += `
        <div class="stop-point ${isPickup ? 'pickup' : ''}" style="${isDone ? 'opacity: 0.7; border-left-color: #ccc;' : ''}">
            <div class="status-tag ${isDone ? 'status-success' : 'status-pending'}" 
                 style="background: ${isDone ? '#27ae60' : (isCurrentTarget ? '#f39c12' : '#eee')}; 
                        color: ${isDone || isCurrentTarget ? 'white' : '#888'};">
                ${isDone ? '‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : (isCurrentTarget ? '‚≠ê ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô' : 'üîí ‡∏£‡∏≠‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö')}
            </div>

            <b style="color: ${isPickup ? '#27ae60' : '#11998e'};">
                ${isPickup ? 'üü¢ ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' : `üìç ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${index}`}
            </b>
            
            <div style="margin-top: 5px; font-size: 1.1em; font-weight: 600;">
                ${stop.label}${phoneText}
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn-action btn-call" onclick="window.location.href='tel:${stop.phone}'">
                    <i class="fas fa-phone"></i> ‡πÇ‡∏ó‡∏£‡∏´‡∏≤
                </button>
                <button class="btn-action btn-nav" onclick="openNav(${stop.lat}, ${stop.lng})">
                    <i class="fas fa-directions"></i> ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
                </button>
            </div>

            ${checkinBtnHtml}
        </div>
        `;
    });

    // üö© 2. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏•‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    container.innerHTML = `
        <div class="merchant-card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <small style="color: #888;">‡∏ú‡∏π‡πâ‡∏à‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô:</small><br>
                    <b style="font-size: 1.2em;"><i class="fas fa-store"></i> ${post.storeName || post.author}</b>
                </div>
                <div class="budget-badge">‡∏ø ${post.budget}</div>
            </div>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
            <small style="color: #888;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô:</small>
            <div style="margin-top: 5px;">${post.content || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'}</div>
        </div>

        <div class="timeline">
            ${stopsHtml}
        </div>
    `;
}
		
		
	// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 2 ‡∏à‡∏∏‡∏î (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ï‡∏£)
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÇ‡∏•‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ï‡∏£
    const œÜ1 = lat1 * Math.PI/180;
    const œÜ2 = lat2 * Math.PI/180;
    const ŒîœÜ = (lat2-lat1) * Math.PI/180;
    const ŒîŒª = (lon2-lon1) * Math.PI/180;

    const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
              Math.cos(œÜ1) * Math.cos(œÜ2) *
              Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c; 
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
async function handleCheckIn(index, targetLat, targetLng) {
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î...';

    if (!navigator.geolocation) {
        alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
        btn.disabled = false;
        btn.innerHTML = originalText;
        return;
    }

    navigator.geolocation.getCurrentPosition(async (position) => {
        const riderLat = position.coords.latitude;
        const riderLng = position.coords.longitude;

        // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
        const distance = calculateDistance(riderLat, riderLng, targetLat, targetLng);

        // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏±‡∏®‡∏°‡∏µ 100 ‡πÄ‡∏°‡∏ï‡∏£
        if (distance > 100) {
            alert(`‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (${Math.round(distance)} ‡πÄ‡∏°‡∏ï‡∏£)\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ 100 ‡πÄ‡∏°‡∏ï‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô`);
            btn.disabled = false;
            btn.innerHTML = originalText;
            return;
        }

        // 3. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
        if (confirm(`‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ? (‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ${Math.round(distance)} ‡πÄ‡∏°‡∏ï‡∏£)`)) {
            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Server (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÉ‡∏ä‡πâ Endpoint ‡∏ô‡∏µ‡πâ)
            try {
                const res = await fetch(`/api/posts/${jobId}/checkin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        stopIndex: index,
                        riderName: myUsername,
                        lat: riderLat,
                        lng: riderLng
                    })
                });
                const data = await res.json();
                if (data.success) {
                    alert("‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    location.reload(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Timeline
                } else {
                    alert("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + data.error);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (e) {
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ");
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } else {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }, (error) => {
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS");
        btn.disabled = false;
        btn.innerHTML = originalText;
    }, { enableHighAccuracy: true });
}


        function openNav(lat, lng) {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
        }

        async function acceptJob() {
            if(!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
            
            // Logic ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á API ‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤ Rider ‡∏Ñ‡∏ô‡πÑ‡∏´‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏£‡∏≤‡∏Ñ‡πà‡∏≠‡∏¢‡∏ó‡∏≥‡∏ï‡πà‡∏≠)
            alert("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô...");
        }
		
		
	// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
function showRatingModal(merchantName) {
    const ratingHtml = `
        <div id="rating-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:flex; align-items:center; justify-content:center;">
            <div style="background:white; padding:25px; border-radius:15px; width:90%; max-width:400px; text-align:center;">
                <h3>üåü ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <p>‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡∏ï‡πà‡∏≠ <b>${merchantName}</b> ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</p>
                <div style="font-size: 2em; margin: 20px 0; color: #f1c40f;">
                    <i class="far fa-star star" onclick="setRating(1)"></i>
                    <i class="far fa-star star" onclick="setRating(2)"></i>
                    <i class="far fa-star star" onclick="setRating(3)"></i>
                    <i class="far fa-star star" onclick="setRating(4)"></i>
                    <i class="far fa-star star" onclick="setRating(5)"></i>
                </div>
                <button onclick="submitRating('${merchantName}')" class="btn-submit" style="background:#11998e; color:white; border:none; padding:15px; width:100%; border-radius:30px; font-weight:bold;">‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', ratingHtml);
}

let selectedRating = 0;
function setRating(n) {
    selectedRating = n;
    const stars = document.querySelectorAll('.star');
    stars.forEach((s, i) => {
        if (i < n) { s.classList.replace('far', 'fas'); }
        else { s.classList.replace('fas', 'far'); }
    });
}

async function submitRating(merchantName) {
    if (selectedRating === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô");
    const res = await fetch(`/api/posts/${jobId}/rate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ targetUser: merchantName, rating: selectedRating, role: 'rider' })
    });
    const data = await res.json();
    if (data.success) {
        alert("‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö!");
        location.href = 'index.html'; // ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
    }
}


        window.onload = loadJobDetails;
    </script>
</body>
</html>